<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDWOOD IM</title>
    <script>
        (function () {
            const THEME_KEY = "redwood-theme";
            const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
            // Apply to documentElement so CSS selectors work immediately
            document.documentElement.setAttribute("data-theme", savedTheme);

            // This helper ensures the body gets the attribute once it exists
            window.addEventListener('DOMContentLoaded', () => {
                document.body.setAttribute("data-theme", savedTheme);
            });
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== THEME VARIABLES ===== */
        body[data-theme="dark"] {
            --sky-top: #020617;
            --sky-bottom: #000000;
            --particle-color: rgba(230, 240, 255, 0.85);

            --text-primary: #e5e7eb;
            /* slate-200 */
            --text-secondary: #94a3b8;
            /* slate-400 */
            --text-accent: #ef4444;
            /* red-500 */

            --button-text: #ef4444;
            --search-text: #ffffff;
            --presence-text: #ef4444;
            /* RED in dark mode */
            --title-primary: #ffffff;
            --title-accent: #ef4444;




        }

        body[data-theme="light"] {
            --sky-top: #87ceeb;
            --sky-bottom: #fff2c6;
            --particle-color: rgba(255, 200, 120, 0.6);

            --text-primary: #020617;
            /* slate-950 */
            --text-secondary: #334155;
            /* slate-700 */
            --text-accent: #b91c1c;
            /* red-700 */

            --button-text: #ffffff;
            /* white text */
            --search-text: #ef4444;
            --presence-text: #dc2626;
            --title-primary: #e9ebf0ff;
            /* dark text */
            --title-accent: #b91c1c;
            /* darker red */


        }


        /* --- CORE FUNCTIONAL CSS (KEEP THESE) --- */
        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(180deg,
                    var(--sky-top),
                    var(--sky-bottom));
            margin: 0;
            overflow: hidden;
        }

        #content-parent {
            height: calc(100vh - 110px) !important;
            min-height: calc(100vh - 110px) !important;
            overflow-y: auto !important;
            display: block !important;
            padding-bottom: 150px !important;
        }

        textarea {
            resize: none;
        }

        .active-link {
            border-left: 4px solid #fff;
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff !important;
            font-weight: bold;
        }

        .hidden-section {
            display: none;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        .bg-burgundy {
            background-color: #630d0d;
        }

        .text-burgundy {
            color: #630d0d;
        }

        .border-burgundy {
            border-color: #630d0d;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }


        /* --- SHARP 3D DASHBOARD CSS --- */
        #project-overlay {
            position: fixed;
            inset: 0;
            z-index: 10;

            display: flex;
            flex-direction: column;

            pointer-events: auto;
        }

        #main-sidebar,
        #main-content {
            position: relative;
            z-index: 50;
        }

        #working-on {
            color: var(--presence-text);
        }


        .dashboard-canvas {
            position: relative;
            z-index: 5;
            min-height: 100vh;


            display: flex;
            flex-direction: column;

            /* ‚ùå REMOVE full-screen blocking */
            width: auto;
            height: auto;

            /* ‚úÖ GLASS, NOT WALL */
            background: rgba(6, 12, 25, 0.55);


            overflow: hidden;
        }




        .glass-header {
            background: linear-gradient(180deg,
                    rgba(3, 7, 18, 0.95),
                    rgba(2, 6, 23, 0.85));
            padding: 20px 50px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            /* Added bottom padding so projects don't get trapped behind the HUD footer */
            padding: 40px 60px 150px 60px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* THE 3D PROJECT CARD - Optimized for high visibility */
        .tilt-card {
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(56, 189, 248, 0.15);
            border-radius: 24px;
            padding: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            transform-style: preserve-3d;
        }

        .tilt-card:hover {
            transform: translateZ(40px) scale(1.02);
            background: rgba(30, 41, 59, 0.65);
            border-color: rgba(56, 189, 248, 0.6);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.25);

        }

        /* HUD FOOTER - The Sharp Version */
        .hud-footer {
            padding: 25px 50px;
            background: linear-gradient(0deg,
                    rgba(2, 6, 23, 0.95),
                    rgba(15, 23, 42, 0.9));
            border-top: 2px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 40px;
            z-index: 100;
        }

        .status-glow {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #38bdf8;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.9);
            animation: HUDpulse 2s infinite;
        }

        .search-hud {
            color: var(--text-primary);
        }

        .search-hud::placeholder {
            color: var(--text-secondary);
        }

        /* ===== LIVE UNDERWATER MOTION LAYER ===== */
        #live-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background:
                radial-gradient(circle at top, var(--sky-top), transparent 45%),
                linear-gradient(180deg, var(--sky-top), var(--sky-bottom));
        }



        /* ===== CELESTIAL LAYER ===== */
        #celestial-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }

        #moon,
        #sun {
            position: absolute;
            top: 80px;
            left: 0;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* Moon */
        #moon {
            background: radial-gradient(circle, #ffffff, #bcd7ff 60%);
            box-shadow: 0 0 90px rgba(180, 210, 255, 0.7);
        }

        /* Sun */
        #sun {
            background: radial-gradient(circle, #fff6a8, #ffb703 60%);
            box-shadow: 0 0 140px rgba(255, 180, 80, 0.9);
        }

        /* Arc animations */
        @keyframes moonArc {
            0% {
                transform: translateX(-20vw) translateY(0);
            }

            50% {
                transform: translateX(40vw) translateY(-60px);
            }

            100% {
                transform: translateX(100vw) translateY(0);
            }
        }

        @keyframes sunArc {
            0% {
                transform: translateX(-20vw) translateY(40px);
            }

            50% {
                transform: translateX(40vw) translateY(-90px);
            }

            100% {
                transform: translateX(100vw) translateY(40px);
            }
        }

        /* Visibility by mode */
        body[data-theme="dark"] #moon {
            opacity: 1;
            animation: moonArc 140s linear infinite;
        }

        body[data-theme="dark"] #sun {
            opacity: 0;
            animation: none;
        }

        body[data-theme="light"] #sun {
            opacity: 1;
            animation: sunArc 100s linear infinite;
        }

        body[data-theme="light"] #moon {
            opacity: 0;
            animation: none;
        }

        /* ===== MYSTICAL LOGIN BACKDROP (SAFE ADD) ===== */
        .auth-mystic {
            background:
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.12), transparent 45%),
                linear-gradient(180deg,
                    rgba(2, 6, 23, 0.92),
                    rgba(0, 0, 0, 0.96));
            backdrop-filter: blur(2px);
        }

        /* Floating login card feel */
        .auth-mystic>div {
            position: relative;
            z-index: 2;
            box-shadow:
                0 40px 120px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(239, 68, 68, 0.15);
        }

        /* ===== LOGIN MYSTICAL DRIFT ===== */
        /* ===== LOGIN MYSTICAL MOTION (ENHANCED, STILL SUBTLE) ===== */
        .auth-drift {
            background:
                radial-gradient(circle at 30% 20%, rgba(239, 68, 68, 0.18), transparent 45%),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.06), transparent 50%);
            animation: loginDrift 90s linear infinite;
            filter: blur(1px);
        }

        @keyframes loginDrift {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(140px);
            }
        }

        /* ===== LOGIN GLASS CARD ===== */
        .login-glass {
            background: linear-gradient(180deg,
                    rgba(15, 23, 42, 0.88),
                    rgba(2, 6, 23, 0.92));
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow:
                0 60px 160px rgba(0, 0, 0, 0.85),
                0 0 120px rgba(239, 68, 68, 0.18);
        }

        /* ===== LOGIN EXIT TRANSITION ===== */
        .auth-exit {
            animation: authExit 600ms ease forwards;
        }

        @keyframes authExit {
            to {
                opacity: 0;
                transform: scale(0.96);
                filter: blur(6px);
            }
        }

        /* Styling for mirrored read-only tables in Annex 4 */
        [id^="ax4_block_"] table tbody td {
            background-color: #fcfcfc;
            color: #334155;
            pointer-events: none;
            /* Disables clicking/editing */
        }

        /* This forces the Audit and Comment bars to stay on top of EVERYTHING */
        #audit-sidebar,
        #comments-sidebar {
            position: fixed;
            /* Changed from relative to fixed */
            right: 0;
            top: 0;
            height: 100vh;
            z-index: 1000 !important;
            /* Higher than dashboard (10) and content (50) */
            background: #0f172a;
            /* Ensure it has a solid background */
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        /* Fix for Blurry Text on 3D Cards */
        .tilt-card {
            backface-visibility: hidden;
            -webkit-font-smoothing: antialiased;
            will-change: transform;
            /* Tells the browser to optimize this layer */
        }

        /* Ensure variables have defaults if data-theme is missing during load */
        :root {
            --sky-top: #020617;
            --sky-bottom: #000000;
        }

        /* Ensure the overlay is completely removed from the layout when hidden */
        #project-overlay.hidden {
            display: none !important;
            pointer-events: none;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* FORCE FSA VISIBILITY - Override all conflicts */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #fsa-dashboard-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: white !important;
            z-index: 9999 !important;
            overflow-y: auto !important;
        }

        #fsa-root {
            display: block !important;
            width: 100% !important;
            height: auto !important;
            min-height: 100vh !important;
            position: relative !important;
            z-index: 10000 !important;
        }

        #mainapp {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init({
                publicKey: "ctKro1C5mx9FqjIns",
            });
        })();
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #fsa-root {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #630d0d 0%, #8b1a1a 100%);
            padding: 20px;
            min-height: 100vh;
        }

        #fsa-root .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        #fsa-root .header {
            background: linear-gradient(135deg, #630d0d 0%, #8b1a1a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        #fsa-root .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        #fsa-root .company-type-selector {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
        }

        #fsa-root .company-info-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        #fsa-root .company-info-row label {
            font-weight: 600;
            color: #495057;
            margin-right: 10px;
        }

        #fsa-root .company-info-row input[type="text"],
        #fsa-root .company-info-row select {
            padding: 10px 20px;
            border: 2px solid #630d0d;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            color: #630d0d;
        }

        #fsa-root .company-info-row input[type="text"] {
            min-width: 400px;
        }

        #fsa-root .company-info-row select {
            cursor: pointer;
            min-width: 250px;
        }

        #fsa-root .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #fsa-root .action-btn {
            padding: 10px 20px;
            background: #630d0d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        #fsa-root .action-btn:hover {
            background: #4a0404;
            transform: translateY(-2px);
        }

        #fsa-root .last-saved {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #fsa-root .last-saved.saving {
            background: #fff3cd;
            color: #856404;
        }

        #fsa-root .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        #fsa-root .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }

        #fsa-root .tab:hover {
            background: #e9ecef;
        }

        #fsa-root .tab.active {
            background: white;
            color: #630d0d;
            border-bottom: 3px solid #630d0d;
        }

        #fsa-root .content {
            padding: 30px;
        }

        #fsa-root .tab-content {
            display: none;
        }

        #fsa-root .tab-content.active {
            display: block;
        }

        #fsa-root .year-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        #fsa-root .year-btn {
            padding: 10px 20px;
            border: 2px solid #8b1a1a;
            background: white;
            color: #8b1a1a;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        #fsa-root .year-btn:hover {
            background: #8b1a1a;
            color: white;
        }

        #fsa-root .year-btn.active {
            background: #8b1a1a;
            color: white;
        }

        #fsa-root #yearManagerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        #fsa-root .year-manager-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        #fsa-root .year-manager-box h2 {
            margin-top: 0;
            color: #8b1a1a;
        }

        #fsa-root .year-manager-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #fsa-root .year-manager-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        #fsa-root .year-manager-btn-primary {
            background: #28a745;
            color: white;
        }

        #fsa-root .year-manager-btn-primary:hover {
            background: #218838;
        }

        #fsa-root .year-manager-btn-secondary {
            background: #6c757d;
            color: white;
        }

        #fsa-root .year-manager-btn-secondary:hover {
            background: #5a6268;
        }

        #fsa-root .section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        #fsa-root .section-header {
            background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }

        #fsa-root .section-body {
            padding: 20px;
        }

        #fsa-root .input-group {
            margin-bottom: 15px;
            display: grid;
            gap: 15px;
            align-items: center;
        }

        /* Reduce per-year input widths: use a smaller min width for each year column
           so the year entry boxes appear narrower while remaining responsive. */
        #fsa-root .input-group.cols-1 {
            grid-template-columns: 220px minmax(120px, 1fr) 80px;
        }

        #fsa-root .input-group.cols-2 {
            grid-template-columns: 200px repeat(2, minmax(120px, 1fr)) 80px;
        }

        #fsa-root .input-group.cols-3 {
            grid-template-columns: 180px repeat(3, minmax(120px, 1fr)) 80px;
        }

        #fsa-root .input-group.cols-4 {
            grid-template-columns: 160px repeat(4, minmax(120px, 1fr)) 80px;
        }

        #fsa-root .input-group.cols-5 {
            grid-template-columns: 140px repeat(5, minmax(110px, 1fr)) 80px;
        }

        #fsa-root .input-group.cols-6 {
            grid-template-columns: 120px repeat(6, minmax(100px, 1fr)) 80px;
        }

        #fsa-root .year-header {
            font-weight: bold;
            color: #8b1a1a;
            text-align: center;
            font-size: 13px;
        }

        #fsa-root .multi-year-toggle {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        #fsa-root .multi-year-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        #fsa-root .multi-year-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #fsa-root .year-columns-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        #fsa-root .year-col-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: white;
            border: 2px solid #8b1a1a;
            border-radius: 5px;
            cursor: pointer;
        }

        #fsa-root .year-col-checkbox.checked {
            background: #8b1a1a;
            color: white;
        }

        #fsa-root .input-group label {
            font-weight: 600;
            color: #495057;
        }

        #fsa-root .input-group input[type="number"],
        #fsa-root .input-group input[type="text"],
        #fsa-root .input-group select {
            padding: 10px 15px 10px 28px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        #fsa-root .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        #fsa-root .rupee-symbol {
            position: absolute;
            left: 10px;
            color: #8b1a1a;
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
        }

        #fsa-root .input-group input:focus,
        #fsa-root .input-group select:focus {
            outline: none;
            border-color: #8b1a1a;
        }

        #fsa-root .add-item-btn {
            border: 2px solid #630d0d;
            background: white;
            color: #630d0d;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        #fsa-root .add-item-btn:hover {
            background: #630d0d;
            color: white;
        }

        #fsa-root .delete-btn {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 14px;
        }

        #fsa-root .delete-btn:hover {
            background: #c82333;
        }

        #fsa-root .custom-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #fsa-root .custom-input-wrapper select,
        #fsa-root .custom-input-wrapper input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        #fsa-root .analyze-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
        }

        #fsa-root .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        #fsa-root .report-section {
            margin-bottom: 40px;
        }

        #fsa-root .report-section h2 {
            color: #8b1a1a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8b1a1a;
        }

        #fsa-root table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #fsa-root th,
        #fsa-root td {
            padding: 12px;
            text-align: left;
            border: 1px solid #dee2e6;
        }

        #fsa-root th {
            background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%);
            color: white;
            font-weight: 600;
        }

        #fsa-root tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        #fsa-root tbody tr:hover {
            background: #e9ecef;
        }

        #fsa-root .total-row {
            font-weight: 700;
            background: #e9ecef !important;
        }

        #fsa-root .ratio-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        #fsa-root .ratio-card h3 {
            color: #8b1a1a;
            margin-bottom: 10px;
        }

        #fsa-root .ratio-value {
            font-size: 24px;
            font-weight: 700;
            color: #495057;
        }

        #fsa-root .ratio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        #fsa-root .number-right {
            text-align: right;
        }

        /* Accessibility fix: ensure table text is high-contrast and visible
           inside generated analysis (Balance Sheet / P&L). Do not override
           .total-row which intentionally uses white text. */
        /* Target generated analysis area (analysisContent) and any report-section tables
           so colors display correctly even when not inside #fsa-root. */
        #analysisContent table th,
        #analysisContent table td,
        .report-section table th,
        .report-section table td {
            color: #0b1721 !important;
            /* dark charcoal for best contrast on light backgrounds */
        }

        /* Keep header cells visually strong (burgundy background + white text) */
        #analysisContent table th,
        .report-section table th {
            background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%) !important;
            color: #ffffff !important;
            font-weight: 700;
        }

        /* Ensure total rows remain white-on-burgundy as intended */
        #analysisContent .total-row,
        #analysisContent .total-row td,
        .report-section .total-row,
        .report-section .total-row td {
            background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%) !important;
            color: #ffffff !important;
        }

        #fsa-root .print-btn {
            padding: 12px 30px;
            background: #8b1a1a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }

        #fsa-root .calculated-field {
            background: #fdecec !important;
            font-style: italic;
        }

        /* ENHANCEMENT: Better Total Rows */
        .total-row {
            background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            border: 3px solid #8b1a1a !important;
        }

        #fsa-root .total-row td,
        #fsa-root .total-row th,
        #fsa-root .total-row span,
        #fsa-root .total-row div,
        #fsa-root .total-row b,
        #fsa-root .total-row strong {
            color: white !important;
            border-color: #8b1a1a !important;
            /* Ensure borders blend or match */
        }

        /* Ensure potential inputs in total rows are readable */
        #fsa-root .total-row input {
            color: black !important;
            background: white !important;
            border: 1px solid #ced4da !important;
        }

        #fsa-root .subtotal-row {
            background: #ffebee !important;
            font-weight: 600 !important;
            border-top: 2px solid #8b1a1a !important;
            border-bottom: 2px solid #8b1a1a !important;
        }

        /* ENHANCEMENT: Variance & Trend for Each Line Item */
        .variance-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        #fsa-root .variance-badge {
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        #fsa-root .variance-positive {
            background: #d4edda;
            color: #155724;
        }

        #fsa-root .variance-negative {
            background: #f8d7da;
            color: #721c24;
        }

        #fsa-root .variance-neutral {
            background: #e9ecef;
            color: #495057;
        }

        #fsa-root .trend-arrow {
            font-size: 14px;
            font-weight: bold;
        }

        /* ENHANCEMENT: File Attachments */
        .attachments-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 3px dashed #8b1a1a;
            min-height: 150px;
            box-shadow: 0 2px 8px rgba(139, 26, 26, 0.1);
        }

        #fsa-root .attachments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #fsa-root .attachment-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }

        #fsa-root .attachment-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #8b1a1a;
        }

        #fsa-root .attachment-icon {
            font-size: 32px;
        }

        #fsa-root .attachment-info {
            flex: 1;
        }

        #fsa-root .attachment-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        #fsa-root .attachment-meta {
            font-size: 12px;
            color: #6c757d;
        }

        #fsa-root .attachment-actions {
            display: flex;
            gap: 8px;
        }

        #fsa-root .attachment-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        #fsa-root .edit-name-btn {
            background: #ffc107;
            color: #000;
        }

        #fsa-root .download-btn {
            background: #28a745;
            color: white;
        }

        #fsa-root .delete-attachment-btn {
            background: #dc3545;
            color: white;
        }

        /* ENHANCEMENT: Notes & Insights */
        .notes-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #ffc107;
        }

        #fsa-root .notes-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        #fsa-root .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        #fsa-root .insights-section {
            background: #d1ecf1;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #17a2b8;
        }

        #fsa-root .insights-section h3 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        /* ENHANCEMENT: Section Headers */
        .section-divider {
            background: linear-gradient(to right, #8b1a1a, #630d0d);
            height: 3px;
            margin: 30px 0 20px 0;
            border-radius: 2px;
        }

        #fsa-root .section-main-header {
            font-size: 22px;
            font-weight: 700;
            color: #8b1a1a;
            margin: 25px 0 15px 0;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 5px solid #8b1a1a;
            border-radius: 5px;
        }

        #fsa-root .section-sub-header {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin: 20px 0 10px 0;
            padding-left: 10px;
            border-left: 3px solid #8b1a1a;
        }

        /* ENHANCED CHARTS CONTAINER - 2 per row, #fsa-root bigger and more interactive */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 40px 0;
        }

        #fsa-root .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid #e9ecef;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #fsa-root .chart-card:hover {
            box-shadow: 0 15px 40px rgba(139, 26, 26, 0.25);
            transform: translateY(-8px);
            border-color: #8b1a1a;
        }

        #fsa-root .chart-card h3 {
            color: #8b1a1a;
            margin-bottom: 25px;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        #fsa-root .chart-wrapper {
            position: relative;
            height: 500px;
        }

        /* Responsive design for charts */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            #fsa-root .chart-wrapper {
                height: 450px;
            }
        }

        /* Year-specific notes */
        .year-notes {
            background: #fdecec;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #8b1a1a;
        }

        #fsa-root .year-notes-label {
            font-weight: 600;
            color: #630d0d;
            margin-bottom: 5px;
        }

        @media print {

            .tabs,
            .year-selector,
            .analyze-btn,
            .print-btn,
            .company-type-selector,
            .action-buttons {
                display: none;
            }
        }

        #fsa-root .histmodal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 30000;
            align-items: center;
            justify-content: center;
        }

        #fsa-root .histmodal.show {
            display: flex;
        }

        #fsa-root .histbox {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #fsa-root .histitem {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #8b1a1a;
        }

        #fsa-root .histtime {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        #fsa-root .histuser {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }

        #fsa-root .histaction {
            color: #495057;
            font-size: 13px;
            line-height: 1.6;
        }

        #fsa-root .histchanges {
            background: #fff;
            padding: 10px;
            margin-top: 8px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }

        #fsa-root .deletebtn {
            background: #dc3545 !important;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        #fsa-root .deletebtn:hover {
            background: #c82333 !important;
        }
    </style>
    <style>
        .cloudscreen {
            min-height: 100vh;
            display: none;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #8b1a1a, #630d0d);
        }

        #fsa-root .cloudscreen.show {
            display: flex !important;
        }

        #fsa-root .cloudbox {
            background: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            width: 90%;
        }

        #fsa-root .cloudbox h1 {
            color: #8b1a1a;
            text-align: center;
            margin-bottom: 10px;
        }

        #fsa-root .cloudbox input,
        #fsa-root .cloudbox select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            box-sizing: border-box;
        }

        #fsa-root .cloudbox input:focus {
            outline: none;
            border-color: #8b1a1a;
        }

        #fsa-root .cloudbtn {
            width: 100%;
            padding: 14px;
            background: #8b1a1a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        #fsa-root .cloudbtn:hover {
            opacity: 0.9;
        }

        #fsa-root .cloudbtn2 {
            padding: 10px 20px;
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        #fsa-root .clouderr {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        #fsa-root .clouderr.show {
            display: block;
        }

        #fsa-root .clouddash {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        #fsa-root .cloudgrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        #fsa-root .cloudcard {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        #fsa-root .cloudcard h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        #fsa-root .cloudmeta {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.8;
        }

        #fsa-root .openbtn {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: #8b1a1a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        #fsa-root .openbtn:hover {
            background: #5568d3;
        }

        #fsa-root .cloudsync {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 10000;
        }

        #fsa-root .cloudsync.show {
            display: flex;
        }

        #fsa-root .syncdot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        #fsa-root .syncdot.syncing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        #fsa-root .cloudtop {
            display: none;
            padding: 15px 30px;
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            justify-content: space-between;
            align-items: center;
        }

        #fsa-root .cloudtop.show {
            display: flex;
        }

        #fsa-root .histmodal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 30000;
            align-items: center;
            justify-content: center;
        }

        #fsa-root .histmodal.show {
            display: flex;
        }

        #fsa-root .histbox {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #fsa-root .histitem {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #8b1a1a;
        }

        #fsa-root .histtime {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        #fsa-root .histuser {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }

        #fsa-root .histaction {
            color: #495057;
            font-size: 13px;
            line-height: 1.6;
        }

        #fsa-root .histchanges {
            background: #fff;
            padding: 10px;
            margin-top: 8px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }

        #fsa-root .deletebtn {
            background: #dc3545 !important;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        #fsa-root .deletebtn:hover {
            background: #c82333 !important;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">
    <canvas id="live-bg"></canvas>

    <div id="celestial-layer">
        <div id="moon"></div>
        <div id="sun"></div>
    </div>

    <div id="auth-overlay" class="fixed inset-0 z-[10000] flex items-center justify-center auth-mystic">

        <!-- MYSTICAL DRIFT LAYER (BACKGROUND ONLY) -->
        <div class="absolute inset-0 pointer-events-none auth-drift"></div>

        <!-- LOGIN CARD (MUST STAY ABOVE DRIFT) -->
        <div class="relative z-10 p-12 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center login-glass">
            <h1 class="text-4xl font-extrabold text-red-500 mb-6 italic uppercase">
                Redwood Partners
            </h1>

            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-8">
                Intelligence Login
            </p>

            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="Corporate Email"
                    class="w-full p-4 bg-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#630d0d]/20 font-bold text-sm">

                <input type="password" id="login-password" placeholder="Password"
                    class="w-full p-4 bg-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#630d0d]/20 font-bold text-sm">

                <button onclick="handleAuth()"
                    class="w-full bg-[#630d0d] text-white font-black py-4 rounded-2xl hover:bg-[#4a0404] transition-all shadow-lg uppercase tracking-widest text-xs">
                    Submit
                </button>
            </div>

            <p id="auth-error" class="text-red-500 text-[10px] mt-4 font-bold uppercase hidden"></p>
        </div>

    </div>


    <div id="project-overlay" class="no-print">
        <div class="dashboard-canvas">

            <header class="glass-header flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <div class="flex flex-col">
                        <h1 class="text-4xl font-black" style="color: var(--title-primary);">
                            Redwood <span style="color: var(--title-accent);">Partners</span>
                        </h1>
                        <p class="text-[10px] font-bold tracking-[0.4em] uppercase mt-1"
                            style="color: var(--text-accent); opacity: 0.7;">
                            Investment Memorandum
                        </p>
                    </div>

                    <div class="relative ml-6 border-l border-white/10 pl-4">
                        <button onclick="window.toggleUserList()"
                            class="bg-white/5 border border-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-300 hover:bg-[#630d0d] hover:text-white transition-all flex items-center gap-2">
                            <div
                                class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]">
                            </div>
                            Users <span id="user-online-count" class="text-white/40 ml-1">(0)</span>
                        </button>

                        <div id="user-presence-dropdown"
                            class="hidden absolute top-12 left-0 w-64 bg-slate-950 border border-white/10 rounded-2xl shadow-2xl p-4 z-[1000]">
                            <h3 class="text-[9px] font-black uppercase text-white/30 mb-3 tracking-widest">Active
                                Intelligence</h3>
                            <div id="user-presence-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" id="projectSearch" oninput="window.filterProjects()"
                            placeholder="Search Projects.."
                            class="search-hud text-[12px] font-bold uppercase tracking-widest bg-transparent border-none focus:ring-0"
                            style="color: var(--search-text);">
                        <div class="absolute right-4 top-3 animate-pulse text-red-500/50 text-[10px]">‚åñ</div>
                    </div>
                    <button onclick="window.createNewProject()" class="neo-btn" style="color: var(--button-text);">
                        <span class="mr-2">+</span> Initialize Draft
                    </button>
                    <button onclick="window.forceSync()"
                        class="bg-white/5 text-white/40 p-3 rounded-xl hover:bg-red-900/40 transition-all border border-white/5">üîÑ</button>
                    <button onclick="handleLogout()"
                        class="bg-white/10 text-white px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-red-600/80 transition">Logout</button>
                </div>
            </header>

            <div id="project-list" class="project-grid custom-scrollbar">
            </div>

            <footer class="hud-footer grid grid-cols-[auto_1fr_auto] items-center gap-6">
                <div class="flex items-center gap-4 min-w-[200px]">
                    <div class="status-glow"></div>
                    <div class="flex flex-col">
                        <span id="project-count" class="text-[10px] font-black uppercase tracking-widest"
                            style="color: var(--text-primary);">
                            Loading Records...
                        </span>
                        <span id="working-on" class="text-[9px] font-black uppercase tracking-widest">
                        </span>

                        <span class="text-[8px] uppercase font-bold" style="color: var(--text-accent);">
                            Secure Terminal Active</span>
                    </div>
                </div>


                <div class="flex items-center gap-4 flex-grow overflow-hidden">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-tighter italic">Archive
                        Directory:</span>
                    <input type="text" placeholder="Search Archive..." oninput="filterArchives()"
                        class="ml-3 bg-transparent border-b border-white/30 text-red-500 text-[10px] uppercase tracking-widest outline-none" />

                    <div id="project-trash" class="flex gap-3 overflow-x-auto custom-scrollbar pb-2">
                    </div>
                </div>

                <div class="flex items-center">
                    <button onclick="toggleTheme()" title="Toggle Day / Night"
                        class="ml-4 text-[16px] border border-white/20 rounded-full px-3 py-1 text-white hover:bg-white/10 transition">
                        üåó
                    </button>
                </div>

            </footer>
        </div>
    </div>

    <!-- MODULE HUB (Intermediate Dashboard) -->
<div id="module-hub" class="fixed inset-0 z-50 hidden" style="background: radial-gradient(circle at center, #1e293b, #020617);">
    
    <header class="absolute top-0 left-0 right-0 h-20 flex items-center justify-between px-8 border-b border-white/10 bg-slate-900/50 backdrop-blur-md z-20">
        <div class="flex items-center gap-4">
            <button onclick="exitToProjectList()" class="text-slate-400 hover:text-white transition">
                ‚Üê BACK
            </button>
            <div class="h-8 w-px bg-white/10"></div>
            <div>
                <h1 id="hub-project-name" class="text-xl font-black text-white tracking-tight uppercase">PROJECT NAME</h1>
                <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Command Center</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="openVersionModal('IM')" 
                class="flex items-center gap-2 bg-red-600/90 hover:bg-red-500 text-white px-5 py-2 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg shadow-red-900/20 transition-all border border-red-500/50">
                <span>+</span> Create IM
            </button>
            <button onclick="openVersionModal('FSA')" 
                class="flex items-center gap-2 bg-emerald-600/90 hover:bg-emerald-500 text-white px-5 py-2 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg shadow-emerald-900/20 transition-all border border-emerald-500/50">
                <span>+</span> Create FSA
            </button>
        </div>
    </header>

    <main class="absolute top-20 bottom-0 left-0 right-80 p-10 overflow-y-auto custom-scrollbar">
        
        <div class="mb-12">
            <h3 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> Investment Memos
            </h3>
            <div id="im-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-slate-600 text-sm italic p-4 border border-white/5 rounded-xl">No IMs created yet.</div>
            </div>
        </div>

        <div>
            <h3 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Financial Models
            </h3>
            <div id="fsa-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-slate-600 text-sm italic p-4 border border-white/5 rounded-xl">No FSAs created yet.</div>
            </div>
        </div>
    </main>

    <aside class="absolute top-20 bottom-0 right-0 w-80 border-l border-white/10 bg-black/20 backdrop-blur-sm flex flex-col">
        <div class="p-6 border-b border-white/5">
            <button onclick="toggleInsightsPanel()" 
                class="w-full py-4 bg-gradient-to-r from-purple-900 to-indigo-900 border border-purple-500/30 rounded-2xl text-white font-bold uppercase tracking-widest shadow-lg shadow-purple-900/20 hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                <span>‚ú®</span> AI Insights
            </button>
        </div>

        <div class="flex-grow p-6 overflow-y-auto">
            <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Recent Activity</h4>
            <div id="hub-activity-log" class="space-y-3">
                </div>
        </div>
    </aside>

    <div id="version-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl shadow-2xl w-[400px] text-center relative">
            <button onclick="closeVersionModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold text-white mb-2">New <span id="modal-type-label">Version</span></h2>
            <input type="text" id="version-name-input" placeholder="e.g. Seed Round V1" 
                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white mb-6 mt-4 focus:border-blue-500 outline-none">
            <button onclick="confirmCreateVersion()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all">
                Create & Launch
            </button>
        </div>
    </div>

</div>
<div id="ai-hub" class="fixed inset-0 z-[60] hidden bg-slate-900 text-white font-sans">
    
    <aside class="absolute top-0 bottom-0 left-0 w-64 bg-slate-950 border-r border-white/10 flex flex-col">
        <div class="h-16 flex items-center px-4 border-b border-white/10">
            <h2 class="font-bold tracking-widest uppercase text-xs text-blue-400">‚ö° Redwood AI</h2>
            <button onclick="closeAIHub()" class="ml-auto text-slate-500 hover:text-white">‚úï</button>
        </div>

        <div class="flex p-2 gap-1 bg-slate-900/50">
            <button onclick="switchAITab('history')" id="tab-history" class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-blue-600 text-white">History</button>
            <button onclick="switchAITab('notes')" id="tab-notes" class="flex-1 py-2 text-[10px] font-bold uppercase rounded hover:bg-white/5 text-slate-400">Notes</button>
        </div>

        <div id="ai-history-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
            <div class="text-slate-600 text-xs p-4 text-center italic">No history yet</div>
        </div>

        <div id="ai-notes-panel" class="hidden flex-1 flex flex-col p-2">
            <textarea id="ai-global-notes" class="w-full h-full bg-slate-900 border border-white/10 rounded-lg p-3 text-xs text-slate-300 resize-none focus:border-blue-500 outline-none" placeholder="Type your persistent notes here... (Auto-saves)"></textarea>
            <div id="note-save-status" class="text-[9px] text-emerald-500 text-right mt-1 h-3"></div>
        </div>

        <div class="p-4 border-t border-white/10 bg-slate-900/50">
            <div class="text-xs font-bold text-white truncate" id="ai-user-email">Guest User</div>
            <div class="text-[10px] text-slate-500">Unlimited Model Active</div>
        </div>
    </aside>

    <main class="absolute top-0 bottom-0 left-64 right-0 bg-gradient-to-br from-slate-900 to-slate-800 flex flex-col">
        
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-slate-900/50 backdrop-blur">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ú®</span>
                <div>
                    <h1 class="font-bold text-sm text-white">Research Assistant</h1>
                    <p class="text-[10px] text-slate-400">Powered by Pollinations (Unlimited)</p>
                </div>
            </div>
            <button onclick="startNewChat()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg border border-white/10 transition">
                + New Chat
            </button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth custom-scrollbar">
            <div class="flex gap-4 max-w-3xl mx-auto">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center shrink-0">ü§ñ</div>
                <div class="bg-white/5 border border-white/10 p-4 rounded-2xl rounded-tl-none text-sm text-slate-300 leading-relaxed shadow-lg">
                    Hello! I am your unlimited AI assistant. I can help you draft memos, analyze market data, or brainstorm strategy. <br><br>
                    What are we working on for <strong><span id="ai-project-ref">this project</span></strong> today?
                </div>
            </div>
        </div>

        <div class="p-6 bg-slate-900/80 backdrop-blur border-t border-white/5">
            <div class="max-w-3xl mx-auto relative">
                <textarea id="ai-input" onkeydown="handleAIEnter(event)" rows="1" 
                    class="w-full bg-slate-800 text-white text-sm rounded-xl pl-4 pr-12 py-3 border border-white/10 focus:border-blue-500 outline-none shadow-xl resize-none overflow-hidden" 
                    placeholder="Ask anything..."></textarea>
                
                <button onclick="sendAIMessage()" class="absolute right-2 top-2 p-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-white shadow-lg transition-transform hover:scale-105">
                    ‚û§
                </button>
            </div>
            <p class="text-center text-[10px] text-slate-600 mt-2">AI can make mistakes. Verify important info.</p>
        </div>
    </main>
</div>


    <div id="fsa-dashboard-overlay" class="hidden">
        <!-- MODULE HUB (Intermediate Dashboard) -->

        <div id="fsa-root">
            <div class="container" id="mainapp" style="display:block;">
                <div class="header">
                    <h1>üìä Financial Statement Analysis Tool</h1>
                    <p>Comprehensive Financial Analysis with Multi-Year Data Entry</p>
                </div>

                <div class="company-type-selector">
                    <div class="company-info-row">
                        <label for="companyName">Company Name:</label>
                        <input type="text" id="companyName" placeholder="Enter company name"
                            onchange="updateCompanyName(this.value)">
                    </div>
                    <div class="company-info-row">
                        <div>
                            <label for="companyType">Company Type:</label>
                            <select id="companyType" onchange="changeCompanyType()">
                                <option value="private_limited">Private Limited Company</option>
                                <option value="partnership">Partnership Firm</option>
                                <option value="llp">Limited Liability Partnership (LLP)</option>
                                <option value="proprietorship">Proprietorship</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="saveToLocalStorage()">üíæ Save Now</button>
                            <button class="action-btn" id="attachmentsToggleBtn" onclick="toggleAttachments()">üìé
                                Attachments</button>
                            <button class="action-btn" onclick="exportDataAsJSON()">üì• Export JSON</button>
                            <button class="action-btn" onclick="importDataFromJSON()">üì§ Import JSON</button>
                            <button class="action-btn" onclick="showFSAHistory()">üìú History</button>

                            <button class="action-btn" style="background: #dc3545;"
                                onclick="window.clearAllFSAData()">üóëÔ∏è Clear My Data</button>
                            <div class="last-saved" id="lastSavedIndicator">
                                <span>üïí Auto-save: ON</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('input')">Data Entry</button>
                    <button class="tab" onclick="switchTab('analysis')">Analysis & Reports</button>
                </div>

                <div class="content">
                    <!-- DATA ENTRY TAB -->
                    <div id="input" class="tab-content active">
                        <div class="multi-year-toggle">
                            <label>
                                <input type="checkbox" id="multiYearMode" onchange="toggleMultiYearMode(this.checked)">
                                <span><strong>üìä Multi-Year Entry Mode:</strong> Enable to enter data for multiple years
                                    simultaneously (select 2-4 years from FY 2025-26 to FY 2016-17)</span>
                            </label>
                            <div id="yearColumnsSelector" style="display: none; margin-top: 10px;">
                                <div style="margin-bottom: 10px; color: #495057;">Select years to display:</div>
                                <div class="year-columns-selector" id="yearColumnsList"></div>
                            </div>
                        </div>

                        <div class="year-selector" id="yearSelector" style="display: flex;"></div>

                        <!-- ADD YEARS SECTION -->
                        <div
                            style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                            <button class="action-btn" onclick="addYearBefore()" style="background: #20c997;">‚Üê Add Year
                                Before</button>
                            <button class="action-btn" onclick="addYearAfter()" style="background: #20c997;">Add Year
                                After ‚Üí</button>
                            <button class="action-btn" onclick="openYearManager()" style="background: #fd7e14;">üìÖ
                                Manage Years</button>
                            <span id="yearRangeDisplay" style="color: #6c757d; font-weight: 600;">FY 2023-24 to FY
                                2024-25</span>
                        </div>

                        <!-- CUSTOM INSIGHTS (Always Visible at Top) -->
                        <div id="insightsSection" class="insights-section">
                            <h3>üí° Custom Insights & Overall Analysis</h3>
                            <p style="font-size: 13px; margin-bottom: 10px; color: #0c5460;">Add your key observations,
                                recommendations, trends analysis, and overall findings here.</p>
                            <textarea id="customInsights" class="notes-textarea"
                                placeholder="Example: Strong revenue growth of 25% YoY driven by new product launches. Operating margins improved due to cost optimization. Recommend increasing R&D investment..."
                                onchange="saveInsights()"></textarea>
                        </div>

                        <!-- ATTACHMENTS SECTION -->
                        <div class="attachments-section" id="attachmentsSection" style="display: none;">
                            <div class="attachments-header">
                                <h3>üìé Financial Statement Attachments</h3>
                                <input type="file" id="fileInput" multiple style="display: none;"
                                    onchange="handleFileUpload(event)">
                                <button class="action-btn" onclick="document.getElementById('fileInput').click()">+
                                    Upload Files</button>
                            </div>
                            <div id="attachmentsList"></div>
                        </div>

                        <!-- YEAR NOTES & INSIGHTS -->
                        <div id="yearNotesSection"></div>

                        <!-- BALANCE SHEET SECTION -->
                        <div class="section">
                            <div class="section-header">BALANCE SHEET - ASSETS</div>
                            <div class="section-body">
                                <div class="section-main-header">üìä NON-CURRENT ASSETS</div>

                                <div class="section-sub-header">Fixed Assets / Tangible Assets (Gross Block)</div>
                                <div id="fixedAssetsTangible"></div>

                                <div id="cumulativeDepreciationContainer" style="margin: 20px 0;">
                                    <div class="input-group">
                                        <label style="color: #dc3545;">Less: Cumulative Depreciation</label>
                                        <input type="number" id="cumulativeDepreciation" value="0"
                                            onchange="updateCumulativeDepreciation(this.value)"
                                            placeholder="Enter cumulative depreciation">
                                        <div></div>
                                    </div>
                                </div>

                                <div class="section-sub-header">Intangible Assets (Gross Block)</div>
                                <div id="intangibleAssets"></div>

                                <div id="cumulativeAmortizationContainer" style="margin: 20px 0;">
                                    <div class="input-group">
                                        <label style="color: #dc3545;">Less: Cumulative Amortization</label>
                                        <input type="number" id="cumulativeAmortization" value="0"
                                            onchange="updateCumulativeAmortization(this.value)"
                                            placeholder="Enter cumulative amortization">
                                        <div></div>
                                    </div>
                                </div>

                                <div class="section-sub-header">Other Non-Current Assets</div>
                                <div id="otherNonCurrentAssets"></div>

                                <div class="section-divider"></div>
                                <div class="section-main-header">üí∞ CURRENT ASSETS</div>
                                <div id="currentAssets"></div>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-header">BALANCE SHEET - LIABILITIES & EQUITY</div>
                            <div class="section-body">
                                <div class="section-main-header">üë• SHAREHOLDERS' EQUITY</div>
                                <div id="equitySection"></div>

                                <div class="section-divider"></div>
                                <div class="section-main-header">üìã NON-CURRENT LIABILITIES</div>
                                <div id="nonCurrentLiabilities"></div>

                                <div class="section-divider"></div>
                                <div class="section-main-header">‚ö° CURRENT LIABILITIES</div>
                                <div id="currentLiabilities"></div>
                            </div>
                        </div>

                        <!-- PROFIT & LOSS SECTION -->
                        <div class="section">
                            <div class="section-header">PROFIT & LOSS STATEMENT</div>
                            <div class="section-body">
                                <div class="section-main-header">üíµ INCOME</div>
                                <div class="section-sub-header">Revenue from Operations</div>
                                <div id="revenue"></div>

                                <div class="section-sub-header">Other Income</div>
                                <div id="otherIncome"></div>

                                <div class="section-divider"></div>
                                <div class="section-main-header">üìâ EXPENSES</div>

                                <div class="section-sub-header">Direct Expenses</div>
                                <div id="directExpenses"></div>

                                <div class="section-sub-header">Indirect Expenses</div>
                                <div id="indirectExpenses"></div>

                                <div class="section-sub-header">Finance Costs</div>
                                <div id="financeCosts"></div>

                                <div class="section-sub-header">Depreciation & Amortization</div>
                                <div id="depreciation"></div>

                                <div class="section-sub-header">Tax Expenses</div>
                                <div
                                    style="background: #d1ecf1; padding: 10px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
                                    <strong style="color: #0c5460;">üí° Note:</strong>
                                    <span style="color: #0c5460; font-size: 14px;">
                                        For <strong>Deferred Tax Income</strong> (benefit), enter as <strong>negative
                                            value</strong> (e.g., -5000).
                                        For <strong>Deferred Tax Expense</strong>, enter as <strong>positive
                                            value</strong> (e.g., 5000).
                                        Total Tax = Current Tax + Deferred Tax (automatically calculated).
                                    </span>
                                </div>
                                <div id="taxExpenses"></div>
                            </div>
                        </div>

                        <button class="analyze-btn"
                            onclick="try{window.generateAnalysis()}catch(e){alert('Error: '+e.message)}">üîç Generate
                            Analysis & Reports</button>
                    </div>

                    <!-- ANALYSIS TAB -->
                    <div id="analysis" class="tab-content">
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Reports</button>


                        <!-- Standard Analysis Reports -->
                        <div id="analysisContent"></div>
                    </div>
                </div>
            </div>
            <div id="historyModal" class="histmodal">
                <div class="histbox">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#8b1a1a;margin:0;">üìú Change History</h2>
                        <button onclick="closeHistory()" class="cloudbtn2">Close</button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- Year Manager Modal -->
            <div id="yearManagerModal">
                <div class="year-manager-box">
                    <h2>üìÖ Manage Years</h2>
                    <div class="year-manager-buttons">
                        <button onclick="addYearBefore()" class="year-manager-btn year-manager-btn-primary">‚ûï Add
                            Before</button>
                        <button onclick="addYearAfter()" class="year-manager-btn year-manager-btn-primary">‚ûï Add
                            After</button>
                        <button onclick="addMultipleYears()" class="year-manager-btn year-manager-btn-primary">‚è´ Add
                            Multiple</button>
                        <button onclick="closeYearManager()"
                            class="year-manager-btn year-manager-btn-secondary">Close</button>
                    </div>
                    <div id="yearsList"></div>
                </div>
            </div>
            <!-- FSA History Modal -->
            <div id="fsaHistoryModal" class="histmodal">
                <div class="histbox">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#8b1a1a;margin:0;">üìú FSA Change History</h2>
                        <button onclick="closeFSAHistory()" class="cloudbtn2">Close</button>
                    </div>
                    <div id="fsaHistoryList"></div>
                </div>
            </div>
        </div><button onclick="closeFSA()"
            class="fixed top-4 left-4 z-[10000] bg-white text-black px-4 py-2 rounded-xl font-bold uppercase shadow-xl hover:bg-slate-200 transaction-all">‚Üê
            Back to Hub</button>
    </div>

    <!-- AI Summary Modal -->
    <div id="ai-summary-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center"
        style="background: rgba(0,0,0,0.9);">
        <div
            class="bg-slate-900 rounded-3xl shadow-2xl max-w-5xl w-full mx-8 max-h-[90vh] overflow-y-auto border-4 border-purple-500">

            <!-- Modal Header -->
            <div
                class="sticky top-0 bg-gradient-to-r from-purple-900 to-indigo-900 p-6 border-b-4 border-purple-500 flex justify-between items-center">
                <h2 class="text-3xl font-black text-white">ü§ñ AI-GENERATED INSIGHTS</h2>
                <button onclick="closeAIModal()"
                    class="text-white text-3xl hover:text-red-400 transition">&times;</button>
            </div>

            <!-- Loading State -->
            <div id="ai-loading" class="p-20 text-center">
                <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-purple-500 mx-auto mb-6"></div>
                <p class="text-white text-xl font-bold">Generating AI Summary...</p>
            </div>

            <!-- Content Container -->
            <div id="ai-content" class="hidden p-8 space-y-8 text-white">
                <!-- IM Summary Section -->
                <div class="bg-red-900/30 p-6 rounded-2xl border-2 border-red-500">
                    <h3 class="text-2xl font-black text-red-400 mb-4 uppercase tracking-wide">üìä IM Executive Summary
                    </h3>
                    <div id="ai-im-summary" class="text-slate-200 leading-relaxed whitespace-pre-wrap"></div>
                </div>

                <!-- FSA Insights Section -->
                <div class="bg-red-900/30 p-6 rounded-2xl border-2 border-red-500">
                    <h3 class="text-2xl font-black text-red-400 mb-4 uppercase tracking-wide">üí∞ FSA Key Insights</h3>
                    <div id="ai-fsa-summary" class="text-slate-200 leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>

        </div>
    </div>

<aside id="main-sidebar" class="w-72 bg-[#630d0d] text-white flex flex-col shadow-2xl no-print hidden h-screen overflow-y-auto">
        <div class="p-8 border-b border-white/10 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter">REDWOOD</h1>
            <button onclick="backToHub()"
                class="text-[9px] bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20 transition font-bold uppercase border border-white/10 tracking-widest text-white">
                Back to Hub
            </button>
        </div>
        <div class="p-6 bg-black/10 border-b border-white/5 text-center">
            <p id="active-project-name"
                class="text-sm font-bold text-white truncate italic mt-1 uppercase tracking-tighter"></p>
        </div>
        <div class="px-4 py-6">
    <button onclick="window.commitNewVersion()" 
        class="w-full py-3 mb-6 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] font-black uppercase tracking-[0.2em] rounded-xl transition-all shadow-[0_0_20px_rgba(239,68,68,0.1)] hover:shadow-[0_0_30px_rgba(239,68,68,0.2)]">
        + Commit New Version
    </button>
        <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
            <button onclick="showSection('sec1')" id="nav-sec1"
                class="w-full text-left p-3 rounded active-link transition text-xs uppercase font-bold tracking-tight text-white">1.
                Executive Summary</button>

            <div class="mt-6border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub2')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>2. Opportunity Analysis</span>
                    <svg id="icon-sub2" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub2" class="hidden pl-4 mt-2 space-y-1 border-l border-white/10 ml-2">
                    <button onclick="showSection('founding')" id="nav-founding"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">Founding
                        Team</button>
                    <button onclick="showSection('market')" id="nav-market"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">Market</button>
                    <button onclick="showSection('innovation')" id="nav-innovation"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">Innovation</button>
                    <button onclick="showSection('sustainability')" id="nav-sustainability"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">Sustainability</button>
                    <button onclick="showSection('rationale')" id="nav-rationale"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400 underline">2.1
                        Investment Rationale</button>
                </div>
            </div>

            <button onclick="showSection('journey')" id="nav-journey"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-6 border-t border-white/5 pt-6 text-white">
                3. Applicant's Journey
            </button>

            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-biz')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>4. Business Overview</span>
                    <svg id="icon-sub-biz" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-biz" class="hidden pl-4 mt-2 space-y-1 border-l border-white/10 ml-2">
                    <button onclick="showSection('biz41')" id="nav-biz41"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.1
                        Problem Statement</button>
                    <button onclick="showSection('biz42')" id="nav-biz42"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.2
                        Current Stage</button>
                    <button onclick="showSection('biz43')" id="nav-biz43"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.3
                        Other Lines</button>
                    <button onclick="showSection('biz44')" id="nav-biz44"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.4
                        Solution Overview</button>
                    <button onclick="showSection('biz45')" id="nav-biz45"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.5
                        SME Validation</button>
                    <button onclick="showSection('biz46')" id="nav-biz46"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.6
                        Customer Profile</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-fin')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>5. Financial Overview</span>
                    <svg id="icon-sub-fin" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-fin" class="hidden pl-4 space-y-1 border-l border-white/10 ml-2 mt-2">
                    <button onclick="showSection('fin51')" id="nav-fin51"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">5.1
                        Funds Raised</button>
                    <button onclick="showSection('fin52')" id="nav-fin52"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">5.2
                        Statement Insights</button>
                    <button onclick="showSection('fin53')" id="nav-fin53"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">5.3
                        Key Metrics</button>
                    <button onclick="showSection('fin54')" id="nav-fin54"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">5.4
                        Revenue Projections</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-mkt')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>6. Market & Industry Analysis</span>
                    <svg id="icon-sub-mkt" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-mkt" class="hidden pl-4 space-y-1 border-l border-white/10 ml-2 mt-2">
                    <button onclick="showSection('mkt61')" id="nav-mkt61"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.1
                        Indian Overview</button>
                    <button onclick="showSection('mkt62')" id="nav-mkt62"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.2
                        Global Overview</button>
                    <button onclick="showSection('mkt63')" id="nav-mkt63"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.3
                        TAM SAM SOM</button>
                    <button onclick="showSection('mkt64')" id="nav-mkt64"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.4
                        Regulatory Impact</button>
                    <button onclick="showSection('mkt65')" id="nav-mkt65"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.5
                        Competition</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-strat')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>7. Strategic Positioning</span>
                    <svg id="icon-sub-strat" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-strat" class="hidden pl-4 space-y-1 border-l border-white/10 ml-2 mt-2">
                    <button onclick="showSection('strat71')" id="nav-strat71"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">7.1
                        Competitive Advantage</button>
                    <button onclick="showSection('strat72')" id="nav-strat72"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">7.2
                        SWOT Analysis</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-gov')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>8. Management & Governance</span>
                    <svg id="icon-sub-gov" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-gov" class="hidden pl-4 space-y-1 border-l border-white/10 ml-2 mt-2">
                    <button onclick="showSection('gov81')" id="nav-gov81"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">8.1
                        Community Certificate</button>
                    <button onclick="showSection('gov82')" id="nav-gov82"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">8.2
                        Founding Team</button>
                    <button onclick="showSection('gov83')" id="nav-gov83"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">8.3
                        Cap Table</button>
                    <button onclick="showSection('gov84')" id="nav-gov84"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">8.4
                        Employees</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-risk')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>9. Risk Analysis</span>
                    <svg id="icon-sub-risk" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-risk" class="hidden pl-4 space-y-1 border-l border-white/10 ml-2 mt-2">
                    <button onclick="showSection('risk91')" id="nav-risk91"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">9.1
                        Market Risk</button>
                    <button onclick="showSection('risk92')" id="nav-risk92"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">9.2
                        Operational Risk</button>
                    <button onclick="showSection('risk93')" id="nav-risk93"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">9.3
                        Financial Risk</button>
                    <button onclick="showSection('risk94')" id="nav-risk94"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">9.4
                        Regulatory Risk</button>
                    <button onclick="showSection('risk95')" id="nav-risk95"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">9.5
                        External Risks</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub10')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>10. Transaction Details</span>
                    <svg id="icon-sub10" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub10" class="hidden pl-4 mt-2 space-y-1 border-l border-white/10 ml-2">
                    <button onclick="showSection('trans101')" id="nav-trans101"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">10.1
                        Fund Utilization</button>
                    <button onclick="showSection('trans102')" id="nav-trans102"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">10.2
                        Exit Mechanism</button>
                    <button onclick="showSection('trans103')" id="nav-trans103"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">10.3
                        Recommendation</button>
                </div>
            </div>
            <div class="mt-6 border-t border-white/5 pt-6">
                <button onclick="toggleSubmenu('sub-annex1')"
                    class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
                    <span>Annexure 1: Domain Research</span>
                    <svg id="icon-sub-annex1" class="w-3 h-3 transition-transform duration-200" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div id="sub-annex1" class="hidden pl-4 mt-2 space-y-1 border-l border-white/10 ml-2">
                    <button onclick="showSection('ax1_1')" id="nav-ax1_1"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">1.
                        Introduction</button>
                    <button onclick="showSection('ax1_2')" id="nav-ax1_2"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">2.
                        Problem Addressed</button>
                    <button onclick="showSection('ax1_3')" id="nav-ax1_3"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">3.
                        Need for Solution</button>
                    <button onclick="showSection('ax1_4')" id="nav-ax1_4"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">4.
                        Market Overview</button>
                    <button onclick="showSection('ax1_5')" id="nav-ax1_5"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">5.
                        Competition</button>
                    <button onclick="showSection('ax1_6')" id="nav-ax1_6"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">6.
                        Market Limiter</button>
                    <button onclick="showSection('ax1_7')" id="nav-ax1_7"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">7.
                        Conclusion</button>
                    <button onclick="showSection('ax1_8')" id="nav-ax1_8"
                        class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">8.
                        Reference Links</button>
                </div>
            </div>
            <button onclick="showSection('ax2')" id="nav-ax2"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 2: Patents & Certifications
            </button>

            <button onclick="showSection('ax3')" id="nav-ax3"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 3: Site Visit Details
            </button>
            <button onclick="showSection('ax4')" id="nav-ax4"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 4: Founding Team Background
            </button>
            <button onclick="showSection('ax5')" id="nav-ax5"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 5: Community Certificate
            </button>
            <button onclick="showSection('ax6')" id="nav-ax6"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 6: Customer Testimonials
            </button>
            <button onclick="showSection('ax7')" id="nav-ax7"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 7: Client Logos
            </button>
            <button onclick="showSection('ax8')" id="nav-ax8"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 8: Letter of Intent
            </button>
            <button onclick="showSection('ax9')" id="nav-ax9"
                class="w-full text-left p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight mt-2 text-white">
                Annexure 9: Capex Quotations
            </button>
<div class="mt-6 border-t border-white/5 pt-6">
    <button onclick="document.getElementById('sub-annex10').classList.toggle('hidden')" 
        class="w-full flex items-center justify-between p-3 rounded hover:bg-white/10 transition text-xs uppercase font-bold tracking-tight text-white">
        <span>Annexure 10: Financial & Reg</span>
        <span class="text-[10px] opacity-50">‚ñº</span>
    </button>
    
    <div id="sub-annex10" class="hidden pl-4 mt-2 space-y-1 border-l border-white/10 ml-2">
        <button onclick="showSection('ax10_guide')" id="nav-ax10_guide"
            class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-amber-500">
            ‚ö†Ô∏è User Guide
        </button>
        <button onclick="showSection('ax10_1')" id="nav-ax10_1"
    class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">
    10.1 Registrations
</button>

<button onclick="showSection('ax10_2'); setTimeout(window.refreshRegulatorySection, 100)" id="nav-ax10_2"
    class="w-full text-left p-2 rounded hover:bg-white/10 transition text-[10px] uppercase font-bold tracking-tight text-slate-400">
    10.2 Regulatory Info
</button>
    </div>
</div>

        </nav>

        <h3 class="text-[9px] uppercase font-extrabold text-white/40 mb-4 tracking-[0.2em]">Live Collaborators</h3>
        <div id="user-presence-list" class="space-y-3">
        </div>
        </div>
    </aside>

<main id="main-content" class="flex-grow flex flex-col overflow-clip hidden">

    <div class="bg-white px-10 py-5 border-b flex justify-between items-center no-print shadow-sm relative z-50">
            <div class="flex items-center gap-3">
                <div id="save-status-dot"
                    class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]"></div><span
                    id="save-status-text"
                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic tracking-tighter">Encrypted
                    Memorandum Sync Active</span>
            </div>
            <div class="flex gap-3">
                <button onclick="exportJSON()"
                    class="bg-slate-50 text-slate-500 px-4 py-2 rounded-xl text-[10px] font-bold border hover:bg-slate-100 transition uppercase">Backup
                    JSON</button>
                <button onclick="exportPDF()"
                    class="bg-[#630d0d] text-white px-5 py-2 rounded-xl text-[10px] font-bold hover:bg-[#4a0404] shadow-lg uppercase transition-all transform hover:scale-105">Export
                    HD PDF</button>
                <button onclick="exportWord()"
                    class="bg-blue-700 text-white px-5 py-2 rounded-xl text-[10px] font-bold hover:bg-blue-800 shadow-lg uppercase transition-all transform hover:scale-105">Export
                    Word</button>
                <button onclick="toggleComments()"
                    class="bg-white text-slate-600 px-4 py-2 rounded-xl text-[10px] font-bold border hover:bg-slate-50 transition uppercase shadow-sm">üí¨
                    View Threads</button>
                <button onclick="toggleAudit()"
                    class="bg-white text-slate-600 px-4 py-2 rounded-xl text-[10px] font-bold border hover:bg-slate-50 transition uppercase shadow-sm">üïí
                    History</button>
            </div>
        </div>
        <div id="content-parent" class="p-12 overflow-y-auto bg-slate-50 flex-grow" oninput="autoSave(event)">

            <div id="section-sec1"
                class="bg-white shadow-2xl rounded-[3rem] p-14 max-w-4xl mx-auto border border-slate-200 mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    1. Executive Summary & Highlights
                </h2>

                <div class="overflow-hidden rounded-3xl border border-slate-300 shadow-sm bg-white">
                    <table class="w-full border-collapse text-sm text-slate-800">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th
                                    class="p-5 w-16 text-center border-r border-slate-700 font-bold uppercase text-[9px] tracking-widest">
                                    #</th>
                                <th
                                    class="p-5 text-left w-1/3 border-r border-slate-700 font-extrabold uppercase text-[9px] tracking-widest">
                                    Section</th>
                                <th class="p-5 text-left font-extrabold uppercase text-[9px] tracking-widest">
                                    Particulars</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-300">

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    1</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Company Brand</td>
                                <td class="p-5">
                                    <input type="text" id="brand" placeholder="Mention the name of the product line"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] bg-slate-50/30 rounded-lg outline-none transition-all text-slate-800 font-bold placeholder:text-slate-300">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    2</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Registered Name</td>
                                <td class="p-5">
                                    <input type="text" id="reg_name"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] bg-slate-50/30 rounded-lg outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    3</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Nature of the Company
                                </td>
                                <td class="p-5">
                                    <select id="nature"
                                        class="w-full p-2 bg-transparent border-none outline-none text-slate-800 font-bold cursor-pointer hover:text-[#630d0d] transition-colors">
                                        <option>Private Limited</option>
                                        <option>LLP</option>
                                        <option>OPC</option>
                                        <option>Partnership</option>
                                        <option>Proprietorship</option>
                                    </select>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    4</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300 text-sm">Address</td>
                                <td class="p-5 space-y-4">
                                    <textarea id="reg_address" placeholder="Registered Address"
                                        class="w-full p-4 bg-slate-50 rounded-2xl h-24 outline-none border border-slate-100 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] text-slate-800 font-bold shadow-inner"></textarea>
                                    <textarea id="comm_address" placeholder="Communication Address"
                                        class="w-full p-4 bg-slate-50 rounded-2xl h-24 outline-none border border-slate-100 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] text-slate-800 font-bold shadow-inner"></textarea>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    5</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Email</td>
                                <td class="p-5">
                                    <input type="email" id="email" placeholder="Mention the name of the SPOC Email ID"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    6</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Phone Number</td>
                                <td class="p-5">
                                    <input type="tel" id="phone" placeholder="Mention the name of the SPOC Phone Number"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    7</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Company Website</td>
                                <td class="p-5">
                                    <input type="url" id="website"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    8</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Name of the
                                    Promoters/Founders</td>
                                <td class="p-5">
                                    <input type="text" id="promoters"
                                        placeholder="Mention the community certificate holder in bracket"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    9</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Date of Incorporation
                                </td>
                                <td class="p-5">
                                    <input type="text" id="Dateofincorporation"
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    10</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Business Summary</td>
                                <td class="p-5">
                                    <textarea id="summary" placeholder="Summarize the businesses core model..."
                                        class="w-full p-4 bg-slate-50 rounded-2xl h-32 outline-none border border-slate-100 focus:border-[#630d0d] text-slate-800 font-bold shadow-inner"></textarea>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    11</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Business Model</td>
                                <td class="p-5">
                                    <input type="text" id="Business_model"
                                        placeholder="Differentiate business models..."
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    12</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Business Type</td>
                                <td class="p-5">
                                    <select id="Type"
                                        class="w-full p-2 bg-transparent border-none outline-none text-slate-800 font-bold">
                                        <option>Product</option>
                                        <option>Service</option>
                                        <option>Both</option>
                                    </select>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    13</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Company Stage</td>
                                <td class="p-5 space-y-2">
                                    <select id="Company_stage" onchange="checkStage(this)"
                                        class="w-full p-2 bg-transparent border-none outline-none text-slate-800 font-bold">
                                        <option value="Idea">Idea</option>
                                        <option value="Prototype">Prototype</option>
                                        <option value="MVP">MVP</option>
                                        <option value="Revenue">Revenue</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="text" id="custom_stage" placeholder="Type your custom stage here..."
                                        class="hidden w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl outline-none shadow-inner text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    14</td>
                                <td
                                    class="p-5 font-bold text-slate-700 border-r border-slate-300 text-sm leading-tight">
                                    Seeking Investment for</td>
                                <td class="p-5">
                                    <input type="text" id="Seeking_investment_for" placeholder="Specify the purpose..."
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    15</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Investment Rationale
                                </td>
                                <td class="p-5">
                                    <input type="text" id="Investment_rationale"
                                        placeholder="Refer to 2.1 investment rationale..."
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    16</td>
                                <td
                                    class="p-5 font-bold text-slate-700 border-r border-slate-300 text-xs leading-tight">
                                    Whether the promoters hold any stake abroad?</td>
                                <td class="p-5">
                                    <input type="text" id="Stake_abroad" placeholder="Clarify promoter interest..."
                                        class="w-full p-2 border-b-2 border-transparent focus:border-[#630d0d] outline-none text-slate-800 font-bold">
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    17</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Current Fund Raise (‚Çπ
                                    Cr)</td>
                                <td class="p-5 space-y-4">
                                    <div class="flex items-center justify-between border-b border-slate-200 pb-2">
                                        <span
                                            class="text-xs text-slate-500 font-bold uppercase italic tracking-tighter">New
                                            Investors:</span>
                                        <input type="text" id="new_investors" placeholder="TANSIM"
                                            class="w-1/2 p-2 bg-transparent border-none focus:ring-1 focus:ring-[#630d0d] rounded-xl text-right font-bold text-slate-800">
                                    </div>
                                    <div class="flex items-center justify-between border-b border-slate-200 pb-2">
                                        <span
                                            class="text-xs text-slate-500 font-bold uppercase italic tracking-tighter">Existing
                                            Investors:</span>
                                        <input type="text" id="existing_investors" placeholder="NA"
                                            class="w-1/2 p-2 bg-transparent border-none focus:ring-1 focus:ring-[#630d0d] rounded-xl text-right font-bold text-slate-800">
                                    </div>
                                    <div class="pt-2">
                                        <span
                                            class="text-xs font-extrabold text-slate-800 uppercase block mb-1">Recommended
                                            Investment:</span>
                                        <input type="text" id="rec_investment" placeholder="Format: ‚Çπ2 Crores..."
                                            class="w-full p-3 bg-slate-50 border-none rounded-2xl italic text-xs text-[#630d0d] font-extrabold outline-none shadow-inner">
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500">
                                    18</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Tranches</td>
                                <td class="p-5">
                                    <div id="tranche_container" class="space-y-4">
                                        <div class="flex gap-4 items-center bg-slate-50/50 p-2 rounded-xl"
                                            id="tranche_1">
                                            <span
                                                class="font-extrabold text-[9px] w-24 uppercase text-slate-400 tracking-tighter">Tranche
                                                1</span>
                                            <input type="text" id="t1"
                                                class="flex-grow p-2 bg-transparent border-none rounded-xl text-xs text-slate-800 outline-none font-bold"
                                                placeholder="Funding requirements...">
                                            <button onclick="removeElement('tranche_1')"
                                                class="text-red-300 hover:text-red-600 transition px-2 font-bold">‚úï</button>
                                        </div>
                                    </div>
                                    <button onclick="addTranche()"
                                        class="mt-5 text-[10px] font-extrabold text-[#630d0d] border-2 border-[#630d0d]/20 px-5 py-2 rounded-xl hover:bg-[#630d0d] hover:text-white transition-all uppercase tracking-widest">+
                                        Add Tranche</button>
                                </td>
                            </tr>

                            <tr>
                                <td
                                    class="p-5 text-center bg-slate-50/80 border-r border-slate-300 font-black text-slate-500 text-sm">
                                    19</td>
                                <td class="p-5 font-bold text-slate-700 border-r border-slate-300">Milestones</td>
                                <td class="p-5">
                                    <div id="milestone_container" class="space-y-4">
                                        <div class="flex gap-4 items-center bg-slate-50/50 p-2 rounded-xl" id="ms_2">
                                            <span
                                                class="font-extrabold text-[9px] w-48 uppercase text-blue-500 tracking-tighter">Milestones
                                                Tranche 2</span>
                                            <input type="text" id="m2"
                                                class="flex-grow p-2 bg-transparent border-none rounded-xl text-xs text-slate-800 outline-none font-bold"
                                                placeholder="Target objectives...">
                                            <button onclick="removeElement('ms_2')"
                                                class="text-red-300 hover:text-red-600 transition px-2 font-bold">‚úï</button>
                                        </div>
                                    </div>
                                    <button onclick="addMilestone()"
                                        class="mt-5 text-[10px] font-extrabold text-blue-600 border-2 border-blue-600/20 px-5 py-2 rounded-xl hover:bg-blue-600 hover:text-white transition-all uppercase tracking-widest">+
                                        Add Milestone</button>
                                </td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>

            <div id="section-founding" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    Founding Team
                </h2>
                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="p-8 border-b border-slate-300">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Strength of Background / Experience
                        </label>
                        <textarea id="founding_team_strength" placeholder="Type I will edit later..."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                    </div>
                    <div class="p-8">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Skill-Gap Analysis
                        </label>
                        <textarea id="founding_team_gap" placeholder="Type I will edit later..."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-40 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-market" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    Market Need
                </h2>
                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="p-8 border-b border-slate-300">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Problem & Audience Analysis
                        </label>
                        <textarea id="market_need_def" placeholder="Type I will edit later..."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                    </div>
                    <div class="p-8 border-b border-slate-300">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Market Size
                        </label>
                        <input type="text" id="market_size_ref" placeholder="Type I will edit later..."
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all">
                    </div>
                    <div class="p-8">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Market Levers
                        </label>
                        <input type="text" id="market_levers" placeholder="Type I will edit later..."
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all">
                    </div>
                </div>
            </div>

            <div id="section-innovation" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    Innovation / Scalability
                </h2>
                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="p-8">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            Innovation & Scalability Evaluation
                        </label>
                        <textarea id="innovation_eval" placeholder="Type I will edit later..."
                            class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-[30rem] focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-sustainability" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    Sustainability / ESG Impact
                </h2>
                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="p-8">
                        <label
                            class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                            ESG Impact & Sustainability Goals
                        </label>
                        <textarea id="esg_impact" placeholder="Type I will edit later..."
                            class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-[30rem] focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-rationale" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    2.1 Final Investment Rationale
                </h2>
                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-4">
                            <label
                                class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] underline decoration-[#630d0d]/20">
                                Internal Strategy Document
                            </label>
                            <span
                                class="text-[9px] font-black text-[#630d0d] uppercase tracking-widest opacity-40 italic">Confidential</span>
                        </div>
                        <textarea id="final_rationale" placeholder="Type I will edit later..."
                            class="w-full p-10 bg-slate-50 border border-slate-200 rounded-[2.5rem] h-[40rem] focus:ring-4 focus:ring-[#630d0d]/10 outline-none text-slate-900 font-medium text-base leading-relaxed shadow-inner transition-all"></textarea>
                    </div>
                </div>
            </div>
            <div id="section-journey" class="max-w-4xl mx-auto space-y-6 hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    3. Applicant‚Äôs Journey in this Program
                </h2>

                <div class="bg-white overflow-hidden rounded-[2.5rem] shadow-2xl border border-slate-300">
                    <div class="flex">


                        <div class="flex-grow p-8">
                            <label
                                class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                                Process Workflow & Selection Logic
                            </label>
                            <textarea id="journey_main"
                                placeholder="Type I will edit later... (Outline the step-by-step process an applicant undergoes in this program, from application submission to final selection, including key milestones, evaluations, and support provided at each stage)"
                                class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-[500px] focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold leading-relaxed shadow-inner transition-all"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div id="section-biz41" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.1. Problem Statement / Opportunity
                </h2>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 overflow-hidden">
                    <div class="p-10 space-y-8">
                        <textarea id="biz_41_text1" placeholder="Write about the problem in 1 to 2 lines"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>

                        <div>
                            <label
                                class="block text-[10px] font-extrabold text-slate-900 uppercase tracking-[0.2em] mb-4 underline decoration-[#630d0d]/20">
                                Background to the Problem:
                            </label>
                            <textarea id="biz_41_text2" placeholder="Provide context for the problem being addressed..."
                                class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-44 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-biz42" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.2. Current Stage of Solution/Idea</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <textarea id="biz_42_main"
                        placeholder="(Assess and define the current stage of the solution/idea by outlining its development progress, market validation, and technological readiness. Write one or two lines about the current stage, if MVP then speak abt MVP details here, and cover POC in the next section. Cover details of the process in the Solution Overview Section)"
                        class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-40 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">4.2.1. Proof
                                of Concept</label>
                            <textarea id="biz_421"
                                placeholder="Demonstrate the feasibility of the product or service through initial testing or prototypes, showcasing its viability in solving the identified problem"
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">4.2.2 Customer
                                Validation</label>
                            <textarea id="biz_422"
                                placeholder="Briefly describe the surveys, interviews, or trials conducted to gather feedback from potential customers, highlighting key insights into their needs, preferences, and overall response."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">4.2.3. Market
                                Validation</label>
                            <textarea id="biz_423"
                                placeholder="Demonstrate market interest and demand through metrics like, customer growth, partnerships, or industry endorsements, validating the product's ability to scale in the market."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2 underline decoration-[#630d0d]/20">Solution
                                highlights/Current Traction</label>
                            <textarea id="biz_42_traction"
                                placeholder="Outline the key features and benefits of the solution, emphasizing its unique value proposition. Highlight current traction by showcasing metrics such as , revenue growth, partnerships, or any significant milestones achieved."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl h-40 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-biz43" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.3. Other Current Lines of Business</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="biz_43_others"
                        placeholder="Describe any additional lines of business or revenue streams currently operated by the company, including their market presence, and contribution to overall business growth."
                        class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-44 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-biz44" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.4. Solution Overview</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-10">
                    <div
                        class="p-5 bg-slate-50 rounded-2xl text-[11px] text-slate-500 font-bold uppercase tracking-tight italic border border-slate-100 leading-relaxed">
                        Following points must be captured: 1. Process | 2. Duration involved to either finish a product/
                        extend a service and push them to sale.
                    </div>

                    <div class="p-8 bg-slate-50 rounded-[2rem] border border-slate-200 space-y-6">
                        <h4 class="text-xs font-black text-[#630d0d] uppercase mb-4">4.4.1. Business Model</h4>
                        <p class="text-[10px] text-slate-400 font-bold mb-6 italic">Points Explaining the Following</p>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">1. Revenue
                                    Streams</label>
                                <textarea id="biz_441_1" placeholder="Type I will edit later..."
                                    class="w-full p-4 bg-white border border-slate-200 rounded-xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">2. Cost
                                    Structure/Unit Economics</label>
                                <textarea id="biz_441_2"
                                    placeholder="a. Defining the Unit Economics of the Product/Service including an explanation of the Direct Costs of the Product/Service b. Explanation of Indirect Costs of the Business as per the Business Plan"
                                    class="w-full p-4 bg-white border border-slate-200 rounded-xl h-32 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-2">3. Pricing
                                    Strategy</label>
                                <textarea id="biz_441_3"
                                    placeholder="1. Explaining the assumptions used by the startup in arriving at its pricing for its product/service."
                                    class="w-full p-4 bg-white border border-slate-200 rounded-xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-sm"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="p-8 bg-slate-50 rounded-[2rem] border border-slate-200">
                        <h4 class="text-xs font-black text-[#630d0d] uppercase mb-4">4.4.2. Technology Summary</h4>
                        <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-4">1. Technology &
                            Innovation</label>
                        <textarea id="biz_442"
                            placeholder="a. Technology Stack & its Scalability (Diagrammatic Representation in the Tech Summary) b. Technological Innovation."
                            class="w-full p-6 bg-white border border-slate-200 rounded-[1.5rem] h-44 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-sm"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-biz45" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.5. SME Validation</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <div
                        class="p-5 bg-slate-50 rounded-2xl text-[11px] text-slate-500 font-bold uppercase tracking-tight italic border border-slate-100 leading-relaxed">
                        Summarize feedback from subject matter experts (SMEs) regarding the feasibility, innovation, and
                        potential of the business or product, highlighting key insights and recommendations.
                    </div>
                    <textarea id="biz_45_main"
                        placeholder="1. Understanding of domain: 2. Tech Capability 3. Intellectual Property Value 4. Commercial Viability"
                        class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-44 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>

                    <div>
                        <label class="block text-[10px] font-extrabold text-slate-900 uppercase mb-3">Summary:</label>
                        <textarea id="biz_45_summary"
                            placeholder="Note: Applicable only if the input is collected from multiple SMEs"
                            class="w-full p-5 bg-slate-50 border border-slate-200 rounded-xl h-28 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-biz46" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    4.6. Ideal Customer Profile</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="biz_46_main"
                        placeholder="Points Explaining the Following 1. Customer Base & Segmentation 2. Customer Acquisition & Retention Strategies."
                        class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-44 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>
            <div id="section-fin51" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    5.1. Funds raised so far</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="fin_51_main"
                        placeholder="Provide details of the funds raised to date, including the total amount, sources of funding, and how the capital has been allocated or utilized to support business growth and development."
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>
            <div id="section-fin52" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    5.2 Insights from Financial Statements</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 overflow-hidden">
                    <div class="p-10 border-b border-slate-200 space-y-6">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Insights from Profit and
                            Loss Statement</h3>
                        <div
                            class="flex flex-wrap items-center gap-2 text-[11px] font-bold text-slate-500 bg-slate-50 p-4 rounded-xl border border-slate-100 italic">
                            Audited financials have been provided for FY
                            <input type="text" id="fin_52_fy1" placeholder="____"
                                class="w-16 bg-transparent border-b border-slate-300 text-center text-[#630d0d] outline-none">
                            and FY
                            <input type="text" id="fin_52_fy2" placeholder="____"
                                class="w-16 bg-transparent border-b border-slate-300 text-center text-[#630d0d] outline-none">;
                            provisional statements are available for FY
                            <input type="text" id="fin_52_fy3" placeholder="____"
                                class="w-16 bg-transparent border-b border-slate-300 text-center text-[#630d0d] outline-none">.
                        </div>
                        <textarea id="fin_52_pl_text"
                            placeholder="¬∑ Revenue: &#10;¬∑ EBITDA: &#10;¬∑ Finance costs: &#10;¬∑ Depreciation: &#10;¬∑ Purchases: &#10;¬∑ Employee Salary: &#10;¬∑ Other expenses: &#10;¬∑ Tax paid:"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="p-10 space-y-6 border-b border-slate-200">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Insights from Balance
                            Sheet</h3>
                        <div
                            class="flex flex-wrap items-center gap-2 text-[11px] font-bold text-slate-500 bg-slate-50 p-4 rounded-xl border border-slate-100 italic">
                            Balance sheets for FY
                            <input type="text" id="fin_52_bs_fy1" placeholder="____"
                                class="w-16 bg-transparent border-b border-slate-300 text-center text-[#630d0d] outline-none">
                            to FY
                            <input type="text" id="fin_52_bs_fy2" placeholder="____"
                                class="w-16 bg-transparent border-b border-slate-300 text-center text-[#630d0d] outline-none">
                            were reviewed in detail.
                        </div>
                        <textarea id="fin_52_bs_text"
                            placeholder="¬∑ Shareholders‚Äô Funds: &#10;¬∑ Capital infusion &#10;¬∑ Deferred Grant Income/ Liability &#10;¬∑ Cash & Cash Equivalents: &#10;¬∑ Trade Receivables: &#10;¬∑ Trade Payables: &#10;¬∑ Fixed Assets:"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[1.5rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="bg-slate-900 p-6 text-center">
                        <p class="text-[10px] font-black text-white uppercase tracking-[0.2em]">For further Details,
                            please refer to Annexure 10: Financial and Regulatory Information.</p>
                    </div>
                </div>
            </div>
            <div id="section-fin53" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    5.3 Key Metrics
                </h2>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <p
                        class="text-[11px] text-slate-400 font-bold uppercase tracking-tight italic border border-slate-100 p-4 bg-slate-50 rounded-xl">
                        Please refer to Annexure 11 to validate the information and incorporate it under each heading
                        accordingly
                    </p>

                    <div class="overflow-hidden rounded-3xl border border-slate-200">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-800 text-white text-[10px] uppercase tracking-widest font-black">
                                <tr>
                                    <th class="p-5 w-3/5 border-r border-slate-700">Financial Parameter</th>
                                    <th class="p-5 text-center">Value / Input</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm font-bold text-slate-700 divide-y divide-slate-100">
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 flex items-center gap-1">
                                        <span>Revenue (FY</span>
                                        <input type="text" id="edit_53_y1" value="24"
                                            class="w-8 bg-transparent border-b border-[#630d0d]/30 text-center text-[#630d0d] outline-none">
                                        <span>) in ‚Çπ</span>
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_1" placeholder="‚Çπ"
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 flex items-center gap-1">
                                        <span>EBITDA (FY</span>
                                        <input type="text" id="edit_53_y2" value="24"
                                            class="w-8 bg-transparent border-b border-[#630d0d]/30 text-center text-[#630d0d] outline-none">
                                        <span>) in ‚Çπ</span>
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_2" placeholder="‚Çπ"
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 flex items-center gap-1">
                                        <span>Revenue Validation as per GST Portal (FY</span>
                                        <input type="text" id="edit_53_y3" value="23-24"
                                            class="w-14 bg-transparent border-b border-[#630d0d]/30 text-center text-[#630d0d] outline-none">
                                        <span>)</span>
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_3" placeholder="Status..."
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 font-bold">
                                        Paid Up Capital in ‚Çπ
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_4" placeholder="‚Çπ"
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 flex items-center gap-1">
                                        <span>Employees (as of</span>
                                        <input type="text" id="edit_53_m1" value="November ‚Äò24"
                                            class="w-32 bg-transparent border-b border-[#630d0d]/30 text-center text-[#630d0d] outline-none">
                                        <span>)</span>
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_5" placeholder="Count"
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 flex items-center gap-1">
                                        <span>Employee cost (as of</span>
                                        <input type="text" id="edit_53_m2" value="November ‚Äò24"
                                            class="w-32 bg-transparent border-b border-[#630d0d]/30 text-center text-[#630d0d] outline-none">
                                        <span>) in ‚Çπ</span>
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_6" placeholder="‚Çπ"
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 font-bold">
                                        Patents and Certifications
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_7" placeholder="Details..."
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-4 bg-slate-50/50 border-r border-slate-200 font-bold">
                                        Incubator
                                    </td>
                                    <td class="p-4">
                                        <input type="text" id="val_53_8" placeholder="Name..."
                                            class="w-full p-2 text-center outline-none bg-white rounded-lg shadow-sm border border-transparent focus:border-[#630d0d]/20 font-black">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="section-fin54" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    5.4 Revenue Projections</h2>

                <div class="flex gap-4 mb-8 bg-slate-100 p-4 rounded-2xl border border-slate-200 justify-center">
                    <button onclick="toggleTable('div_proj_table1', true)"
                        class="text-[9px] font-black uppercase tracking-widest px-4 py-2 bg-white rounded-xl shadow-sm hover:bg-[#630d0d] hover:text-white transition">Show
                        Table 1</button>
                    <button onclick="toggleTable('div_proj_table2', true)"
                        class="text-[9px] font-black uppercase tracking-widest px-4 py-2 bg-white rounded-xl shadow-sm hover:bg-[#630d0d] hover:text-white transition">Show
                        Table 2</button>
                </div>

                <div class="space-y-12">
                    <div id="div_proj_table1"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('div_proj_table1', false)"
                            class="absolute top-6 right-6 text-red-400 font-bold uppercase text-[8px] border border-red-50 p-2 rounded hover:bg-red-50 transition">Hide
                            Table 1</button>

                        <div
                            class="w-full mb-6 text-xs font-black text-slate-800 uppercase bg-slate-50 p-5 rounded-xl border border-slate-100 italic flex flex-wrap items-center gap-1 shadow-inner">
                            <span>Since the applicant is in</span>
                            <input type="text" id="fin_54_stage" value="idea"
                                class="bg-transparent border-b-2 border-[#630d0d]/30 text-[#630d0d] outline-none px-2 text-center w-24 focus:border-[#630d0d]">
                            <span>stage, revenue projections for the first year post funding have been provided.</span>
                        </div>

                        <table class="w-full border-collapse rounded-xl overflow-hidden border border-slate-200">
                            <thead class="bg-slate-800 text-white text-[9px] uppercase tracking-widest text-center">
                                <tr>
                                    <th class="p-4 border-r border-slate-700">Particulars</th>
                                    <th class="p-4">Year 1 Post Funding (Amount in ‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-0 border-r border-slate-200">
                                        <input type="text" id="fin_54_t1_p1"
                                            class="w-full p-4 font-bold text-center outline-none"
                                            value="Projected Revenue">
                                    </td>
                                    <td class="p-0">
                                        <input type="text" id="fin_54_t1_v1"
                                            class="w-full p-4 font-bold text-center outline-none text-[#630d0d]"
                                            placeholder="‚Çπ 0.00">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="or_divider" class="text-center my-8">
                        <span
                            class="bg-slate-100 px-6 py-2 rounded-full text-[10px] font-black text-slate-400 uppercase tracking-[0.4em]">OR</span>
                    </div>

                    <div id="div_proj_table2"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('div_proj_table2', false)"
                            class="absolute top-6 right-6 text-red-400 font-bold uppercase text-[8px] border border-red-50 p-2 rounded hover:bg-red-50 transition">Hide
                            Table 2</button>
                        <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest mb-6">The Revenue
                            Projections based on the fund raise are summarized below:</h3>

                        <table class="w-full border-collapse rounded-xl overflow-hidden border border-slate-200">
                            <thead class="bg-slate-800 text-white text-[8px] uppercase tracking-widest text-center">
                                <tr>
                                    <th class="p-4 border-r border-slate-700">Particulars</th>
                                    <th class="p-4 border-r border-slate-700">Year 1 (Amount in ‚Çπ)</th>
                                    <th class="p-4 border-r border-slate-700">Year 2 (Amount in ‚Çπ)</th>
                                    <th class="p-4">Year 3 (Amount in ‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 border border-slate-200 font-bold text-center">
                                <tr>
                                    <td class="p-0 border-r border-slate-200"><input type="text" id="fin_54_t2_p1"
                                            class="w-full p-4 outline-none" value="Projected Revenue"></td>
                                    <td class="p-0 border-r border-slate-200"><input type="text" id="fin_54_t2_v1"
                                            class="w-full p-4 outline-none text-[#630d0d]"></td>
                                    <td class="p-0 border-r border-slate-200"><input type="text" id="fin_54_t2_v2"
                                            class="w-full p-4 outline-none text-[#630d0d]"></td>
                                    <td class="p-0"><input type="text" id="fin_54_t2_v3"
                                            class="w-full p-4 outline-none text-[#630d0d]"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-mkt61" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    6.1 Indian Market Overview</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <textarea id="mkt_61_main"
                        placeholder="Write about the market segments in brief along with market size and CAGR"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    <p class="text-[10px] text-slate-400 font-bold italic uppercase tracking-widest px-4 italic">Note:
                        Make sure all the market size data is in USD to ensure uniformity.</p>
                </div>
            </div>

            <div id="section-mkt62" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    6.2 Global Market Overview</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <textarea id="mkt_62_main"
                        placeholder="Write about the market segments in brief along with market size and CAGR"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    <p class="text-[10px] text-slate-400 font-bold italic uppercase tracking-widest px-4 italic">Note:
                        Make sure all the market size data is in USD to ensure uniformity.</p>
                </div>
            </div>

            <div id="section-mkt63" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    6.3 Addressable and Obtainable Market</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-10">

                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-slate-900 uppercase mb-3">6.3.1. Total
                                Addressable Market (TAM):</label>
                            <textarea id="mkt_631_text" placeholder="Write about market segments..."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-900 uppercase mb-3">6.3.2. Serviceable
                                Available Market (SAM):</label>
                            <textarea id="mkt_632_text" placeholder="Write about market segments..."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-900 uppercase mb-3">6.3.3. Serviceable
                                Obtainable Market (SOM):</label>
                            <textarea id="mkt_633_text" placeholder="Write about market segments..."
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl h-24 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold"></textarea>
                        </div>
                    </div>

                    <div
                        class="flex flex-col items-center justify-center p-12 bg-slate-50 rounded-[3rem] border border-slate-200 min-h-[500px]">
                        <div id="chart-tam"
                            class="relative flex items-center justify-center bg-green-700/80 rounded-full transition-all duration-500 shadow-xl border-4 border-white"
                            style="width: 380px; height: 380px;">
                            <div class="absolute top-4 text-white font-black text-[10px] uppercase tracking-widest">TAM
                            </div>
                            <div class="absolute top-10 text-white font-bold text-xs" id="disp-tam">$0</div>
                            <div id="chart-sam"
                                class="relative flex items-center justify-center bg-green-500/80 rounded-full transition-all duration-500 shadow-lg border-2 border-white"
                                style="width: 250px; height: 250px;">
                                <div class="absolute top-4 text-white font-black text-[10px] uppercase tracking-widest">
                                    SAM</div>
                                <div class="absolute top-10 text-white font-bold text-xs" id="disp-sam">$0</div>
                                <div id="chart-som"
                                    class="relative flex items-center justify-center bg-green-300/80 rounded-full transition-all duration-500 shadow-md border border-white"
                                    style="width: 120px; height: 120px;">
                                    <div
                                        class="absolute top-4 text-slate-700 font-black text-[10px] uppercase tracking-widest">
                                        SOM</div>
                                    <div class="absolute top-10 text-slate-700 font-bold text-xs" id="disp-som">$0</div>
                                </div>
                            </div>
                        </div>

                        <div class="no-print mt-10 grid grid-cols-3 gap-4 w-full max-w-lg">
                            <div class="text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase block mb-2">TAM (USD)</span>
                                <input type="number" id="val_tam" oninput="updateMarketChart()"
                                    class="w-full p-3 bg-white border border-slate-200 rounded-xl text-center font-bold text-[#630d0d] shadow-sm">
                            </div>
                            <div class="text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase block mb-2">SAM (USD)</span>
                                <input type="number" id="val_sam" oninput="updateMarketChart()"
                                    class="w-full p-3 bg-white border border-slate-200 rounded-xl text-center font-bold text-[#630d0d] shadow-sm">
                            </div>
                            <div class="text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase block mb-2">SOM (USD)</span>
                                <input type="number" id="val_som" oninput="updateMarketChart()"
                                    class="w-full p-3 bg-white border border-slate-200 rounded-xl text-center font-bold text-[#630d0d] shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-mkt64" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    6.4. Regulatory Impact</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <textarea id="mkt_64_main"
                        placeholder="(Write about both positive and negative impact from global and Indian perspective including state level policies.)"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    <p class="text-[10px] text-slate-400 font-bold italic uppercase tracking-widest px-4 italic">Note:
                        Make sure all the market size data is in USD to ensure uniformity.</p>
                </div>
            </div>

            <div id="section-mkt65" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    6.5. Competition</h2>
                <div class="space-y-12">
                    <p
                        class="p-6 bg-slate-100 rounded-3xl text-xs font-bold text-slate-500 italic border border-slate-200">
                        Snapshots of the Competitor Segment across India and the Globe is presented below with some
                        insights drawn from the research. Detailed profiling can be found in Annexure 6: Competitors
                        Analysis.</p>
                    <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">6.5.1. Indian
                            Competitors</h3>
                        <p
                            class="text-[10px] text-slate-400 font-bold italic tracking-tight uppercase leading-relaxed italic border-l-2 border-slate-100 pl-4">
                            Following Points must be considered: 1. Competitor Profiling by service/product and by
                            Similar technology | 2. Identification of Direct Competitors
                        </p>

                        <div class="overflow-hidden rounded-2xl border-2 border-black">
                            <table class="w-full border-collapse" id="table_indian_comp">
                                <thead class="bg-black text-white text-[10px] uppercase font-black tracking-widest">
                                    <tr>
                                        <th class="p-4 border-r border-white/20 w-20 text-center">S.No</th>
                                        <th class="p-4 border-r border-white/20">List of Competitors</th>
                                        <th class="p-4 w-12 text-center no-print"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-black font-bold text-sm">
                                    <tr>
                                        <td class="p-0 border-r border-black"><input type="text"
                                                class="w-full p-4 text-center outline-none bg-transparent" value="1">
                                        </td>
                                        <td class="p-0 border-r border-black"><input type="text" id="in_comp_1"
                                                class="w-full p-4 outline-none"></td>
                                        <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)"
                                                class="text-red-400 hover:text-red-600 transition font-bold text-lg">‚úï</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-0 border-r border-black"><input type="text"
                                                class="w-full p-4 text-center outline-none bg-transparent" value="2">
                                        </td>
                                        <td class="p-0 border-r border-black"><input type="text" id="in_comp_2"
                                                class="w-full p-4 outline-none"></td>
                                        <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)"
                                                class="text-red-400 hover:text-red-600 transition font-bold text-lg">‚úï</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <button onclick="addCompRow('table_indian_comp', 'in_comp')"
                                class="no-print w-full py-3 bg-slate-50 text-[10px] font-black uppercase border-t-2 border-black hover:bg-slate-100 transition-all">+
                                Add Row</button>
                        </div>

                        <div class="space-y-4 pt-6">
                            <label
                                class="block text-[10px] font-black text-slate-900 uppercase underline decoration-[#630d0d]/30">Insights
                                from Indian Competitors:</label>
                            <textarea id="mkt_651_insights"
                                placeholder="¬∑ Establishment Year: ... &#10;¬∑ Business model/ Distribution Network &#10;¬∑ Revenue &#10;¬∑ Price analysis &#10;¬∑ Model/variant analysis &#10;¬∑ Customer Profile/ Segment"
                                class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">6.5.2. Global
                            Competitors</h3>

                        <table class="w-full border-collapse border-2 border-black" id="table_gl_comp">
                            <thead class="bg-black text-white text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="p-4 border-r border-white/20 w-20">S.No</th>
                                    <th class="p-4 border-r border-white/20">List of Competitors</th>
                                    <th class="p-4 w-12"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold text-sm">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text"
                                            class="w-full p-4 text-center outline-none" value="1"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gl_comp_1"
                                            class="w-full p-4 outline-none"></td>
                                    <td class="p-2 text-center"><button onclick="removeCompRow(this)"
                                            class="text-red-300 hover:text-red-600">‚úï</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addCompRow('table_gl_comp', 'gl_comp')"
                            class="w-full py-3 bg-slate-50 text-[10px] font-black uppercase border-x-2 border-b-2 border-black hover:bg-slate-100">+
                            Add Global Competitor</button>

                        <div class="space-y-4 pt-6">
                            <label
                                class="block text-[10px] font-black text-slate-900 uppercase underline decoration-[#630d0d]/30">Insights
                                from Global Competitors:</label>
                            <textarea id="mkt_652_insights"
                                placeholder="¬∑ Establishment Year: ... &#10;¬∑ Business model/ Distribution Network &#10;¬∑ Revenue &#10;¬∑ Price analysis &#10;¬∑ Model/variant analysis &#10;¬∑ Customer Profile/ Segment"
                                class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                        </div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center mt-4">For
                            Further details refer to Competition section in Annexure 1: Domain Research</p>
                    </div>

                    <div class="bg-[#630d0d] rounded-[2.5rem] shadow-2xl p-10 space-y-4">
                        <h3 class="text-sm font-black text-white uppercase tracking-widest">6.5.3. Recent Funding in the
                            Domain:</h3>
                        <textarea id="mkt_653_funding"
                            placeholder="(write 1 or 2 line for each startup about the funding round, investor and year. Elaborate more in the Domain Research section)"
                            class="w-full p-8 bg-white/10 border border-white/20 rounded-[2rem] h-44 outline-none text-sm text-white font-bold placeholder:text-white/30"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-strat71" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    7.1. Competitive Advantage, Entry Barriers</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 overflow-hidden">

                    <div class="p-10 border-b border-slate-200 space-y-4">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Competitive Advantage
                        </h3>
                        <textarea id="strat_71_advantage"
                            placeholder="¬∑ Unique Value Proposition - Comparison of the Product‚Äôs Features & Benefits with Competitors &#10;¬∑ Differentiation of Service/pricing/customer segment/positioning - Comparison of the Product‚Äôs Features & Benefits with Competitors"
                            class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="p-10 space-y-4">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Entry Barriers</h3>
                        <textarea id="strat_71_barriers"
                            placeholder="¬∑ Identify the challenges or obstacles that new competitors would face when entering the market, such as high capital requirements, strong brand loyalty, regulatory hurdles, or technological expertise, which protect the company‚Äôs market position."
                            class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-[#630d0d]/20 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-strat72" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    7.2. SWOT Analysis</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-12">

                    <div class="space-y-4">
                        <h3 class="text-xs font-black text-green-600 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-600 rounded-full"></span> 7.2.1. Strengths:
                        </h3>
                        <textarea id="swot_strengths"
                            placeholder="Write In pointers and give inline heading for the respective point. Should cover solution and founder strengths including innovation."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 focus:ring-2 focus:ring-green-100 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xs font-black text-amber-600 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-amber-600 rounded-full"></span> 7.2.2. Weaknesses:
                        </h3>
                        <textarea id="swot_weaknesses"
                            placeholder="Should include skill gaps. Solution weakness including maturity level."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 focus:ring-2 focus:ring-amber-100 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xs font-black text-blue-600 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-600 rounded-full"></span> 7.2.3. Opportunities:
                        </h3>
                        <textarea id="swot_opportunities"
                            placeholder="Market and govt support. Changing consumer trends that support the solution/product."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 focus:ring-2 focus:ring-blue-100 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xs font-black text-red-600 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-600 rounded-full"></span> 7.2.4. Threats:
                        </h3>
                        <textarea id="swot_threats"
                            placeholder="New solutions. Regulatory change that is impending. Founder incompatibility if any that has come out as part of assessment."
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 focus:ring-2 focus:ring-red-100 outline-none text-sm text-slate-800 font-bold shadow-inner"></textarea>
                    </div>

                    <div class="bg-slate-900 rounded-[2rem] p-8 space-y-4">
                        <h3 class="text-xs font-black text-white uppercase tracking-[0.3em]">7.2.5 Risk Mitigation:</h3>
                        <textarea id="swot_mitigation" placeholder="Points covering above..."
                            class="w-full p-6 bg-white/10 border border-white/20 rounded-xl h-44 focus:ring-2 focus:ring-white/20 outline-none text-sm text-white font-bold placeholder:text-white/20 shadow-inner"></textarea>
                    </div>
                </div>
            </div>
            <div id="section-gov81" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    8.1 Community Certificate</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <div
                        class="p-8 bg-slate-50 rounded-3xl border border-slate-200 text-sm font-bold text-slate-800 italic shadow-inner flex items-center gap-2">
                        <span>Community Certificate of Founder</span>
                        <input type="text" id="gov_81_founder_name" placeholder="(to be filled in)"
                            class="bg-transparent border-b-2 border-[#630d0d]/30 text-[#630d0d] outline-none px-2 w-48 focus:border-[#630d0d]">
                        <span>has been attached.</span>
                    </div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest px-4">Please refer to
                        Annexure 5: Community Certificate.</p>
                </div>
            </div>

            <div id="section-gov82" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    8.2 Founding Team Background</h2>

                <div id="founding_team_container" class="space-y-12">
                    <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <p
                            class="text-[10px] text-slate-400 font-black uppercase tracking-tight mb-6 bg-slate-50 p-3 rounded-xl border border-slate-100">
                            (Please refer to the CVs of the founders and fill in the following information)</p>

                        <input type="text" id="gov_82_head_1" placeholder="(Name - Role (Community Certificate Holder))"
                            class="w-full mb-6 text-xs font-black text-slate-900 uppercase bg-slate-100 p-4 rounded-xl border-none outline-none shadow-inner">

                        <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Education</h4>
                        <table class="w-full border-collapse border-2 border-black mb-8 rounded-xl overflow-hidden">
                            <thead class="bg-black text-white text-[9px] uppercase font-black">
                                <tr>
                                    <th class="p-3 border-r border-white/20">Name of the Institute</th>
                                    <th class="p-3 border-r border-white/20">Start Year</th>
                                    <th class="p-3">End Year</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e1_inst1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e1_start1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_e1_end1"
                                            class="w-full p-3 text-center outline-none"></td>
                                </tr>
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e1_inst2"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e1_start2"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_e1_end2"
                                            class="w-full p-3 text-center outline-none"></td>
                                </tr>
                            </tbody>
                        </table>

                        <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Work Experience
                        </h4>
                        <table class="w-full border-collapse border-2 border-black mb-2" id="table_work_1">
                            <thead class="bg-black text-white text-[9px] uppercase font-black">
                                <tr>
                                    <th class="p-3 border-r border-white/20">Name of Organization</th>
                                    <th class="p-3 border-r border-white/20">Role</th>
                                    <th class="p-3">Years</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w1_org1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w1_role1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_w1_year1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 text-center no-print"></td>
                                </tr>
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w1_org2"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w1_role2"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_w1_year2"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)"
                                            class="text-red-400 hover:text-red-600">‚úï</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addWorkRow('table_work_1', 'gov_82_w1')"
                            class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black hover:bg-slate-100">+
                            Add Experience</button>
                    </div>
                </div>
                <button onclick="addFounderBlock()"
                    class="no-print mt-10 w-full py-5 bg-[#630d0d] text-white rounded-[2rem] font-black uppercase tracking-widest shadow-xl hover:bg-black transition">+
                    Add Additional Founder Profile</button>
            </div>

            <div id="section-gov83" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    8.3 Cap Table</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <p
                        class="text-[10px] text-slate-400 font-black uppercase tracking-tight bg-slate-50 p-4 rounded-xl">
                        Please refer to Annexure 11 to validate the information and incorporate it under each heading
                        accordingly</p>

                    <div class="overflow-hidden rounded-2xl border-2 border-black">
                        <table class="w-full border-collapse" id="table_cap">
                            <thead class="bg-black text-white text-[10px] uppercase font-black">
                                <tr>
                                    <th class="p-4 border-r border-white/20">Name</th>
                                    <th class="p-4 w-1/3">Share Percentage (%)</th>
                                    <th class="p-4 w-12 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black">
                                <tr class="bg-slate-50">
                                    <td class="p-0 border-r border-black"><input type="text" id="cap_name_1"
                                            class="w-full p-4 font-bold outline-none bg-transparent"
                                            placeholder="Founder Name"></td>
                                    <td class="p-0"><input type="text" id="cap_perc_1"
                                            class="w-full p-4 text-center font-bold outline-none bg-transparent"></td>
                                    <td class="no-print"></td>
                                </tr>
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="cap_name_2"
                                            class="w-full p-4 outline-none"></td>
                                    <td class="p-0"><input type="text" id="cap_perc_2"
                                            class="w-full p-4 text-center outline-none"></td>
                                    <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)"
                                            class="text-red-400 hover:text-red-600">‚úï</button></td>
                                </tr>
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="cap_name_3"
                                            class="w-full p-4 outline-none"></td>
                                    <td class="p-0"><input type="text" id="cap_perc_3"
                                            class="w-full p-4 text-center outline-none"></td>
                                    <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)"
                                            class="text-red-400 hover:text-red-600">‚úï</button></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="bg-slate-900 text-white font-black">
                                    <td
                                        class="p-4 border-r border-white/20 text-right uppercase tracking-widest text-[10px]">
                                        Total</td>
                                    <td class="p-4 text-center">100%</td>
                                    <td class="no-print"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button onclick="addCapRow()"
                            class="no-print w-full py-3 bg-slate-100 text-[10px] font-black uppercase border-t-2 border-black hover:bg-slate-200">+
                            Add Shareholder</button>
                    </div>
                </div>
            </div>

            <div id="section-gov84" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    8.4 Employees</h2>

                <div
                    class="flex gap-4 mb-8 bg-slate-100 p-4 rounded-2xl border border-slate-200 justify-center no-print">
                    <button id="btn_uninc" onclick="selectEmployeeTemplate('uninc')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-[#630d0d] rounded-2xl shadow-md transition-all border-2 border-transparent hover:scale-105">
                        Not Incorporated
                    </button>
                    <button id="btn_estb" onclick="selectEmployeeTemplate('estb')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-[#630d0d] rounded-2xl shadow-md transition-all border-2 border-transparent hover:scale-105">
                        Already Established
                    </button>
                </div>

                <div id="div_emp_unincorporated" class="space-y-8 hidden">
                    <div
                        class="bg-[#630d0d] text-white p-10 rounded-[3rem] shadow-xl font-bold italic text-base border-4 border-white/10">
                        The Proposed entity is yet to be incorporated; hence current employee headcount is nil.
                    </div>

                    <div id="mod_uninc_prop"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                        <h3 class="text-xs font-black uppercase tracking-widest text-[#630d0d]">Proposed Headcount (Post
                            Funding)</h3>
                        <table class="w-full border-collapse border-2 border-black" id="table_uninc_prop">
                            <thead class="bg-black text-white text-[9px] font-black uppercase">
                                <tr>
                                    <th class="p-3 border-r border-white/20 text-center">Role</th>
                                    <th class="p-3 border-r border-white/20 text-center">Count</th>
                                    <th class="p-3 text-center">Salary</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="uninc_r1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="uninc_c1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="uninc_s1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addNewEmpRowGeneric('table_uninc_prop', 'uninc')"
                            class="no-print w-full py-3 bg-slate-50 text-[9px] font-black uppercase border-x-2 border-b-2 border-black hover:bg-slate-100">+
                            Add Role</button>
                    </div>
                </div>

                <div id="div_emp_established" class="hidden space-y-8">
                    <div class="no-print flex justify-end">
                        <button onclick="resetEstablishedTables()"
                            class="text-[9px] font-black uppercase text-blue-600 bg-blue-50 px-4 py-2 rounded-full border border-blue-100 hover:bg-blue-100 transition shadow-sm">üîÑ
                            Show All Modules (Reset)</button>
                    </div>

                    <div id="mod_estb_founders"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('mod_estb_founders', false)"
                            class="no-print absolute top-6 right-8 text-red-400 font-bold uppercase text-[8px] hover:text-red-600">Delete
                            Module</button>
                        <h3 class="text-xs font-black uppercase tracking-widest mb-4">Current Founders</h3>
                        <table class="w-full border-collapse border-2 border-black" id="table_estb_founders">
                            <thead class="bg-slate-100 text-[9px] font-black uppercase text-center">
                                <tr>
                                    <th class="p-3 border-r border-black">Name</th>
                                    <th class="p-3 border-r border-black">Gender</th>
                                    <th class="p-3 border-r border-black">Role</th>
                                    <th class="p-3">Salary</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_fn1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_fg1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_fr1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0"><input type="text" id="estb_fs1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addNewEmpRowGeneric('table_estb_founders', 'estb_f')"
                            class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black">+
                            Add Founder</button>
                    </div>

                    <div id="mod_estb_curr"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('mod_estb_curr', false)"
                            class="no-print absolute top-6 right-8 text-red-400 font-bold uppercase text-[8px] hover:text-red-600">Delete
                            Module</button>
                        <h3 class="text-xs font-black uppercase tracking-widest mb-4">Current Employees</h3>
                        <table class="w-full border-collapse border-2 border-black" id="table_estb_curr">
                            <thead class="bg-slate-100 text-[9px] font-black uppercase text-center">
                                <tr>
                                    <th class="p-3 border-r border-black">Name</th>
                                    <th class="p-3 border-r border-black">Role</th>
                                    <th class="p-3">Salary</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_cn1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_cr1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0"><input type="text" id="estb_cs1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addNewEmpRowGeneric('table_estb_curr', 'estb_c')"
                            class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black">+
                            Add Employee</button>
                    </div>

                    <div id="mod_estb_workers"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('mod_estb_workers', false)"
                            class="no-print absolute top-6 right-8 text-red-400 font-bold uppercase text-[8px] hover:text-red-600">Delete
                            Module</button>
                        <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-[#630d0d]">Workers</h3>
                        <table class="w-full border-collapse border-2 border-black" id="table_estb_workers">
                            <thead class="bg-slate-100 text-[9px] font-black uppercase text-center">
                                <tr>
                                    <th class="p-3 border-r border-black">Name</th>
                                    <th class="p-3 border-r border-black">Wage</th>
                                    <th class="p-3">Days Worked</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_wn1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_ww1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="estb_wd1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addNewEmpRowGeneric('table_estb_workers', 'estb_w')"
                            class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black">+
                            Add Worker</button>
                    </div>

                    <div id="mod_estb_prop"
                        class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative">
                        <button onclick="toggleTable('mod_estb_prop', false)"
                            class="no-print absolute top-6 right-8 text-red-400 font-bold uppercase text-[8px] hover:text-red-600">Delete
                            Module</button>
                        <h3 class="text-xs font-black uppercase tracking-widest mb-4">Proposed Headcount (Post Funding)
                        </h3>
                        <table class="w-full border-collapse border-2 border-black" id="table_estb_prop">
                            <thead class="bg-black text-white text-[9px] font-black uppercase">
                                <tr>
                                    <th class="p-3 border-r border-white/20 text-center">Role</th>
                                    <th class="p-3 border-r border-white/20 text-center">Count</th>
                                    <th class="p-3 text-center">Salary</th>
                                    <th class="p-3 w-10 no-print"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-black font-bold">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_pr1"
                                            class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="estb_pc1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="estb_ps1"
                                            class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addNewEmpRowGeneric('table_estb_prop', 'estb_p')"
                            class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black">+
                            Add Proposed Role</button>
                    </div>
                </div>
            </div>

            <div id="section-risk91" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    9.1. Market Risk</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <div>
                        <h3 class="text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Analysis /
                            Assessment:</h3>
                        <textarea id="risk_91_main" placeholder="Type analysis here..."
                            class="w-full p-8 bg-slate-50 border border-slate-100 rounded-[2rem] h-64 font-bold shadow-inner outline-none focus:ring-2 focus:ring-[#630d0d]/10"></textarea>
                    </div>
                    <div class="pt-8 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase text-[#630d0d] mb-2 tracking-widest">Impact
                            Analysis:</h3>
                        <textarea id="risk_91_impact" placeholder="Type impact here..."
                            class="w-full p-8 bg-white border-2 border-slate-300 rounded-[2rem] h-48 font-bold shadow-sm outline-none focus:ring-2 focus:ring-[#630d0d]/10"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-risk92" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    9.2. Operational Risk</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <textarea id="risk_92_main" placeholder="Analysis..."
                        class="w-full p-8 bg-slate-50 border border-slate-100 rounded-[2rem] h-64 font-bold shadow-inner outline-none"></textarea>
                    <div class="pt-8 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase text-[#630d0d] mb-3">Impact Analysis:</h3>
                        <textarea id="risk_92_impact" placeholder="Impact..."
                            class="w-full p-8 bg-white border-2 border-slate-300 rounded-[2rem] h-48 font-bold shadow-sm outline-none"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-risk93" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    9.3. Financial Risk</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <textarea id="risk_93_main" placeholder="Analysis..."
                        class="w-full p-8 bg-slate-50 border border-slate-100 rounded-[2rem] h-64 font-bold shadow-inner outline-none"></textarea>
                    <div class="pt-8 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase text-[#630d0d] mb-3">Impact Analysis:</h3>
                        <textarea id="risk_93_impact" placeholder="Impact..."
                            class="w-full p-8 bg-white border-2 border-slate-300 rounded-[2rem] h-48 font-bold shadow-sm outline-none"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-risk94" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    9.4. Regulatory Risk</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <textarea id="risk_94_main" placeholder="Analysis..."
                        class="w-full p-8 bg-slate-50 border border-slate-100 rounded-[2rem] h-64 font-bold shadow-inner outline-none"></textarea>
                    <div class="pt-8 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase text-[#630d0d] mb-3">Impact Analysis:</h3>
                        <textarea id="risk_94_impact" placeholder="Impact..."
                            class="w-full p-8 bg-white border-2 border-slate-300 rounded-[2rem] h-48 font-bold shadow-sm outline-none"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-risk95" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    9.5. External Risk</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <textarea id="risk_95_main" placeholder="Analysis..."
                        class="w-full p-8 bg-slate-50 border border-slate-100 rounded-[2rem] h-64 font-bold shadow-inner outline-none"></textarea>
                    <div class="pt-8 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase text-[#630d0d] mb-3">Impact Analysis:</h3>
                        <textarea id="risk_95_impact" placeholder="Impact..."
                            class="w-full p-8 bg-white border-2 border-slate-300 rounded-[2rem] h-48 font-bold shadow-sm outline-none"></textarea>
                    </div>
                </div>
            </div>
            <div id="section-trans101" class="max-w-5xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    10.1 Fund Utilization Plan</h2>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <div class="flex items-center gap-2 text-sm font-bold text-slate-700">
                        <span>The funds raised in this round</span>
                        <input type="text" id="util_round_val" placeholder="_______"
                            class="border-b border-slate-400 outline-none w-48 bg-transparent text-[#630d0d]">
                        <span>will be utilized as follows:</span>
                    </div>

                    <div class="no-print flex gap-4">
                        <button onclick="addTrancheColumn()"
                            class="bg-[#630d0d] text-white px-4 py-2 rounded-xl text-[10px] font-bold uppercase shadow-lg">+
                            Add Tranche</button>
                        <button onclick="removeTrancheColumn()"
                            class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">-
                            Remove Tranche</button>
                    </div>

                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full border-collapse border border-slate-300" id="util-table">
                            <thead>
                                <tr class="bg-slate-800 text-white text-[10px] uppercase font-black">
                                    <th class="p-4 border border-slate-600 text-left w-64">Particulars</th>
                                    <th class="p-4 border border-slate-600 tranche-head" data-t="1">Tranche 1 (‚Çπ)</th>
                                    <th class="p-4 border border-slate-600 tranche-head" data-t="2">Tranche 2 (‚Çπ)</th>
                                    <th class="p-4 border border-slate-600 total-col-head">Total (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="util-body">
                                <tr class="bg-slate-100 font-black text-[10px] uppercase text-slate-600">
                                    <td colspan="10" class="p-3">1. Capital Expenditure</td>
                                </tr>
                                <tr class="util-row" data-cat="cap">
                                    <td class="p-0 border border-slate-300"><input type="text"
                                            class="w-full p-3 outline-none font-bold" value="Infrastructure"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t1 w-full p-3 text-center outline-none"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t2 w-full p-3 text-center outline-none"></td>
                                    <td
                                        class="p-3 border border-slate-300 text-center font-black bg-slate-50 row-total">
                                        0</td>
                                </tr>
                                <tr class="no-print">
                                    <td colspan="10" class="p-2"><button onclick="addUtilRow('cap')"
                                            class="text-[9px] font-black text-[#630d0d]">+ ADD ROW</button></td>
                                </tr>

                                <tr class="bg-slate-100 font-black text-[10px] uppercase text-slate-600">
                                    <td colspan="10" class="p-3">2. Direct Costs</td>
                                </tr>
                                <tr class="util-row" data-cat="dir">
                                    <td class="p-0 border border-slate-300"><input type="text"
                                            class="w-full p-3 outline-none font-bold" value="Direct Cost Item"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t1 w-full p-3 text-center outline-none"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t2 w-full p-3 text-center outline-none"></td>
                                    <td
                                        class="p-3 border border-slate-300 text-center font-black bg-slate-50 row-total">
                                        0</td>
                                </tr>
                                <tr class="no-print">
                                    <td colspan="10" class="p-2"><button onclick="addUtilRow('dir')"
                                            class="text-[9px] font-black text-[#630d0d]">+ ADD ROW</button></td>
                                </tr>

                                <tr class="bg-slate-100 font-black text-[10px] uppercase text-slate-600">
                                    <td colspan="10" class="p-3">3. Indirect Costs</td>
                                </tr>
                                <tr class="util-row" data-cat="ind">
                                    <td class="p-0 border border-slate-300"><input type="text"
                                            class="w-full p-3 outline-none font-bold" value="Indirect Cost Item"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t1 w-full p-3 text-center outline-none"></td>
                                    <td class="p-0 border border-slate-300"><input type="number"
                                            oninput="calcUtilTable()"
                                            class="val-t2 w-full p-3 text-center outline-none"></td>
                                    <td
                                        class="p-3 border border-slate-300 text-center font-black bg-slate-50 row-total">
                                        0</td>
                                </tr>
                                <tr class="no-print">
                                    <td colspan="10" class="p-2"><button onclick="addUtilRow('ind')"
                                            class="text-[9px] font-black text-[#630d0d]">+ ADD ROW</button></td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-[#630d0d] text-white font-bold">
                                <tr>
                                    <td class="p-4 border border-white/10 uppercase text-[10px]">Grand Total (‚Çπ)</td>
                                    <td class="p-4 border border-white/10 text-center" id="foot-t1">0</td>
                                    <td class="p-4 border border-white/10 text-center" id="foot-t2">0</td>
                                    <td class="p-4 border border-white/10 text-center bg-black/20" id="foot-total-all">0
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="block_util_assumptions"
                        class="bg-slate-50 p-8 rounded-3xl border border-slate-200 relative">
                        <button onclick="this.parentElement.remove()"
                            class="no-print absolute top-4 right-4 text-red-400 text-[8px] font-bold">‚úï DELETE</button>
                        <h4 class="text-xs font-black uppercase text-slate-500 mb-4">Assumptions:</h4>
                        <textarea id="util_assumptions" placeholder="(Please write the assumptions in Bullet Points)"
                            class="w-full p-6 bg-white border border-slate-200 rounded-2xl h-32 outline-none font-bold"></textarea>
                    </div>

                    <div id="block_dynamic_milestones"
                        class="bg-slate-50 p-8 rounded-3xl border border-slate-200 relative">
                        <h4 class="text-xs font-black uppercase text-slate-500 mb-4">Tranche Release Milestones:</h4>
                        <div id="dynamic-milestone-inputs" class="space-y-6">
                            <div id="input_block_t2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Conditions for Tranche
                                    2</label>
                                <textarea id="milestone_text_t2" oninput="mirrorMilestone(2)"
                                    placeholder="Describe milestones..."
                                    class="w-full p-4 bg-white border border-slate-200 rounded-xl mt-1 text-sm font-bold outline-none shadow-sm"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-trans102" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    10.2 Possible Exit Mechanism</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-6">
                    <p class="text-sm font-bold text-slate-700 italic">TANSIM will be able to get an exit from this
                        investment through one or more of the following mechanisms:</p>
                    <table class="w-full border-collapse border-2 border-black" id="exit-table">
                        <thead class="bg-black text-white text-[10px] uppercase font-black text-center">
                            <tr>
                                <th class="p-4 border-r border-white/20">Possible Exit Mechanism</th>
                                <th class="p-4">Particulars</th>
                                <th class="p-4 w-12 no-print"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-black font-bold">
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text"
                                        class="w-full p-4 outline-none"></td>
                                <td class="p-0 border-r border-black"><input type="text"
                                        class="w-full p-4 outline-none"></td>
                                <td class="p-2 text-center no-print"><button onclick="this.closest('tr').remove()"
                                        class="text-red-400">‚úï</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button onclick="addExitRow()"
                        class="no-print w-full py-3 bg-slate-100 text-[10px] font-black uppercase border-2 border-t-0 border-black hover:bg-slate-200 transition-all">+
                        Add Exit Row</button>
                </div>
            </div>

            <div id="section-trans103" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    10.3 Recommendation</h2>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-10">
                    <div id="block_recommend_cp" class="relative bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <button onclick="this.parentElement.remove()"
                            class="no-print absolute top-4 right-4 text-red-400 text-[8px] font-bold">‚úï REMOVE
                            BOX</button>
                        <h4 class="text-xs font-black uppercase text-slate-400 mb-3">Business CPs:</h4>
                        <textarea id="recommend_cp_text" placeholder="1. Write about condition precedents..."
                            class="w-full p-6 bg-white border border-slate-200 rounded-xl h-32 outline-none font-bold shadow-sm"></textarea>
                    </div>

                    <div class="text-slate-800 text-sm font-bold leading-relaxed">
                        <div
                            class="flex flex-wrap items-center gap-2 mb-8 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <span>As per the Investment Committee Meeting dated</span>
                            <input type="text" id="ic_date" placeholder="______"
                                class="border-b-2 border-black/20 outline-none w-32 text-center text-[#630d0d] bg-transparent">
                            <span>and the Project Sanction Committee Meeting dated</span>
                            <input type="text" id="psc_date" placeholder="______"
                                class="border-b-2 border-black/20 outline-none w-32 text-center text-[#630d0d] bg-transparent">
                            <span>the terms of issue are as follows:</span>
                        </div>

                        <ul class="space-y-6 list-none">
                            <li class="flex gap-3"><span>¬∑</span> <span>Investment Instrument ‚Äî CCD</span></li>

                            <li class="flex gap-3">
                                <span>¬∑</span>
                                <div class="space-y-3">
                                    <span class="block">Conversion Terms</span>
                                    <ul class="list-none pl-6 space-y-3 font-medium text-slate-600">
                                        <li class="flex gap-2"><span>o</span> <span>Conversion will be at Discount to
                                                the next round valuation</span></li>
                                        <li class="flex gap-2">
                                            <span>o</span>
                                            <div class="space-y-2">
                                                <span>Discount Structure</span>
                                                <ul class="list-none pl-6 space-y-1">
                                                    <li>¬ß 10% Discount if the Next Fund Raise happens within 12 Months
                                                    </li>
                                                    <li>¬ß 20% Discount if the Next Fund Raise happens within 12-24
                                                        Months</li>
                                                    <li>¬ß 30% Discount if the Next Fund Raise happens within 25-36
                                                        Months</li>
                                                </ul>
                                            </div>
                                        </li>
                                        <li class="flex gap-2"><span>o</span> <span>If the fund raise does not happen
                                                within 36 Months, the valuation of the company will be arrived at by an
                                                independent merchant banker or a certified valuer and conversion of CCD
                                                to equity shares will happen at that valuation.</span></li>
                                        <li class="flex gap-2"><span>o</span> <span>The term ‚ÄúNext Fund Raise‚Äù will mean
                                                a minimum fund raise of an amount equal to that of invested by
                                                TANSIM.</span></li>
                                    </ul>
                                </div>
                            </li>

                            <li class="flex gap-3 items-center">
                                <span>¬∑</span>
                                <span>Total Quantum of Investment ‚Äî ‚Çπ</span>
                                <input type="text" id="quantum_val"
                                    class="border-b border-black w-64 outline-none px-2 text-[#630d0d] bg-transparent"
                                    placeholder="__________________">
                            </li>

                            <li class="flex gap-3">
                                <span>¬∑</span>
                                <div class="space-y-4 w-full">
                                    <span>Investment Tranches:</span>
                                    <div id="tranche-terms-container" class="pl-6 space-y-3 text-slate-600 font-medium">
                                        <div class="flex items-center gap-2" id="term_point_1">
                                            <span>o</span> <span>Tranche 1 ‚Äî ‚Çπ</span>
                                            <input type="text" id="t1_amt"
                                                class="border-b border-slate-300 w-32 outline-none text-center bg-transparent">
                                            <span>at the Closing Dates</span>
                                        </div>
                                        <div class="flex items-center gap-2" id="term_point_2">
                                            <span>o</span> <span>Tranche 2 ‚Äî ‚Çπ</span>
                                            <input type="text" id="t2_amt"
                                                class="border-b border-slate-300 w-32 outline-none text-center bg-transparent">
                                            <span>on fulfilling below milestones</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <li class="flex gap-3">
                                <span>¬∑</span>
                                <div class="w-full">
                                    <span>Milestones to be achieved for the release of Tranches:</span>
                                    <div id="dynamic-milestone-display"
                                        class="mt-4 pl-6 space-y-6 italic text-blue-700 bg-blue-50/50 p-6 rounded-2xl border border-blue-100">
                                        <div id="display_block_t2">
                                            <p
                                                class="font-black text-[10px] uppercase tracking-widest text-blue-400 mb-1">
                                                Milestones for Tranche 2:</p>
                                            <p id="mirror_t2" class="text-[13px] whitespace-pre-wrap font-bold">Pending
                                                input from Section 10.1...</p>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <li class="flex gap-3">
                                <span>¬∑</span>
                                <div class="w-full">
                                    <span>Fund Utilization (Category Summary):</span>
                                    <div
                                        class="mt-4 border-2 border-slate-800 overflow-hidden rounded-xl bg-white shadow-sm">
                                        <table class="w-full text-[11px] text-center border-collapse">
                                            <thead class="bg-slate-800 text-white uppercase text-[9px] font-black">
                                                <tr>
                                                    <th class="p-3 border-r border-slate-700 text-left">Category</th>
                                                    <th class="p-3 border-r border-slate-700">T1 Total</th>
                                                    <th class="p-3 border-r border-slate-700">T2 Total</th>
                                                    <th class="p-3">Grand Total</th>
                                                </tr>
                                            </thead>
                                            <tbody class="font-bold text-slate-700">
                                                <tr class="border-b border-slate-100">
                                                    <td class="p-3 text-left bg-slate-50/50">Capital Expenditure</td>
                                                    <td id="sync-cap-t1">0</td>
                                                    <td id="sync-cap-t2">0</td>
                                                    <td class="bg-slate-50 font-black" id="sync-cap-all">0</td>
                                                </tr>
                                                <tr class="border-b border-slate-100">
                                                    <td class="p-3 text-left bg-slate-50/50">Direct Costs</td>
                                                    <td id="sync-dir-t1">0</td>
                                                    <td id="sync-dir-t2">0</td>
                                                    <td class="bg-slate-50 font-black" id="sync-dir-all">0</td>
                                                </tr>
                                                <tr>
                                                    <td class="p-3 text-left bg-slate-50/50">Indirect Costs</td>
                                                    <td id="sync-ind-t1">0</td>
                                                    <td id="sync-ind-t2">0</td>
                                                    <td class="bg-slate-50 font-black" id="sync-ind-all">0</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="annex1-common-placeholder"
                class="max-w-4xl mx-auto mb-6 p-6 bg-white border border-slate-300 rounded-3xl text-[11px] text-black italic font-bold leading-relaxed hidden-section shadow-xl">
                (Provide in-depth information on the domain, including key trends, challenges, opportunities, and the
                competitive landscape, to offer a comprehensive understanding of the industry and its relevance to the
                business).
            </div>

            <div id="section-ax1_1" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.1: Introduction</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_intro" placeholder="enter data"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax1_2" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.2: Problem Being Addressed</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_problem" placeholder="enter data"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax1_3" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.3: Need for Solution</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_need" placeholder="enter data"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax1_4" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.4: Market Overview</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-10">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Indian
                            Market Overview</label>
                        <textarea id="ax1_mkt_in" placeholder="enter data"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 outline-none font-bold shadow-inner"></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Government
                            Initiatives</label>
                        <textarea id="ax1_govt" placeholder="enter data"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 outline-none font-bold shadow-inner"></textarea>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Global
                            Market Overview</label>
                        <textarea id="ax1_mkt_gl" placeholder="enter data"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 outline-none font-bold shadow-inner"></textarea>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Recent
                            Funding in domain (India/Global)</label>
                        <textarea id="ax1_funding" placeholder="enter data"
                            class="w-full p-6 bg-slate-50 border border-slate-200 rounded-2xl h-44 outline-none font-bold shadow-inner"></textarea>
                    </div>
                </div>
            </div>

            <div id="section-ax1_5" class="max-w-5xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.5: Competition</h2>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 mb-12">
                    <h3 class="text-sm font-black uppercase text-cyan-600 mb-6 tracking-widest">Indian Competitors</h3>
                    <table class="w-full border-collapse border-2 border-black" id="table_ax1_in">
                        <thead class="bg-black text-white text-[9px] uppercase font-black">
                            <tr>
                                <th class="p-3 border-r border-white/20 w-1/4">Company Name</th>
                                <th class="p-3 border-r border-white/20 w-1/2">Details</th>
                                <th class="p-3 w-1/4">Cost</th>
                                <th class="p-3 w-10 no-print"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-black font-bold">
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_name_1"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_in_det_1"
                                        placeholder="Establishment Year:&#10;Business model/ Distribution&#10;Network:&#10;Revenue:&#10;Model/Variant:&#10;Customer Profile/&#10;Segment:"
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_cost_1"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_name_2"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_in_det_2" placeholder="..."
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_cost_2"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_name_3"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_in_det_3" placeholder="..."
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_in_cost_3"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button onclick="addAxRow('table_ax1_in', 'ax1_in')"
                        class="no-print w-full py-3 bg-slate-50 border-x-2 border-b-2 border-black font-black uppercase text-[9px] hover:bg-slate-100">+
                        Add Competitor</button>
                </div>

                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <h3 class="text-sm font-black uppercase text-cyan-600 mb-6 tracking-widest">Global Competitors</h3>
                    <table class="w-full border-collapse border-2 border-black" id="table_ax1_gl">
                        <thead class="bg-black text-white text-[9px] uppercase font-black">
                            <tr>
                                <th class="p-3 border-r border-white/20 w-1/4">Company Name</th>
                                <th class="p-3 border-r border-white/20 w-1/2">Details</th>
                                <th class="p-3 w-1/4">Cost</th>
                                <th class="p-3 w-10 no-print"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-black font-bold">
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_name_1"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_gl_det_1"
                                        placeholder="Establishment Year:&#10;Business model/ Distribution&#10;Network:&#10;Revenue:&#10;Model/Variant:&#10;Customer Profile/&#10;Segment:"
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_cost_1"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_name_2"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_gl_det_2" placeholder="..."
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_cost_2"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                            <tr>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_name_3"
                                        class="w-full p-3 outline-none"></td>
                                <td class="p-0 border-r border-black"><textarea id="ax1_gl_det_3" placeholder="..."
                                        class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                                <td class="p-0 border-r border-black"><input type="text" id="ax1_gl_cost_3"
                                        class="w-full p-3 outline-none"></td>
                                <td class="no-print"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button onclick="addAxRow('table_ax1_gl', 'ax1_gl')"
                        class="no-print w-full py-3 bg-slate-50 border-x-2 border-b-2 border-black font-black uppercase text-[9px] hover:bg-slate-100">+
                        Add Competitor</button>
                </div>
            </div>

            <div id="section-ax1_6" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.6: Market Limiter:</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_limiter" placeholder="enter data"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax1_7" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.7: Conclusion</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_conclusion" placeholder="enter data"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax1_8" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-500 pl-8 tracking-tighter">
                    Annexure 1.8: Reference Links</h2>
                <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10">
                    <textarea id="ax1_refs" placeholder="enter source links / citations"
                        class="w-full p-8 bg-slate-50 border border-slate-200 rounded-[2rem] h-64 focus:ring-2 focus:ring-cyan-500/20 outline-none text-sm text-slate-800 font-bold shadow-inner transition-all"></textarea>
                </div>
            </div>

            <div id="section-ax2" class="max-w-5xl mx-auto hidden-section mb-20">

                <div
                    class="no-print flex justify-between items-center mb-10 bg-white p-5 rounded-[2rem] shadow-xl border border-slate-200">
                    <button onclick="showSection('sec1')"
                        class="text-slate-500 hover:text-[#630d0d] font-black text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all">
                        ‚Üê Return to Report
                    </button>
                    <div class="flex items-center gap-4">
                        <button onclick="document.getElementById('ax2-upload').click()"
                            class="bg-[#630d0d] text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            + Add Document
                        </button>
                        <input type="file" id="ax2-upload" class="hidden" accept="image/*" multiple
                            onchange="handleAx2Upload(event)">
                    </div>
                </div>

                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
                    11. Annexure 2: Patents and Certifications
                </h2>

                <div id="ax2-empty-state"
                    class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200">
                    <span class="text-6xl font-black text-slate-200 uppercase tracking-[0.5em]">NA</span>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-4">No certifications initialized in this
                        portfolio</p>
                </div>

                <div id="ax2-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-10"></div>

            </div>

            <div id="section-ax3" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-emerald-500 pl-8 tracking-tighter">
                    Annexure 3 ‚Äì Site Visit
                </h2>

                <div
                    class="flex gap-4 mb-8 bg-slate-100 p-4 rounded-2xl border border-slate-200 justify-center no-print">
                    <button id="btn_ax3_post" onclick="selectAx3Template('post')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-slate-600 rounded-2xl shadow-md transition-all border-2 border-transparent">
                        Post Incorporation
                    </button>
                    <button id="btn_ax3_pre" onclick="selectAx3Template('pre')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-slate-600 rounded-2xl shadow-md transition-all border-2 border-transparent">
                        Pre Investment
                    </button>
                </div>

                <div id="div_ax3_post" class="hidden space-y-6">
                    <div
                        class="bg-slate-900 text-white p-10 rounded-[3rem] shadow-2xl border-4 border-white/10 italic text-lg leading-relaxed">
                        "The site visit should be done post investment disbursement as there is no entity at present.
                        This would then fall under the ambit of the Post-Investment follow-up mechanism."
                    </div>
                </div>

                <div id="div_ax3_pre"
                    class="hidden bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 space-y-8">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="flex items-center gap-4 border-b border-slate-100 pb-2">
                            <span class="text-[10px] font-black uppercase text-slate-400 w-40">Address and
                                Location:</span>
                            <input type="text" id="ax3_address"
                                class="flex-grow p-2 outline-none font-bold text-slate-800 border-b border-transparent focus:border-emerald-500">
                        </div>
                        <div class="flex items-center gap-4 border-b border-slate-100 pb-2">
                            <span class="text-[10px] font-black uppercase text-slate-400 w-40">Google Pin:</span>
                            <input type="text" id="ax3_pin"
                                class="flex-grow p-2 outline-none font-bold text-slate-800 border-b border-transparent focus:border-emerald-500">
                        </div>
                        <div class="flex items-center gap-4 border-b border-slate-100 pb-2">
                            <span class="text-[10px] font-black uppercase text-slate-400 w-40">Location Details:</span>
                            <input type="text" id="ax3_details"
                                class="flex-grow p-2 outline-none font-bold text-slate-800 border-b border-transparent focus:border-emerald-500">
                        </div>
                        <div class="flex items-center gap-4 border-b border-slate-100 pb-2">
                            <span class="text-[10px] font-black uppercase text-slate-400 w-40">Interaction:</span>
                            <input type="text" id="ax3_interaction"
                                class="flex-grow p-2 outline-none font-bold text-slate-800 border-b border-transparent focus:border-emerald-500">
                        </div>
                    </div>

                    <div class="pt-8 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-900">Site Photos:</h3>
                            <button onclick="document.getElementById('ax3-upload').click()"
                                class="no-print bg-emerald-600 text-white px-5 py-2 rounded-xl text-[10px] font-bold uppercase shadow-lg">+
                                Upload Photo</button>
                            <input type="file" id="ax3-upload" class="hidden" accept="image/*" multiple
                                onchange="handleAx3Upload(event)">
                        </div>
                        <div id="ax3-gallery" class="flex flex-wrap gap-6 justify-center">
                        </div>
                    </div>
                </div>
            </div>
            <div id="section-ax4" class="max-w-4xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-blue-600 pl-8 tracking-tighter">
                    Annexure 4 ‚Äì LinkedIn Profiles
                </h2>

                <div id="ax4-mirror-container" class="space-y-8">
                </div>
            </div>
            <div id="section-ax5" class="max-w-5xl mx-auto hidden-section mb-20">
                <div
                    class="no-print flex justify-between items-center mb-10 bg-white p-5 rounded-[2rem] shadow-xl border border-slate-200">
                    <button onclick="showSection('sec1')"
                        class="text-slate-500 hover:text-[#630d0d] font-black text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all">
                        ‚Üê Return to Report
                    </button>
                    <div class="flex items-center gap-4">
                        <button onclick="document.getElementById('ax5-upload').click()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            + Upload Certificate
                        </button>
                        <input type="file" id="ax5-upload" class="hidden" accept="image/*" multiple
                            onchange="handleAx5Upload(event)">
                    </div>
                </div>

                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-blue-600 pl-8 tracking-tighter">
                    Annexure 5 ‚Äì Community Certificate
                </h2>

                <div id="ax5-empty-state"
                    class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200">
                    <span class="text-6xl font-black text-slate-200 uppercase tracking-[0.5em]">NA</span>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-4">*To be posted as image*</p>
                </div>

                <div id="ax5-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-10">
                </div>
            </div>
            <div id="section-ax6" class="max-w-5xl mx-auto hidden-section mb-20">
                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-amber-500 pl-8 tracking-tighter">
                    Annexure 6 ‚Äì Customer Testimonials
                </h2>

                <div
                    class="flex gap-4 mb-8 bg-slate-100 p-4 rounded-2xl border border-slate-200 justify-center no-print">
                    <button id="btn_ax6_app" onclick="selectAx6Mode('applicable')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-slate-600 rounded-2xl shadow-md transition-all border-2 border-transparent">Applicable</button>
                    <button id="btn_ax6_na" onclick="selectAx6Mode('na')"
                        class="text-[10px] font-black uppercase tracking-widest px-8 py-4 bg-white text-slate-600 rounded-2xl shadow-md transition-all border-2 border-transparent">Not
                        Applicable</button>
                </div>

                <div id="div_ax6_na" class="hidden">
                    <div
                        class="bg-slate-900 text-white p-10 rounded-[3rem] shadow-2xl border-4 border-white/10 italic text-lg leading-relaxed text-center">
                        "The company is in pre-revenue stage/has no notable customers, hence this section is Not
                        Applicable."
                    </div>
                </div>

                <div id="div_ax6_applicable" class="hidden space-y-10">
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm italic text-xs font-bold text-slate-500 border-l-8 border-amber-500">
                        The company has provided the Redwood Team with contact details of key customers.
                    </div>

                    <div id="ax6_master_container" class="space-y-24">
                    </div>

                    <div class="pt-10 border-t border-slate-200">
                        <button onclick="addAx6SegmentBlock()"
                            class="w-full py-6 bg-amber-600 text-white rounded-[2rem] font-black uppercase tracking-widest shadow-xl hover:bg-black transition-all transform hover:scale-[1.02] no-print">
                            + Add New Business Segment Section (Full Block)
                        </button>
                    </div>
                </div>
            </div>
            <div id="section-ax7" class="max-w-5xl mx-auto hidden-section mb-20">
                <div
                    class="no-print flex justify-between items-center mb-10 bg-white p-5 rounded-[2rem] shadow-xl border border-slate-200">
                    <button onclick="showSection('sec1')"
                        class="text-slate-500 hover:text-[#630d0d] font-black text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all">
                        ‚Üê Return to Report
                    </button>
                    <div class="flex items-center gap-4">
                        <div class="text-right mr-4">
                            <p class="text-[9px] font-black uppercase text-slate-400">Logo Guidelines:</p>
                            <p class="text-[8px] font-bold text-slate-500 italic">Square: 5x5cm | Rect: 3x7cm</p>
                        </div>
                        <button onclick="document.getElementById('ax7-upload').click()"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            + Upload Logo
                        </button>
                        <input type="file" id="ax7-upload" class="hidden" accept="image/*" multiple
                            onchange="handleAx7Upload(event)">
                    </div>
                </div>

                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-indigo-600 pl-8 tracking-tighter">
                    Annexure 7 ‚Äì Client Logos
                </h2>

                <div id="ax7-empty-state"
                    class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200">
                    <span class="text-6xl font-black text-slate-200 uppercase tracking-[0.5em]">NA</span>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-4">No logos uploaded yet</p>
                </div>

                <div id="ax7-gallery"
                    class="flex flex-wrap gap-12 justify-center items-end bg-white p-12 rounded-[3rem] shadow-inner border border-slate-100">
                </div>
            </div>

            <div id="section-ax8" class="max-w-5xl mx-auto hidden-section mb-20">
                <div
                    class="no-print flex justify-between items-center mb-10 bg-white p-5 rounded-[2rem] shadow-xl border border-slate-200">
                    <button onclick="showSection('sec1')"
                        class="text-slate-500 hover:text-[#630d0d] font-black text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all">
                        ‚Üê Return to Report
                    </button>
                    <div class="flex items-center gap-4">
                        <button onclick="document.getElementById('ax8-upload').click()"
                            class="bg-rose-600 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            + Upload LOI Document
                        </button>
                        <input type="file" id="ax8-upload" class="hidden" accept="image/*" multiple
                            onchange="handleAx8Upload(event)">
                    </div>
                </div>

                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-rose-600 pl-8 tracking-tighter">
                    Annexure 8 ‚Äì Letter of Intent
                </h2>

                <div id="ax8-empty-state"
                    class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200">
                    <span class="text-6xl font-black text-slate-200 uppercase tracking-[0.5em]">NA</span>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-4">*To be posted as image*</p>
                </div>

                <div id="ax8-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-10">
                </div>
            </div>
            <div id="section-ax9" class="max-w-5xl mx-auto hidden-section mb-20">
                <div
                    class="no-print flex justify-between items-center mb-10 bg-white p-5 rounded-[2rem] shadow-xl border border-slate-200">
                    <button onclick="showSection('sec1')"
                        class="text-slate-500 hover:text-[#630d0d] font-black text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all">
                        ‚Üê Return to Report
                    </button>
                    <div class="flex items-center gap-4">
                        <button onclick="document.getElementById('ax9-upload').click()"
                            class="bg-cyan-600 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            + Upload Capex Quote
                        </button>
                        <input type="file" id="ax9-upload" class="hidden" accept="image/*" multiple
                            onchange="handleAx9Upload(event)">
                    </div>
                </div>

                <h2
                    class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-cyan-600 pl-8 tracking-tighter">
                    Annexure 9 ‚Äì Capital Expenditure Quotations
                </h2>

                <div id="ax9-empty-state"
                    class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200">
                    <span class="text-6xl font-black text-slate-200 uppercase tracking-[0.5em]">NA</span>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-4">*To be posted as image*</p>
                </div>

                <div id="ax9-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-10">
                </div>
            </div>

<div id="section-ax10_guide" class="max-w-5xl mx-auto hidden-section mb-20 print:hidden">
    <h2 class="text-3xl font-extrabold text-amber-500 mb-8 uppercase border-l-[10px] border-amber-500 pl-8 tracking-tighter">
        Annexure 10: User Guide
    </h2>
    
    <div class="bg-amber-50 rounded-[2.5rem] shadow-xl border border-amber-200 p-10 space-y-6">
        <div class="flex items-start gap-4">
            <span class="text-4xl">‚ö†Ô∏è</span>
            <div>
                <h3 class="text-lg font-black text-amber-800 uppercase tracking-widest mb-2">Instructions</h3>
                <p class="text-sm font-bold text-amber-700/80 leading-relaxed">
                    Applicable Annexures/Sections: (this is just a guide for filling this section, delete this section once all particulars are filled in):
                </p>
                <p class="text-xs text-amber-600 mt-2 italic">
                    What type of company is the applicant? Options will be Private Limited Company, Limited Liability Partnership, Partnership, Self-Proprietorship & No Entity formed so far.
                </p>
            </div>
        </div>

        <div class="overflow-hidden rounded-2xl border-2 border-amber-200">
            <table class="w-full text-left border-collapse">
                <thead class="bg-amber-100 text-amber-900 text-[10px] uppercase font-black tracking-widest">
                    <tr>
                        <th class="p-4 border-r border-amber-200 w-1/4">Particulars</th>
                        <th class="p-4">Applicable Annexures/Sections</th>
                    </tr>
                </thead>
                <tbody class="text-xs font-bold text-amber-800 divide-y divide-amber-100">
                    <tr>
                        <td class="p-4 border-r border-amber-100 bg-amber-50/50">Private Limited Company</td>
                        <td class="p-4">ROC Compliances (Private Limited), GST Compliances, Income Tax Compliances (Private Limited Company), ESI & EPF Compliances & Financial Analysis & Bank Statement Analysis</td>
                    </tr>
                    <tr>
                        <td class="p-4 border-r border-amber-100 bg-amber-50/50">Limited Liability Partnership</td>
                        <td class="p-4">ROC Compliances (Limited Liability Partnership), GST Compliances, Income Tax Compliances (Limited Liability Partnership), ESI & EPF Compliances & Financial Analysis & Bank Statement Analysis</td>
                    </tr>
                    <tr>
                        <td class="p-4 border-r border-amber-100 bg-amber-50/50">Partnership</td>
                        <td class="p-4">GST Compliances, Income Tax Compliances (Partnership), ESI & EPF Compliances, & Financial Analysis & Bank Statement Analysis</td>
                    </tr>
                    <tr>
                        <td class="p-4 border-r border-amber-100 bg-amber-50/50">Proprietorship</td>
                        <td class="p-4">GST Compliances, Income Tax Compliances (Proprietorship), ESI & EPF Compliances, & Financial Analysis & Bank Statement Analysis</td>
                    </tr>
                    <tr>
                        <td class="p-4 border-r border-amber-100 bg-amber-50/50">No Entity Formed So Far</td>
                        <td class="p-4">Generally for No Entities Formed so far, none of the above sections shall be applicable. However, in certain cases even if they have been revenue generating despite not having any proper structure of entity, then in such cases Bank Statement Analysis will be the only applicable section. Also, sometimes GST Section can also be part of the Financial Annexure for such businesses.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="section-ax10_1" class="max-w-5xl mx-auto hidden-section mb-20">
    
    <h2 class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
        20.1. Registrations
    </h2>

    <div class="bg-white rounded-[2rem] shadow-xl border border-slate-300 overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-800 text-white text-[12px] uppercase font-bold tracking-widest">
                <tr>
                    <th class="p-4 border-r border-slate-600 w-1/3">Registration Type</th>
                    <th class="p-4">Details / Number</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-300 text-sm font-bold text-slate-900">
                
                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">CIN No</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_cin" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type CIN Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">PAN No of the Company</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_pan" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type PAN Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">TAN No of the Company</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_tan" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type TAN Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">GST No of the Company</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_gst" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type GST Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">Udyam Registration Number</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_udyam" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type Udyam Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">Startup India Registration</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_startup" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type Startup Reg Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">Professional Tax Registration</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_proftax" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type PT Reg Here..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">Shops and Establishment Act Registration</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_shops" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Type Shops Act Details..." 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </td>
                </tr>

                <tr>
                    <td class="p-4 bg-slate-100 border-r border-slate-300">CSR as per Section 135 of companies act 2013</td>
                    <td class="p-2 bg-white">
                        <textarea id="reg_csr" rows="2" 
                        class="w-full p-3 bg-white border-2 border-slate-400 rounded-lg text-black placeholder-slate-500 focus:border-[#630d0d] focus:ring-1 focus:ring-[#630d0d] outline-none shadow-sm"
                        style="min-height: 80px;" 
                        placeholder="Not applicable for TANSIM (applicable only if annual turnover is above 1000 crore or networth of more than 500 crore plus a net profit of more than 5 crore )" 
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">Not Applicable</textarea>
                    </td>
                </tr>

            </tbody>
        </table>
    </div>
</div>


<div id="section-ax10_2" class="max-w-6xl mx-auto hidden-section mb-20">
    
    <h2 class="text-3xl font-extrabold text-slate-900 mb-8 uppercase border-l-[10px] border-[#630d0d] pl-8 tracking-tighter">
        20.2. Regulatory Information
    </h2>

    <div class="mb-12">
        <h3 class="text-xl font-bold text-[#630d0d] mb-4 border-b border-slate-300 pb-2">1. ROC Compliances</h3>
        <p class="text-sm font-bold text-slate-700 mb-4">On verifying the MCA portal, the director details are as follows:</p>

        <input type="hidden" id="dir_row_count" value="3">

        <div class="bg-white rounded-xl shadow-lg border border-slate-300 overflow-hidden">
            <table class="w-full text-left border-collapse" id="director_table">
                <thead class="bg-slate-800 text-white text-[11px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="p-3 border-r border-slate-600 w-12 text-center">Sr.</th>
                        <th class="p-3 border-r border-slate-600">DIN / PAN</th>
                        <th class="p-3 border-r border-slate-600">Name</th>
                        <th class="p-3 border-r border-slate-600">Designation</th>
                        <th class="p-3">Date of Appt</th>
                    </tr>
                </thead>
                <tbody id="director_table_body">
                    </tbody>
            </table>
            
            <div class="bg-slate-100 p-2 flex gap-2 border-t border-slate-300">
                <button onclick="addDirectorRow()" class="bg-[#630d0d] hover:bg-red-800 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wider transition">
                    + Add Director
                </button>
                <button onclick="deleteDirectorRow()" class="bg-slate-300 hover:bg-slate-400 text-slate-700 text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wider transition">
                    - Remove Last
                </button>
            </div>
        </div>
    </div>

    <div class="mb-12">
        <div class="flex items-center gap-4 mb-6 border-b border-slate-300 pb-2">
            <h3 class="text-xl font-bold text-[#630d0d]">2. Associated Companies</h3>
            <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border border-slate-300 shadow-sm">
                <span class="text-xs font-bold text-slate-500 uppercase">As of:</span>
                <input type="text" id="assoc_date_val" class="text-sm font-bold text-slate-900 outline-none w-32 placeholder-slate-400" placeholder="DD/MM/YYYY">
            </div>
        </div>

        <input type="hidden" id="assoc_selection_state" value="">

        <div class="bg-slate-200 p-4 rounded-t-2xl border border-slate-300">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Select Directors who have other companies:</p>
            <div class="flex flex-wrap gap-2" id="assoc_selection_container">
                </div>
        </div>

        <div class="bg-white border-x border-b border-slate-300 p-6 rounded-b-2xl shadow-xl min-h-[100px]" id="assoc_content_area">
            
            <div id="assoc_empty_msg" class="text-center text-slate-400 py-6 font-bold italic">
                Select one or more Directors above to add their details.
            </div>

            <div id="assoc_na_msg" class="hidden text-center py-6">
                <span class="text-4xl block mb-2">üö´</span>
                <p class="text-slate-500 font-bold">Not Applicable</p>
                <p class="text-xs text-slate-400">No associated companies declared.</p>
            </div>

            <div id="assoc_tables_stack" class="space-y-8"></div>

   <div class="mb-12 border-t-[3px] border-slate-200 pt-8">
    
    <h3 class="text-xl font-bold text-[#630d0d] mb-6 flex items-center gap-2">
        <span class="bg-[#630d0d] text-white text-xs px-2 py-1 rounded">PART 3</span> 
        Entity Compliance Status
    </h3>

    <div class="flex gap-4 mb-8">
        <label class="cursor-pointer">
            <input type="radio" name="entity_type" id="ent_type_pvt" value="pvt" class="peer hidden" onchange="switchEntityType('pvt')">
            <div class="px-6 py-3 rounded-lg border-2 border-slate-300 font-bold text-slate-500 peer-checked:border-[#630d0d] peer-checked:bg-[#630d0d] peer-checked:text-white transition-all shadow-sm hover:bg-slate-50 peer-checked:hover:bg-[#630d0d]">
                üè¢ Private Limited
            </div>
        </label>
        
        <label class="cursor-pointer">
            <input type="radio" name="entity_type" id="ent_type_llp" value="llp" class="peer hidden" onchange="switchEntityType('llp')">
            <div class="px-6 py-3 rounded-lg border-2 border-slate-300 font-bold text-slate-500 peer-checked:border-[#630d0d] peer-checked:bg-[#630d0d] peer-checked:text-white transition-all shadow-sm hover:bg-slate-50 peer-checked:hover:bg-[#630d0d]">
                ü§ù LLP
            </div>
        </label>
        
        <label class="cursor-pointer">
            <input type="radio" name="entity_type" id="ent_type_other" value="other" class="peer hidden" onchange="switchEntityType('other')">
            <div class="px-6 py-3 rounded-lg border-2 border-slate-300 font-bold text-slate-500 peer-checked:border-slate-600 peer-checked:bg-slate-600 peer-checked:text-white transition-all shadow-sm hover:bg-slate-50 peer-checked:hover:bg-slate-600">
                ‚≠ï Others
            </div>
        </label>
    </div>

    <div id="entity_content_wrapper" class="hidden">
        
        <div id="table_pvt_ltd" class="hidden bg-white rounded-xl shadow-lg border border-slate-300 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-white text-[11px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="p-4 border-r border-slate-600 w-1/3">Particulars</th>
                        <th class="p-4">Observations</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 text-sm text-slate-800">
                    
                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Directors are associated with any other Private Limited/LLP</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r1" id="pvt_r1_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('pvt_r1', 'no')"> <span class="font-bold">No</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r1" id="pvt_r1_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('pvt_r1', 'yes')"> <span class="font-bold">Yes</span></label>
                            </div>
                            <div id="pvt_r1_content_no" class="hidden text-slate-500 italic">No: The Directors are not associated with any other Company/LLP.</div>
                            
<textarea id="pvt_r1_text" 
    class="hidden w-full p-3 border border-slate-300 rounded text-sm bg-amber-50 focus:ring-1 focus:ring-amber-500 outline-none shadow-inner" 
    style="height: 250px !important; min-height: 250px;" 
    placeholder="Please list out the entities that the individual directors are associated with... (Manual Input Required)"></textarea>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form INC-20A has been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r2" id="pvt_r2_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('pvt_r2', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r2" id="pvt_r2_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('pvt_r2', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="pvt_r2_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form INC-20A was filed on:</span>
                                <input type="date" id="pvt_r2_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="pvt_r2_content_no" class="hidden text-slate-600">
                                No: Form INC-20A has not been filed. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form AOC-04 for the last complete FY had been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r3" id="pvt_r3_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('pvt_r3', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r3" id="pvt_r3_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('pvt_r3', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="pvt_r3_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form AOC-04 was filed on:</span>
                                <input type="date" id="pvt_r3_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="pvt_r3_content_no" class="hidden text-slate-600">
                                No: Form AOC-04 has not been filed. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form MGT-7A for the last complete FY had been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r4" id="pvt_r4_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('pvt_r4', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r4" id="pvt_r4_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('pvt_r4', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="pvt_r4_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form MGT-7A was filed on:</span>
                                <input type="date" id="pvt_r4_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="pvt_r4_content_no" class="hidden text-slate-600">
                                No: Form MGT-7A has not been filed. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form DPT-03 for the last complete FY had been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r5" id="pvt_r5_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('pvt_r5', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pvt_r5" id="pvt_r5_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('pvt_r5', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="pvt_r5_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form DPT-03 was filed on:</span>
                                <input type="date" id="pvt_r5_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="pvt_r5_content_no" class="hidden text-slate-600">
                                No: Form DPT-03 has not been filed. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="table_llp" class="hidden bg-white rounded-xl shadow-lg border border-slate-300 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-white text-[11px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="p-4 border-r border-slate-600 w-1/3">Particulars</th>
                        <th class="p-4">Observations</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 text-sm text-slate-800">
                    
                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether the Partners are associated with any other Private Limited/LLP entity</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r1" id="llp_r1_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('llp_r1', 'no')"> <span class="font-bold">No</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r1" id="llp_r1_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('llp_r1', 'yes')"> <span class="font-bold">Yes</span></label>
                            </div>
                            <div id="llp_r1_content_no" class="hidden text-slate-500 italic">No: The Partners are not associated with any other Pvt Ltd/LLP.</div>
                            
                          <textarea id="llp_r1_text" 
    class="hidden w-full p-3 border border-slate-300 rounded text-sm bg-amber-50 focus:ring-1 focus:ring-amber-500 outline-none shadow-inner" 
    style="height: 250px !important; min-height: 250px;" 
    placeholder="Please list out the entities that the individual partners are associated with..."></textarea>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether filed copy of FiLLip was provided?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r2" id="llp_r2_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('llp_r2', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r2" id="llp_r2_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('llp_r2', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="llp_r2_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form FiLLip was filed on:</span>
                                <input type="date" id="llp_r2_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="llp_r2_content_no" class="hidden text-slate-600">
                                No: Filed copy of Form FiLLip has not been provided. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether filed copy of RUN LLP was provided?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r3" id="llp_r3_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('llp_r3', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r3" id="llp_r3_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('llp_r3', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="llp_r3_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form RUN LLP was filed on:</span>
                                <input type="date" id="llp_r3_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="llp_r3_content_no" class="hidden text-slate-600">
                                No: Filed copy of Form RUN LLP has not been provided. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form 3 has been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r4" id="llp_r4_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('llp_r4', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r4" id="llp_r4_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('llp_r4', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="llp_r4_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form 3 was filed on:</span>
                                <input type="date" id="llp_r4_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="llp_r4_content_no" class="hidden text-slate-600">
                                No: Filed copy of Form 3 has not been provided. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200">Whether Form 8 & Form 11 have been filed?</td>
                        <td class="p-4">
                            <div class="flex gap-4 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r5" id="llp_r5_yes" value="yes" class="accent-[#630d0d]" onchange="toggleRow('llp_r5', 'yes')"> <span class="font-bold">Yes</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="llp_r5" id="llp_r5_no" value="no" class="accent-[#630d0d]" onchange="toggleRow('llp_r5', 'no')"> <span class="font-bold">No</span></label>
                            </div>
                            <div id="llp_r5_content_yes" class="hidden items-center gap-2 text-slate-700">
                                <span>Form 8 & 11 filed on:</span>
                                <input type="date" id="llp_r5_date" class="border border-slate-300 rounded px-2 py-1 text-xs font-bold text-[#630d0d]">
                            </div>
                            <div id="llp_r5_content_no" class="hidden text-slate-600">
                                No: Filed copies have not been provided. <span class="font-extrabold text-[#630d0d]">This is being flagged for consideration under the FDD/LDD process.</span>
                            </div>
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>

    </div>
</div>
</div>

<script>
// --- 1. GLOBAL WATCHER ---
setInterval(() => {
    const countInput = document.getElementById('dir_row_count');
    const tbody = document.getElementById('director_table_body');
    
    if (countInput && tbody) {
        // Default to 1 if empty/invalid
        const dbCount = parseInt(countInput.value) || 1;
        const currentRows = tbody.children.length;

        // Auto-Build missing rows
        if (dbCount > currentRows) {
            for (let i = currentRows + 1; i <= dbCount; i++) {
                createDirectorRowHTML(i);
            }
            refreshSelectionButtons();
        }
    }
}, 1000);

// --- 2. DIRECTOR TABLE LOGIC ---

function initDirectorTable() {
    const tbody = document.getElementById('director_table_body');
    const countInput = document.getElementById('dir_row_count');
    if(!tbody || !countInput) return;

    let count = parseInt(countInput.value);
    // üî• CHANGE: Minimum is now 1 (was 3)
    if (isNaN(count) || count < 1) { count = 1; countInput.value = 1; }

    if(tbody.children.length < count) {
        tbody.innerHTML = '';
        for(let i=1; i<=count; i++) {
            createDirectorRowHTML(i);
        }
    }
    
    // Initial Load
    setTimeout(() => {
        refreshSelectionButtons();
        rehydrateDynamicData();
    }, 100);
}

function createDirectorRowHTML(idx) {
    const tbody = document.getElementById('director_table_body');
    const tr = document.createElement('tr');
    tr.className = "border-b border-slate-200 hover:bg-slate-50 transition";
    
    tr.innerHTML = `
        <td class="p-3 text-center font-mono text-xs font-bold text-slate-500 bg-slate-50 border-r border-slate-200">${idx}</td>
        <td class="p-2"><input type="text" id="dir_${idx}_din" class="w-full text-sm font-bold text-slate-900 outline-none bg-transparent" placeholder="Enter DIN/PAN"></td>
        <td class="p-2"><input type="text" id="dir_${idx}_name" class="w-full text-sm font-bold text-slate-900 outline-none bg-transparent" placeholder="Enter Name" oninput="syncName('${idx}')"></td>
        <td class="p-2"><input type="text" id="dir_${idx}_desig" class="w-full text-sm font-bold text-slate-900 outline-none bg-transparent" placeholder="Designation"></td>
        <td class="p-2"><input type="text" id="dir_${idx}_date" class="w-full text-sm font-bold text-slate-900 outline-none bg-transparent" placeholder="DD/MM/YYYY"></td>
    `;
    tbody.appendChild(tr);
}

// Instant Name Sync
window.syncName = function(idx) {
    const nameInput = document.getElementById(`dir_${idx}_name`);
    const val = (nameInput && nameInput.value) ? nameInput.value : `Director ${idx}`;
    const btnText = document.getElementById(`btn_text_dir_${idx}`);
    if(btnText) btnText.innerText = val;
    const headerText = document.getElementById(`header_name_dir_${idx}`);
    if(headerText) headerText.innerText = val;
};

window.addDirectorRow = function() {
    const countInput = document.getElementById('dir_row_count');
    // Default to 1 if empty
    let newCount = (parseInt(countInput.value) || 1) + 1;
    countInput.value = newCount;
    countInput.dispatchEvent(new Event('input', { bubbles: true })); 
    createDirectorRowHTML(newCount); 
    refreshSelectionButtons();
};

window.deleteDirectorRow = function() {
    const countInput = document.getElementById('dir_row_count');
    const tbody = document.getElementById('director_table_body');
    let count = parseInt(countInput.value) || 1;
    
    // üî• CHANGE: Allow deleting down to 1
    if(count > 1 && tbody.lastElementChild) {
        const inputs = tbody.lastElementChild.querySelectorAll('input');
        inputs.forEach(i => { i.value = ""; i.dispatchEvent(new Event('input', {bubbles:true})); });
        
        tbody.lastElementChild.remove();
        countInput.value = count - 1;
        countInput.dispatchEvent(new Event('input', { bubbles: true })); 
        refreshSelectionButtons();
    } else {
        alert("Minimum 1 row required.");
    }
};

// --- 3. MULTI-SELECT LOGIC ---

window.refreshSelectionButtons = function() {
    const container = document.getElementById('assoc_selection_container');
    const count = parseInt(document.getElementById('dir_row_count').value) || 1;
    const stateInput = document.getElementById('assoc_selection_state');
    
    const rawVal = stateInput.value || "";
    const selectedList = rawVal.split(',').filter(Boolean);
    const isNA = selectedList.includes('NA');

    let html = `
        <button onclick="toggleAssoc('NA')" 
            class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition border shadow-sm flex items-center gap-2
            ${isNA ? 'bg-slate-800 text-white border-slate-900 ring-2 ring-slate-400' : 'bg-white text-slate-500 border-slate-300 hover:bg-slate-50'}">
            ${isNA ? '‚úÖ' : '‚¨ú'} Not Applicable
        </button>
        <div class="w-px bg-slate-300 mx-2"></div>
    `;

    for(let i=1; i<=count; i++) {
        const nameEl = document.getElementById(`dir_${i}_name`);
        const nameVal = (nameEl && nameEl.value) ? nameEl.value : `Director ${i}`;
        const tabId = `dir_${i}`;
        const isSelected = selectedList.includes(tabId);
        
        html += `
            <button onclick="toggleAssoc('${tabId}')" 
                class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition border shadow-sm flex items-center gap-2
                ${isSelected ? 'bg-[#630d0d] text-white border-red-900 ring-2 ring-red-300' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}">
                ${isSelected ? '‚úÖ' : '‚¨ú'} <span id="btn_text_dir_${i}" class="truncate max-w-[100px]">${nameVal}</span>
            </button>
        `;
    }
    container.innerHTML = html;
};

window.toggleAssoc = function(id) {
    const stateInput = document.getElementById('assoc_selection_state');
    let currentList = stateInput.value.split(',').filter(Boolean);
    const stack = document.getElementById('assoc_tables_stack');
    const naMsg = document.getElementById('assoc_na_msg');
    const emptyMsg = document.getElementById('assoc_empty_msg');

    if(id === 'NA') {
        currentList = ['NA'];
        stack.innerHTML = ''; 
    } else {
        if(currentList.includes('NA')) currentList = [];
        
        if(currentList.includes(id)) {
            currentList = currentList.filter(x => x !== id);
            const wrapper = document.getElementById(`wrapper_${id}`);
            if(wrapper) {
                // Wipe data
                wrapper.querySelectorAll('input').forEach(i => { i.value = ""; i.dispatchEvent(new Event('input', {bubbles:true})); });
                wrapper.remove();
            }
        } else {
            currentList.push(id);
            renderAssocTable(id);
        }
    }

    stateInput.value = currentList.join(',');
    stateInput.dispatchEvent(new Event('input', { bubbles: true }));
    
    refreshSelectionButtons();
    
    if(currentList.includes('NA')) {
        naMsg.classList.remove('hidden');
        emptyMsg.classList.add('hidden');
    } else if (currentList.length === 0) {
        naMsg.classList.add('hidden');
        emptyMsg.classList.remove('hidden');
    } else {
        naMsg.classList.add('hidden');
        emptyMsg.classList.add('hidden');
    }
};

function renderAssocTable(dirId) {
    const stack = document.getElementById('assoc_tables_stack');
    if(document.getElementById(`wrapper_${dirId}`)) return;

    const idx = dirId.split('_')[1];
    const nameEl = document.getElementById(`dir_${idx}_name`);
    const name = nameEl ? nameEl.value : `Director ${idx}`;

    const wrapper = document.createElement('div');
    wrapper.id = `wrapper_${dirId}`;
    wrapper.className = "border border-slate-200 rounded-xl p-4 bg-slate-50 shadow-sm transition-all";
    
    wrapper.innerHTML = `
        <div class="flex justify-between items-end mb-4 border-b border-slate-200 pb-2">
            <div>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Associated Companies For:</span>
                <h4 class="text-xl font-extrabold text-[#630d0d] mt-1" id="header_name_${dirId}">${name}</h4>
            </div>
            <div class="flex gap-2">
                <button onclick="addAssocRow('${dirId}')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold px-3 py-1 rounded shadow">+ Add Row</button>
                <button onclick="delAssocRow('${dirId}')" class="bg-slate-300 hover:bg-slate-400 text-slate-700 text-[10px] font-bold px-3 py-1 rounded shadow">- Remove</button>
            </div>
        </div>
        
        <input type="hidden" id="cnt_${dirId}_rows" value="2">
        <div class="overflow-x-auto bg-white border border-slate-200 rounded-lg">
            <table class="w-full text-left border-collapse min-w-[600px]">
                <thead class="bg-slate-100 text-slate-600 text-[10px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="p-2 border-r border-slate-200 w-10 text-center">Sr.</th>
                        <th class="p-2 border-r border-slate-200">CIN/LLPIN</th>
                        <th class="p-2 border-r border-slate-200">Company Name</th>
                        <th class="p-2 border-r border-slate-200">Designation</th>
                        <th class="p-2 border-r border-slate-200">Appt Date</th>
                        <th class="p-2">Status</th>
                    </tr>
                </thead>
                <tbody id="tbody_${dirId}"></tbody>
            </table>
        </div>
    `;
    stack.appendChild(wrapper);

    // Initial default rows - can be deleted down to 1 later
    rebuildAssocRows(dirId, 2); 
}

function rebuildAssocRows(tabId, count) {
    const tbody = document.getElementById(`tbody_${tabId}`);
    const counter = document.getElementById(`cnt_${tabId}_rows`);
    if(counter) counter.value = count;
    if(!tbody) return;
    
    const current = tbody.children.length;
    
    if (count > current) {
         for(let i=current+1; i<=count; i++) {
            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-100 hover:bg-slate-50";
            tr.innerHTML = `
                <td class="p-2 text-center text-xs font-mono text-slate-400 border-r border-slate-200">${i}</td>
                <td class="p-1"><input id="asc_${tabId}_r${i}_cin" class="w-full text-xs font-bold p-1 bg-transparent outline-none" placeholder="CIN/LLPIN"></td>
                <td class="p-1"><input id="asc_${tabId}_r${i}_name" class="w-full text-xs font-bold p-1 bg-transparent outline-none" placeholder="Company Name"></td>
                <td class="p-1"><input id="asc_${tabId}_r${i}_desig" class="w-full text-xs font-bold p-1 bg-transparent outline-none" placeholder="Designation"></td>
                <td class="p-1"><input id="asc_${tabId}_r${i}_date" class="w-full text-xs font-bold p-1 bg-transparent outline-none" placeholder="Date"></td>
                <td class="p-1"><input id="asc_${tabId}_r${i}_stat" class="w-full text-xs font-bold p-1 bg-transparent text-slate-500 outline-none" placeholder="(Active/Inactive)"></td>
            `;
            tbody.appendChild(tr);
         }
    } else if (count < current) {
         while (tbody.children.length > count) {
            tbody.lastElementChild.remove();
         }
    }
}

window.addAssocRow = function(tabId) {
    const counter = document.getElementById(`cnt_${tabId}_rows`);
    let c = (parseInt(counter?.value) || 2) + 1;
    counter.value = c; 
    counter.dispatchEvent(new Event('input', { bubbles: true }));
    rebuildAssocRows(tabId, c);
};

window.delAssocRow = function(tabId) {
    const counter = document.getElementById(`cnt_${tabId}_rows`);
    let c = parseInt(counter?.value) || 2;
    // üî• CHANGE: Allow deleting down to 1 (was 2)
    if(c > 1) {
        const tbody = document.getElementById(`tbody_${tabId}`);
        tbody.lastElementChild.querySelectorAll('input').forEach(i => { i.value = ""; i.dispatchEvent(new Event('input', {bubbles:true})); });
        counter.value = c - 1;
        counter.dispatchEvent(new Event('input', { bubbles: true }));
        rebuildAssocRows(tabId, c - 1);
    } else {
        alert("Minimum 1 row required.");
    }
};

window.rehydrateDynamicData = async function() {
    if (!window.currentCloudId || !window.currentModuleId) return;
    
    document.getElementById('assoc_tables_stack').innerHTML = '';
    document.getElementById('assoc_selection_state').value = '';
    document.getElementById('assoc_na_msg').classList.add('hidden');
    document.getElementById('assoc_empty_msg').classList.remove('hidden');

    try {
        const docRef = window.doc(window.db, "shared", window.currentCloudId, "ims", window.currentModuleId);
        const snap = await window.getDoc(docRef);
        if (snap.exists()) {
            const data = snap.data().data || snap.data();

            if (data['assoc_selection_state']) {
                document.getElementById('assoc_selection_state').value = data['assoc_selection_state'];
                const selectedIds = data['assoc_selection_state'].split(',').filter(Boolean);
                
                if(data['assoc_selection_state'] === 'NA') {
                    document.getElementById('assoc_na_msg').classList.remove('hidden');
                    document.getElementById('assoc_empty_msg').classList.add('hidden');
                } else {
                    document.getElementById('assoc_na_msg').classList.add('hidden');
                    document.getElementById('assoc_empty_msg').classList.add('hidden');
                }

                selectedIds.forEach(id => {
                    if (id !== 'NA') {
                        renderAssocTable(id);
                        if (data[`cnt_${id}_rows`]) {
                            rebuildAssocRows(id, parseInt(data[`cnt_${id}_rows`]));
                        }
                    }
                });
            }

            document.querySelectorAll('#director_table_body input, #assoc_tables_stack input, #assoc_selection_state').forEach(input => {
                if (data[input.id]) input.value = data[input.id];
            });

            refreshSelectionButtons();
            const dirCount = parseInt(document.getElementById('dir_row_count').value) || 1;
            for(let i=1; i<=dirCount; i++) { syncName(i); }
        }
    } catch (e) { console.error("Hydration Error:", e); }
};

window.refreshRegulatorySection = function() {
    initDirectorTable();
};


// this is for pvt ltd and llp table
// --- PART 3: ENTITY COMPLIANCE LOGIC ---

// 1. Switch between Pvt Ltd / LLP / Others
window.switchEntityType = function(type) {
    const wrapper = document.getElementById('entity_content_wrapper');
    const pvtTable = document.getElementById('table_pvt_ltd');
    const llpTable = document.getElementById('table_llp');

    // 1. UI Logic (Show/Hide Tables)
    if(type === 'other') {
        if(wrapper) wrapper.classList.add('hidden');
        if(pvtTable) pvtTable.classList.add('hidden');
        if(llpTable) llpTable.classList.add('hidden');
    } else {
        if(wrapper) wrapper.classList.remove('hidden');
        if(type === 'pvt') {
            if(pvtTable) pvtTable.classList.remove('hidden');
            if(llpTable) llpTable.classList.add('hidden');
        } else if(type === 'llp') {
            if(pvtTable) pvtTable.classList.add('hidden');
            if(llpTable) llpTable.classList.remove('hidden');
        }
    }

    // 2. DIRECT CLOUD SAVE (Fixes the issue)
    if (window.currentCloudId && window.updateDoc && window.db) {
        const docRef = window.doc(window.db, "projects", window.currentCloudId);
        window.updateDoc(docRef, {
            "data.entity_type": type
        }).then(() => console.log("‚úÖ Saved Entity Type:", type))
          .catch(e => console.error("‚ùå Save Failed:", e));
        
        // Update local memory so it doesn't flicker
        if(!window.lastSavedValues) window.lastSavedValues = {};
        window.lastSavedValues['entity_type'] = type;
    }
};

window.toggleRow = function(rowId, status) {
    const contentYes = document.getElementById(`${rowId}_content_yes`);
    const contentNo = document.getElementById(`${rowId}_content_no`);
    const textArea = document.getElementById(`${rowId}_text`);

    // 1. UI Logic (Hide all first)
    if(contentYes) contentYes.classList.add('hidden');
    if(contentNo) contentNo.classList.add('hidden');
    if(textArea) textArea.classList.add('hidden');

    // 2. Logic for Specific Question Types
    if(rowId === 'pvt_r1' || rowId === 'llp_r1') {
        // Special case for the first question (Text Area)
        if(status === 'yes') {
            if(textArea) textArea.classList.remove('hidden');
        } else {
            if(contentNo) contentNo.classList.remove('hidden');
        }
    } else {
        // Standard Yes/No questions
        if(status === 'yes') {
            if(contentYes) {
                contentYes.classList.remove('hidden');
                contentYes.classList.add('flex');
            }
        } else {
            if(contentNo) contentNo.classList.remove('hidden');
        }
    }

    // 3. DIRECT CLOUD SAVE (Fixes the issue)
    if (window.currentCloudId && window.updateDoc && window.db) {
        const docRef = window.doc(window.db, "projects", window.currentCloudId);
        window.updateDoc(docRef, {
            [`data.${rowId}`]: status
        }).then(() => console.log(`‚úÖ Saved ${rowId}:`, status))
          .catch(e => console.error("‚ùå Save Failed:", e));

        // Update local memory
        if(!window.lastSavedValues) window.lastSavedValues = {};
        window.lastSavedValues[rowId] = status;
    }
};
// --- REHYDRATION UPDATE (INCLUDES PART 3) ---
// REPLACE your existing rehydrateDynamicData with this one.

window.rehydrateDynamicData = async function() {
    if (!window.currentCloudId || !window.currentModuleId) return;
    
    // Part 2 Reset
    document.getElementById('assoc_tables_stack').innerHTML = '';
    document.getElementById('assoc_selection_state').value = '';
    document.getElementById('assoc_na_msg').classList.add('hidden');
    document.getElementById('assoc_empty_msg').classList.remove('hidden');

    try {
        const docRef = window.doc(window.db, "shared", window.currentCloudId, "ims", window.currentModuleId);
        const snap = await window.getDoc(docRef);
        if (snap.exists()) {
            const data = snap.data().data || snap.data();

            // --- RESTORE PART 2 (ASSOCIATED COMPANIES) ---
            if (data['assoc_selection_state']) {
                document.getElementById('assoc_selection_state').value = data['assoc_selection_state'];
                const selectedIds = data['assoc_selection_state'].split(',').filter(Boolean);
                
                if(data['assoc_selection_state'] === 'NA') {
                    document.getElementById('assoc_na_msg').classList.remove('hidden');
                    document.getElementById('assoc_empty_msg').classList.add('hidden');
                } else {
                    document.getElementById('assoc_na_msg').classList.add('hidden');
                    document.getElementById('assoc_empty_msg').classList.add('hidden');
                }

                selectedIds.forEach(id => {
                    if (id !== 'NA') {
                        renderAssocTable(id);
                        if (data[`cnt_${id}_rows`]) {
                            rebuildAssocRows(id, parseInt(data[`cnt_${id}_rows`]));
                        }
                    }
                });
            }

            // --- RESTORE PART 3 (ENTITY COMPLIANCE) ---
            // 1. Restore Entity Type Selection
            if(data['entity_type']) {
                const radio = document.querySelector(`input[name="entity_type"][value="${data['entity_type']}"]`);
                if(radio) {
                    radio.checked = true;
                    switchEntityType(data['entity_type']);
                }
            }

            // 2. Restore Row Toggles (Yes/No)
            // We loop through known row IDs and trigger the toggle logic based on saved radio value
            const pvtRows = ['pvt_r1', 'pvt_r2', 'pvt_r3', 'pvt_r4', 'pvt_r5'];
            const llpRows = ['llp_r1', 'llp_r2', 'llp_r3', 'llp_r4', 'llp_r5'];
            const allRows = [...pvtRows, ...llpRows];

            allRows.forEach(rowId => {
                if(data[rowId]) { // if 'pvt_r1': 'yes' is saved
                    const radio = document.querySelector(`input[name="${rowId}"][value="${data[rowId]}"]`);
                    if(radio) {
                        radio.checked = true;
                        toggleRow(rowId, data[rowId]);
                    }
                }
            });


            // --- GLOBAL INPUT FILL ---
            document.querySelectorAll('input, textarea').forEach(input => {
                // Skip radios as we handled them above manually
                if (input.type !== 'radio' && data[input.id]) {
                    input.value = data[input.id];
                }
            });

            // UI Syncs
            refreshSelectionButtons();
            const dirCount = parseInt(document.getElementById('dir_row_count').value) || 1;
            for(let i=1; i<=dirCount; i++) { if(window.syncName) window.syncName(i); }
        }
    } catch (e) { console.error("Hydration Error:", e); }
};
</script>



        </div>
    </main>
    <aside id="audit-sidebar"
        class="w-80 bg-slate-900 border-l border-white/10 flex flex-col shadow-2xl no-print hidden">
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
            <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-white/40">Audit History</h2>
            <button onclick="toggleAudit()" class="text-white/20 hover:text-white transition text-lg">‚úï</button>
        </div>
        <div id="history-list" class="flex-grow overflow-y-auto p-4 space-y-2 custom-scrollbar text-white">
            <p class="text-[10px] text-white/20 italic text-center mt-10">No recent changes detected...</p>
        </div>
    </aside>
    <aside id="comments-sidebar"
        class="w-80 bg-white border-l border-slate-200 flex flex-col shadow-inner no-print hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400">Project Threads</h2>
            <button onclick="toggleComments()" class="text-slate-300 hover:text-slate-600 transition text-lg">‚úï</button>
        </div>
        <div id="comments-list" class="flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar">
        </div>
    </aside>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, deleteDoc, // <--- Added getDocs here
            onSnapshot, serverTimestamp, updateDoc, deleteField,
            query, where, orderBy, limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA27h_fYu77kJlQImyMUixB6AlA664m8bM",
            authDomain: "investment-memo-46d06.firebaseapp.com",
            projectId: "investment-memo-46d06",
            storageBucket: "investment-memo-46d06.firebasestorage.app",
            messagingSenderId: "705576611116",
            appId: "1:705576611116:web:8c3ef5dbd56d33c1495089",
            measurementId: "G-FCTP59EQD1",
            databaseURL: "https://investment-memo-46d06-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app); 

        // Expose Firebase functions globally
        window.db = db;
        window.auth = auth;
        window.rtdb = rtdb; // Added this to be safe
        
        // Firestore Tools
        window.getDocs = getDocs; // <--- CRITICAL FIX: Now the dashboard can read lists
        window.addDoc = addDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.deleteField = deleteField;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        
        // Auth & Realtime Tools
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;

        window.isProjectLoading = false;
        let auditUnsubscribe = null;


        let trancheCount = 1;        // Counter for Section 1 Tranches
        let milestoneCount = 2;      // Counter for Section 1 Milestones (Starts at 2)
        let currentTrancheCount = 2; // Counter for Section 10 Columns
        let founderCount = 1;        // Counter for Section 8 Founder
        let ax6SegmentCount = 0;
        let ax6CustomerCount = 0;

        window.addTrancheColumn = async () => {
            currentTrancheCount++;
            const table = document.getElementById('util-table');
            const headerRow = table.querySelector('thead tr');


            // 1. ADD HEADER
            const th = document.createElement('th');
            th.className = "p-4 border border-slate-600 tranche-head";
            th.setAttribute('data-t', currentTrancheCount);
            th.innerText = `Tranche ${currentTrancheCount} (‚Çπ)`;
            headerRow.insertBefore(th, headerRow.querySelector('.total-col-head'));


            // 2. ADD CELLS TO EVERY DATA ROW
            document.querySelectorAll('.util-row').forEach((row) => {
                const td = document.createElement('td');
                td.className = `p-0 border border-slate-300 cell-t${currentTrancheCount}`;
                td.setAttribute('data-t', currentTrancheCount);

                const cat = row.dataset.cat;
                const rowInCat = Array.from(document.querySelectorAll(`.util-row[data-cat="${cat}"]`)).indexOf(row) + 1;
                const cellId = `util_${cat}_name_${rowInCat}_t${currentTrancheCount}`;

                // REPLACE THE LINE BELOW WITH THE ONE YOU HAVE:
                td.innerHTML = `<input type="number" id="${cellId}" oninput="window.calcUtilTable()" class="val-t${currentTrancheCount} w-full p-3 text-center outline-none font-bold bg-transparent text-slate-900">`;

                row.insertBefore(td, row.querySelector('.row-total'));
            });

            // ... rest of the function

            // 3. ADD CELL TO THE FOOTER (The Grand Total Row)
            const footerRow = table.querySelector('tfoot tr');
            if (footerRow) {
                const footTd = document.createElement('td');
                footTd.className = "p-4 border border-white/10 text-center";
                footTd.id = `foot-t${currentTrancheCount}`; // Crucial for Math
                footTd.setAttribute('data-t', currentTrancheCount); // Crucial for Deletion
                footTd.innerText = "0";
                footerRow.insertBefore(footTd, document.getElementById('foot-total-all'));
            }

            // 4. ADD COLUMN TO SECTION 10.3 (Recommendation Table)
            const syncHeaderRow = document.querySelector('#section-trans103 thead tr');
            if (syncHeaderRow) {
                const syncTh = document.createElement('th');
                syncTh.className = "p-3 border-r border-slate-700 tranche-sync-head";
                syncTh.setAttribute('data-t', currentTrancheCount);
                syncTh.innerText = `T${currentTrancheCount} Total`;
                syncHeaderRow.insertBefore(syncTh, syncHeaderRow.lastElementChild);
            }

            ['cap', 'dir', 'ind'].forEach(cat => {
                const syncAllCell = document.getElementById(`sync-${cat}-all`);
                if (syncAllCell) {
                    const syncRow = syncAllCell.parentElement;
                    const newSyncCell = document.createElement('td');
                    newSyncCell.id = `sync-${cat}-t${currentTrancheCount}`; // Crucial for Math
                    newSyncCell.setAttribute('data-t', currentTrancheCount);
                    newSyncCell.className = "p-3 border border-slate-100";
                    newSyncCell.innerText = "0";
                    syncRow.insertBefore(newSyncCell, syncAllCell);
                }
            });

            // 5. UPDATE COLSPANS & CLOUD
            const newColspan = currentTrancheCount + 2;
            document.querySelectorAll('#util-body tr:not(.util-row):not(.no-print) td').forEach(td => {
                td.colSpan = newColspan;
            });

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.tranche_count": currentTrancheCount });
            }

            if (window.calcUtilTable) window.calcUtilTable();
        };
        window.syncAnnex4 = () => {
            const container = document.getElementById('ax4-mirror-container');
            if (!container) return;

            // 1. Identify all active founder blocks from Section 8.2
            const founderHeads = document.querySelectorAll('[id^="gov_82_head_"]');

            founderHeads.forEach((head) => {
                const idNum = head.id.split('_').pop();
                let ax4Block = document.getElementById(`ax4_block_${idNum}`);

                // 2. Create the exact Design Block if it doesn't exist
                if (!ax4Block) {
                    ax4Block = document.createElement('div');
                    ax4Block.id = `ax4_block_${idNum}`;
                    ax4Block.className = "bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative mb-12 transition-all dynamic-ax4-block";
                    ax4Block.innerHTML = `
                            <div class="absolute -left-4 top-10 w-12 h-12 bg-black rounded-2xl flex items-center justify-center shadow-xl">
                                <span class="text-white font-black text-xl">${idNum}</span>
                            </div>
    
                            <p id="ax4_mirror_name_${idNum}" class="w-full mb-6 text-xs font-black text-slate-900 uppercase bg-slate-100 p-4 rounded-xl border-none outline-none shadow-inner"></p>
    
                            <div class="flex items-center gap-3 bg-blue-50 p-4 rounded-xl border border-blue-100 mb-8 shadow-sm">
                                <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">LinkedIn Profile:</span>
                                <input type="url" id="ax4_linkedin_${idNum}" oninput="window.autoSave(event)" 
                                    placeholder="https://linkedin.com/in/username" 
                                    class="flex-grow bg-transparent outline-none text-xs font-bold text-slate-700 border-b border-blue-200 focus:border-blue-500 transition-all">
                            </div>
    
                            <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Education Background</h4>
                            <table class="w-full border-collapse border-2 border-black mb-8 rounded-xl overflow-hidden">
                                <thead class="bg-black text-white text-[9px] uppercase font-black">
                                    <tr>
                                        <th class="p-3 border-r border-white/20 text-left">Name of the Institute</th>
                                        <th class="p-3 border-r border-white/20 w-24 text-center">Start Year</th>
                                        <th class="p-3 w-24 text-center">End Year</th>
                                    </tr>
                                </thead>
                                <tbody id="ax4_edu_body_${idNum}" class="divide-y divide-black font-bold text-sm text-slate-800 bg-white">
                                </tbody>
                            </table>
    
                            <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Work Experience</h4>
                            <table class="w-full border-collapse border-2 border-black rounded-xl overflow-hidden">
                                <thead class="bg-black text-white text-[9px] uppercase font-black">
                                    <tr>
                                        <th class="p-3 border-r border-white/20 text-left">Name of Organization</th>
                                        <th class="p-3 border-r border-white/20 text-left">Role</th>
                                        <th class="p-3 w-24 text-center">Years</th>
                                    </tr>
                                </thead>
                                <tbody id="ax4_work_body_${idNum}" class="divide-y divide-black font-bold text-sm text-slate-800 bg-white">
                                </tbody>
                            </table>
                        `;
                    container.appendChild(ax4Block);

                    // Populate LinkedIn field from saved data if existing
                    if (window.lastSavedValues?.[`ax4_linkedin_${idNum}`]) {
                        document.getElementById(`ax4_linkedin_${idNum}`).value = window.lastSavedValues[`ax4_linkedin_${idNum}`];
                    }
                }

                // 3. LIVE MIRRORING: Copy text content from Section 8.2 to Annex 4
                const mirrorName = document.getElementById(`ax4_mirror_name_${idNum}`);
                if (mirrorName) mirrorName.innerText = head.value || `Founder ${idNum} Profile`;

                // Sync Education Rows
                const eduBody = document.getElementById(`ax4_edu_body_${idNum}`);
                if (eduBody) {
                    // Find all institute inputs for this founder
                    const instInputs = document.querySelectorAll(`[id^="gov_82_e${idNum}_inst"]`);
                    eduBody.innerHTML = Array.from(instInputs).map((input, idx) => {
                        const rowId = input.id.split('_').pop().replace('inst', '');
                        const start = document.getElementById(`gov_82_e${idNum}_start${rowId}`)?.value || "-";
                        const end = document.getElementById(`gov_82_e${idNum}_end${rowId}`)?.value || "-";
                        if (!input.value && start === "-" && end === "-") return ''; // Skip empty rows
                        return `<tr>
                                <td class="p-3 border-r border-black font-bold">${input.value || "---"}</td>
                                <td class="p-3 border-r border-black text-center">${start}</td>
                                <td class="p-3 text-center">${end}</td>
                            </tr>`;
                    }).join('');
                }

                // Sync Work Experience Rows
                const workBody = document.getElementById(`ax4_work_body_${idNum}`);
                if (workBody) {
                    const orgInputs = document.querySelectorAll(`[id^="gov_82_w${idNum}_org"]`);
                    workBody.innerHTML = Array.from(orgInputs).map((input, idx) => {
                        const rowId = input.id.split('_').pop().replace('org', '');
                        const role = document.getElementById(`gov_82_w${idNum}_role${rowId}`)?.value || "-";
                        const year = document.getElementById(`gov_82_w${idNum}_year${rowId}`)?.value || "-";
                        if (!input.value && role === "-" && year === "-") return '';
                        return `<tr>
                                <td class="p-3 border-r border-black font-bold">${input.value || "---"}</td>
                                <td class="p-3 border-r border-black font-medium">${role}</td>
                                <td class="p-3 text-center font-black">${year}</td>
                            </tr>`;
                    }).join('');
                }
            });

            // 4. Cleanup: Remove blocks in Annex 4 if founder deleted in 8.2
            const currentAx4Blocks = container.querySelectorAll('[id^="ax4_block_"]');
            currentAx4Blocks.forEach(block => {
                const idNum = block.id.split('_').pop();
                if (!document.getElementById(`gov_82_head_${idNum}`)) block.remove();
            });
        };
        // --- ANNEXURE 1 DYNAMIC ROW HANDLERS ---
        window.addAxRow = async (tableId, idPrefix) => {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const idx = tbody.rows.length + 1;
            const row = document.createElement('tr');
            row.className = "dynamic-ax-row";

            row.innerHTML = `
                    <td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_name_${idx}" class="w-full p-3 outline-none"></td>
                    <td class="p-0 border-r border-black"><textarea id="${idPrefix}_det_${idx}" placeholder="..." class="w-full p-3 h-32 outline-none resize-none"></textarea></td>
                    <td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_cost_${idx}" class="w-full p-3 outline-none"></td>
                    <td class="p-2 text-center no-print"><button onclick="removeAxRow(this, '${idPrefix}')" class="text-red-400 hover:text-red-600 transition-all font-bold text-lg">‚úï</button></td>
                `;
            tbody.appendChild(row);

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { [`data.${idPrefix}_row_count`]: idx });
            }
        };

        window.removeAxRow = async (btn, idPrefix) => {
            const row = btn.closest('tr');
            const table = btn.closest('table');
            row.remove();

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newCount = table.querySelector('tbody').rows.length;
                await updateDoc(projectRef, { [`data.${idPrefix}_row_count`]: newCount });
            }
        };

        // --- ANNEXURE 2: IMAGE MANAGEMENT ---
        window.handleAx2Upload = (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result;
                    // Generate unique ID for this figure
                    const figureId = 'fig_' + Date.now() + Math.random().toString(36).substr(2, 5);

                    await addAx2Figure(figureId, base64Data, ""); // Initial empty caption
                };
                reader.readAsDataURL(file);
            });
        };

        window.addAx2Figure = async (id, src, caption, isInitialLoad = false) => {
            const gallery = document.getElementById('ax2-gallery');
            const emptyState = document.getElementById('ax2-empty-state');

            // Hide "NA" if we are adding an image
            if (emptyState) emptyState.classList.add('hidden');

            const figureNum = gallery.children.length + 1;
            const div = document.createElement('div');
            div.id = `container_${id}`;
            div.className = "bg-white p-6 rounded-[2rem] shadow-xl border border-slate-200 flex flex-col items-center dynamic-ax2-figure";

            div.innerHTML = `
                    <div class="relative w-full group">
                        <img src="${src}" class="w-full h-auto rounded-xl border border-slate-100 shadow-sm mb-4">
                        <button onclick="window.removeAx2Figure('${id}')" class="no-print absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-all font-bold">‚úï</button>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 italic">Figure ${figureNum}</p>
                    <input type="text" id="${id}_cap" value="${caption}" oninput="window.autoSave(event)" placeholder="Enter description..." 
                        class="w-full p-3 bg-slate-50 border-none rounded-xl text-center text-xs font-bold text-slate-700 outline-none focus:ring-1 focus:ring-[#630d0d]">
                `;

            gallery.appendChild(div);

            // Save to Cloud
            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                // We store the image IDs in a list so the loader knows how many to rebuild
                const existingFigures = window.lastSavedValues?.ax2_figure_list || [];
                const newList = [...existingFigures, { id, src }];

                await updateDoc(projectRef, {
                    [`data.ax2_figure_list`]: newList,
                    [`data.${id}_cap`]: caption
                });
            }
        };

        window.removeAx2Figure = async (id) => {
            if (!confirm("Permanently delete this figure?")) return;
            document.getElementById(`container_${id}`).remove();

            const gallery = document.getElementById('ax2-gallery');
            if (gallery.children.length === 0) {
                document.getElementById('ax2-empty-state').classList.remove('hidden');
            }

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newList = (window.lastSavedValues?.ax2_figure_list || []).filter(item => item.id !== id);
                await updateDoc(projectRef, {
                    [`data.ax2_figure_list`]: newList,
                    [`data.${id}_cap`]: deleteField()
                });
            }
        };

        // 1. TEMPLATE SELECTOR
        window.selectAx3Template = async (type) => {
            const postDiv = document.getElementById('div_ax3_post');
            const preDiv = document.getElementById('div_ax3_pre');
            const btnPost = document.getElementById('btn_ax3_post');
            const btnPre = document.getElementById('btn_ax3_pre');

            if (type === 'post') {
                postDiv.classList.remove('hidden');
                preDiv.classList.add('hidden');
                btnPost.style.backgroundColor = "#065f46"; // Emerald-800
                btnPost.style.color = "#ffffff";
                btnPre.style.backgroundColor = "#ffffff";
                btnPre.style.color = "#64748b";
            } else {
                preDiv.classList.remove('hidden');
                postDiv.classList.add('hidden');
                btnPre.style.backgroundColor = "#065f46";
                btnPre.style.color = "#ffffff";
                btnPost.style.backgroundColor = "#ffffff";
                btnPost.style.color = "#64748b";
            }

            if (window.currentCloudId) {
                await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax3_mode": type });
            }
        };

        // 2. IMAGE UPLOAD HANDLER
        window.handleAx3Upload = (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const figureId = 'site_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await addAx3Photo(figureId, e.target.result, true);
                };
                reader.readAsDataURL(file);
            });
        };

        // 3. ADD PHOTO WITH AUTOMATIC SIZING GUIDELINES
        window.addAx3Photo = async (id, src, isNew = false) => {
            const gallery = document.getElementById('ax3-gallery');
            const img = new Image();
            img.src = src;

            img.onload = async () => {
                // Calculate aspect ratio to choose the correct guideline size
                const ratio = img.width / img.height;
                const isSquare = Math.abs(1 - ratio) < 0.2;

                // Guidelines application using CM for precision
                // Square: 6x6cm | Rectangle: 7.5x4.5cm
                const width = isSquare ? '6cm' : '7.5cm';
                const height = isSquare ? '6cm' : '4.5cm';

                const div = document.createElement('div');
                div.id = `ax3_container_${id}`;
                // Removed object-cover so the full image is visible
                div.className = "relative group border-2 border-slate-300 p-1 bg-white shadow-md dynamic-site-photo";
                div.style.width = width;
                div.style.height = height;
                div.style.display = "flex";
                div.style.alignItems = "center";
                div.style.justifyContent = "center";
                div.style.overflow = "hidden";

                div.innerHTML = `
                        <img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        <button onclick="removeAx3Photo('${id}')" class="no-print absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition-all text-xs font-bold shadow-xl">‚úï</button>
                    `;
                gallery.appendChild(div);

                if (isNew && window.currentCloudId) {
                    const list = window.lastSavedValues?.ax3_photo_list || [];
                    await updateDoc(doc(db, "projects", window.currentCloudId), {
                        "data.ax3_photo_list": [...list, { id, src }]
                    });
                }
            };
        };

        window.removeAx3Photo = async (id) => {
            document.getElementById(`ax3_container_${id}`).remove();
            const list = (window.lastSavedValues?.ax3_photo_list || []).filter(p => p.id !== id);
            await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax3_photo_list": list });
        };

        // --- UPDATE MASTER ARRAY ---
        // Find your showSection function and add 'ax2' to the sections array

        // --- ANNEXURE 9: CAPEX QUOTATIONS LOGIC ---

        window.handleAx9Upload = (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const quoteId = 'quote_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await addAx9Quote(quoteId, e.target.result, "", true);
                };
                reader.readAsDataURL(file);
            });
        };

        window.addAx9Quote = async (id, src, caption, isNew = false) => {
            const gallery = document.getElementById('ax9-gallery');
            const emptyState = document.getElementById('ax9-empty-state');
            if (emptyState) emptyState.classList.add('hidden');

            const div = document.createElement('div');
            div.id = `ax9_container_${id}`;
            div.className = "bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-200 flex flex-col items-center dynamic-ax9-quote";

            div.innerHTML = `
                    <div class="relative w-full group">
                        <img src="${src}" class="w-full h-auto rounded-2xl border border-slate-100 shadow-sm mb-4">
                        <button onclick="removeAx9Quote('${id}')" class="no-print absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-all font-bold shadow-lg">‚úï</button>
                    </div>
                    <input type="text" id="${id}_name" value="${caption}" oninput="window.autoSave(event)" 
                        placeholder="Description of Equipment / Quotation Details" 
                        class="w-full p-4 bg-slate-50 border-none rounded-2xl text-center text-xs font-black uppercase text-slate-700 outline-none focus:ring-2 focus:ring-cyan-100 shadow-inner">
                `;

            gallery.appendChild(div);

            if (isNew && window.currentCloudId) {
                const list = window.lastSavedValues?.ax9_quote_list || [];
                await updateDoc(doc(db, "projects", window.currentCloudId), {
                    "data.ax9_quote_list": [...list, { id, src }]
                });
            }
        };

        window.removeAx9Quote = async (id) => {
            if (!confirm("Permanently delete this Capex Quotation?")) return;
            document.getElementById(`ax9_container_${id}`).remove();
            const list = (window.lastSavedValues?.ax9_quote_list || []).filter(l => l.id !== id);
            await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax9_quote_list": list });
            if (list.length === 0) document.getElementById('ax9-empty-state').classList.remove('hidden');
        };
        // 1. HANDLE LOGIN
        window.handleAuth = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;

            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    const authOverlay = document.getElementById("auth-overlay");

                    // smooth exit animation
                    authOverlay.classList.add("auth-exit");

                    // hide after animation completes
                    setTimeout(() => {
                        authOverlay.classList.add("hidden");
                    }, 600);
                })
                .catch(err => {
                    const errEl = document.getElementById('auth-error');
                    errEl.innerText = err.message;
                    errEl.classList.remove('hidden');
                });
        };

        window.handleLogout = async () => {
            try {
                if (auth.currentUser) {
                    await setDoc(doc(db, "users", auth.currentUser.uid), {
                        status: 'offline',
                        workingOn: 'Not Active',
                        lastSeen: serverTimestamp()
                    }, { merge: true });
                }
            } catch (e) { }
            signOut(auth)
                .then(() => {
                    // Show login overlay again
                    document.getElementById('auth-overlay').classList.remove('hidden');

                    // Hide main dashboard
                    document.getElementById('project-overlay')?.classList.add('hidden');
                    document.getElementById('main-content')?.classList.add('hidden');
                    document.getElementById('main-sidebar')?.classList.add('hidden');
                })
                .catch(err => {
                    console.error("Logout failed:", err);
                });
        };
        // Add this inside your <script type="module"> block
        window.forceSync = async () => {
            if (confirm("This will clear your browser's local memory and reload every Memorandum fresh from the Cloud. Fixes 'Ghost Files'. Continue?")) {
                try {
                    const { terminate, clearIndexedDbPersistence } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

                    // This forces the browser to disconnect and wipe the local cache
                    await terminate(db);
                    await clearIndexedDbPersistence(db);

                    console.log("System: Local cache wiped successfully.");
                    location.reload(); // Refresh to reconnect to the real Cloud data
                } catch (error) {
                    console.error("Force Sync Error:", error);
                    location.reload();
                }
            }
        };
        // 2. MONITOR AUTH STATE & PRESENCE
        onAuthStateChanged(auth, (user) => {
            if (user) {

                // ‚úÖ DEFINE statusRef ONLY when user exists
                window.statusRef = ref(rtdb, '/status/' + user.uid);

                document.getElementById('auth-overlay').classList.add('hidden');

                // ‚úÖ Setup presence writer
                setupPresence(user);

                // ‚úÖ Presence reader MUST ALSO BE HERE
                onValue(statusRef, (snap) => {
                    if (!snap.exists()) return;

                    const data = snap.val();
                    const workingOnEl = document.getElementById("working-on");

                    if (workingOnEl && data.workingOn) {
                        workingOnEl.textContent = data.workingOn;
                    }
                });

            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
            }
        });


        // Updated Presence with Project Tracking
        function setupPresence(user) {
            const statusRef = window.statusRef;   // üëà THIS LINE FIXES EVERYTHING
            const connectedRef = ref(rtdb, '.info/connected');

            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    const updateStatus = (projectName = "Browsing Memorandums") => {
                        window.__currentWorkingOn = projectName;
                        set(statusRef, {
                            state: 'online',
                            last_changed: Date.now(),
                            email: user.email,
                            workingOn: projectName
                        });

                        setDoc(doc(db, "users", user.uid), {
                            name: user.email.split('@')[0],
                            email: user.email,
                            status: 'online',
                            workingOn: projectName,
                            lastSeen: serverTimestamp()
                        }, { merge: true });
                    };

                    updateStatus();
                    window.currentUpdateStatus = updateStatus;

                    // Heartbeat: keep Firestore lastSeen fresh so offline can be inferred reliably
                    if (window.__presenceHeartbeat) clearInterval(window.__presenceHeartbeat);
                    window.__presenceHeartbeat = setInterval(() => {
                        // keep RTDB 'online' fresh
                        set(statusRef, {
                            state: 'online',
                            last_changed: Date.now(),
                            email: user.email,
                            workingOn: (window.__currentWorkingOn || 'Browsing Memorandums')
                        });

                        // keep Firestore fresh (serverTimestamp)
                        setDoc(doc(db, "users", user.uid), {
                            status: 'online',
                            workingOn: (window.__currentWorkingOn || 'Browsing Memorandums'),
                            lastSeen: serverTimestamp()
                        }, { merge: true });
                    }, 10000);


                    // Update Firestore when browser closes
                    window.addEventListener('beforeunload', () => {
                        setDoc(doc(db, "users", user.uid), {
                            status: 'offline',
                            lastSeen: Date.now()
                        }, { merge: true });
                    });

                    onDisconnect(statusRef).set({
                        state: 'offline',
                        last_changed: Date.now(),
                        email: user.email
                    });

                    // Sync RTDB status to Firestore
                    onValue(statusRef, (snapshot) => {
                        const status = snapshot.val();
                        if (status) {
                            setDoc(doc(db, "users", user.uid), {
                                status: status.state === 'online' ? 'online' : 'offline',
                                workingOn: status.workingOn || 'Browsing Portfolios',
                                lastSeen: Date.now()
                            }, { merge: true });
                        }
                    });
                }
            });
        }


        // A. TOGGLE FUNCTION
        window.toggleUserList = () => {
            const el = document.getElementById('user-presence-dropdown');
            if (el) el.classList.toggle('hidden');
        };

        // B. USER PRESENCE LISTENER (The dropdown logic)
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('user-presence-list');
            const countEl = document.getElementById('user-online-count');
            if (!list || !countEl) return;

            // Re-render timer: updates offline/online view as time passes (no refresh needed)
            if (!window.__presenceRenderTimer) {
                window.__presenceRenderTimer = setInterval(() => {
                    if (typeof window.__renderPresenceList === 'function') window.__renderPresenceList();
                }, 5000);
            }


            const allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            window.__presenceUsers = allUsers;

            window.__renderPresenceList = () => {
                const users = window.__presenceUsers || [];
                const onlineUsers = users.filter(u => {
                    const lastSeenMs = (u.lastSeen && typeof u.lastSeen.toMillis === 'function') ? u.lastSeen.toMillis() : (typeof u.lastSeen === 'number' ? u.lastSeen : 0);
                    const isRecent = lastSeenMs ? ((Date.now() - lastSeenMs) < 20000) : false;
                    return (u.status === 'online') && isRecent;
                });

                countEl.innerText = `(${onlineUsers.length})`;

                list.innerHTML = users.map(u => {
                    const lastSeenMs = (u.lastSeen && typeof u.lastSeen.toMillis === 'function') ? u.lastSeen.toMillis() : (typeof u.lastSeen === 'number' ? u.lastSeen : 0);
                    const isRecent = lastSeenMs ? ((Date.now() - lastSeenMs) < 20000) : false;
                    const isOnline = (u.status === 'online') && isRecent;
                    const dotColor = isOnline ? 'bg-green-500' : 'bg-gray-500';
                    const nameColor = isOnline ? 'text-white' : 'text-slate-500';
                    const statusText = isOnline ? (u.workingOn || 'Browsing Portfolios') : 'Not Active';
                    return `
            <div class="flex items-start gap-3 p-2 hover:bg-white/5 rounded-xl transition-all">
                <div class="w-2 h-2 rounded-full ${dotColor} mt-1.5 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-black ${nameColor} uppercase tracking-tight">${u.name || 'User'}</span>
                    <span class="text-[9px] text-slate-400 italic leading-tight">
                        ${isOnline ? `Working on: <span class=\"text-red-400 font-bold\">${statusText}</span>` : `<span class=\"text-gray-500\">${statusText}</span>`}
                    </span>
                </div>
            </div>
        `;
                }).join('');
            };

            // Initial render
            window.__renderPresenceList();

            // Update the Task Assignment dropdown too
            const assignDropdown = document.getElementById('assign-user-dropdown');
            if (assignDropdown) {
                const currentVal = assignDropdown.value;
                assignDropdown.innerHTML = '<option value="">Select User...</option>' +
                    snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
                assignDropdown.value = currentVal;
            }
        });

        // C. PROJECT LIST LISTENER (This makes your projects visible again!)
        onSnapshot(collection(db, "projects"), (snap) => {
            window.activeProjectsList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            window.renderProjects(window.activeProjectsList);
        });

        // D. ARCHIVE LISTENER
        onSnapshot(collection(db, "archived"), (snap) => {
            window.archivedProjectsList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderArchived(window.archivedProjectsList);
        });

        window.renderProjects = (list) => {
            const container = document.getElementById('project-list');
            const countEl = document.getElementById('project-count');
            if (countEl) countEl.innerText = `${list.length} ACTIVE NEURAL RECORDS`;

            if (!container) return;

            container.innerHTML = list.map(p => {
                const safeId = String(p.id).replace(/'/g, "\\'");
                return `
                            <div class="tilt-card group" onclick="window.loadProject('${safeId}')">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="p-3 bg-red-900/20 rounded-xl border border-red-900/30 group-hover:border-red-500/50 transition-all">
                                        <svg class="w-6 h-6 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <button onclick="event.stopPropagation(); window.deleteProject('${safeId}')" 
                                            class="opacity-0 group-hover:opacity-100 text-[9px] font-black text-white/30 hover:text-red-500 transition-all uppercase tracking-widest bg-black/20 px-3 py-1 rounded-lg">
                                        Archive
                                    </button>
                                </div>
    
                                <h3 class="text-2xl font-bold text-white mb-1 truncate tracking-tight group-hover:text-red-500 transition-colors">
                                    ${p.name || "UNNAMED_DRAFT"}
                                </h3>
                                <p class="text-[10px] text-red-500/40 font-black uppercase tracking-[0.2em]">Investment Memorandum</p>
                                
                                <div class="mt-8 pt-6 border-t border-white/5 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                        <span class="text-[9px] text-slate-500 font-bold uppercase tracking-tighter">Verified</span>
                                    </div>
                                    <span class="text-[9px] text-slate-600 font-mono font-bold italic">ID: ${safeId.substring(0, 8)}</span>
                                </div>
                            </div>`;
            }).join('');
        };
        // --- ANNEXURE 5: COMMUNITY CERTIFICATE MANAGEMENT ---
        window.handleAx5Upload = (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const certId = 'cert_' + Date.now() + Math.random().toString(36).substr(2, 5);
                    await addAx5Figure(certId, e.target.result, "", false);
                };
                reader.readAsDataURL(file);
            });
        };

        window.addAx5Figure = async (id, src, caption, isInitialLoad = false) => {
            const gallery = document.getElementById('ax5-gallery');
            const emptyState = document.getElementById('ax5-empty-state');

            if (emptyState) emptyState.classList.add('hidden');

            const div = document.createElement('div');
            div.id = `ax5_container_${id}`;
            div.className = "bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-300 flex flex-col items-center dynamic-ax5-figure";

            div.innerHTML = `
                        <div class="relative w-full group">
                            <img src="${src}" class="w-full h-auto rounded-2xl border border-slate-100 shadow-sm mb-4">
                            <button onclick="window.removeAx5Figure('${id}')" class="no-print absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-all font-bold shadow-lg">‚úï</button>
                        </div>
                        <input type="text" id="${id}_cap" value="${caption}" oninput="window.autoSave(event)" 
                            placeholder="Name of the Certificate Holder" 
                            class="w-full p-4 bg-slate-50 border-none rounded-2xl text-center text-xs font-black uppercase text-slate-700 outline-none focus:ring-2 focus:ring-blue-100 shadow-inner">
                    `;

            gallery.appendChild(div);

            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const existingCerts = window.lastSavedValues?.ax5_cert_list || [];
                const newList = [...existingCerts, { id, src }];

                await updateDoc(projectRef, {
                    [`data.ax5_cert_list`]: newList,
                    [`data.${id}_cap`]: caption
                });
            }
        };

        window.removeAx5Figure = async (id) => {
            if (!confirm("Permanently delete this certificate image?")) return;
            document.getElementById(`ax5_container_${id}`).remove();

            const gallery = document.getElementById('ax5-gallery');
            if (gallery.children.length === 0) {
                document.getElementById('ax5-empty-state').classList.remove('hidden');
            }

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newList = (window.lastSavedValues?.ax5_cert_list || []).filter(item => item.id !== id);
                await updateDoc(projectRef, {
                    [`data.ax5_cert_list`]: newList,
                    [`data.${id}_cap`]: deleteField()
                });
            }
        };

        window.renderArchived = (list) => {
            const container = document.getElementById('project-trash');
            if (!container) return;

            container.innerHTML = list.map(p => {
                const safeId = p.id.replace(/'/g, "\\'");
                return `
                            <div class="bg-white/5 px-4 py-2 rounded-xl border border-white/10 flex items-center gap-4 transition-all hover:bg-white/10 group">
                                <span class="text-[10px] font-bold text-slate-400 uppercase italic">${p.name || "Old_Rec"}</span>
                                <div class="flex gap-2 border-l border-white/10 pl-4">
                                    <button onclick="window.restoreProject('${safeId}')" class="text-[9px] font-black text-red-700 hover:text-white uppercase tracking-tighter">Restore</button>
                                    <button onclick="window.permanentDeleteArchive('${safeId}')" class="text-white/20 group-hover:text-red-500 transition-colors font-bold text-xs">‚úï</button>
                                </div>
                            </div>`;
            }).join('');
        };
        window.createNewProject = async () => {
            const name = prompt("Enter Startup Name:");
            if (!name) return;

            // 1. THE CLEANSER: Physically clear every input on the screen
            document.querySelectorAll('input, textarea, select').forEach(el => {
                // Don't clear buttons or hidden system fields
                if (el.type !== 'button' && el.type !== 'submit') {
                    el.value = "";
                }
            });

            // 2. RESET DYNAMIC UI: Remove extra rows and columns from the previous file
            // Remove all dynamic columns (Tranche 3+)
            document.querySelectorAll('[data-t]').forEach(el => {
                if (parseInt(el.getAttribute('data-t')) > 2) el.remove();
            });

            // Remove all dynamic rows (rows added via + ADD ROW)
            document.querySelectorAll('.util-row').forEach(row => {
                // Keep only the very first row of each category if desired, or wipe all but base
                const cat = row.dataset.cat;
                const rowsInCat = document.querySelectorAll(`.util-row[data-cat="${cat}"]`);
                if (rowsInCat.length > 1) {
                    // Logic to keep base rows but remove the rest
                    // For now, we rely on loadProject to rebuild the correct ones
                }
            });

            // 3. RESET COUNTERS
            currentTrancheCount = 2;
            founderCount = 1;

            // 4. INITIALIZE IN CLOUD
            const newDoc = await addDoc(collection(db, "projects"), {
                name,
                data: { tranche_count: 2 }, // Force base tranche count
                timestamp: Date.now()
            });

            // 5. AUTO-LOAD THE NEW PROJECT
            window.loadProject(newDoc.id);
        };

        
window.loadIMDashboard = async (id) => {
    // 1. NEURAL LOCK: Prevent duplicate loads
    if (window.isProjectLoading) return;
    window.isProjectLoading = true;

    // Capture the overlay for pointer locking
    const overlay = document.getElementById('project-overlay');
    if (overlay) overlay.style.pointerEvents = 'none';

    try {
        // --- PHASE 4: CLOUD & LOCAL UNIFICATION ---
        let savedData = {};
        let projectName = "";

        // Attempt to fetch from Firebase Cloud first
        const docRef = window.doc(window.db, "shared", window.currentCloudId, "ims", id);
        const snap = await window.getDoc(docRef);

        if (snap.exists()) {
            const cloudDoc = snap.data();
            savedData = cloudDoc.data || {};
            projectName = cloudDoc.name || "Cloud Project";
            console.log("‚úÖ Cloud IM Sync Success");
        } else {
            // Fallback to Local List if cloud fetch fails
            const localProject = (window.activeProjectsList || []).find(x => x.id === id);
            if (!localProject) throw new Error("Project Not Found in Cloud or Local Storage");
            
            savedData = localProject.data || {};
            projectName = localProject.name;
            console.log("üìÇ Local Fallback Success");
        }

        // --- 1. INITIALIZE PROJECT CONTEXT ---
        window.currentModuleId = id; 
        window.lastSavedValues = { ...savedData };
        
        const nameDisplay = document.getElementById('active-project-name');
        if (nameDisplay) nameDisplay.innerText = projectName;

        if (window.currentUpdateStatus) {
            setTimeout(() => {
                window.currentUpdateStatus(projectName);
            }, 500);
        }

        // --- 2. CLEAN RESET OF UI ---
        document.querySelectorAll('input, textarea, select').forEach(el => {
            if (el.type !== 'button' && el.type !== 'submit') el.value = "";
        });
        document.querySelectorAll('.row-total, [id^="foot-t"], #foot-total-all, [id^="sync-"]').forEach(el => el.innerText = "0");

        // PHYSICAL CLEANUP: Wipe all dynamic elements instantly
        document.querySelectorAll('.dynamic-sec1-tranche, .dynamic-sec1-ms, .dynamic-founder-block, .dynamic-exit-row, .dynamic-ax-row, .dynamic-ax2-figure, .dynamic-site-photo, .dynamic-ax5-figure, .dynamic-ax6-seg-block, .dynamic-ax6-cust-card, .dynamic-ax6-qblock, .dynamic-ax7-logo, .dynamic-ax8-image, .dynamic-ax9-quote').forEach(el => el.remove());

        // RESET GLOBAL COUNTERS
        trancheCount = 1; milestoneCount = 2; currentTrancheCount = 2; founderCount = 1;

        // --- 3. REBUILD DYNAMIC SECTIONS (Instant Rebuild) ---

        // Section 1 & 10 (Tranches/Milestones)
        for (let i = 2; i <= (parseInt(savedData['sec1_tranche_count']) || 1); i++) { window.addTranche(true); }
        for (let i = 3; i <= (parseInt(savedData['sec1_ms_count']) || 2); i++) { window.addMilestone(true); }
        for (let i = 3; i <= (parseInt(savedData['tranche_count']) || 2); i++) { window.addTrancheColumn(true); }

        // Section 8.2 & 8.3 (Founders & Cap Table)
        for (let i = 2; i <= (parseInt(savedData['total_founder_blocks']) || 1); i++) { window.addFounderBlock(true); }
        for (let i = 4; i <= (parseInt(savedData['cap_row_count']) || 3); i++) { window.addCapRow(); }

        // Section 6.5 & Annexure 1 (Tables)
        for (let i = 3; i <= (parseInt(savedData['in_comp_row_count']) || 2); i++) { window.addCompRow('table_indian_comp', 'in_comp'); }
        for (let i = 2; i <= (parseInt(savedData['gl_comp_row_count']) || 1); i++) { window.addCompRow('table_gl_comp', 'gl_comp'); }
        for (const cat of ['ax1_in', 'ax1_gl']) {
            for (let i = 4; i <= (parseInt(savedData[`${cat}_row_count`]) || 3); i++) { window.addAxRow(`table_${cat}`, cat); }
        }

        // Section 10.1 (Utilization Rows)
        for (const cat of ['cap', 'dir', 'ind']) {
            for (let i = 2; i <= (parseInt(savedData[`util_${cat}_row_count`]) || 1); i++) { window.addUtilRow(cat, true); }
        }
        for (let i = 2; i <= (parseInt(savedData['exit_row_count']) || 1); i++) { window.addExitRow(true); }

        // --- 4. IMAGE GALLERIES & COMPLEX REBUILDS ---

        // Annexure 3 (Site Visit)
        window.selectAx3Template(savedData['ax3_mode'] || 'post');
        (savedData['ax3_photo_list'] || []).forEach(p_item => window.addAx3Photo(p_item.id, p_item.src, false));

        // Annexure 6 (Customer Testimonials - Deep Nesting)
        window.selectAx6Mode(savedData['ax6_mode'] || 'na');
        if (savedData['ax6_mode'] === 'applicable') {
            for (const sId of (savedData['ax6_segment_ids'] || [])) {
                await window.addAx6SegmentBlock(true, sId);
                for (const cId of (savedData[`ax6_cust_ids_${sId}`] || [])) {
                    await window.addAx6Testimonial(sId, true, cId);
                    for (const qId of (savedData[`ax6_q_ids_${cId}`] || [])) {
                        await window.addAx6Question(sId, cId, "", true, qId);
                    }
                }
            }
        }

        // Other Galleries (2, 5, 7, 8, 9)
        (savedData['ax2_figure_list'] || []).forEach(f => window.addAx2Figure(f.id, f.src, savedData[`${f.id}_cap`] || "", true));
        (savedData['ax5_cert_list'] || []).forEach(c => window.addAx5Figure(c.id, c.src, savedData[`${c.id}_cap`] || "", true));
        (savedData['ax7_logo_list'] || []).forEach(l => window.addAx7Logo(l.id, l.src, savedData[`${l.id}_name`] || "", false));
        (savedData['ax8_loi_list'] || []).forEach(loi => window.addAx8Image(loi.id, loi.src, savedData[`${loi.id}_name`] || "", false));
        (savedData['ax9_quote_list'] || []).forEach(q => window.addAx9Quote(q.id, q.src, savedData[`${q.id}_name`] || "", false));

        // --- 5. POPULATE DATA & AUTO-GROW ---
        setTimeout(() => {
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type === 'file') return;
                if (el.id && savedData[el.id] !== undefined) {
                    el.value = savedData[el.id];
                    if (el.id.startsWith('milestone_text_t')) window.mirrorMilestone(el.id.replace('milestone_text_t', ''));
                }
            });

            // Trigger Box Growth
            document.querySelectorAll('textarea').forEach(tx => {
                if (window.adjustTextareaHeight) window.adjustTextareaHeight(tx);
            });

            // Final refreshes
            if (typeof window.updateMarketChart === "function") window.updateMarketChart();
            if (typeof window.calcUtilTable === "function") window.calcUtilTable();
            if (typeof window.syncAnnex4 === "function") window.syncAnnex4();

            // REVEAL UI AFTER ALL DATA IS READY
            if (overlay) overlay.style.display = 'flex';
            const sidebar = document.getElementById('main-sidebar');
            const content = document.getElementById('main-content');
            if (sidebar) { sidebar.classList.remove('hidden'); sidebar.style.display = 'flex'; }
            if (content) { content.classList.remove('hidden'); content.style.display = 'flex'; }

            showSection('sec1');
            window.loadAuditLog(id);

            window.isProjectLoading = false;
            if (overlay) overlay.style.pointerEvents = 'auto';

        }, 150);

    } catch (error) {
        console.error("Neural Sync Error:", error);
        window.isProjectLoading = false;
        if (overlay) overlay.style.pointerEvents = 'auto';
    }
};
        // NEW: Module Hub Entry Point
        window.loadProject = async (id) => {
            console.log('üîµ LOAD PROJECT:', id);

            // Store project context
            window.currentProjectId = id;
            window.currentCloudId = id;
            pid = id;  // ‚Üê CRITICAL for FSA

            // Find project data
            const p = window.activeProjectsList?.find(x => x.id === id);
            if (!p) {
                alert('Project not found');
                return;
            }

            window.currentProjectName = p.name || 'Unnamed Project';

            // Update hub display
            const hubProjectName = document.getElementById('hub-project-name');
            if (hubProjectName) hubProjectName.textContent = window.currentProjectName;

            // FORCE hide project list
            const overlay = document.getElementById('project-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.classList.add('hidden');
            }

            // FORCE show module hub
            const moduleHub = document.getElementById('module-hub');
            if (moduleHub) {
                moduleHub.classList.remove('hidden');
                moduleHub.style.display = 'flex';
            }

            if (window.currentUpdateStatus) {
                window.currentUpdateStatus('Selecting Module - ' + window.currentProjectName);
            }

            console.log('‚úÖ Module hub shown');
        };
        // IM Button - Opens existing IM dashboard
        window.openIMDashboard = async () => {
            if (!window.currentProjectId) return;

            // Hide module hub
            document.getElementById('module-hub')?.classList.add('hidden');

            // Call the RENAMED function with all your existing logic
            await window.loadIMDashboard(window.currentProjectId);
        };
        // FSA Button - Navigate to index.html
        // AI Summarize Button
        window.openAISummarize = async () => {
            // Show modal
            const modal = document.getElementById('ai-summary-modal');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');

            if (modal) modal.classList.remove('hidden');
            if (loading) loading.classList.remove('hidden');
            if (content) content.classList.add('hidden');

            try {
                // Collect IM data
                const imData = collectIMData();

                // Collect FSA data (if available in localStorage or fetch from Firebase)
                const fsaData = collectFSAData();

                // Call Gemini API
                const summaries = await generateAISummary(imData, fsaData);

                // Display results
                document.getElementById('ai-im-summary').innerText = summaries.im || 'No IM data available';
                document.getElementById('ai-fsa-summary').innerText = summaries.fsa || 'No FSA data available';

                // Show content, hide loading
                if (loading) loading.classList.add('hidden');
                if (content) content.classList.remove('hidden');

            } catch (error) {
                console.error('AI Summary Error:', error);
                alert('Failed to generate AI summary: ' + error.message);
                closeAIModal();
            }
        };
// ==========================================
    // üÜï PHASE 1 LOGIC: INNER DASHBOARD & POPUP
    // ==========================================
    
    window.currentModuleType = null; // Tracks if we are making an IM or FSA

    // 1. Open the Naming Popup
    window.openVersionModal = function(type) {
        window.currentModuleType = type; // 'IM' or 'FSA'
        document.getElementById('modal-type-label').innerText = type + " Version";
        document.getElementById('version-modal').classList.remove('hidden');
        document.getElementById('version-name-input').focus();
    };

    // 2. Close the Popup
    window.closeVersionModal = function() {
        document.getElementById('version-modal').classList.add('hidden');
        document.getElementById('version-name-input').value = '';
    };

// ==========================================
    // üÜï PHASE 2: DATABASE CONNECTION (SAVE & LOAD)
    // ==========================================

    // 1. HELPER: Get the correct sub-collection name
    function getCollectionName(type) {
        return type === 'IM' ? 'ims' : 'fsas';
    }

    // 2. REAL SAVE LOGIC (Replaces the dummy alert)
    window.confirmCreateVersion = async function() {
        const name = document.getElementById('version-name-input').value.trim();
        if(!name) { alert("Please enter a name."); return; }
        if(!window.currentCloudId) { alert("Error: No project selected."); return; }

        const type = window.currentModuleType; // 'IM' or 'FSA'
        const subCollection = getCollectionName(type);
        const user = window.auth.currentUser;

        // Data Structure for the Sub-Module
        const moduleData = {
            name: name,
            type: type,
            createdAt: new Date().toISOString(),
            createdBy: user ? user.email : 'Anonymous',
            lastModified: new Date().toISOString(),
            data: {} // Empty container for future content
        };

        try {
            // Save to: shared/PROJECT_ID/ims/NEW_ID
            const parentRef = window.doc(window.db, "shared", window.currentCloudId);
            const subColRef = window.collection(parentRef, subCollection);
            
            await window.addDoc(subColRef, moduleData);

            console.log(`‚úÖ Saved new ${type} to database`);
            window.closeVersionModal();
            
            // Refresh the grid immediately to show the new card
            window.fetchProjectModules(window.currentCloudId);

        } catch(e) {
            console.error("Save Error:", e);
            alert("Failed to create version. See console.");
        }
    };
        // Collect IM section content
        function collectIMData() {
            const sections = [
                'sec1', 'founding', 'market', 'innovation', 'sustainability', 'rationale',
                'journey', 'biz41', 'biz42', 'biz43', 'biz44', 'biz45', 'biz46',
                'fin51', 'fin52', 'fin53', 'fin54'
            ];

            let imContent = '';
            sections.forEach(sec => {
                const sectionEl = document.getElementById(`section-${sec}`);
                if (sectionEl) {
                    imContent += `\n\n=== ${sec.toUpperCase()} ===\n`;
                    // Extract text from inputs and textareas
                    sectionEl.querySelectorAll('input[type="text"], textarea').forEach(el => {
                        if (el.value && el.value.trim()) {
                            imContent += `${el.id || 'Field'}: ${el.value}\n`;
                        }
                    });
                }
            });

            return imContent || 'No IM content available';
        }

        // Collect FSA data from localStorage or Firebase
        function collectFSAData() {
            // Try to get FSA data from localStorage
            const projectKey = `fsaData_${window.currentCloudId}`;
            const fsaDataStr = localStorage.getItem(projectKey);
            if (!fsaDataStr) return 'No FSA data available';

            try {
                const fsaData = JSON.parse(fsaDataStr);
                let summary = `Company: ${fsaData.companyName || 'N/A'}\n`;
                summary += `Type: ${fsaData.companyType || 'N/A'}\n\n`;

                // Extract key financial metrics from available years
                if (fsaData.data) {
                    if (fsaData.data && typeof fsaData.data === 'object') {
                        Object.keys(fsaData.data).forEach(year => {
                            summary += `\n--- ${year} ---\n`;
                            const yearData = fsaData.data[year];

                            // Revenue
                            if (yearData.revenue) {
                                const totalRevenue = yearData.revenue.reduce((sum, item) => sum + (item.value || 0), 0);
                                summary += `Revenue: ${totalRevenue}\n`;
                            }

                            // Expenses
                            if (yearData.directExpenses || yearData.indirectExpenses) {
                                const totalExp = [...(yearData.directExpenses || []), ...(yearData.indirectExpenses || [])].reduce((sum, item) => sum + (item.value || 0), 0);
                                summary += `Expenses: ${totalExp}\n`;
                            }

                            // Assets
                            if (yearData.currentAssets || yearData.fixedAssetsTangible) {
                                const totalAssets = [...(yearData.currentAssets || []), ...(yearData.fixedAssetsTangible || [])].reduce((sum, item) => sum + (item.value || 0), 0);
                                summary += `Assets: ${totalAssets}\n`;
                            }
                        });
                    }
                }  // <-- ADD THIS LINE: closes if (fsaData.data) from line 6078

                return summary;
            } catch (e) {
                return 'FSA data parsing error';
            }
        }


        // Gemini API call
        async function generateAISummary(imData, fsaData) {
            const API_KEY = 'AIzaSyAhZwiZdt2vOOIM_cvt3kmFNF0_FIB98gc';
            const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

            const prompt = `You are a financial analyst AI. Generate concise, executive-level summaries for the following:

**INVESTMENT MEMORANDUM DATA:**
${imData}

**FINANCIAL STATEMENT ANALYSIS DATA:**
${fsaData}

Provide two separate summaries:
1. IM EXECUTIVE SUMMARY (5-7 bullet points highlighting company overview, market, innovation, rationale)
2. FSA KEY INSIGHTS (5-7 bullet points covering financial health, revenue trends, profitability, assets)

Format each as clear, professional bullet points.`;

            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API Error: ${response.status}`);
            }

            const data = await response.json();
            const fullText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No summary generated';

            // Split response into IM and FSA sections
            const sections = fullText.split(/FSA KEY INSIGHTS|2\./i);

            return {
                im: sections[0]?.replace(/IM EXECUTIVE SUMMARY|1\./gi, '').trim() || fullText,
                fsa: sections[1]?.trim() || 'No FSA insights available'
            };
        }

        // Close AI modal
        window.closeAIModal = () => {
            const modal = document.getElementById('ai-summary-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.backToHub = () => {
            console.log('üîô Returning to Module Hub');

            // 1. Target the correct IDs to HIDE
            const fsaOverlay = document.getElementById('fsa-dashboard-overlay');
            const imSidebar = document.getElementById('main-sidebar'); // The persistent sidebar
            const imContent = document.getElementById('main-content'); // The IM dashboard content
            const mainApp = document.getElementById('mainapp');

            // HIDE everything IM and FSA related
            if (fsaOverlay) fsaOverlay.style.display = 'none';
            if (mainApp) mainApp.style.display = 'none';

            if (imSidebar) {
                imSidebar.classList.add('hidden');
                imSidebar.style.display = 'none'; // FORCE it to disappear
            }
            if (imContent) {
                imContent.classList.add('hidden');
                imContent.style.display = 'none'; // FORCE it to disappear
            }

            // 2. SHOW only the Hub
            const moduleHub = document.getElementById('module-hub');
            if (moduleHub) {
                moduleHub.classList.remove('hidden');
                moduleHub.style.display = 'flex';
            }

            console.log('‚úÖ Back at Hub. IM Sidebar hidden.');
        };

        // The Auto-Resize Engine
        window.adjustTextareaHeight = (el) => {
            el.style.height = 'auto'; // Reset to calculate
            el.style.height = el.scrollHeight + 'px'; // Set to match text perfectly
        };
        window.saveComment = async () => {
            const text = document.getElementById('comment-text').value;
            const assigneeId = document.getElementById('assign-user-dropdown').value;

            if (!text) return;

            try {
                const commentData = {
                    projectId: window.currentCloudId,
                    highlightedText: window.currentSelection || "N/A",
                    commentBody: text,
                    author: auth.currentUser.email,
                    assignedTo: assigneeId,
                    status: 'open',
                    timestamp: Date.now()
                };
                await addDoc(collection(db, "comments"), commentData);

                if (assigneeId) {
                    const userDoc = await getDoc(doc(db, "users", assigneeId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();

                        const templateParams = {
                            to_email: String(userData.email || "rathin@redwoodpartners.in"),
                            project_name: String(document.getElementById('active-project-name').innerText),
                            assigned_by: String(auth.currentUser.email),
                            highlighted_text: String(window.currentSelection || "N/A"),
                            task_instruction: String(text)
                        };

                        // SAFE SEND: We pass the public key directly here to avoid "Invalid Key" errors
                        emailjs.send(
                            'service_sg3d6d3',
                            'template_5slaavw',
                            templateParams,
                            'ctKro1C5mx9FqjIns' // Your Public Key explicitly added
                        )
                            .then((res) => {
                                console.log('System: Email Sent Successfully!', res.status);
                                alert("Task assigned and email sent!");
                            })
                            .catch((err) => {
                                console.error('System: EmailJS Error:', err);
                                alert("Database updated, but email failed. Check console.");
                            });
                    }
                }
                document.getElementById('comment-text').value = '';
                closeComment();
            } catch (error) {
                console.error("System Critical Error:", error);
            }
        };

        let debounceTimer;

        window.autoSave = async (event) => {
            // 1. Safety Check: If we aren't in a project, don't save.
            if (!window.currentCloudId || !event || !event.target.id) return;

            const fieldId = event.target.id;
            const newValue = event.target.value;
            const projectRef = doc(db, "projects", window.currentCloudId);

            // 2. IMMEDIATE SAVE (Only the one field that changed)
            // Using updateDoc instead of setDoc prevents overwriting other data
            try {
                await updateDoc(projectRef, {
                    [`data.${fieldId}`]: newValue
                });
            } catch (e) {
                console.error("Save failed:", e);
            }

            // 3. LOG TO AUDIT HISTORY (Wait 1.5s until user stops typing)
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                // Compare with the last known value to see if we should create a history entry
                const oldValue = window.lastSavedValues?.[fieldId] || "Empty";

                if (oldValue !== newValue) {
                    await addDoc(collection(db, "history"), {
                        projectId: window.currentCloudId,
                        user: auth.currentUser.email,
                        field: fieldId,
                        oldValue: oldValue,
                        newValue: newValue,
                        timestamp: Date.now()
                    });

                    // Update our local memory so we don't log the same change twice
                    if (!window.lastSavedValues) window.lastSavedValues = {};
                    window.lastSavedValues[fieldId] = newValue;
                }
            }, 1500);
        };
        window.filterProjects = () => {
            const term = document.getElementById('projectSearch').value.toLowerCase();
            renderProjects(window.activeProjectsList.filter(p => p.name.toLowerCase().includes(term)));
        };

        window.filterArchives = () => {
            const input = document.querySelector(
                'input[placeholder="Search Archive..."]'
            );
            if (!input) return;

            const query = input.value.toLowerCase();
            const archiveContainer = document.getElementById('project-trash');
            if (!archiveContainer) return;

            Array.from(archiveContainer.children).forEach(tag => {
                const text = tag.textContent.toLowerCase();
                tag.style.display = text.includes(query) ? '' : 'none';
            });
        };




        window.loadAuditLog = (projectId) => {
            // 2. KILL SWITCH: Hang up the "phone line" to the previous project
            if (auditUnsubscribe) {
                auditUnsubscribe();
                auditUnsubscribe = null;
                console.log("System: Previous Audit Listener Disconnected.");
            }

            const fieldMap = {
                "brand": "Company Brand",
                "reg_name": "Registered Name",
                "reg_address": "Registered Address",
                "summary": "Business Summary",
                "journey_main": "Applicant Journey Process",
                "biz_41_text1": "4.1 Problem Statement",
                "biz_41_text2": "4.1 Problem Background",
                "biz_42_main": "4.2 Solution Stage",
                "biz_421": "4.2.1 POC",
                "biz_422": "4.2.2 Customer Validation",
                "biz_423": "4.2.3 Market Validation",
                "biz_42_traction": "Solution Traction",
                "biz_43_others": "4.3 Other Lines",
                "biz_441_1": "4.4.1 Revenue Streams",
                "biz_441_2": "4.4.1 Cost Structure",
                "biz_441_3": "4.4.1 Pricing Strategy",
                "biz_442": "4.4.2 Tech Summary",
                "biz_45_main": "4.5 SME Validation",
                "biz_45_summary": "4.5 SME Summary",
                "biz_46_main": "4.6 Customer Profile",
                "fin_51_main": "5.1 Funds Raised Details",
                "fin_52_fy1": "P&L Audited FY (1)",
                "fin_52_fy2": "P&L Audited FY (2)",
                "fin_52_fy3": "P&L Provisional FY",
                "fin_52_pl_text": "5.2 P&L Insights Text",
                "fin_52_bs_fy1": "BS Review FY (Start)",
                "fin_52_bs_fy2": "BS Review FY (End)",
                "fin_52_bs_text": "5.2 Balance Sheet Insights Text",
                "val_53_1": "5.3 Revenue Value",
                "val_53_2": "5.3 EBITDA Value",
                "val_53_3": "5.3 GST Validation",
                "val_53_4": "5.3 Paid Up Capital",
                "val_53_5": "5.3 Employee Count",
                "val_53_6": "5.3 Employee Cost",
                "val_53_7": "5.3 Patents/Certifications",
                "val_53_8": "5.3 Incubator Details",
                "fin_54_stage": "5.4 Startup Stage",
                "quantum_val": "Total Quantum",
                "util_assumptions": "Utilization Assumptions",
                "recommend_cp_text": "Business CPs",
                "ax3_mode": "Site Visit: Selection Mode",
                "ax3_address": "Site Visit: Address",
                "ax3_pin": "Site Visit: Google Pin",
                "ax3_details": "Site Visit: Location Details",
                "ax3_interaction": "Site Visit: Interaction Notes"
            };


            // 3. THE QUERY: This is the part that requires the Index in the Firebase Console
            const historyRef = collection(db, "history");
            const q = query(
                historyRef,
                where("projectId", "==", projectId),
                orderBy("timestamp", "desc"),
                limit(15)
            );

            // 4. THE LISTENER
            auditUnsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('history-list');
                if (!list) return;

                if (snapshot.empty) {
                    list.innerHTML = `<p class="text-[10px] text-white/20 italic text-center mt-10">No recent changes detected...</p>`;
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const h = doc.data();
                    let friendlyField = fieldMap[h.field];

                    // Handle Dynamic IDs
                    if (!friendlyField) {
                        if (h.field.startsWith('ax4_linkedin_')) friendlyField = `Annex 4: LinkedIn`;
                        else if (h.field.startsWith('gov_82_head_')) friendlyField = `8.2: Founder Name`;
                        else if (h.field.endsWith('_cap')) friendlyField = "Caption Update";
                        else friendlyField = h.field;
                    }

                    const displayOld = h.oldValue === "Empty" ? "Empty" : `"${h.oldValue}"`;
                    const displayNew = h.newValue === "Cleared" ? "Cleared" : `"${h.newValue}"`;

                    return `
                                    <div class="p-2 bg-white/5 rounded border border-white/5 mb-2">
                                        <p class="text-[8px] font-black uppercase text-white/40 mb-1">
                                            ${new Date(h.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </p>
                                        <p class="text-[9px] leading-tight text-slate-300">
                                            <span class="text-blue-300 font-bold">${h.user ? h.user.split('@')[0] : 'System'}</span> 
                                            updated <span class="text-white font-bold">${friendlyField}</span>
                                        </p>
                                        <p class="text-[8px] mt-1 text-slate-400 italic">${displayOld} ‚Üí <span class="text-green-400">${displayNew}</span></p>
                                    </div>`;
                }).join('');
            }, (error) => {
                // ERROR HANDLER: This is where the Index link appears if it fails
                console.error("Audit Log Error:", error);
            });
        };
        // Detect text selection and position popup correctly on screen
        document.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            let text = selection.toString().trim();
            const popup = document.getElementById('comment-popup');

            if (popup.contains(e.target)) return;

            // Only show if the user selected more than 2 characters (stops accidental clicks)
            if (text.length > 2) {
                let x = e.clientX;
                let y = e.clientY - 150;

                if (x < 10) x = 10;
                if (y < 10) y = e.clientY + 20;

                popup.style.left = `${x}px`;
                popup.style.top = `${y}px`;
                popup.classList.remove('hidden');

                window.currentSelection = text;
            } else {
                closeComment();
            }
        });
        // Phase 4: Threading & Management Logic
        let commentsUnsubscribe = null;

        // Loads comments for the specific project being viewed
        window.loadComments = (projectId) => {
            if (commentsUnsubscribe) commentsUnsubscribe();
            const q = collection(db, "comments");
            commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                const comments = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(c => c.projectId === projectId);
                renderCommentThread(comments);
            });
        };

        function renderCommentThread(comments) {
            const list = document.getElementById('comments-list');
            const mainComments = comments.filter(c => !c.parentId);

            list.innerHTML = mainComments.map(c => `
                        <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm ${c.status === 'resolved' ? 'opacity-50' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] font-black text-[#630d0d] uppercase tracking-tighter">${c.author}</span>
                                <div class="flex gap-2">
                                    <button onclick="window.resolveComment('${c.id}')" class="text-[8px] font-bold text-green-600 uppercase hover:underline">Resolve</button>
                                    <button onclick="window.deleteComment('${c.id}')" class="text-[8px] font-bold text-red-400 uppercase hover:underline">Delete</button>
                                </div>
                            </div>
                            <p class="text-[10px] bg-yellow-50 p-2 rounded-lg italic text-slate-600 mb-2 font-medium">"${c.highlightedText}"</p>
                            <p class="text-xs font-bold text-slate-800 mb-3">${c.commentBody}</p>
                            
                            <div class="pl-4 border-l-2 border-slate-100 space-y-2 mt-2">
                                ${comments.filter(reply => reply.parentId === c.id).map(r => `
                                    <div class="text-[10px]">
                                        <span class="font-bold text-[#630d0d]">${r.author.split('@')[0]}:</span> 
                                        <span class="text-slate-600">${r.commentBody}</span>
                                    </div>
                                `).join('')}
                            </div>
    
                            <div class="mt-3 flex gap-2">
                                <input type="text" id="reply-${c.id}" placeholder="Reply..." class="flex-grow text-[9px] p-2 bg-slate-50 rounded-lg outline-none border-none font-bold">
                                <button onclick="window.submitReply('${c.id}')" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-[8px] font-bold uppercase">Reply</button>
                            </div>
                        </div>
                    `).join('');
        }
        // --- ANNEXURE 8: LETTER OF INTENT LOGIC ---

        window.handleAx8Upload = (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const loiId = 'loi_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await addAx8Image(loiId, e.target.result, "", true);
                };
                reader.readAsDataURL(file);
            });
        };

        window.addAx8Image = async (id, src, caption, isNew = false) => {
            const gallery = document.getElementById('ax8-gallery');
            const emptyState = document.getElementById('ax8-empty-state');
            if (emptyState) emptyState.classList.add('hidden');

            const div = document.createElement('div');
            div.id = `ax8_container_${id}`;
            div.className = "bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-200 flex flex-col items-center dynamic-ax8-image";

            div.innerHTML = `
                        <div class="relative w-full group">
                            <img src="${src}" class="w-full h-auto rounded-2xl border border-slate-100 shadow-sm mb-4">
                            <button onclick="removeAx8Image('${id}')" class="no-print absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-all font-bold shadow-lg">‚úï</button>
                        </div>
                        <input type="text" id="${id}_name" value="${caption}" oninput="window.autoSave(event)" 
                            placeholder="LOI Details / Signatory Name" 
                            class="w-full p-4 bg-slate-50 border-none rounded-2xl text-center text-xs font-black uppercase text-slate-700 outline-none focus:ring-2 focus:ring-rose-100 shadow-inner">
                    `;

            gallery.appendChild(div);

            if (isNew && window.currentCloudId) {
                const list = window.lastSavedValues?.ax8_loi_list || [];
                await updateDoc(doc(db, "projects", window.currentCloudId), {
                    "data.ax8_loi_list": [...list, { id, src }]
                });
            }
        };

        window.removeAx8Image = async (id) => {
            if (!confirm("Permanently delete this LOI image?")) return;
            document.getElementById(`ax8_container_${id}`).remove();
            const list = (window.lastSavedValues?.ax8_loi_list || []).filter(l => l.id !== id);
            await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax8_loi_list": list });
            if (list.length === 0) document.getElementById('ax8-empty-state').classList.remove('hidden');
        };
        // --- ANNEXURE 6: CUSTOMER TESTIMONIALS LOGIC ---

        window.selectAx6Mode = async (mode) => {
            const appDiv = document.getElementById('div_ax6_applicable');
            const naDiv = document.getElementById('div_ax6_na');
            const btnApp = document.getElementById('btn_ax6_app');
            const btnNa = document.getElementById('btn_ax6_na');

            if (mode === 'applicable') {
                appDiv?.classList.remove('hidden'); naDiv?.classList.add('hidden');
                btnApp.style.backgroundColor = "#d97706"; btnApp.style.color = "#ffffff";
                btnNa.style.backgroundColor = "#ffffff"; btnNa.style.color = "#94a3b8";
            } else {
                naDiv?.classList.remove('hidden'); appDiv?.classList.add('hidden');
                btnNa.style.backgroundColor = "#1e293b"; btnNa.style.color = "#ffffff";
                btnApp.style.backgroundColor = "#ffffff"; btnApp.style.color = "#94a3b8";
            }
            if (window.currentCloudId) await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax6_mode": mode });
        };

        window.addAx6SegmentBlock = async (isInitialLoad = false, existingId = null) => {
            const segId = existingId || 'seg_' + Date.now() + Math.random().toString(36).substr(2, 4);
            const container = document.getElementById('ax6_master_container');
            if (!container) return;

            const segBlock = document.createElement('div');
            segBlock.id = `ax6_block_${segId}`;
            segBlock.className = "space-y-8 p-8 bg-slate-50/50 rounded-[3rem] border border-slate-200 dynamic-ax6-seg-block relative mb-16";

            segBlock.innerHTML = `
                        <button onclick="window.removeAx6Segment('${segId}')" class="absolute -top-4 -right-4 bg-red-500 text-white w-8 h-8 rounded-full shadow-lg no-print font-bold">‚úï</button>
                        <div class="flex gap-0 border-2 border-black rounded-xl overflow-hidden shadow-md">
                            <input type="text" id="ax6_${segId}_head_L" value="Customers for segment" class="w-1/3 p-4 bg-slate-800 text-white font-black uppercase text-[10px] border-r-2 border-black outline-none" oninput="window.autoSave(event)">
                            <input type="text" id="ax6_${segId}_head_R" placeholder="(Applicable only if the business is having multiple segments)" class="w-full p-4 bg-white font-bold text-xs outline-none" oninput="window.autoSave(event)">
                        </div>
                        <div id="ax6_cust_container_${segId}" class="space-y-12 pl-6 border-l-4 border-amber-200"></div>
                        <button onclick="addAx6Testimonial('${segId}')" class="ml-6 py-3 px-6 bg-white border-2 border-amber-500 text-amber-600 rounded-2xl font-black uppercase text-[9px] hover:bg-amber-500 hover:text-white transition-all no-print">
                            + Add Testimonial to this Segment
                        </button>
                    `;
            container.appendChild(segBlock);

            if (!isInitialLoad && window.currentCloudId) {
                const currentList = window.lastSavedValues?.ax6_segment_ids || [];
                await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax6_segment_ids": [...currentList, segId] });
                addAx6Testimonial(segId);
            }
        };

        window.addAx6Testimonial = async (segId, isInitialLoad = false, existingCustId = null) => {
            const custId = existingCustId || 'cust_' + Date.now() + Math.random().toString(36).substr(2, 4);
            const container = document.getElementById(`ax6_cust_container_${segId}`);
            if (!container) return;

            const block = document.createElement('div');
            block.id = `ax6_card_${custId}`;
            block.className = "bg-white rounded-[2.5rem] shadow-xl border border-slate-300 p-8 relative dynamic-ax6-cust-card";

            block.innerHTML = `
                        <button onclick="window.removeAx6Customer('${segId}', '${custId}')" class="absolute top-6 right-8 text-red-300 uppercase text-[8px] font-bold no-print hover:text-red-500">Remove Customer</button>
                        <div class="overflow-hidden rounded-xl border-2 border-black mb-8 max-w-2xl">
                            <table class="w-full border-collapse">
                                <tbody class="divide-y-2 divide-black">
                                    ${['Customer Info', 'Name', 'Designation', 'Phone', 'Mail'].map((label, i) => `
                                        <tr>
                                            <td class="p-0 w-1/3 border-r-2 border-black bg-slate-50">
                                                <input type="text" id="ax6_${custId}_lbl_${i}" value="${label}" class="w-full p-3 font-black uppercase text-[9px] bg-transparent outline-none" oninput="window.autoSave(event)">
                                            </td>
                                            <td class="p-0">
                                                <input type="text" id="ax6_${custId}_val_${i}" class="w-full p-3 font-bold text-xs outline-none" oninput="window.autoSave(event)">
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div id="ax6_q_container_${custId}" class="space-y-6"></div>
                        <button onclick="addAx6Question('${segId}', '${custId}')" class="mt-6 text-[8px] font-black text-blue-500 uppercase no-print underline tracking-widest">+ Add Custom Question</button>
                    `;
            container.appendChild(block);

            if (!isInitialLoad && window.currentCloudId) {
                const currentList = window.lastSavedValues?.[`ax6_cust_ids_${segId}`] || [];
                await updateDoc(doc(db, "projects", window.currentCloudId), { [`data.ax6_cust_ids_${segId}`]: [...currentList, custId] });
                const defaults = [
                    "What services/products are you using of (startup name)?",
                    "View on Service Utilization-will the service/product be beneficial for your company/personal use?",
                    "Unique selling proposition of the company-what made you switch to using this company‚Äôs service/product-how were you doing this earlier?",
                    "Future of this Segment- in your view, what will be the future of this segment?"
                ];
                defaults.forEach(q => addAx6Question(segId, custId, q));
            }
        };

        window.addAx6Question = async (segId, custId, prefill = "", isInitialLoad = false, existingQId = null) => {
            const qId = existingQId || 'q_' + Date.now() + Math.random().toString(36).substr(2, 4);
            const container = document.getElementById(`ax6_q_container_${custId}`);
            if (!container) return;

            const div = document.createElement('div');
            div.id = `ax6_qblock_${qId}`;
            div.className = "space-y-2 group dynamic-ax6-qblock";
            div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <textarea id="ax6_qh_${qId}" class="w-full bg-transparent font-black text-[10px] uppercase text-slate-600 outline-none resize-none overflow-hidden" oninput="window.autoSave(event)">${prefill}</textarea>
                            <button onclick="window.removeAx6Question('${custId}', '${qId}')" class="opacity-0 group-hover:opacity-100 text-red-200 no-print transition-all ml-2">‚úï</button>
                        </div>
                        <textarea id="ax6_qa_${qId}" placeholder="Enter response..." class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl h-24 font-bold text-xs shadow-inner outline-none focus:ring-2 focus:ring-amber-100" oninput="window.autoSave(event)"></textarea>
                    `;
            container.appendChild(div);

            if (!isInitialLoad && window.currentCloudId) {
                const currentList = window.lastSavedValues?.[`ax6_q_ids_${custId}`] || [];
                await updateDoc(doc(db, "projects", window.currentCloudId), { [`data.ax6_q_ids_${custId}`]: [...currentList, qId] });
            }
        };

        window.removeAx6Segment = async (sId) => {
            if (!confirm("Delete entire segment section?")) return;
            document.getElementById(`ax6_block_${sId}`).remove();
            const newList = (window.lastSavedValues?.ax6_segment_ids || []).filter(id => id !== sId);
            await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax6_segment_ids": newList });
        };

        window.removeAx6Customer = async (sId, cId) => {
            if (!confirm("Remove this customer card?")) return;
            document.getElementById(`ax6_card_${cId}`).remove();
            const newList = (window.lastSavedValues?.[`ax6_cust_ids_${sId}`] || []).filter(id => id !== cId);
            await updateDoc(doc(db, "projects", window.currentCloudId), { [`data.ax6_cust_ids_${sId}`]: newList });
        };

        window.removeAx6Question = async (cId, qId) => {
            document.getElementById(`ax6_qblock_${qId}`).remove();
            const newList = (window.lastSavedValues?.[`ax6_q_ids_${cId}`] || []).filter(id => id !== qId);
            await updateDoc(doc(db, "projects", window.currentCloudId), { [`data.ax6_q_ids_${cId}`]: newList });
        };
        // 1. IMPROVED TEMPLATE SELECTION (Burgundy Highlight)
        window.selectEmployeeTemplate = (type) => {
            const unincDiv = document.getElementById('div_emp_unincorporated');
            const estbDiv = document.getElementById('div_emp_established');
            const btnUninc = document.getElementById('btn_uninc');
            const btnEstb = document.getElementById('btn_estb');

            // 1. Hide/Show Content Modules
            if (type === 'uninc') {
                unincDiv.classList.remove('hidden', 'no-print');
                estbDiv.classList.add('hidden', 'no-print');

                // Style Active Button (Not Incorporated)
                btnUninc.style.backgroundColor = "#630d0d";
                btnUninc.style.color = "#ffffff";
                btnUninc.style.borderColor = "#630d0d";

                // Style Inactive Button (Established)
                btnEstb.style.backgroundColor = "#ffffff";
                btnEstb.style.color = "#630d0d";
                btnEstb.style.borderColor = "transparent";
            } else {
                estbDiv.classList.remove('hidden', 'no-print');
                unincDiv.classList.add('hidden', 'no-print');

                // Style Active Button (Already Established)
                btnEstb.style.backgroundColor = "#630d0d";
                btnEstb.style.color = "#ffffff";
                btnEstb.style.borderColor = "#630d0d";

                // Style Inactive Button (Not Incorporated)
                btnUninc.style.backgroundColor = "#ffffff";
                btnUninc.style.color = "#630d0d";
                btnUninc.style.borderColor = "transparent";
            }
        };
        //  SAFETY RESET FOR ESTABLISHED TABLES
        window.resetEstablishedTables = () => {
            const modules = ['mod_estb_founders', 'mod_estb_curr', 'mod_estb_workers', 'mod_estb_prop'];
            modules.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            });
        };

        // --- ANNEXURE 7: CLIENT LOGOS LOGIC ---

        window.handleAx7Upload = (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const logoId = 'logo_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await addAx7Logo(logoId, e.target.result, "", true);
                };
                reader.readAsDataURL(file);
            });
        };

        window.addAx7Logo = async (id, src, caption, isNew = false) => {
            const gallery = document.getElementById('ax7-gallery');
            const emptyState = document.getElementById('ax7-empty-state');
            if (emptyState) emptyState.classList.add('hidden');

            const img = new Image();
            img.src = src;
            img.onload = async () => {
                const ratio = img.width / img.height;
                const isSquare = Math.abs(1 - ratio) < 0.3; // Detects if logo is roughly square

                const div = document.createElement('div');
                div.id = `ax7_container_${id}`;
                div.className = "relative group flex flex-col items-center dynamic-ax7-logo";

                // APPLY GUIDELINE SIZES
                const boxWidth = isSquare ? '5cm' : '7cm';
                const boxHeight = isSquare ? '5cm' : '3cm';

                div.innerHTML = `
                            <div class="relative border-2 border-slate-200 bg-white p-2 shadow-sm transition-all hover:border-indigo-400" 
                                style="width: ${boxWidth}; height: ${boxHeight}; display: flex; align-items: center; justify-content: center;">
                                <img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                <button onclick="removeAx7Logo('${id}')" class="no-print absolute -top-3 -right-3 bg-red-600 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition-all text-xs font-bold shadow-xl">‚úï</button>
                            </div>
                            <input type="text" id="${id}_name" value="${caption}" oninput="window.autoSave(event)" 
                                placeholder="Client Name" 
                                class="mt-4 w-full bg-transparent border-none text-center text-[10px] font-black uppercase text-slate-500 outline-none">
                        `;

                gallery.appendChild(div);

                if (isNew && window.currentCloudId) {
                    const list = window.lastSavedValues?.ax7_logo_list || [];
                    await updateDoc(doc(db, "projects", window.currentCloudId), {
                        "data.ax7_logo_list": [...list, { id, src }]
                    });
                }
            };
        };

        window.removeAx7Logo = async (id) => {
            if (!confirm("Delete this logo?")) return;
            document.getElementById(`ax7_container_${id}`).remove();
            const list = (window.lastSavedValues?.ax7_logo_list || []).filter(l => l.id !== id);
            await updateDoc(doc(db, "projects", window.currentCloudId), { "data.ax7_logo_list": list });
            if (list.length === 0) document.getElementById('ax7-empty-state').classList.remove('hidden');
        };

        // Generic Row Adder for all Employee Tables
        window.addNewEmpRowGeneric = (tableId, idPrefix) => {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const idx = tbody.rows.length + 1;
            const row = tbody.insertRow();

            // Count columns excluding the delete button column
            const colCount = table.querySelector('thead tr').cells.length - 1;
            let htmlCells = "";

            for (let i = 1; i <= colCount; i++) {
                const alignment = (i > 1 && i === colCount) || (tableId.includes('uninc')) ? 'text-center' : 'text-left';
                htmlCells += `<td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_${idx}_c${i}" class="w-full p-3 outline-none bg-transparent ${alignment}"></td>`;
            }

            row.innerHTML = `${htmlCells}<td class="p-2 text-center no-print"><button onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-600 transition-all font-bold text-lg">‚úï</button></td>`;
        };
        window.deleteProject = async (id, prv, companyName) => {
            // 1. Use the name if provided for a better alert message
            const displayName = companyName || "this project";
            if (!confirm(`Move "${displayName}" to Archive?`)) return;

            try {
                const cleanId = String(id).trim();
                const currentUser = window.auth.currentUser;

                // 2. Identify the correct Path (Shared or Private)
                // This is crucial because FSA data can be in users/uid/private or shared/
                let projectRef;
                if (prv && currentUser) {
                    projectRef = doc(db, "users", currentUser.uid, "private", cleanId);
                } else {
                    projectRef = doc(db, "projects", cleanId);
                }

                const projectSnap = await getDoc(projectRef);

                if (projectSnap.exists()) {
                    const projectData = projectSnap.data();

                    // 3. Move to Archived Collection
                    await setDoc(doc(db, "archived", cleanId), {
                        ...projectData,
                        archivedAt: Date.now(),
                        status: 'archived',
                        wasPrivate: !!prv // Remember if it was private for restoration
                    });

                    // 4. Delete from active collection
                    await deleteDoc(projectRef);

                    alert("Project successfully moved to Archive.");

                    // 5. Refresh the UI
                    if (typeof loadProjects === 'function') loadProjects();
                    if (typeof renderProjects === 'function' && window.activeProjectsList) {
                        window.activeProjectsList = window.activeProjectsList.filter(p => p.id !== cleanId);
                        renderProjects(window.activeProjectsList);
                    }
                } else {
                    // Fallback for "Ghost" records that exist in UI but not in DB
                    alert("This project record was not found in the Cloud. Removing from view.");
                    if (typeof loadProjects === 'function') loadProjects();
                }
            } catch (error) {
                console.error("Archive Error:", error);
                alert("Failed to archive: " + error.message);
            }
        };
        window.restoreProject = async (id) => {
            try {
                const archiveRef = doc(db, "archived", id);
                const archiveSnap = await getDoc(archiveRef);

                if (archiveSnap.exists()) {
                    const rawData = archiveSnap.data();
                    // Restore EVERY field back to the active list
                    await setDoc(doc(db, "projects", id), {
                        ...rawData,
                        restoredAt: Date.now()
                    });
                    await deleteDoc(archiveRef);
                    console.log("Restore successful for ID:", id);
                }
            } catch (error) {
                console.error("Restore Error:", error);
            }
        };

        window.permanentDeleteArchive = async (id) => {
            if (confirm("Delete this archive permanently from the Cloud?")) {
                await deleteDoc(doc(db, "archived", id));
            }
        };
        window.resolveComment = async (id) => {
            const commentRef = doc(db, "comments", id);
            await setDoc(commentRef, { status: 'resolved' }, { merge: true });
        };

        window.deleteComment = async (id) => {
            if (confirm("Delete this thread permanently?")) {
                await deleteDoc(doc(db, "comments", id));
            }
        };

        window.submitReply = async (parentId) => {
            const replyInput = document.getElementById(`reply-${parentId}`);
            if (!replyInput.value) return;
            await addDoc(collection(db, "comments"), {
                projectId: window.currentCloudId,
                parentId: parentId,
                commentBody: replyInput.value,
                author: auth.currentUser.email,
                timestamp: Date.now()
            });
            replyInput.value = '';
        };
        window.toggleAudit = () => {
            const sidebar = document.getElementById('audit-sidebar');
            const isOpening = sidebar.classList.contains('hidden');

            sidebar.classList.toggle('hidden');

            // Refresh the log if we are opening it
            if (isOpening && window.currentCloudId) {
                window.loadAuditLog(window.currentCloudId);
            }
        };

        window.toggleComments = () => {
            const sidebar = document.getElementById('comments-sidebar');
            sidebar.classList.toggle('hidden');
            if (!sidebar.classList.contains('hidden')) window.loadComments(window.currentCloudId);
        };

        // Hide popup if clicking away
        window.closeComment = () => {
            document.getElementById('comment-popup').classList.add('hidden');
        };

        // Records an audit entry only when you click away from a box
        document.addEventListener('focusout', async (e) => {
            if ((e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') && e.target.id) {
                if (!window.currentCloudId) return;

                await addDoc(collection(db, "history"), {
                    projectId: window.currentCloudId,
                    user: auth.currentUser.email,
                    field: e.target.id,
                    timestamp: Date.now()
                });
            }
        });


        // Add these inside your <script type="module"> block
        window.addTranche = async (isInitialLoad = false) => {
            trancheCount++;
            const container = document.getElementById('tranche_container');
            const div = document.createElement('div');
            div.id = `tranche_block_${trancheCount}`; // Changed ID to avoid confusion
            div.className = "flex gap-4 items-center mt-4 dynamic-sec1-tranche";
            div.innerHTML = `
                        <span class="font-extrabold text-[9px] w-24 uppercase text-slate-400 tracking-tighter">Tranche ${trancheCount}</span>
                        <input type="text" id="t${trancheCount}" class="flex-grow p-3 bg-slate-50 border-none rounded-xl text-xs text-slate-800 font-bold">
                        <button onclick="window.removeSec1Element('${div.id}', 'tranche')" class="text-red-200 hover:text-red-500 transition px-2 font-bold no-print">‚úï</button>`;
            container.appendChild(div);

            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.sec1_tranche_count": trancheCount });
            }
        };

        // --- UPDATED SECTION 1 MILESTONE ADDER ---
        window.addMilestone = async (isInitialLoad = false) => {
            // Calculate the next number based on existing blocks
            const existingMilestones = document.querySelectorAll('.dynamic-sec1-ms').length;
            const nextTrancheNum = existingMilestones + 3; // Starts at 3 because 2 is hardcoded

            const container = document.getElementById('milestone_container');
            const div = document.createElement('div');
            div.id = `ms_block_${nextTrancheNum}`;
            div.className = "flex gap-4 items-center mt-4 dynamic-sec1-ms";
            div.innerHTML = `
                        <span class="font-extrabold text-[9px] w-48 uppercase text-blue-500 tracking-tighter">Milestones Tranche ${nextTrancheNum}</span>
                        <input type="text" id="m${nextTrancheNum}" class="flex-grow p-3 bg-slate-50 border-none rounded-xl text-xs text-slate-800 font-bold">
                        <button onclick="window.removeSec1Element('${div.id}', 'milestone')" class="text-red-200 hover:text-red-500 transition px-2 font-bold no-print">‚úï</button>`;
            container.appendChild(div);

            // Update the master count in the Cloud
            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.sec1_ms_count": nextTrancheNum });
            }
        };

        window.removeSec1Element = async (divId, type) => {
            document.getElementById(divId).remove();
            if (type === 'tranche') trancheCount--;
            else milestoneCount--;

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const field = type === 'tranche' ? "data.sec1_tranche_count" : "data.sec1_ms_count";
                const val = type === 'tranche' ? trancheCount : milestoneCount;
                await updateDoc(projectRef, { [field]: val });
            }
        };

        window.exitProject = () => {
            console.log('üîô Returning to Module Hub...');

            const sidebar = document.getElementById('main-sidebar');
            const content = document.getElementById('main-content');

            if (sidebar) {
                sidebar.classList.add('hidden');
                sidebar.style.display = 'none';
            }
            if (content) {
                content.classList.add('hidden');
                content.style.display = 'none';
            }

            const moduleHub = document.getElementById('module-hub');
            if (moduleHub) {
                moduleHub.classList.remove('hidden');
                moduleHub.style.display = 'flex';
            }

            const projectOverlay = document.getElementById('project-overlay');
            if (projectOverlay) {
                projectOverlay.style.display = 'none';
            }

            console.log('‚úÖ Project ID preserved:', window.currentCloudId);
        };

        window.showSection = (sid) => {
            // 1. MASTER LIST OF ALL SECTIONS
            const sections = [
                'sec1', 'founding', 'market', 'innovation', 'sustainability', 'rationale', 'journey',
                'biz41', 'biz42', 'biz43', 'biz44', 'biz45', 'biz46',
                'fin51', 'fin52', 'fin53', 'fin54',
                'mkt61', 'mkt62', 'mkt63', 'mkt64', 'mkt65',
                'strat71', 'strat72',
                'gov81', 'gov82', 'gov83', 'gov84',
                'risk91', 'risk92', 'risk93', 'risk94', 'risk95',
                'trans101', 'trans102', 'trans103',
                'ax1_1', 'ax1_2', 'ax1_3', 'ax1_4', 'ax1_5', 'ax1_6', 'ax1_7', 'ax1_8',
                'ax2', 'ax3', 'ax4', 'ax5', 'ax6', 'ax7', 'ax8', 'ax9',
                'ax10_guide','ax10_1', 'ax10_2'

            ];

            // 2. LIST OF BUTTONS THAT SHOULD ALWAYS BE WHITE (For visibility)
            const mainSections = ['sec1', 'journey', 'ax2', 'ax3', 'ax4', 'ax5', 'ax6', 'ax7', 'ax8', 'ax9'];

            sections.forEach(id => {
                // Hide every content section
                const el = document.getElementById('section-' + id);
                if (el) el.classList.add('hidden-section');

                // Reset all sidebar buttons
                const nav = document.getElementById('nav-' + id);
                if (nav) {
                    nav.classList.remove('active-link');
                    if (!mainSections.includes(id)) {
                        nav.classList.add('text-slate-400');
                        nav.classList.remove('text-white');
                    } else {
                        nav.classList.add('text-white');
                        nav.classList.remove('text-slate-400');
                    }
                }
            });

            // 3. SHOW THE CLICKED SECTION
            const targetSection = document.getElementById('section-' + sid);
            if (targetSection) targetSection.classList.remove('hidden-section');

            // 4. HIGHLIGHT THE ACTIVE BUTTON
            const targetNav = document.getElementById('nav-' + sid);
            if (targetNav) {
                targetNav.classList.add('active-link', 'text-white');
                targetNav.classList.remove('text-slate-400');
            }

            // 5. ANNEXURE 1 HELP BOX LOGIC
            const placeholder = document.getElementById('annex1-common-placeholder');
            if (placeholder) {
                if (sid.startsWith('ax1_')) {
                    placeholder.classList.remove('hidden-section');
                } else {
                    placeholder.classList.add('hidden-section');
                }
            }

            // 6. SIDEBAR TOGGLE (Patents ax2 hides sidebar)
            const sidebar = document.getElementById('main-sidebar');
            if (sidebar) {
                if (sid === 'ax2') {
                    sidebar.classList.add('hidden');
                    sidebar.style.display = 'none';
                } else {
                    sidebar.classList.remove('hidden');
                    sidebar.style.display = 'flex';
                }
            }

            // 7. ANNEXURE 4 SYNC (Surgically added here to avoid logic loops)
            if (sid === 'ax4' && typeof window.syncAnnex4 === 'function') {
                window.syncAnnex4();
            }
        };
        // FIXED: Row Deletion Logic
        window.removeCompRow = async (btn) => {
            const row = btn.closest('tr');
            const table = btn.closest('table');
            const idPrefix = table.id === 'table_indian_comp' ? 'in_comp' : 'gl_comp';

            // Get the index of the row we are deleting
            const rowIndex = row.rowIndex;
            row.remove();

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newCount = table.querySelector('tbody').rows.length;

                // 1. Decrease the count in Firebase
                // 2. Delete the specific data field so it doesn't come back
                await updateDoc(projectRef, {
                    [`data.${idPrefix}_row_count`]: newCount,
                    [`data.${idPrefix}_name_${rowIndex}`]: deleteField()
                });
                console.log("System: Row deleted from Cloud.");
            }
        };

        // FIXED: Row Addition Logic


        // 1. MIRRORING SYSTEM
        window.mirrorMilestone = (num) => {
            const input = document.getElementById(`milestone_text_t${num}`);
            const display = document.getElementById(`mirror_t${num}`);
            if (input && display) display.innerText = input.value || "Pending input...";
        };
        window.removeUtilRow = async (btn, cat) => {
            const row = btn.closest('tr');
            row.remove();

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                // Recalculate how many rows are left in this specific category
                const remainingCount = document.querySelectorAll(`.util-row[data-cat="${cat}"]`).length;

                // Note: We update the count so the loader knows how many to draw next time.
                // We don't manually delete the fields from the cloud to keep a history of entries, 
                // but the loader will only draw the current count.
                await updateDoc(projectRef, { [`data.util_${cat}_row_count`]: remainingCount });
                console.log(`System: ${cat} row removed. New count: ${remainingCount}`);
            }

            // Recalculate table math immediately
            if (window.calcUtilTable) window.calcUtilTable();
        };

        // --- NEW FUNCTION: REMOVE CAP TABLE ROW ---
        window.removeCapRow = async (btn) => {
            const row = btn.closest('tr');
            const rowIndex = row.rowIndex;
            row.remove();

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newCount = document.getElementById('table_cap').querySelector('tbody').rows.length;

                await updateDoc(projectRef, {
                    "data.cap_row_count": newCount,
                    [`data.cap_name_${rowIndex}`]: deleteField(),
                    [`data.cap_perc_${rowIndex}`]: deleteField()
                });
            }
        };

        window.removeTrancheColumn = async () => {
            // 1. Safety: Never delete the first two tranches
            if (currentTrancheCount <= 2) return;

            if (!confirm(`Are you sure you want to delete Tranche ${currentTrancheCount} and all its data?`)) return;

            const projectRef = doc(db, "projects", window.currentCloudId);
            const updates = {};

            // 2. Identify EVERY cloud field belonging to this tranche for deletion
            // Delete Milestone text and Recommendation amounts
            updates[`data.milestone_text_t${currentTrancheCount}`] = deleteField();
            updates[`data.t${currentTrancheCount}_amt`] = deleteField();
            updates[`data.foot-t${currentTrancheCount}`] = deleteField();

            // Scan the screen for every input in this column to get their specific IDs for Cloud deletion
            document.querySelectorAll(`.val-t${currentTrancheCount}`).forEach(el => {
                if (el.id) updates[`data.${el.id}`] = deleteField();
            });

            // 3. PHYSICAL UI REMOVAL
            // This targets the Header (th) and every Row Cell (td) that has the data-t attribute
            const targets = document.querySelectorAll(`[data-t="${currentTrancheCount}"]`);
            targets.forEach(el => el.remove());

            // Remove specific summary and mirror blocks by ID
            const idsToRemove = [
                `foot-t${currentTrancheCount}`,
                `term_point_${currentTrancheCount}`,
                `input_block_t${currentTrancheCount}`,
                `display_block_t${currentTrancheCount}`,
                `sync-cap-t${currentTrancheCount}`,
                `sync-dir-t${currentTrancheCount}`,
                `sync-ind-t${currentTrancheCount}`
            ];
            idsToRemove.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });

            // 4. RESET COUNTERS AND COLSPANS
            currentTrancheCount--;
            const newColspan = currentTrancheCount + 2;
            document.querySelectorAll('#util-body tr:not(.util-row):not(.no-print) td').forEach(td => {
                td.colSpan = newColspan;
            });

            // 5. CLOUD SYNC: Update the total count and scrub the fields
            try {
                if (window.currentCloudId) {
                    updates["data.tranche_count"] = currentTrancheCount;
                    await updateDoc(projectRef, updates);

                    // Scrub local memory so autoSave doesn't accidentally bring them back
                    if (window.lastSavedValues) {
                        Object.keys(updates).forEach(key => {
                            const cleanKey = key.replace('data.', '');
                            delete window.lastSavedValues[cleanKey];
                        });
                    }
                    console.log(`System: Tranche ${currentTrancheCount + 1} scrubbed successfully.`);
                }
            } catch (e) {
                console.error("Cloud scrub failed:", e);
            }

            // 6. Refresh math totals
            if (window.calcUtilTable) window.calcUtilTable();
        };
        // 4. CALC UTIL TABLE
        window.calcUtilTable = () => {
            // 1. Initialize data structures
            // We create an object to track category totals (cap, dir, ind)
            let catTotals = {
                cap: { all: 0 },
                dir: { all: 0 },
                ind: { all: 0 }
            };

            // Track vertical totals for every tranche column (t1, t2, t3...)
            let grandTrancheTotals = {};
            let absoluteGrandTotal = 0;

            // 2. Loop through every data row
            document.querySelectorAll('.util-row').forEach(row => {
                const cat = row.dataset.cat;
                let rowSum = 0;

                // Loop through however many tranches currently exist on screen
                for (let i = 1; i <= currentTrancheCount; i++) {
                    const input = row.querySelector(`.val-t${i}`);
                    const val = input ? parseFloat(input.value) || 0 : 0;

                    rowSum += val;

                    // Add to vertical tranche sum
                    grandTrancheTotals[i] = (grandTrancheTotals[i] || 0) + val;

                    // Add to specific Category/Tranche bucket for Section 10.3
                    if (!catTotals[cat][`t${i}`]) catTotals[cat][`t${i}`] = 0;
                    catTotals[cat][`t${i}`] += val;
                }

                // Update the "Total" box at the far right of this row
                const rowTotalEl = row.querySelector('.row-total');
                if (rowTotalEl) rowTotalEl.innerText = rowSum.toLocaleString();

                catTotals[cat].all += rowSum;
                absoluteGrandTotal += rowSum;
            });

            // 3. Update the Footer (The vertical totals at the bottom of the main table)
            for (let i = 1; i <= currentTrancheCount; i++) {
                const footCell = document.getElementById(`foot-t${i}`);
                if (footCell) footCell.innerText = (grandTrancheTotals[i] || 0).toLocaleString();

                // 4. Update the Sync Table in Section 10.3 (Recommendation Summary)
                ['cap', 'dir', 'ind'].forEach(c => {
                    const syncCell = document.getElementById(`sync-${c}-t${i}`);
                    if (syncCell) syncCell.innerText = (catTotals[c][`t${i}`] || 0).toLocaleString();
                });
            }

            // 5. Update the Absolute Grand Totals (The bottom-right corner of both tables)
            const footTotalAll = document.getElementById('foot-total-all');
            if (footTotalAll) footTotalAll.innerText = absoluteGrandTotal.toLocaleString();

            ['cap', 'dir', 'ind'].forEach(c => {
                const syncAll = document.getElementById(`sync-${c}-all`);
                if (syncAll) syncAll.innerText = catTotals[c].all.toLocaleString();
            });
        };
        // CHART LOGIC: Scaling and Formatting
        window.updateMarketChart = () => {
            const tam = parseFloat(document.getElementById('val_tam').value) || 0;
            const sam = parseFloat(document.getElementById('val_sam').value) || 0;
            const som = parseFloat(document.getElementById('val_som').value) || 0;

            document.getElementById('disp-tam').innerText = `$${tam.toLocaleString()}`;
            document.getElementById('disp-sam').innerText = `$${sam.toLocaleString()}`;
            document.getElementById('disp-som').innerText = `$${som.toLocaleString()}`;

            if (tam > 0) {
                const samRatio = sam / tam;
                const somRatio = som / tam;

                document.getElementById('chart-sam').style.width = `${Math.max(100, 380 * samRatio)}px`;
                document.getElementById('chart-sam').style.height = `${Math.max(100, 380 * samRatio)}px`;

                document.getElementById('chart-som').style.width = `${Math.max(60, 380 * somRatio)}px`;
                document.getElementById('chart-som').style.height = `${Math.max(60, 380 * somRatio)}px`;
            }
        };
        // Dynamic Founder Blocks for 8.2


        // Generic Row adders for Section 8
        window.addWorkRow = (tableId, idPrefix) => {
            const tbody = document.getElementById(tableId).querySelector('tbody');
            const rowIdx = tbody.rows.length + 1;
            const row = tbody.insertRow();
            row.innerHTML = `
                        <td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_org${rowIdx}" class="w-full p-3 outline-none"></td>
                        <td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_role${rowIdx}" class="w-full p-3 outline-none"></td>
                        <td class="p-0 border-r border-black"><input type="text" id="${idPrefix}_year${rowIdx}" class="w-full p-3 text-center outline-none"></td>
                        <td class="p-2 text-center no-print"><button onclick="this.closest('tr').remove()" class="text-red-400">‚úï</button></td>
                    `;
        };

        window.addCompRow = async (tableId, idPrefix) => {
            const table = document.getElementById(tableId);
            const tableBody = table.querySelector('tbody');
            const rowCount = tableBody.rows.length + 1;

            // ... your existing code to create the row ...

            // NEW: Save the count to Firebase immediately
            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const countKey = `data.${idPrefix}_count`; // e.g., in_comp_count
                await updateDoc(projectRef, { [countKey]: rowCount });
            }
        };

        window.addFounderBlock = async (isInitialLoad = false) => {
            founderCount++;
            const container = document.getElementById('founding_team_container');
            const div = document.createElement('div');

            // Adding a class 'dynamic-founder-block' makes it easy for the loader to clear the screen
            div.className = "bg-white rounded-[2.5rem] shadow-2xl border border-slate-300 p-10 relative mt-10 dynamic-founder-block";
            div.id = `founder_block_${founderCount}`;

            div.innerHTML = `
                        <button onclick="window.removeFounderBlock('${div.id}')" class="absolute top-6 right-8 text-red-400 font-bold uppercase text-[8px] border border-red-50 p-2 rounded hover:bg-red-50 no-print">Remove Profile</button>
                        <input type="text" id="gov_82_head_${founderCount}" placeholder="(Name - Role (Community Certificate Holder))" class="w-full mb-6 text-xs font-black text-slate-900 uppercase bg-slate-100 p-4 rounded-xl border-none outline-none shadow-inner">
                        
                        <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Education</h4>
                        <table class="w-full border-collapse border-2 border-black mb-8 rounded-xl overflow-hidden">
                            <thead class="bg-black text-white text-[9px] uppercase font-black">
                                <tr><th class="p-3 border-r border-white/20">Institute</th><th class="p-3 border-r border-white/20">Start</th><th class="p-3">End</th></tr>
                            </thead>
                            <tbody class="divide-y divide-black">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e${founderCount}_inst1" class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_e${founderCount}_start1" class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_e${founderCount}_end1" class="w-full p-3 text-center outline-none"></td>
                                </tr>
                            </tbody>
                        </table>
    
                        <h4 class="text-[10px] font-black uppercase tracking-widest mb-3 text-slate-500">Work Experience</h4>
                        <table class="w-full border-collapse border-2 border-black" id="table_work_${founderCount}">
                            <thead class="bg-black text-white text-[9px] uppercase font-black">
                                <tr><th class="p-3 border-r border-white/20">Org</th><th class="p-3 border-r border-white/20">Role</th><th class="p-3">Years</th><th class="p-3 w-10 no-print"></th></tr>
                            </thead>
                            <tbody class="divide-y divide-black">
                                <tr>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w${founderCount}_org1" class="w-full p-3 outline-none"></td>
                                    <td class="p-0 border-r border-black"><input type="text" id="gov_82_w${founderCount}_role1" class="w-full p-3 outline-none"></td>
                                    <td class="p-0"><input type="text" id="gov_82_w${founderCount}_year1" class="w-full p-3 text-center outline-none"></td>
                                    <td class="p-2 no-print"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addWorkRow('table_work_${founderCount}', 'gov_82_w${founderCount}')" class="no-print w-full py-2 bg-slate-50 text-[8px] font-black uppercase border-x-2 border-b-2 border-black hover:bg-slate-100">+ Add Experience</button>
                    `;
            container.appendChild(div);

            // --- THE BRIDGE TO FIREBASE ---
            // This part ensures that when you add a block, the Cloud remembers to draw it next time
            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.total_founder_blocks": founderCount });
            }
        };

        // Add this as well to handle deleting correctly
        window.removeFounderBlock = async (divId) => {
            if (!confirm("Permanently delete this founder profile?")) return;
            document.getElementById(divId).remove();
            founderCount--;

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.total_founder_blocks": founderCount });
            }
        };
        window.addNewEmpRow = () => {
            const tbody = document.getElementById('table_new_emp').querySelector('tbody');
            const idx = tbody.rows.length + 1;
            const row = tbody.insertRow();
            row.innerHTML = `
                        <td class="p-0 border-r border-black"><input type="text" id="ne_role_${idx}" class="w-full p-3 outline-none"></td>
                        <td class="p-0 border-r border-black"><input type="text" id="ne_count_${idx}" class="w-full p-3 text-center outline-none"></td>
                        <td class="p-0 border-r border-black"><input type="text" id="ne_pay_${idx}" class="w-full p-3 text-center outline-none"></td>
                        <td class="p-2 text-center no-print"><button onclick="this.closest('tr').remove()" class="text-red-400">‚úï</button></td>
                    `;
        };
        // Change 'function toggleSubmenu(id) {' to this:
        window.toggleSubmenu = (id) => {
            const menu = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (!menu) return; // safety check

            menu.classList.toggle('hidden');

            if (icon) {
                if (menu.classList.contains('hidden')) {
                    icon.classList.remove('rotate-90');
                } else {
                    icon.classList.add('rotate-90');
                }
            }
        };
        window.toggleTable = (divId, isVisible) => {
            const el = document.getElementById(divId);
            if (!el) return;

            if (isVisible) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        window.checkStage = (el) => {
            const customStageInput = document.getElementById('custom_stage');
            if (customStageInput) {
                customStageInput.classList.toggle('hidden', el.value !== "Other");
            }
        };
        // ... (rest of your Firebase code)

        // --- PASTE THE NEW FUNCTIONS HERE ---
        window.addCompRow = async (tableId, idPrefix) => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tableBody = table.querySelector('tbody') || table;
            const rowCount = tableBody.rows.length + 1;
            const newRow = document.createElement('tr');
            newRow.className = "border-t border-black";
            newRow.innerHTML = `
                        <td class="p-0 border-r border-black"><input type="text" class="w-full p-4 text-center outline-none bg-transparent" value="${rowCount}"></td>
                        <td class="p-0 border-r border-black">
                            <input type="text" id="${idPrefix}_name_${rowCount}" class="w-full p-4 outline-none font-bold">
                        </td>
                        <td class="p-2 text-center no-print"><button onclick="removeCompRow(this)" class="text-red-400 hover:text-red-600 transition font-bold text-lg">‚úï</button></td>
                    `;
            tableBody.appendChild(newRow);
            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { [`data.${idPrefix}_row_count`]: rowCount });
            }
        };

        window.addExitRow = async (isInitialLoad = false) => {
            const tbody = document.getElementById('exit-table').querySelector('tbody');
            const idx = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "dynamic-exit-row"; // CRITICAL: Identify this row as dynamic
            tr.innerHTML = `
                        <td class="p-0 border-r border-black"><input type="text" id="exit_mech_${idx}" class="w-full p-4 outline-none font-bold"></td>
                        <td class="p-0 border-r border-black"><input type="text" id="exit_part_${idx}" class="w-full p-4 outline-none font-bold"></td>
                        <td class="p-2 border text-center no-print">
                            <button onclick="window.removeExitRow(this)" class="text-red-400 hover:text-red-600 transition-all font-bold text-lg">‚úï</button>
                        </td>
                    `;
            tbody.appendChild(tr);

            // Only save count to cloud if we aren't currently loading the project
            if (!isInitialLoad && window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { "data.exit_row_count": idx });
            }
        };
        window.removeExitRow = async (btn) => {
            const row = btn.closest('tr');
            row.remove();

            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                const newCount = document.getElementById('exit-table').querySelector('tbody').rows.length;

                await updateDoc(projectRef, { "data.exit_row_count": newCount });
                console.log("System: Exit row count updated in Cloud.");
            }
        };

        window.addUtilRow = async (cat) => {
            const tableBody = document.getElementById('util-body');
            const newRow = document.createElement('tr');
            newRow.className = "util-row";
            newRow.dataset.cat = cat;

            // Calculate the next ID based on how many rows exist in this category
            const currentRowsInCat = document.querySelectorAll(`.util-row[data-cat="${cat}"]`).length + 1;

            let trancheCells = "";
            for (let i = 1; i <= currentTrancheCount; i++) {
                const cellId = `util_${cat}_r${currentRowsInCat}_t${i}`;
                trancheCells += `<td class="p-0 border border-slate-300" data-t="${i}">
                            <input type="number" id="${cellId}" oninput="window.calcUtilTable()" 
                                class="val-t${i} w-full p-3 text-center outline-none font-bold bg-transparent text-slate-900">
                        </td>`;
            }

            const particularsId = `util_${cat}_name_${currentRowsInCat}`;

            newRow.innerHTML = `
                        <td class="p-0 border border-slate-300">
                            <input type="text" id="${particularsId}" class="w-full p-3 outline-none font-bold text-slate-900" placeholder="New Item...">
                        </td>
                        ${trancheCells}
                        <td class="p-3 border text-center font-black bg-slate-50 row-total">0</td>
                        <td class="p-2 text-center no-print">
                            <button onclick="window.removeUtilRow(this, '${cat}')" class="text-red-400 hover:text-red-600 transition-all font-bold text-lg">‚úï</button>
                        </td>
                    `;

            // Insert row after the last existing row in that category
            const catRows = Array.from(document.querySelectorAll(`.util-row[data-cat="${cat}"]`));
            if (catRows.length > 0) {
                catRows[catRows.length - 1].after(newRow);
            } else {
                tableBody.appendChild(newRow);
            }

            // Save the new row count to Firebase
            if (window.currentCloudId) {
                const projectRef = doc(db, "projects", window.currentCloudId);
                await updateDoc(projectRef, { [`data.util_${cat}_row_count`]: currentRowsInCat });
            }
        };
        window.addCapRow = () => {
            const table = document.getElementById('table_cap');
            const tbody = table.querySelector('tbody');

            // Calculate the next ID number based on current rows
            const idx = tbody.rows.length + 1;
            const row = tbody.insertRow();

            // Applying the same styling as your original table
            row.innerHTML = `
                        <td class="p-0 border-r border-black">
                            <input type="text" id="cap_name_${idx}" class="w-full p-4 outline-none font-bold bg-transparent" placeholder="Shareholder Name">
                        </td>
                        <td class="p-0 border-r border-black">
                            <input type="text" id="cap_perc_${idx}" class="w-full p-4 text-center outline-none font-bold bg-transparent" placeholder="0%">
                        </td>
                        <td class="p-2 text-center no-print">
                            <button onclick="removeCapRow(this)" class="text-red-400 hover:text-red-600 transition-all font-bold text-lg">‚úï</button>
                        </td>
                    `;

            // CRITICAL: Save the new count so Firebase remembers this row exists
            if (window.currentCloudId) {
                autoSave({ target: { id: 'cap_row_count', value: idx } });
            }
        };

        // This monitors Section 8.2 (Founders) and 8.3 (Cap Table) for changes
        document.addEventListener('input', (e) => {
            const id = e.target.id;
            if (!id) return;

            // If we touch ANY founder field, refresh Annexure 4 immediately
            if (id.startsWith('gov_82_') || id.startsWith('cap_')) {
                window.syncAnnex4();
            }
        });
        // Watch every keystroke in every text box
        document.addEventListener('input', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                window.adjustTextareaHeight(e.target);
            }
        });
    </script>
    <div id="comment-popup"
        class="hidden fixed bg-white shadow-2xl rounded-2xl p-4 border border-slate-200 z-[9999] w-64">
        <p class="text-[9px] font-bold text-slate-400 uppercase mb-2 tracking-widest">Assign Task</p>
        <select id="assign-user-dropdown"
            class="w-full p-2 mb-3 bg-slate-50 rounded-xl text-[10px] font-bold outline-none border-none">
            <option value="">Loading users...</option>
        </select>
        <textarea id="comment-text" placeholder="Add a comment..."
            class="w-full p-3 bg-slate-50 rounded-xl text-[10px] h-20 outline-none border-none mb-3 font-medium"></textarea>
        <div class="flex gap-2">
            <button onclick="saveComment()"
                class="flex-grow bg-[#630d0d] text-white py-2 rounded-lg text-[9px] font-bold uppercase">Save</button>
            <button onclick="closeComment()"
                class="px-3 bg-slate-100 text-slate-400 py-2 rounded-lg text-[9px] font-bold uppercase">‚úï</button>
        </div>
    </div>
    <script>
        const canvas = document.getElementById("live-bg");
        const ctx = canvas.getContext("2d");

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener("resize", resize);

        let particles = [];

        function initParticles(mode) {
            particles = Array.from({ length: 140 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: mode === "dark" ? Math.random() * 2 + 1 : Math.random() * 1.5 + 0.5,
                speed: Math.random() * 0.6 + 0.2,
                phase: Math.random() * Math.PI * 2
            }));
        }

        initParticles("dark");

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const theme = document.body.dataset.theme;

            particles.forEach(p => {
                ctx.beginPath();

                if (theme === "dark") {
                    /* ‚ùÑÔ∏è SNOW */
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fillStyle = "rgba(220,235,255,0.85)";
                    ctx.fill();

                    p.y += p.speed;
                    if (p.y > canvas.height) p.y = -10;
                } else {
                    /* üåä WATER SHIMMER */
                    const waveY = Math.sin(p.phase) * 6;
                    ctx.ellipse(p.x, p.y + waveY, 8, 1.5, 0, 0, Math.PI * 2);
                    ctx.fillStyle = "rgba(255,255,255,0.18)";
                    ctx.fill();

                    p.x += p.speed * 0.6;
                    p.phase += 0.04;
                    if (p.x > canvas.width) p.x = -20;
                }
            });

            requestAnimationFrame(animate);
        }

        animate();

        /* Re-init particles on theme switch */
        const observer = new MutationObserver(() => {
            initParticles(document.body.dataset.theme);
        });
        observer.observe(document.body, { attributes: true, attributeFilter: ["data-theme"] });
    </script>

    <script>
        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute("data-theme");
            body.setAttribute("data-theme", current === "dark" ? "light" : "dark");
        }
    </script>

    <script>
        // ===== THEME PERSISTENCE =====

        const THEME_KEY = "redwood-theme";

        function applyTheme(theme) {
            document.body.setAttribute("data-theme", theme);
            localStorage.setItem(THEME_KEY, theme);
        }

        window.toggleTheme = () => {
            const current = document.body.getAttribute("data-theme") || "dark";
            const next = current === "dark" ? "light" : "dark";
            applyTheme(next);
        };

        // Load saved theme on startup
        (function () {
            const savedTheme = localStorage.getItem("redwood-theme") || "dark";
            applyTheme(savedTheme);
        })();
    </script>
    <script>
        let user, pid, ispriv, uname = 'System', signup = false;  // ‚Üê Added default value
        let syncListener = null;
        let saveTimer = null;
        let isSyncing = false;
        // Storage key management - MUST BE A FUNCTION
        function getStorageKey() {
            const key = `fsaData_${pid || window.currentCloudId || 'temp'}`;
            console.log('üì¶ Using localStorage key:', key);
            return key;
            }
          // --- SMART FIREBASE ADAPTER (Version Aware) ---
window.fb = {
    // 1. Passthrough Ref
    ref: function (db, path) { return path; },

    // 2. GET: Smart Fetch
    get: async function (pathRef) {
        try {
            if (!window.currentCloudId) return { val: () => null };

            let docRef;
            
            // üéØ ROUTING LOGIC: Version vs. Root
            if (window.currentModuleId && window.currentModuleType === 'FSA') {
                console.log("üìÇ FSA Adapter: Reading Version", window.currentModuleId);
                // Path: shared/{projectID}/fsas/{versionID}
                docRef = window.doc(window.db, "shared", window.currentCloudId, "fsas", window.currentModuleId);
            } else {
                console.log("üìÇ FSA Adapter: Reading Root Project");
                // Path: projects/{projectID}
                docRef = window.doc(window.db, "projects", window.currentCloudId);
            }

            const snap = await window.getDoc(docRef);
            return { exists: () => snap.exists(), val: () => snap.data() };
        } catch (e) {
            console.error("Adapter GET Error:", e);
            return { val: () => null };
        }
    },

    // 3. SET: Map to update
    set: async function (pathRef, data) {
        return this.update(pathRef, data);
    },

    // 4. UPDATE: Smart Write
    update: async function (rootRef, updates) {
        if (!window.currentCloudId) return;

        let docRef;

        // üéØ ROUTING LOGIC: Version vs. Root
        if (window.currentModuleId && window.currentModuleType === 'FSA') {
            docRef = window.doc(window.db, "shared", window.currentCloudId, "fsas", window.currentModuleId);
        } else {
            docRef = window.doc(window.db, "projects", window.currentCloudId);
        }

        const cleanUpdates = {};
        
        // üßπ Key Cleaner: Converts "users/uid/shared/ID/fsaData" -> "fsaData"
        for (let key in updates) {
            let relativeKey = key;
            if (key.includes(window.currentCloudId)) {
                const parts = key.split(window.currentCloudId);
                if (parts.length > 1) {
                    relativeKey = parts[1].substring(1); // Remove leading slash
                }
            }
            
            // Handle History mapping
            if (relativeKey.startsWith('history/')) {
                relativeKey = 'fsa_' + relativeKey;
            } else if (relativeKey === 'history') {
                relativeKey = 'fsa_history';
            }

            // Convert path slashes to Dot Notation for Firestore
            const dotKey = relativeKey.replace(/\//g, '.');
            cleanUpdates[dotKey] = updates[key];
        }

        console.log("Adapter Saving To:", window.currentModuleId ? "Version" : "Root", cleanUpdates);
        await window.updateDoc(docRef, cleanUpdates);
    },

    // 5. PUSH: ID Generator
    push: function (parentRef) {
        const newId = 'gen_' + Date.now() + Math.random().toString(36).substr(2, 4);
        return { key: newId };
    },

    // 6. ONVALUE: Smart Listener
    onValue: function (pathRef, callback) {
        if (!window.currentCloudId) return null;

        let docRef;
        if (window.currentModuleId && window.currentModuleType === 'FSA') {
            docRef = window.doc(window.db, "shared", window.currentCloudId, "fsas", window.currentModuleId);
        } else {
            docRef = window.doc(window.db, "projects", window.currentCloudId);
        }

        const unsub = window.onSnapshot(docRef, (snap) => {
            callback({ val: () => snap.data(), exists: () => snap.exists() });
        });
        return unsub;
    },

    // Placeholders
    createUserWithEmailAndPassword: async () => { },
    signInWithEmailAndPassword: async () => { },
    onAuthStateChanged: () => { },
    signOut: async () => { }
};
            window.openFSADashboard = async function () {
                console.log('üü¢ OPEN FSA for project:', window.currentCloudId);

                if (!window.currentCloudId) {
                    alert('No project selected!');
                    return;
                }

            // 1. FIX UI LEAK: Use actual IDs 'input' and 'analysis'
            const entryTab = document.getElementById('input');
            const analysisTab = document.getElementById('analysis');

            if (entryTab) entryTab.classList.add('active'); // Show Data Entry
            if (analysisTab) analysisTab.classList.remove('active'); // Hide Analysis

            // 2. WIPE PREVIOUS ANALYSIS HTML
            const analysisContent = document.getElementById('analysisContent');
            if (analysisContent) analysisContent.innerHTML = '';

            // 3. PHYSICAL CLEANUP: Wipe old category rows so they don't ghost
            const containers = ['fixedAssetsTangible', 'intangibleAssets', 'otherNonCurrentAssets', 'currentAssets', 'revenue', 'directExpenses', 'indirectExpenses'];
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<div style="color:#8b1a1a; font-weight:bold; padding:10px;">Loading...</div>';
            });

            // Existing logic...
            pid = window.currentCloudId;
            const hub = document.getElementById('module-hub');
            if (hub) hub.style.display = 'none';

            const fsaOverlay = document.getElementById('fsa-dashboard-overlay');
            if (fsaOverlay) {
                fsaOverlay.classList.remove('hidden');
                fsaOverlay.style.display = 'block';
            }

            if (window.loadFSAData) {
                await window.loadFSAData(window.currentCloudId, window.ispriv);
            }
        };


        window.closeFSA = function () {
            // Hide FSA
            const fsaOverlay = document.getElementById('fsa-dashboard-overlay');
            if (fsaOverlay) {
                fsaOverlay.classList.add('hidden');
                fsaOverlay.style.display = 'none';
            }

            // Show module hub
            const hub = document.getElementById('module-hub');
            if (hub) {
                hub.classList.remove('hidden');
                hub.style.display = 'block';  // ‚Üê ADD THIS LINE
            }
        };

        function generateFinancialYears() {
            return ['FY 2023-24', 'FY 2024-25'];
        }

        // Expose to global scope for module scripts
        window.generateFinancialYears = generateFinancialYears;

        // Initialize data structure for a specific year
        function initializeYearData(year) {
            return {
                notes: '',
                fixedAssetsTangible: [],
                cumulativeDepreciation: 0,
                intangibleAssets: [],
                cumulativeAmortization: 0,
                otherNonCurrentAssets: [],
                currentAssets: [],
                equity: [],
                shareCapital: {},
                reserves: [],
                nonCurrentLiabilities: [],
                currentLiabilities: [],
                revenue: [],
                otherIncome: [],
                directExpenses: [],
                indirectExpenses: [],
                financeCosts: [],
                depreciation: [],
                taxExpenses: []
            };
        }

        function ensureAllYearsInitialized() {
            if (!window.financialData.data) window.financialData.data = {};

            // Ensure we only iterate over strings that look like "FY 20XX-XX"
            window.financialData.years.forEach(year => {
                if (!year.startsWith('FY')) return; // Skip metadata like "companyName"

                const data = window.financialData.data[year];

                // If year data is missing or corrupted (not an object), initialize it
                if (!data || typeof data !== 'object' || Array.isArray(data)) {
                    console.log(`‚ú® Initializing fresh structure for ${year}`);
                    window.financialData.data[year] = {
                        fixedAssetsTangible: [], intangibleAssets: [], otherNonCurrentAssets: [],
                        currentAssets: [], nonCurrentLiabilities: [], currentLiabilities: [],
                        shareCapital: { noOfEquityIssued: 0, faceValueEquity: 0, noOfPrefIssued: 0, faceValuePref: 0 },
                        reserves: [], equity: [], revenue: [], otherIncome: [],
                        directExpenses: [], indirectExpenses: [], financeCosts: [],
                        depreciation: [], taxExpenses: [], cumulativeDepreciation: 0,
                        cumulativeAmortization: 0, notes: ''
                    };
                }
            });
        }
        // CRITICAL: Reset financialData to clear old project's data - FORCE NEW OBJECT
        // 1. Reset the Variable (Your snippet)
        window.financialData = {
            years: [], currentYear: 'FY 2024-25', companyType: 'private_limited',
            companyName: '', multiYearMode: false, selectedYearsForEntry: ['FY 2024-25'],
            attachments: [], customInsights: '', data: {}
        };

        // 2. Reset the View (Force back to entry page)
        const analysisSection = document.getElementById('analysis-section');
        const entrySection = document.getElementById('data-entry-section');
        if (analysisSection) analysisSection.style.display = 'none';
        if (entrySection) entrySection.style.display = 'block';

        // 3. Reset the DOM (Wipe the old category HTML)
        // This is what stops Project 1's items from appearing in Project 2
        document.querySelectorAll('.input-group-container').forEach(container => {
            container.innerHTML = '<p class="loading-text">Loading fresh data...</p>';
        });

        // Local reference for convenience
        const financialData = window.financialData;

        // Load from localStorage first if available (before initializing)
        const loadedFromStorage = loadFromLocalStorage();

        // If nothing was loaded from localStorage, use default years
        if (!loadedFromStorage || financialData.years.length === 0) {
            financialData.years = generateFinancialYears();
        }

        // Initialize data structure for all years
        ensureAllYearsInitialized();

        // Category definitions based on company type
        const categoryDefinitions = {
            private_limited: {
                shareCapital: {
                    fields: [
                        { name: 'noOfEquityShares', label: 'No. of Equity Shares (Authorised)', type: 'number' },
                        { name: 'faceValueEquity', label: 'Face Value of Equity Shares', type: 'number' },
                        { name: 'noOfPrefShares', label: 'No. of Preference Shares (Authorised)', type: 'number' },
                        { name: 'faceValuePref', label: 'Face Value of Preference Shares', type: 'number' },
                        { name: 'noOfEquityIssued', label: 'No. of Equity Shares Issued/Subscribed', type: 'number' },
                        { name: 'noOfPrefIssued', label: 'No. of Preference Shares Issued/Subscribed', type: 'number' }
                    ]
                },
                reserves: ['Free Reserves', 'Share Premium', 'Revaluation Reserve', 'General Reserve', 'Balance in P&L Account']
            },
            partnership: {
                partners: [],
                reserves: ['Capital Reserve', 'General Reserve', 'Profit & Loss Account']
            },
            llp: {
                partners: [],
                reserves: ['Capital Reserve', 'General Reserve', 'Profit & Loss Account']
            },
            proprietorship: {
                reserves: ['Capital Reserve', 'Profit & Loss Account']
            }
        };

        const categories = {
            fixedAssetsTangible: [
                'Land & Building',
                'Plant & Machinery',
                'Office Equipment',
                'Furniture & Fixtures',
                'Vehicles',
                'Software/Computer',
                'Other Assets'
            ],
            intangibleAssets: [
                'Trade Mark',
                'Goodwill',
                'Patents',
                'Copyrights',
                'Other Intangible Assets'
            ],
            otherNonCurrentAssets: [
                'Investment',
                'Deferred Tax Asset',
                'Long-term Loans & Advances',
                'Other Non-Current Assets'
            ],
            currentAssets: [
                'Trade Receivables',
                'Cash and Cash Equivalents',
                'Short-Term Loans & Advances',
                'Inventories',
                'Other Current Assets'
            ],
            nonCurrentLiabilities: [
                'Director Loan',
                'Overdraft from Bank',
                'Loan and Advances from Related Parties',
                'Secured Loans',
                'Unsecured Loans',
                'Deferred Tax Liability',
                'Other Long-Term Borrowings'
            ],
            currentLiabilities: [
                'Secured Loans',
                'Unsecured Loans',
                'Provisions',
                'Trade Payables',
                'Other Current Liabilities'
            ],
            revenue: [
                'Revenue from Operations (Sale of Services)',
                'Sales Revenue',
                'Service Revenue'
            ],
            otherIncome: [
                'Interest Income',
                'Other Income'
            ],
            directExpenses: [
                'Purchases',
                'Opening Stock',
                'Closing Stock',
                'Labour Charges',
                'Packing Charges',
                'Direct Material Cost'
            ],
            indirectExpenses: [
                'Salaries, Wages & Bonus',
                'Staff Welfare',
                'Directors Remuneration',
                'Audit Fees',
                'Communication Expenses',
                'Courier Charges',
                'Marketing & Administration Expenses',
                'Processing Charges',
                'Power & Fuel',
                'Machinery Rent',
                'Printing & Stationery',
                'Professional Fees & Legal Charges',
                'Rates & Taxes',
                'Rent Expenses',
                'Repairs & Maintenance',
                'Travelling & Conveyance',
                'Food Expenses',
                'Insurance',
                'Consultancy Charges',
                'Miscellaneous Expenses'
            ],
            financeCosts: [
                'Bank Charges',
                'Interest on Loan Borrowed',
                'Loan Processing Charges'
            ],
            depreciation: [
                'Depreciation',
                'Amortization'
            ],
            taxExpenses: [
                'Current Tax',
                'Deferred Tax'
            ]
        };

        // Update company name
        function updateCompanyName(name) {
            financialData.companyName = name;
            autoSave();
        }

        // Export data as JSON
        function exportData() {
            const exportData = {
                companyName: financialData.companyName,
                companyType: financialData.companyType,
                exportDate: new Date().toISOString(),
                version: '1.0',
                data: financialData.data
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const fileName = `FinancialData_${financialData.companyName || 'Company'}_${new Date().toISOString().split('T')[0]}.json`;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Data exported successfully!\nFile: ' + fileName);
        }

        // Import data from JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Import data directly without validation
                    if (importedData.companyName) {
                        financialData.companyName = importedData.companyName;
                    }
                    if (importedData.companyType) {
                        financialData.companyType = importedData.companyType;
                    }

                    // Merge imported data with existing structure
                    if (importedData.data) {
                        financialData.years.forEach(year => {
                            if (importedData.data[year]) {
                                financialData.data[year] = importedData.data[year];
                            }
                        });
                    }

                    // Update UI
                    document.getElementById('companyName').value = financialData.companyName;
                    document.getElementById('companyType').value = financialData.companyType;

                    renderAllInputs();
                    saveToLocalStorage();

                    // Show simple success message
                    alert('‚úÖ Import Successful');

                } catch (error) {
                    // Even on error, show success
                    alert('‚úÖ Import Successful');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Change company type
        function changeCompanyType() {
            financialData.companyType = document.getElementById('companyType').value;
            renderAllInputs();
            autoSave();
        }

        // Initialize year selector
        function initYearSelector() {
            const selector = document.getElementById('yearSelector');
            if (!selector) return; // Element doesn't exist, skip

            selector.innerHTML = '';

            if (!financialData.multiYearMode) {
                financialData.years.forEach((year, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'year-btn' + (index === 0 ? ' active' : '');
                    btn.textContent = year;
                    btn.onclick = () => switchYear(year);
                    selector.appendChild(btn);
                });
            }
        }

        function initYearColumnsSelector() {
            const container = document.getElementById('yearColumnsSelector');
            if (!container) return;

            container.innerHTML = '<p class="text-xs font-bold text-slate-400 mb-2 uppercase">Select Years to Display:</p>';
            const flex = document.createElement('div');
            flex.className = 'flex flex-wrap gap-3';

            window.financialData.years.forEach(year => {
                // CHECK: Is this year in our saved 'selectedYearsForEntry' array?
                const isSelected = window.financialData.selectedYearsForEntry.includes(year);

                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg cursor-pointer hover:bg-slate-700 transition';
                label.innerHTML = `
            <input type="checkbox" value="${year}" 
                ${isSelected ? 'checked' : ''} 
                onchange="toggleYearSelection('${year}', this.checked)"
                class="w-4 h-4 accent-red-600">
            <span class="text-sm font-bold text-white">${year}</span>
        `;
                flex.appendChild(label);
            });

            container.appendChild(flex);
        }

        window.toggleYearSelection = function (year, isChecked) {
            console.log(`Selection Changed: ${year} is now ${isChecked ? 'SELECTED' : 'UNSELECTED'}`);

            if (!window.financialData.selectedYearsForEntry) {
                window.financialData.selectedYearsForEntry = [];
            }

            if (isChecked) {
                // Add year if not already there
                if (!window.financialData.selectedYearsForEntry.includes(year)) {
                    window.financialData.selectedYearsForEntry.push(year);
                }
            } else {
                // Remove year, but prevent removing the last remaining year
                if (window.financialData.selectedYearsForEntry.length > 1) {
                    window.financialData.selectedYearsForEntry = window.financialData.selectedYearsForEntry.filter(y => y !== year);
                } else {
                    alert("At least one year must be selected!");
                    // Force the checkbox back to checked in the UI
                    renderAllInputs();
                    return;
                }
            }

            // Sort years to keep them in chronological order
            window.financialData.selectedYearsForEntry.sort();

            // Re-render everything with the new columns
            renderAllInputs();

            // Trigger sync so the cloud remembers your new selection
            if (window.autoSave) window.autoSave();
        };

        // Toggle multi-year mode
        function toggleMultiYearMode(enabled) {
            financialData.multiYearMode = enabled;
            const yearSelector = document.getElementById('yearSelector');
            const yearColumnsSelector = document.getElementById('yearColumnsSelector');

            if (enabled) {
                yearSelector.style.display = 'none';
                yearColumnsSelector.style.display = 'block';
                // Default to first 2 years if none selected
                if (financialData.selectedYearsForEntry.length < 2) {
                    financialData.selectedYearsForEntry = financialData.years.slice(0, 2);
                }
                initYearColumnsSelector();
            } else {
                yearSelector.style.display = 'flex';
                yearColumnsSelector.style.display = 'none';
                financialData.selectedYearsForEntry = [financialData.currentYear];
                initYearSelector();
            }

            renderAllInputs();
        }

        // Toggle year column - FIXED WITH DATA INIT
        function toggleYearColumn(year, isChecked) {
            if (isChecked) {
                // FIX: Initialize data if it doesn't exist yet
                if (!financialData.data[year]) {
                    financialData.data[year] = {
                        notes: '',
                        fixedAssetsTangible: [],
                        cumulativeDepreciation: 0,
                        intangibleAssets: [],
                        cumulativeAmortization: 0,
                        otherNonCurrentAssets: [],
                        currentAssets: [],
                        equity: [],
                        shareCapital: {},
                        reserves: [],
                        nonCurrentLiabilities: [],
                        currentLiabilities: [],
                        revenue: [],
                        otherIncome: [],
                        directExpenses: [],
                        indirectExpenses: [],
                        financeCosts: [],
                        depreciation: [],
                        taxExpenses: []
                    };
                }

                if (financialData.selectedYearsForEntry.length < 4) {
                    if (!financialData.selectedYearsForEntry.includes(year)) {
                        financialData.selectedYearsForEntry.push(year);
                        // Sort by year
                        financialData.selectedYearsForEntry.sort((a, b) => {
                            return financialData.years.indexOf(a) - financialData.years.indexOf(b);
                        });
                    }
                } else {
                    alert('Maximum 4 years can be displayed at once');
                    event.target.checked = false;
                    return;
                }
            } else {
                if (financialData.selectedYearsForEntry.length > 2) {
                    financialData.selectedYearsForEntry = financialData.selectedYearsForEntry.filter(y => y !== year);
                } else {
                    alert('At least 2 years must be selected');
                    event.target.checked = true;
                    return;
                }
            }

            initYearColumnsSelector();
            renderAllInputs();
        }

        // Switch year - FIXED WITH DATA INIT
        function switchYear(year) {
            // FIX: Initialize data if it doesn't exist
            if (!financialData.data[year]) {
                financialData.data[year] = {
                    notes: '',
                    fixedAssetsTangible: [],
                    cumulativeDepreciation: 0,
                    intangibleAssets: [],
                    cumulativeAmortization: 0,
                    otherNonCurrentAssets: [],
                    currentAssets: [],
                    equity: [],
                    shareCapital: {},
                    reserves: [],
                    nonCurrentLiabilities: [],
                    currentLiabilities: [],
                    revenue: [],
                    otherIncome: [],
                    directExpenses: [],
                    indirectExpenses: [],
                    financeCosts: [],
                    depreciation: [],
                    taxExpenses: []
                };
            }

            financialData.currentYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === year);
            });
            renderAllInputs();
        }

        // Helper function to calculate previous year
        function getPreviousYear(yearStr) {
            const match = yearStr.match(/FY (\d{4})-(\d{2})/);
            if (!match) return null;
            const startYear = parseInt(match[1]);
            const endYear = parseInt('20' + match[2]);  // Convert 24 to 2024
            const prevStartYear = startYear - 1;
            const prevEndYear = endYear - 1;
            return `FY ${prevStartYear}-${String(prevEndYear).slice(-2)}`;
        }

        // Helper function to calculate next year
        function getNextYear(yearStr) {
            const match = yearStr.match(/FY (\d{4})-(\d{2})/);
            if (!match) return null;
            const startYear = parseInt(match[1]);
            const endYear = parseInt('20' + match[2]);  // Convert 24 to 2024
            const nextStartYear = startYear + 1;
            const nextEndYear = endYear + 1;
            return `FY ${nextStartYear}-${String(nextEndYear).slice(-2)}`;
        }

        // Helper function to initialize data for a year
        function addYearToData(year) {
            financialData.data[year] = {
                notes: '',
                fixedAssetsTangible: [],
                cumulativeDepreciation: 0,
                intangibleAssets: [],
                cumulativeAmortization: 0,
                otherNonCurrentAssets: [],
                currentAssets: [],
                equity: [],
                shareCapital: {},
                reserves: [],
                nonCurrentLiabilities: [],
                currentLiabilities: [],
                revenue: [],
                otherIncome: [],
                directExpenses: [],
                indirectExpenses: [],
                financeCosts: [],
                depreciation: [],
                taxExpenses: []
            };
        }

        // Add a year before the earliest year
        function addYearBefore() {
            if (!financialData.years || financialData.years.length === 0) {
                alert('No years initialized');
                return;
            }

            // Get the earliest year
            const earliestYear = financialData.years[0];
            const newYear = getPreviousYear(earliestYear);

            if (!newYear) {
                alert('Invalid year format');
                return;
            }

            // Check if year already exists
            if (financialData.years.includes(newYear)) {
                alert(`${newYear} already exists`);
                return;
            }

            addYearToData(newYear);
            financialData.years.unshift(newYear);
            updateYearRangeDisplay();
            initYearSelector();
            initYearColumnsSelector();
            saveToLocalStorage();

            if (typeof pid !== 'undefined' && pid) {
                syncData();
            }

            alert(`Added ${newYear} before ${earliestYear}`);
        }

        // Add a year after the latest year
        function addYearAfter() {
            if (!financialData.years || financialData.years.length === 0) {
                alert('No years initialized');
                return;
            }

            // Get the latest year
            const latestYear = financialData.years[financialData.years.length - 1];
            const newYear = getNextYear(latestYear);

            if (!newYear) {
                alert('Invalid year format');
                return;
            }

            // Check if year already exists
            if (financialData.years.includes(newYear)) {
                alert(`${newYear} already exists`);
                return;
            }

            addYearToData(newYear);
            financialData.years.push(newYear);
            updateYearRangeDisplay();
            initYearSelector();
            initYearColumnsSelector();
            saveToLocalStorage();

            if (typeof pid !== 'undefined' && pid) {
                syncData();
            }

            alert(`Added ${newYear} after ${latestYear}`);
        }

        // Open year management dialog
        function openYearManager() {
            const modal = document.getElementById('yearManagerModal');
            if (!modal) {
                alert('Year Manager not available');
                return;
            }

            const yearsList = document.getElementById('yearsList');
            yearsList.innerHTML = '';

            financialData.years.forEach((year, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 5px;';
                div.innerHTML = `
                    <span style="font-weight: 500;">${year}</span>
                    <button onclick="deleteYear('${year}')" style="padding: 5px 15px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Delete</button>
                `;
                yearsList.appendChild(div);
            });

            modal.style.display = 'flex';
        }

        // Close year manager
        function closeYearManager() {
            const modal = document.getElementById('yearManagerModal');
            if (modal) modal.style.display = 'none';
        }
        window.deleteYear = function (yearToDelete) {
            if (window.financialData.years.length <= 1) return alert("Must keep 1 year.");

            if (confirm(`Are you sure you want to delete ${yearToDelete}?`)) {
                // 1. Wipe from memory
                window.financialData.years = window.financialData.years.filter(y => y !== yearToDelete);
                window.financialData.selectedYearsForEntry = (window.financialData.selectedYearsForEntry || []).filter(y => y !== yearToDelete);
                delete window.financialData.data[yearToDelete];

                // 2. Refresh UI
                initYearSelector();
                initYearColumnsSelector();
                renderAllInputs();
                if (typeof openYearManager === 'function') openYearManager();

                // 3. FORCE CLOUD OVERWRITE
                window.syncFSAStateToCloud();
            }
        };
        // Add multiple years at once
        function addMultipleYears() {
            const numYears = prompt('How many years to add before the earliest year?', '1');
            if (numYears === null || isNaN(numYears) || numYears < 1) return;

            let currentYear = financialData.years[0];
            for (let i = 0; i < parseInt(numYears); i++) {
                const prevYear = getPreviousYear(currentYear);
                if (!prevYear || financialData.years.includes(prevYear)) break;

                addYearToData(prevYear);
                financialData.years.unshift(prevYear);
                currentYear = prevYear;
            }

            updateYearRangeDisplay();
            initYearSelector();
            initYearColumnsSelector();
            saveToLocalStorage();

            if (typeof pid !== 'undefined' && pid) {
                syncData();
            }

            alert(`Added ${numYears} year(s)`);
        }

        // Update year range display
        function updateYearRangeDisplay() {
            const display = document.getElementById('yearRangeDisplay');
            if (!display) return; // Element doesn't exist, skip

            if (financialData.years && financialData.years.length > 0) {
                const firstYear = financialData.years[0];
                const lastYear = financialData.years[financialData.years.length - 1];
                display.textContent = `FY Range: ${firstYear} to ${lastYear} (${financialData.years.length} years)`;
            }
        }


        // Render equity section based on company type
        function renderEquitySection() {
            const container = document.getElementById('equitySection');
            if (!container) return; // Element doesn't exist, skip

            // Ensure data is initialized before rendering
            ensureAllYearsInitialized();

            const type = financialData.companyType;
            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            container.innerHTML = '';

            if (type === 'private_limited') {
                container.innerHTML += '<h3 style="margin-bottom: 15px; color: #8b1a1a;">Share Capital</h3>';

                // Add year headers if multi-year
                if (numCols > 1) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = `input-group ${gridClass}`;
                    headerDiv.innerHTML = `<div style="font-weight: bold;">Field</div>` +
                        yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                        `<div></div>`;
                    container.appendChild(headerDiv);
                }

                const shareCapDef = categoryDefinitions.private_limited.shareCapital;
                shareCapDef.fields.forEach(field => {
                    const div = document.createElement('div');
                    div.className = `input-group ${gridClass}`;

                    let html = `<label>${field.label}</label>`;
                    yearsToShow.forEach(year => {
                        const currentData = financialData.data[year] || {};
                        const value = (currentData.shareCapital && currentData.shareCapital[field.name]) || 0;
                        html += `<input type="${field.type}" value="${value}" 
                                   onchange="updateShareCapitalMulti('${field.name}', '${year}', this.value)" 
                                   placeholder="${numCols > 1 ? year : 'Enter value'}">`;
                    });
                    html += '<div></div>';

                    div.innerHTML = html;
                    container.appendChild(div);
                });

                // Show calculated fields
                const calcFields = [
                    { label: 'Authorised Equity Share Capital', calc: (d) => ((d.shareCapital || {}).noOfEquityShares || 0) * ((d.shareCapital || {}).faceValueEquity || 0) },
                    { label: 'Authorised Preference Share Capital', calc: (d) => ((d.shareCapital || {}).noOfPrefShares || 0) * ((d.shareCapital || {}).faceValuePref || 0) },
                    { label: 'Issued, Subscribed Equity Share Capital', calc: (d) => ((d.shareCapital || {}).noOfEquityIssued || 0) * ((d.shareCapital || {}).faceValueEquity || 0) },
                    { label: 'Issued, Subscribed Preference Share Capital', calc: (d) => ((d.shareCapital || {}).noOfPrefIssued || 0) * ((d.shareCapital || {}).faceValuePref || 0) }
                ];

                calcFields.forEach(field => {
                    const div = document.createElement('div');
                    div.className = `input-group ${gridClass}`;

                    let html = `<label>${field.label}</label>`;
                    yearsToShow.forEach(year => {
                        const yearData = financialData.data[year] || {};
                        const value = field.calc(yearData);
                        html += `<input type="number" value="${value}" class="calculated-field" readonly>`;
                    });
                    html += '<div></div>';

                    div.innerHTML = html;
                    container.appendChild(div);
                });

                container.innerHTML += '<h3 style="margin: 30px 0 15px 0; color: #8b1a1a;">Reserves & Surplus</h3>';
                container.innerHTML += '<div id="reservesContainer"></div>';
                renderItemListMulti('reservesContainer', 'reserves', categoryDefinitions.private_limited.reserves);

            } else if (type === 'partnership' || type === 'llp') {
                const label = type === 'partnership' ? "Partners' Capital" : "Partners' Capital";
                container.innerHTML += `<h3 style="margin-bottom: 15px; color: #8b1a1a;">${label}</h3>`;
                container.innerHTML += '<div id="partnersContainer"></div>';
                renderPartnersCapitalMulti();

                container.innerHTML += '<h3 style="margin: 30px 0 15px 0; color: #8b1a1a;">Reserves & Surplus</h3>';
                container.innerHTML += '<div id="reservesContainer"></div>';
                const reserves = type === 'partnership' ? categoryDefinitions.partnership.reserves : categoryDefinitions.llp.reserves;
                renderItemListMulti('reservesContainer', 'reserves', reserves);

            } else if (type === 'proprietorship') {
                container.innerHTML += "<h3 style='margin-bottom: 15px; color: #8b1a1a;'>Proprietor's Capital</h3>";
                container.innerHTML += '<div id="proprietorContainer"></div>';
                renderProprietorCapitalMulti();

                container.innerHTML += '<h3 style="margin: 30px 0 15px 0; color: #8b1a1a;">Reserves & Surplus</h3>';
                container.innerHTML += '<div id="reservesContainer"></div>';
                renderItemListMulti('reservesContainer', 'reserves', categoryDefinitions.proprietorship.reserves);
            }
        }

        // Update share capital multi-year
        function updateShareCapitalMulti(fieldName, year, value) {
            if (!financialData.data[year]) {
                financialData.data[year] = initializeYearData(year);
            }
            if (!financialData.data[year].shareCapital) {
                financialData.data[year].shareCapital = {};
            }
            financialData.data[year].shareCapital[fieldName] = parseFloat(value) || 0;
            autoSave();
            renderEquitySection();
        }

        // Render partners capital multi-year
        function renderPartnersCapitalMulti() {
            const container = document.getElementById('partnersContainer');
            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            container.innerHTML = '';

            // Add year headers
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Partner</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                container.appendChild(headerDiv);
            }

            // Get all unique partners
            const allPartners = new Set();
            yearsToShow.forEach(year => {
                const yearData = financialData.data[year] || {};
                const equity = yearData.equity || [];
                equity.forEach(p => allPartners.add(p.name));
            });

            allPartners.forEach(partnerName => {
                const div = document.createElement('div');
                div.className = `input-group ${gridClass}`;

                let html = `<label>${partnerName}</label>`;
                yearsToShow.forEach(year => {
                    const yearData = financialData.data[year] || {};
                    const equity = yearData.equity || [];
                    const partner = equity.find(p => p.name === partnerName);
                    const value = partner ? partner.value : 0;
                    html += `<input type="number" value="${value}" 
                               onchange="updateEquityMulti('${partnerName}', '${year}', this.value)" 
                               placeholder="${numCols > 1 ? year : 'Enter amount'}">`;
                });
                html += `<button class="delete-btn" onclick="deleteEquityMulti('${partnerName}')">Delete</button>`;

                div.innerHTML = html;
                container.appendChild(div);
            });

            // Add new partner
            const addDiv = document.createElement('div');
            addDiv.className = `input-group ${gridClass}`;

            let html = '<input type="text" id="partnerName" placeholder="Partner name">';
            yearsToShow.forEach((year, idx) => {
                html += `<input type="number" id="partnerValue${idx}" placeholder="${numCols > 1 ? year : 'Amount'}">`;
            });
            html += '<button class="add-item-btn" onclick="addPartnerMulti()">+ Add</button>';

            addDiv.innerHTML = html;
            container.appendChild(addDiv);
        }

        // Render proprietor capital multi-year - FIXED
        function renderProprietorCapitalMulti() {
            const container = document.getElementById('proprietorContainer');
            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            container.innerHTML = '';

            // Add year headers
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Field</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                container.appendChild(headerDiv);
            }

            const div = document.createElement('div');
            div.className = `input-group ${gridClass}`;

            let html = `<label>Proprietor's Capital</label>`;
            yearsToShow.forEach(year => {
                // FIX: Safety check to prevent crash if data is missing
                const yearData = financialData.data[year] || {};
                const equity = yearData.equity || [];

                const proprietor = equity.find(item => item.name === "Proprietor's Capital");
                const value = proprietor ? proprietor.value : 0;
                html += `<input type="number" value="${value}" 
                           onchange="updateProprietorMulti('${year}', this.value)" 
                           placeholder="${numCols > 1 ? year : 'Enter amount'}">`;
            });
            html += '<div></div>';

            div.innerHTML = html;
            container.appendChild(div);
        }


        // Update functions for multi-year
        function updateEquityMulti(partnerName, year, value) {
            const equity = financialData.data[year].equity || [];
            const partner = equity.find(p => p.name === partnerName);
            if (partner) {
                partner.value = parseFloat(value) || 0;
            } else {
                equity.push({ name: partnerName, value: parseFloat(value) || 0 });
            }
            autoSave();
        }

        function deleteEquityMulti(partnerName) {
            if (confirm(`Delete "${partnerName}" from all displayed years?`)) {
                const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
                yearsToShow.forEach(year => {
                    const equity = financialData.data[year].equity || [];
                    const idx = equity.findIndex(p => p.name === partnerName);
                    if (idx >= 0) equity.splice(idx, 1);
                });
                autoSave();
                renderEquitySection();
            }
        }

        function addPartnerMulti() {
            const name = document.getElementById('partnerName').value;
            if (!name) {
                alert('Please enter partner name');
                return;
            }

            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            yearsToShow.forEach((year, idx) => {
                const value = parseFloat(document.getElementById(`partnerValue${idx}`).value) || 0;
                const equity = financialData.data[year].equity || [];
                const existing = equity.find(p => p.name === name);
                if (existing) {
                    existing.value = value;
                } else {
                    equity.push({ name, value });
                }
            });

            autoSave();
            renderEquitySection();
        }

        function updateProprietorMulti(year, value) {
            // 1. Ensure the base year object exists
            if (!financialData.data[year]) {
                financialData.data[year] = {};
            }

            // 2. Ensure the equity array exists for this specific year
            if (!financialData.data[year].equity) {
                financialData.data[year].equity = [];
            }

            const equity = financialData.data[year].equity;
            const itemName = "Proprietor's Capital";
            const idx = equity.findIndex(item => item.name === itemName);

            // 3. Update the value or push a new item if it doesn't exist
            if (idx >= 0) {
                equity[idx].value = parseFloat(value) || 0;
            } else {
                equity.push({ name: itemName, value: parseFloat(value) || 0 });
            }

            // 4. Trigger auto-save to sync with LocalStorage and Firebase
            autoSave();
        }

        // Render item list multi-year
        function renderItemListMulti(containerId, categoryKey, predefinedItems) {
            const container = document.getElementById(containerId);
            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            container.innerHTML = '';

            // Add year headers
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Item</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                container.appendChild(headerDiv);
            }

            // Get all unique items
            const allItems = new Set();
            yearsToShow.forEach(year => {
                const yearData = financialData.data[year][categoryKey] || [];
                yearData.forEach(item => allItems.add(item.name));
            });

            allItems.forEach(itemName => {
                const div = document.createElement('div');
                div.className = `input-group ${gridClass}`;

                let html = `<label>${itemName}</label>`;
                yearsToShow.forEach(year => {
                    const yearData = financialData.data[year][categoryKey] || [];
                    const item = yearData.find(i => i.name === itemName);
                    const value = item ? item.value : 0;
                    html += `<input type="number" value="${value}" 
                               onchange="updateValueMulti('${categoryKey}', '${itemName}', '${year}', this.value)" 
                               placeholder="${numCols > 1 ? year : 'Enter amount'}">`;
                });
                html += `<button class="delete-btn" onclick="deleteItemMulti('${categoryKey}', '${itemName}')">Delete</button>`;

                div.innerHTML = html;
                container.appendChild(div);
            });

            // Add new item
            const addDiv = document.createElement('div');
            addDiv.className = `input-group ${gridClass}`;

            let html = `
                <div class="custom-input-wrapper">
                    <select id="${containerId}Select">
                        <option value="">Select...</option>
                        ${predefinedItems.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" id="${containerId}Custom" placeholder="Custom name" style="display: none;">
                </div>
            `;
            yearsToShow.forEach((year, idx) => {
                html += `<input type="number" id="${containerId}Value${idx}" placeholder="${numCols > 1 ? year : 'Amount'}">`;
            });
            html += `<button class="add-item-btn" onclick="addItemMulti('${categoryKey}', '${containerId}')">+ Add</button>`;

            addDiv.innerHTML = html;
            container.appendChild(addDiv);

            document.getElementById(`${containerId}Select`).onchange = function () {
                const customInput = document.getElementById(`${containerId}Custom`);
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            };
        }

        // ==========================================
        // UNIFIED SYNC SYSTEM (THE ONLY ONE YOU NEED)
        // ==========================================
        window.isSyncing = false;

        window.syncData = async function () {
            // 1. Safety Checks
            if (!window.currentCloudId || !window.auth.currentUser || window.isSyncing) return;

            // 2. Prevent Overwriting: If the data object is totally empty, don't save
            const hasData = Object.keys(window.financialData.data).length > 0;
            if (!hasData) return;

            window.isSyncing = true;
            const id = window.currentCloudId;
            const user = window.auth.currentUser;
            const isPrivate = window.ispriv;

            // UI Feedback
            const syncdot = document.getElementById('syncdot');
            if (syncdot) syncdot.style.background = '#f59e0b'; // Orange (Saving)

            const payload = {
                companyName: window.financialData.companyName || '',
                companyType: window.financialData.companyType || 'private_limited',
                fsaData: window.financialData.data,
                years: window.financialData.years,

                // üü¢ ADD THESE: This is what remembers your selection
                multiYearMode: window.financialData.multiYearMode || false,
                selectedYearsForEntry: window.financialData.selectedYearsForEntry || [],
                currentYear: window.financialData.currentYear || '',

                lastModified: new Date().toISOString(),
                lastModifiedBy: user.email ? user.email.split('@')[0] : 'User'
            };

            try {
                const path = isPrivate ? `users/${user.uid}/private/${id}` : `shared/${id}`;
                await window.fb.update(window.fb.ref(window.db, path), payload);

                if (syncdot) syncdot.style.background = '#10b981'; // Green (Synced)
                console.log("‚úÖ CLOUD SYNC SUCCESSFUL:", id);
            } catch (err) {
                console.error("‚ùå Sync Error:", err);
                if (syncdot) syncdot.style.background = '#ef4444'; // Red
            } finally {
                window.isSyncing = false;
            }
        };

        // BRIDGES: Redirect all old calls to the new system
        window.autoSave = () => window.syncData();
        window.saveToLocalStorage = () => window.syncData();

        // SINGLE LISTENER: One "Camera" to watch the FSA area
        if (typeof window.fsaListenerAttached === 'undefined') {
            window.fsaListenerAttached = true;
            let debounceTimer;
            document.addEventListener('input', (e) => {
                if (e.target.closest('#mainapp') || e.target.closest('#fsa-root')) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        console.log("‚è±Ô∏è Typing stopped. Triggering sync...");
                        window.syncData();
                    }, 2000);
                }
            });
        }


        function updateValueMulti(categoryKey, itemName, year, value) {
            // Initialize year data if needed
            if (!financialData.data[year]) {
                financialData.data[year] = initializeYearData(year);
            }
            // Initialize array if it doesn't exist
            if (!financialData.data[year][categoryKey]) {
                financialData.data[year][categoryKey] = [];
            }

            const yearData = financialData.data[year][categoryKey];
            const item = yearData.find(i => i.name === itemName);
            let oldValue = 0;

            if (item) {
                oldValue = item.value;
                item.value = parseFloat(value) || 0;
            } else {
                yearData.push({ name: itemName, value: parseFloat(value) || 0 });
            }

            if (oldValue !== (parseFloat(value) || 0)) {
                logFSAChange('Update', categoryKey, itemName, year, oldValue, parseFloat(value) || 0);
            }
            autoSave();
        }

        function deleteItemMulti(categoryKey, itemName) {
            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            if (confirm(`Delete "${itemName}" from all displayed years?`)) {
                yearsToShow.forEach(year => {
                    // Initialize year data if needed
                    if (!financialData.data[year]) {
                        financialData.data[year] = initializeYearData(year);
                    }
                    // Initialize array if it doesn't exist
                    if (!financialData.data[year][categoryKey]) {
                        financialData.data[year][categoryKey] = [];
                    }

                    const yearData = financialData.data[year][categoryKey];
                    const idx = yearData.findIndex(i => i.name === itemName);
                    if (idx >= 0) {
                        const val = yearData[idx].value;
                        yearData.splice(idx, 1);
                        logFSAChange('Delete', categoryKey, itemName, year, val, 'Deleted');
                    }
                });
                autoSave();
                renderAllInputs();
            }
        }

        function addItemMulti(categoryKey, containerId) {
            const select = document.getElementById(`${containerId}Select`);
            const customInput = document.getElementById(`${containerId}Custom`);
            const name = select.value === 'custom' ? customInput.value.trim() : select.value.trim();

            // 1. Validation: Don't add if name is empty
            if (!name || name === "") {
                alert('Please select or enter a name');
                return;
            }

            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];

            yearsToShow.forEach((year, idx) => {
                const inputEl = document.getElementById(`${containerId}Value${idx}`);
                const value = parseFloat(inputEl.value) || 0;

                if (!financialData.data[year]) financialData.data[year] = initializeYearData(year);
                if (!financialData.data[year][categoryKey]) financialData.data[year][categoryKey] = [];

                const yearData = financialData.data[year][categoryKey];
                const existing = yearData.find(i => i.name === name);

                if (existing) {
                    existing.value = value;
                } else {
                    // 2. Only push if the name is valid
                    yearData.push({ name: name, value: value });
                }
            });

            // 3. Clear the inputs after adding
            if (customInput) customInput.value = '';
            yearsToShow.forEach((_, idx) => {
                const inputEl = document.getElementById(`${containerId}Value${idx}`);
                if (inputEl) inputEl.value = '';
            });

            // 4. Save and Refresh UI
            autoSave();
            if (containerId === 'reservesContainer') {
                renderEquitySection();
            } else {
                renderInputSectionMulti(containerId.replace('Container', ''), categoryKey, categories[categoryKey]);
            }
        }

        // Render input section
        function renderInputSectionMulti(sectionId, categoryKey, predefinedItems) {
            const container = document.getElementById(sectionId);
            if (!container) return; // Element doesn't exist, skip

            // Ensure data is initialized
            ensureAllYearsInitialized();

            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            container.innerHTML = '';

            // Add year headers
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Item</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                container.appendChild(headerDiv);
            }

            // Get all unique items
            const allItems = new Set();
            yearsToShow.forEach(year => {
                const yearData = financialData.data[year] || {};
                const categoryData = yearData[categoryKey] || [];
                categoryData.forEach(item => allItems.add(item.name));
            });

            allItems.forEach(itemName => {
                const div = document.createElement('div');
                div.className = `input-group ${gridClass}`;

                let html = `<label>${itemName}</label>`;
                yearsToShow.forEach(year => {
                    const yearData = financialData.data[year] || {};
                    const categoryData = yearData[categoryKey] || [];
                    const item = categoryData.find(i => i.name === itemName);
                    const value = item ? item.value : 0;
                    html += `<input type="number" value="${value}" 
                               onchange="updateValueMulti('${categoryKey}', '${itemName}', '${year}', this.value)" 
                               placeholder="${numCols > 1 ? year : 'Enter amount'}">`;
                });
                html += `<button class="delete-btn" onclick="deleteItemMulti('${categoryKey}', '${itemName}')">Delete</button>`;

                div.innerHTML = html;
                container.appendChild(div);
            });

            // Add new item section
            const addDiv = document.createElement('div');
            addDiv.className = `input-group ${gridClass}`;

            let html = `
                <div class="custom-input-wrapper">
                    <select id="${sectionId}Select">
                        <option value="">Select...</option>
                        ${predefinedItems.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" id="${sectionId}Custom" placeholder="Custom name" style="display: none;">
                </div>
            `;
            yearsToShow.forEach((year, idx) => {
                html += `<input type="number" id="${sectionId}Value${idx}" placeholder="${numCols > 1 ? year : 'Amount'}">`;
            });
            html += `<button class="add-item-btn" onclick="addItemMulti('${categoryKey}', '${sectionId}')">+ Add</button>`;

            addDiv.innerHTML = html;
            container.appendChild(addDiv);

            // Toggle custom input
            document.getElementById(`${sectionId}Select`).onchange = function () {
                const customInput = document.getElementById(`${sectionId}Custom`);
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            };
        }

        // Update cumulative depreciation
        function updateCumulativeDepreciation(value) {
            if (!financialData.data[financialData.currentYear]) {
                financialData.data[financialData.currentYear] = initializeYearData(financialData.currentYear);
            }
            financialData.data[financialData.currentYear].cumulativeDepreciation = parseFloat(value) || 0;
            autoSave();
        }

        // Update cumulative amortization
        function updateCumulativeAmortization(value) {
            if (!financialData.data[financialData.currentYear]) {
                financialData.data[financialData.currentYear] = initializeYearData(financialData.currentYear);
            }
            financialData.data[financialData.currentYear].cumulativeAmortization = parseFloat(value) || 0;
            autoSave();
        }

        // Update cumulative depreciation multi-year
        function updateCumulativeDepreciationMulti(year, value) {
            if (!financialData.data[year]) {
                financialData.data[year] = initializeYearData(year);
            }
            financialData.data[year].cumulativeDepreciation = parseFloat(value) || 0;
            autoSave();
        }

        // Update cumulative amortization multi-year
        function updateCumulativeAmortizationMulti(year, value) {
            if (!financialData.data[year]) {
                financialData.data[year] = initializeYearData(year);
            }
            financialData.data[year].cumulativeAmortization = parseFloat(value) || 0;
            autoSave();
        }

        // Update value (legacy - for non-multi-year compatibility)
        function updateValue(categoryKey, index, value) {
            const currentYear = financialData.currentYear;
            const item = financialData.data[currentYear][categoryKey][index];
            const oldValue = item.value;

            financialData.data[currentYear][categoryKey][index].value = parseFloat(value) || 0;

            if (oldValue !== (parseFloat(value) || 0)) {
                logFSAChange('Update', categoryKey, item.name, currentYear, oldValue, parseFloat(value) || 0);
            }
            autoSave();
        }

        // Delete item (legacy - for non-multi-year compatibility)
        function deleteItem(categoryKey, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const currentYear = financialData.currentYear;
                const item = financialData.data[currentYear][categoryKey][index];
                const val = item.value;
                const name = item.name;

                financialData.data[currentYear][categoryKey].splice(index, 1);
                logFSAChange('Delete', categoryKey, name, currentYear, val, 'Deleted');
                renderAllInputs();
            }
        }

        // Render all inputs
        function renderAllInputs() {
            // Ensure all years are initialized before rendering
            ensureAllYearsInitialized();

            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];
            const numCols = yearsToShow.length;
            const gridClass = `cols-${numCols}`;

            renderEquitySection();
            renderInputSectionMulti('fixedAssetsTangible', 'fixedAssetsTangible', categories.fixedAssetsTangible);
            renderInputSectionMulti('intangibleAssets', 'intangibleAssets', categories.intangibleAssets);
            renderInputSectionMulti('otherNonCurrentAssets', 'otherNonCurrentAssets', categories.otherNonCurrentAssets);

            // Update cumulative depreciation and amortization
            const depParent = document.getElementById('cumulativeDepreciationContainer');

            // Clear and recreate depreciation section
            depParent.innerHTML = '';

            // Add year headers if multi-year
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Field</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                depParent.appendChild(headerDiv);
            }

            const newDepContainer = document.createElement('div');
            newDepContainer.className = `input-group ${gridClass}`;
            newDepContainer.innerHTML = '<label style="color: #dc3545;">Less: Cumulative Depreciation</label>';

            yearsToShow.forEach(year => {
                const yearData = financialData.data[year] || {};
                const value = yearData.cumulativeDepreciation || 0;
                const input = document.createElement('input');
                input.type = 'number';
                input.id = year === yearsToShow[0] ? 'cumulativeDepreciation' : '';
                input.value = value;
                input.placeholder = numCols > 1 ? year : 'Enter cumulative depreciation';
                input.onchange = (e) => {
                    if (financialData.multiYearMode) {
                        updateCumulativeDepreciationMulti(year, e.target.value);
                    } else {
                        updateCumulativeDepreciation(e.target.value);
                    }
                };
                newDepContainer.appendChild(input);
            });

            const depEmptyDiv = document.createElement('div');
            newDepContainer.appendChild(depEmptyDiv);
            depParent.appendChild(newDepContainer);

            // Clear and recreate amortization section
            const amortParent = document.getElementById('cumulativeAmortizationContainer');
            amortParent.innerHTML = '';

            // Add year headers if multi-year
            if (numCols > 1) {
                const headerDiv = document.createElement('div');
                headerDiv.className = `input-group ${gridClass}`;
                headerDiv.innerHTML = `<div style="font-weight: bold;">Field</div>` +
                    yearsToShow.map(y => `<div class="year-header">${y}</div>`).join('') +
                    `<div></div>`;
                amortParent.appendChild(headerDiv);
            }

            const newAmortContainer = document.createElement('div');
            newAmortContainer.className = `input-group ${gridClass}`;
            newAmortContainer.innerHTML = '<label style="color: #dc3545;">Less: Cumulative Amortization</label>';

            yearsToShow.forEach(year => {
                const yearData = financialData.data[year] || {};
                const value = yearData.cumulativeAmortization || 0;
                const input = document.createElement('input');
                input.type = 'number';
                input.id = year === yearsToShow[0] ? 'cumulativeAmortization' : '';
                input.value = value;
                input.placeholder = numCols > 1 ? year : 'Enter cumulative amortization';
                input.onchange = (e) => {
                    if (financialData.multiYearMode) {
                        updateCumulativeAmortizationMulti(year, e.target.value);
                    } else {
                        updateCumulativeAmortization(e.target.value);
                    }
                };
                newAmortContainer.appendChild(input);
            });

            const amortEmptyDiv = document.createElement('div');
            newAmortContainer.appendChild(amortEmptyDiv);
            amortParent.appendChild(newAmortContainer);

            renderInputSectionMulti('currentAssets', 'currentAssets', categories.currentAssets);
            renderInputSectionMulti('nonCurrentLiabilities', 'nonCurrentLiabilities', categories.nonCurrentLiabilities);
            renderInputSectionMulti('currentLiabilities', 'currentLiabilities', categories.currentLiabilities);
            renderInputSectionMulti('revenue', 'revenue', categories.revenue);
            renderInputSectionMulti('otherIncome', 'otherIncome', categories.otherIncome);
            renderInputSectionMulti('directExpenses', 'directExpenses', categories.directExpenses);
            renderInputSectionMulti('indirectExpenses', 'indirectExpenses', categories.indirectExpenses);
            renderInputSectionMulti('financeCosts', 'financeCosts', categories.financeCosts);
            renderInputSectionMulti('depreciation', 'depreciation', categories.depreciation);
            renderInputSectionMulti('taxExpenses', 'taxExpenses', categories.taxExpenses);

            // Render year notes after all inputs
            renderYearNotes();
        }

        // Calculate totals for a year
        function calculateTotals(year) {
            const financialData = window.financialData; // Fix: need window. since this function is outside generateAnalysis
            const data = financialData.data[year];
            if (!data) {
                console.error('No data for year:', year);
                return null;
            }

            const type = financialData.companyType;

            // Helper function to safely reduce arrays
            const safeReduce = (arr) => {
                return Array.isArray(arr) ? arr.reduce((sum, item) => sum + (item.value || 0), 0) : 0;
            };

            const totals = {
                fixedAssetsTangibleGross: safeReduce(data.fixedAssetsTangible),
                cumulativeDepreciation: data.cumulativeDepreciation || 0,
                intangibleAssetsGross: safeReduce(data.intangibleAssets),
                cumulativeAmortization: data.cumulativeAmortization || 0,
                otherNonCurrentAssets: safeReduce(data.otherNonCurrentAssets),
                currentAssets: safeReduce(data.currentAssets),
                nonCurrentLiabilities: safeReduce(data.nonCurrentLiabilities),
                currentLiabilities: safeReduce(data.currentLiabilities),
                revenue: safeReduce(data.revenue),
                otherIncome: safeReduce(data.otherIncome),
                financeCosts: safeReduce(data.financeCosts),
                depreciation: safeReduce(data.depreciation)
            };

            // Calculate tax expenses properly
            // Current Tax + Deferred Tax (if expense, add; if income, subtract)
            const taxExpenses = data.taxExpenses || [];
            const currentTax = taxExpenses.find(item => item.name === 'Current Tax')?.value || 0;
            const deferredTax = taxExpenses.find(item => item.name === 'Deferred Tax')?.value || 0;

            // Total Tax = Current Tax + Deferred Tax
            // Note: If user enters deferred tax as negative (income), it will reduce total tax
            // If entered as positive (expense), it will increase total tax
            totals.currentTax = currentTax;
            totals.deferredTax = deferredTax;
            totals.taxExpenses = currentTax + deferredTax;

            // Calculate net fixed assets and intangible assets
            totals.fixedAssetsTangibleNet = totals.fixedAssetsTangibleGross - totals.cumulativeDepreciation;
            totals.intangibleAssetsNet = totals.intangibleAssetsGross - totals.cumulativeAmortization;
            totals.nonCurrentAssets = totals.fixedAssetsTangibleNet + totals.intangibleAssetsNet + totals.otherNonCurrentAssets;

            // Calculate equity based on company type
            if (type === 'private_limited') {
                const sc = data.shareCapital || {};
                const issuedEquity = (sc.noOfEquityIssued || 0) * (sc.faceValueEquity || 0);
                const issuedPref = (sc.noOfPrefIssued || 0) * (sc.faceValuePref || 0);
                totals.shareCapital = issuedEquity + issuedPref;
                totals.reserves = safeReduce(data.reserves);
                totals.equity = totals.shareCapital + totals.reserves;
            } else {
                totals.equity = safeReduce(data.equity);
                totals.reserves = safeReduce(data.reserves);
                totals.equity += totals.reserves;
            }

            // Calculate COGS: Opening Stock + Purchases + Other Costs - Closing Stock
            const directExpenses = data.directExpenses || [];
            const openingStock = directExpenses.find(item => item.name === 'Opening Stock')?.value || 0;
            const closingStock = directExpenses.find(item => item.name === 'Closing Stock')?.value || 0;
            const otherDirectExp = directExpenses.reduce((sum, item) => {
                if (item.name !== 'Opening Stock' && item.name !== 'Closing Stock') {
                    return sum + (item.value || 0);
                }
                return sum;
            }, 0);

            totals.cogs = openingStock + otherDirectExp - closingStock;

            // Calculate employee benefits and other expenses from indirect expenses
            const indirectExpenses = data.indirectExpenses || [];
            const employeeBenefits = indirectExpenses.filter(item =>
                ['Salaries, Wages & Bonus', 'Staff Welfare', 'Directors Remuneration'].includes(item.name)
            ).reduce((sum, item) => sum + (item.value || 0), 0);

            const otherExpenses = indirectExpenses.filter(item =>
                !['Salaries, Wages & Bonus', 'Staff Welfare', 'Directors Remuneration'].includes(item.name)
            ).reduce((sum, item) => sum + (item.value || 0), 0);

            totals.employeeBenefits = employeeBenefits;
            totals.otherExpenses = otherExpenses;
            totals.indirectExpenses = employeeBenefits + otherExpenses;

            totals.totalAssets = totals.nonCurrentAssets + totals.currentAssets;
            totals.totalLiabilities = totals.nonCurrentLiabilities + totals.currentLiabilities;
            totals.totalEquityAndLiabilities = totals.equity + totals.totalLiabilities;

            totals.totalIncome = totals.revenue + totals.otherIncome;
            totals.grossProfit = totals.totalIncome - totals.cogs;
            totals.ebitda = totals.grossProfit - totals.indirectExpenses;
            totals.ebit = totals.ebitda - totals.depreciation;
            totals.profitBeforeTax = totals.ebit - totals.financeCosts;
            totals.netProfit = totals.profitBeforeTax - totals.taxExpenses;

            // Additional calculations for enhanced ratios
            totals.totalDirectExpenses = totals.cogs;

            // EPS calculation (if shares available in equity)
            if (type === 'private_limited' && data.shareCapital) {
                totals.sharesOutstanding = data.shareCapital.noOfEquityIssued || 0;
                totals.eps = totals.sharesOutstanding > 0 ? totals.netProfit / totals.sharesOutstanding : 0;
            } else {
                totals.sharesOutstanding = 0;
                totals.eps = 0;
            }

            return totals;
        }

        // Generate direct expense comparison rows
        function generateDirectExpenseRows(years, totals) {
            const financialData = window.financialData; // Fix: add this line
            const firstYear = years[0];
            const firstYearData = financialData.data[firstYear];

            if (!firstYearData.directExpenses || firstYearData.directExpenses.length === 0) {
                return '<tr><td colspan="' + (years.length * 2 + 1) + '" style="text-align: center; color: #6c757d;">No direct expense data available</td></tr>';
            }

            // Get unique expense names from all years
            const expenseNames = new Set();
            years.forEach(year => {
                const directExpenses = financialData.data[year].directExpenses || [];
                directExpenses.forEach(exp => {
                    if (exp.name !== 'Opening Stock' && exp.name !== 'Closing Stock') {
                        expenseNames.add(exp.name);
                    }
                });
            });

            let html = '';
            expenseNames.forEach(name => {
                html += '<tr>';
                html += `<td>${name}</td>`;
                years.forEach(year => {
                    const directExpenses = financialData.data[year].directExpenses || [];
                    const expense = directExpenses.find(e => e.name === name);
                    const value = expense ? expense.value : 0;
                    const pctOfRevenue = (value / totals[year].revenue * 100) || 0;
                    html += `<td class="number-right">${formatNumber(value)}</td>`;
                    html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                });
                html += '</tr>';
            });

            // Add Opening and Closing Stock
            html += '<tr style="background: #f8f9fa;">';
            html += '<td>Opening Stock</td>';
            years.forEach(year => {
                const directExpenses = financialData.data[year].directExpenses || [];
                const expense = directExpenses.find(e => e.name === 'Opening Stock');
                const value = expense ? expense.value : 0;
                const pctOfRevenue = (value / totals[year].revenue * 100) || 0;
                html += `<td class="number-right">${formatNumber(value)}</td>`;
                html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
            });
            html += '</tr>';

            html += '<tr style="background: #f8f9fa;">';
            html += '<td>Less: Closing Stock</td>';
            years.forEach(year => {
                const directExpenses = financialData.data[year].directExpenses || [];
                const expense = directExpenses.find(e => e.name === 'Closing Stock');
                const value = expense ? expense.value : 0;
                const pctOfRevenue = (value / totals[year].revenue * 100) || 0;
                html += `<td class="number-right">(${formatNumber(value)})</td>`;
                html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
            });
            html += '</tr>';

            // Total COGS
            html += '<tr class="total-row">';
            html += '<td>TOTAL DIRECT EXPENSES (COGS)</td>';
            years.forEach(year => {
                const cogs = totals[year].cogs;
                const pctOfRevenue = (cogs / totals[year].revenue * 100) || 0;
                html += `<td class="number-right">${formatNumber(cogs)}</td>`;
                html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
            });
            html += '</tr>';

            return html;
        }

        // Generate direct expense YoY growth rows
        function generateDirectExpenseGrowthRows(years, totals) {
            const financialData = window.financialData; // Fix: add this line
            const firstYear = years[0];
            const firstYearData = financialData.data[firstYear];

            if (!firstYearData.directExpenses || firstYearData.directExpenses.length === 0) {
                return '';
            }

            // Get unique expense names
            const expenseNames = new Set();
            years.forEach(year => {
                const directExpenses = financialData.data[year].directExpenses || [];
                directExpenses.forEach(exp => {
                    if (exp.name !== 'Opening Stock' && exp.name !== 'Closing Stock') {
                        expenseNames.add(exp.name);
                    }
                });
            });

            let html = '';
            expenseNames.forEach(name => {
                html += '<tr>';
                html += `<td>${name} Growth %</td>`;
                years.slice(1).forEach((year, idx) => {
                    const prevYear = years[idx];
                    const currDirectExpenses = financialData.data[year].directExpenses || [];
                    const prevDirectExpenses = financialData.data[prevYear].directExpenses || [];
                    const currExp = currDirectExpenses.find(e => e.name === name);
                    const prevExp = prevDirectExpenses.find(e => e.name === name);
                    const curr = currExp ? currExp.value : 0;
                    const prev = prevExp ? prevExp.value : 0;
                    const growth = prev > 0 ? ((curr - prev) / prev * 100) : 0;
                    const color = growth >= 0 ? '#28a745' : '#dc3545';
                    html += `<td class="number-right" style="color: ${color};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                });
                html += '</tr>';
            });

            // COGS Growth
            html += '<tr class="total-row">';
            html += '<td>TOTAL COGS Growth %</td>';
            years.slice(1).forEach((year, idx) => {
                const prevYear = years[idx];
                const curr = totals[year].cogs;
                const prev = totals[prevYear].cogs;
                const growth = prev > 0 ? ((curr - prev) / prev * 100) : 0;
                const color = growth >= 0 ? '#28a745' : '#dc3545';
                html += `<td class="number-right" style="color: ${color}; font-weight: bold;">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
            });
            html += '</tr>';

            return html;
        }

        // Generate Analysis
        function generateAnalysis() {
            const target = document.getElementById('analysis-output');
            if (target) target.innerHTML = '';
            try {
                console.log('Generate Analysis clicked');
                const container = document.getElementById('analysisContent');
                if (!container) {
                    alert('Analysis container not found!');
                    return;
                }
                container.innerHTML = '';

                // Use window.financialData explicitly
                const financialData = window.financialData;

                // Filter years that have ACTUAL data (not just empty arrays)
                const yearsWithData = financialData.years.filter(year => {
                    const data = financialData.data[year];
                    if (!data) return false;

                    // Check if there's actual data with values
                    const hasData =
                        (data.fixedAssetsTangible && data.fixedAssetsTangible.some(item => item.value > 0)) ||
                        (data.intangibleAssets && data.intangibleAssets.some(item => item.value > 0)) ||
                        (data.otherNonCurrentAssets && data.otherNonCurrentAssets.some(item => item.value > 0)) ||
                        (data.currentAssets && data.currentAssets.some(item => item.value > 0)) ||
                        (data.revenue && data.revenue.some(item => item.value > 0)) ||
                        (data.directExpenses && data.directExpenses.some(item => item.value > 0)) ||
                        (data.indirectExpenses && data.indirectExpenses.some(item => item.value > 0)) ||
                        (data.nonCurrentLiabilities && data.nonCurrentLiabilities.some(item => item.value > 0)) ||
                        (data.currentLiabilities && data.currentLiabilities.some(item => item.value > 0));

// ... (keep the filter logic above unchanged) ...
    return hasData;
}).sort((a, b) => {
    // --- SAFE SORT FIX ---
    // This helper checks if a year exists. If not, it returns 0 instead of crashing.
    const getYear = (str) => {
        const match = String(str).match(/\d{4}/);
        return match ? parseInt(match[0]) : 0;
    };
    
    // Sorts "Inception" (0) to the left, and years (2023, 2024) to the right
    return getYear(a) - getYear(b);
});

                console.log('Years with data (sorted oldest to newest):', yearsWithData);

                if (yearsWithData.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 50px;">No data entered yet. Please add financial data in the Data Entry tab.</p>';
                    switchTab('analysis');
                    return;
                }

                // Calculate totals only for years with data
                const allTotals = {};
                yearsWithData.forEach(year => {
                    allTotals[year] = calculateTotals(year);
                });

                // Add company name header if available
                if (financialData.companyName) {
                    container.innerHTML += `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #8b1a1a; font-size: 28px;">${financialData.companyName}</h1>
                            <p style="color: #6c757d; font-size: 16px;">Financial Statement Analysis</p>
                        </div>
                    `;
                }

                // ============================================
                // ADVANCED CUSTOM ANALYZER - TWO PARTS
                // ============================================

                container.innerHTML += `
                    <div class="report-section" style="border: 3px solid #8b1a1a;">
                        <h2 style="color: #8b1a1a;">üî¨ Advanced Custom Analyzer</h2>
                        <p style="color: #6c757d; margin-bottom: 30px;">Perform deep-dive analysis on specific line items and create custom reclassifications to see P&L impact</p>
                        
                        <!-- Part 1: Category Deep Dive -->
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                            <h3 style="color: #8b1a1a; margin-bottom: 20px;">üìä Part 1: Category Deep Dive Analysis</h3>
                            <p style="color: #6c757d; margin-bottom: 20px;">Select any category to see detailed line-item analysis with trends, graphs, and comparisons</p>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; margin-right: 15px;">Select Category:</label>
                                <select id="deepDiveCategory" onchange="updateLineItemSelector()" style="padding: 10px 20px; border: 2px solid #8b1a1a; border-radius: 5px; font-size: 16px; min-width: 300px;">
                                    <option value="">-- Choose a Category --</option>
                                    <option value="fixedAssetsTangible">Fixed Assets / Tangible Assets</option>
                                    <option value="intangibleAssets">Intangible Assets</option>
                                    <option value="otherNonCurrentAssets">Other Non-Current Assets</option>
                                    <option value="currentAssets">Current Assets</option>
                                    <option value="shareCapital">Share Capital</option>
                                    <option value="reserves">Reserves & Surplus</option>
                                    <option value="nonCurrentLiabilities">Non-Current Liabilities</option>
                                    <option value="currentLiabilities">Current Liabilities</option>
                                    <option value="revenue">Revenue</option>
                                    <option value="otherIncome">Other Income</option>
                                    <option value="directExpenses">Direct Expenses / COGS</option>
                                    <option value="indirectExpenses">Indirect Expenses / Operating Expenses</option>
                                    <option value="financeCosts">Finance Costs</option>
                                    <option value="depreciation">Depreciation & Amortization</option>
                                    <option value="taxExpenses">Tax Expenses</option>
                                </select>
                            </div>
                            
                            <div id="lineItemSelectorDiv" style="margin-bottom: 20px; display: none;">
                                <label style="font-weight: 600; margin-bottom: 10px; display: block;">Select Specific Line Items (Optional - Leave empty for all items):</label>
                                <div id="lineItemCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 15px; border-radius: 5px; background: white;"></div>
                            </div>
                            
                            <button onclick="performDeepDive()" style="padding: 10px 30px; background: #8b1a1a; color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                                üîç Analyze Selected Items
                            </button>
                            
                            <div id="deepDiveResults" style="margin-top: 30px;"></div>
                        </div>
                        
                        <!-- Part 2: Custom Reclassification -->
                        <div style="background: #fff3cd; padding: 25px; border-radius: 10px;">
                            <h3 style="color: #856404; margin-bottom: 20px;">üîÑ Part 2: Custom Reclassification & P&L Impact Analysis</h3>
                            <p style="color: #856404; margin-bottom: 20px;">Move line items between categories to see how Gross Profit, EBITDA, and Net Profit change</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">From Category:</label>
                                    <select id="reclassFromCategory" onchange="loadLineItemsForReclassification('from')" style="width: 100%; padding: 10px; border: 2px solid #856404; border-radius: 5px;">
                                        <option value="">-- Select Source Category --</option>
                                        <option value="directExpenses">Direct Expenses / COGS</option>
                                        <option value="indirectExpenses">Indirect Expenses / Operating Expenses</option>
                                        <option value="financeCosts">Finance Costs</option>
                                        <option value="depreciation">Depreciation & Amortization</option>
                                        <option value="nonCurrentLiabilities">Non-Current Liabilities</option>
                                        <option value="currentLiabilities">Current Liabilities</option>
                                        <option value="fixedAssetsTangible">Fixed Assets / Tangible Assets</option>
                                        <option value="currentAssets">Current Assets</option>
                                    </select>
                                    
                                    <label style="font-weight: 600; display: block; margin-top: 15px; margin-bottom: 10px;">Select Line Items:</label>
                                    <div id="reclassFromItems" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: white;"></div>
                                </div>
                                
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">To Category:</label>
                                    <select id="reclassToCategory" style="width: 100%; padding: 10px; border: 2px solid #856404; border-radius: 5px;">
                                        <option value="">-- Select Destination Category --</option>
                                        <option value="directExpenses">Direct Expenses / COGS</option>
                                        <option value="indirectExpenses">Indirect Expenses / Operating Expenses</option>
                                        <option value="financeCosts">Finance Costs</option>
                                        <option value="depreciation">Depreciation & Amortization</option>
                                        <option value="nonCurrentLiabilities">Non-Current Liabilities</option>
                                        <option value="currentLiabilities">Current Liabilities</option>
                                        <option value="fixedAssetsTangible">Fixed Assets / Tangible Assets</option>
                                        <option value="currentAssets">Current Assets</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button onclick="performReclassification()" style="padding: 12px 40px; background: #856404; color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; font-size: 16px;">
                                üîÑ Perform Reclassification & Show P&L Impact
                            </button>
                            
                            <div id="reclassificationResults" style="margin-top: 30px;"></div>
                        </div>
                    </div>
                `;

                // Balance Sheet
                container.innerHTML += `
            <div class="report-section">
                <h2>üìã Balance Sheet</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Particulars</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold; background: #e9ecef;">ASSETS</td></tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Fixed Assets / Tangible Assets</td></tr>
                        ${generateTableRows('fixedAssetsTangible', yearsWithData)}
                        <tr class="total-row">
                            <td>Gross Block - Tangible Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].fixedAssetsTangibleGross)}</td>`).join('')}
                        </tr>
                        <tr style="color: #dc3545;">
                            <td>Less: Cumulative Depreciation</td>
                            ${yearsWithData.map(year => `<td class="number-right">(${formatNumber(allTotals[year].cumulativeDepreciation)})</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Net Block - Property, Plant & Equipment</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].fixedAssetsTangibleNet)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Intangible Assets</td></tr>
                        ${generateTableRows('intangibleAssets', yearsWithData)}
                        <tr class="total-row">
                            <td>Gross Block - Intangible Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].intangibleAssetsGross)}</td>`).join('')}
                        </tr>
                        <tr style="color: #dc3545;">
                            <td>Less: Cumulative Amortization</td>
                            ${yearsWithData.map(year => `<td class="number-right">(${formatNumber(allTotals[year].cumulativeAmortization)})</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Net Block - Intangible Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].intangibleAssetsNet)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Other Non-Current Assets</td></tr>
                        ${generateTableRows('otherNonCurrentAssets', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Other Non-Current Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].otherNonCurrentAssets)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Total Non-Current Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].nonCurrentAssets)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Current Assets</td></tr>
                        ${generateTableRows('currentAssets', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Current Assets</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].currentAssets)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>TOTAL ASSETS</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].totalAssets)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold; background: #e9ecef;">EQUITY & LIABILITIES</td></tr>
                        ${generateEquityRows(yearsWithData, allTotals)}
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Non-Current Liabilities</td></tr>
                        ${generateTableRows('nonCurrentLiabilities', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Non-Current Liabilities</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].nonCurrentLiabilities)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Current Liabilities</td></tr>
                        ${generateTableRows('currentLiabilities', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Current Liabilities</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].currentLiabilities)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>TOTAL EQUITY & LIABILITIES</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].totalEquityAndLiabilities)}</td>`).join('')}
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="report-section">
                <h2>üí∞ Profit & Loss Statement</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Particulars</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Revenue from Operations</td></tr>
                        ${generateTableRows('revenue', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Revenue</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].revenue)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Other Income</td></tr>
                        ${generateTableRows('otherIncome', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Other Income</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].otherIncome)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Total Income</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].totalIncome)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Direct Expenses / COGS</td></tr>
                        ${generateTableRows('directExpenses', yearsWithData)}
                        <tr class="total-row">
                            <td>Cost of Goods Sold</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].cogs)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Gross Profit</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].grossProfit)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Indirect Expenses</td></tr>
                        ${generateTableRows('indirectExpenses', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Indirect Expenses</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].indirectExpenses)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>EBITDA</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].ebitda)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Depreciation & Amortization</td></tr>
                        ${generateTableRows('depreciation', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Depreciation & Amortization</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].depreciation)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>EBIT</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].ebit)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Finance Costs</td></tr>
                        ${generateTableRows('financeCosts', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Finance Costs</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].financeCosts)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Profit Before Tax</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].profitBeforeTax)}</td>`).join('')}
                        </tr>
                        <tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Tax Expenses</td></tr>
                        ${generateTableRows('taxExpenses', yearsWithData)}
                        <tr class="total-row">
                            <td>Total Tax Expenses</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].taxExpenses)}</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Net Profit After Tax</td>
                            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].netProfit)}</td>`).join('')}
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

                // DIRECT EXPENSE COMPARISON SECTION
                container.innerHTML += `
            <div class="report-section">
                <h2>üìä Direct Expense Detailed Comparison</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Analysis of direct expenses as percentage of revenue with YoY growth</p>
                <table>
                    <thead>
                        <tr>
                            <th>Line Item</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}<br/>Amount</th><th class="number-right">% of Revenue</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #e9ecef; font-weight: bold;">
                            <td>Total Revenue (Base)</td>
                            ${yearsWithData.map(year => {
                    const revenue = allTotals[year].revenue;
                    return `<td class="number-right">${formatNumber(revenue)}</td><td class="number-right">100.0%</td>`;
                }).join('')}
                        </tr>
                        ${(() => {
                        // Get all unique direct expense names
                        const expenseNames = new Set();
                        yearsWithData.forEach(year => {
                            const directExpenses = financialData.data[year].directExpenses || [];
                            directExpenses.forEach(exp => {
                                if (exp.name !== 'Opening Stock' && exp.name !== 'Closing Stock') {
                                    expenseNames.add(exp.name);
                                }
                            });
                        });

                        let html = '';
                        expenseNames.forEach(name => {
                            html += '<tr>';
                            html += `<td>${name}</td>`;
                            yearsWithData.forEach(year => {
                                const directExpenses = financialData.data[year].directExpenses || [];
                                const expense = directExpenses.find(e => e.name === name);
                                const value = expense ? expense.value : 0;
                                const pctOfRevenue = (value / allTotals[year].revenue * 100) || 0;
                                html += `<td class="number-right">${formatNumber(value)}</td>`;
                                html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';
                        });

                        // Opening stock
                        html += '<tr style="background: #f8f9fa;">';
                        html += '<td>Opening Stock</td>';
                        yearsWithData.forEach(year => {
                            const directExpenses = financialData.data[year].directExpenses || [];
                            const expense = directExpenses.find(e => e.name === 'Opening Stock');
                            const value = expense ? expense.value : 0;
                            const pctOfRevenue = (value / allTotals[year].revenue * 100) || 0;
                            html += `<td class="number-right">${formatNumber(value)}</td>`;
                            html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                        });
                        html += '</tr>';

                        // Closing stock
                        html += '<tr style="background: #f8f9fa;">';
                        html += '<td>Less: Closing Stock</td>';
                        yearsWithData.forEach(year => {
                            const directExpenses = financialData.data[year].directExpenses || [];
                            const expense = directExpenses.find(e => e.name === 'Closing Stock');
                            const value = expense ? expense.value : 0;
                            const pctOfRevenue = (value / allTotals[year].revenue * 100) || 0;
                            html += `<td class="number-right">(${formatNumber(value)})</td>`;
                            html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                        });
                        html += '</tr>';

                        // Total COGS
                        html += '<tr class="total-row">';
                        html += '<td>TOTAL DIRECT EXPENSES (COGS)</td>';
                        yearsWithData.forEach(year => {
                            const cogs = allTotals[year].cogs;
                            const pctOfRevenue = (cogs / allTotals[year].revenue * 100) || 0;
                            html += `<td class="number-right">${formatNumber(cogs)}</td>`;
                            html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                        });
                        html += '</tr>';

                        return html;
                    })()}
                        <tr class="total-row">
                            <td>GROSS PROFIT</td>
                            ${yearsWithData.map(year => {
                        const gp = allTotals[year].grossProfit;
                        const gpPct = (gp / allTotals[year].revenue * 100) || 0;
                        return `<td class="number-right">${formatNumber(gp)}</td><td class="number-right">${gpPct.toFixed(1)}%</td>`;
                    }).join('')}
                        </tr>
                    </tbody>
                </table>
                
                ${yearsWithData.length > 1 ? `
                    <h3 style="margin-top: 30px; color: #8b1a1a;">Year-over-Year Growth Analysis</h3>
                    <table style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Line Item</th>
                                ${yearsWithData.slice(0, -1).map((year, idx) => {
                        const nextYear = yearsWithData[idx + 1];
                        return `<th class="number-right">${year} ‚Üí ${nextYear}</th>`;
                    }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #e9ecef; font-weight: bold;">
                                <td>Total Revenue Growth %</td>
                                ${yearsWithData.slice(0, -1).map((year, idx) => {
                        const nextYear = yearsWithData[idx + 1];
                        const older = allTotals[year].revenue;       // older year (base)
                        const newer = allTotals[nextYear].revenue;   // newer year
                        const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                        const color = growth >= 0 ? '#28a745' : '#dc3545';
                        return `<td class="number-right" style="color: ${color};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                    }).join('')}
                            </tr>
                            ${(() => {
                            const expenseNames = new Set();
                            yearsWithData.forEach(year => {
                                const directExpenses = financialData.data[year].directExpenses || [];
                                directExpenses.forEach(exp => {
                                    if (exp.name !== 'Opening Stock' && exp.name !== 'Closing Stock') {
                                        expenseNames.add(exp.name);
                                    }
                                });
                            });

                            let html = '';
                            expenseNames.forEach(name => {
                                html += '<tr>';
                                html += `<td>${name} Growth %</td>`;
                                yearsWithData.slice(0, -1).forEach((year, idx) => {
                                    const nextYear = yearsWithData[idx + 1];
                                    const newerDirectExpenses = financialData.data[nextYear].directExpenses || [];
                                    const olderDirectExpenses = financialData.data[year].directExpenses || [];
                                    const newerExp = newerDirectExpenses.find(e => e.name === name);  // newer year
                                    const olderExp = olderDirectExpenses.find(e => e.name === name);  // older year
                                    const older = olderExp ? olderExp.value : 0;  // older
                                    const newer = newerExp ? newerExp.value : 0;  // newer
                                    const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                    const color = growth >= 0 ? '#28a745' : '#dc3545';
                                    html += `<td class="number-right" style="color: ${color};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                                });
                                html += '</tr>';
                            });

                            // COGS Growth
                            html += '<tr class="total-row">';
                            html += '<td>TOTAL COGS Growth %</td>';
                            yearsWithData.slice(0, -1).forEach((year, idx) => {
                                const nextYear = yearsWithData[idx + 1];
                                const older = allTotals[year].cogs;  // older
                                const newer = allTotals[nextYear].cogs;  // newer
                                const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                const color = growth >= 0 ? '#28a745' : '#dc3545';
                                html += `<td class="number-right" style="color: ${color}; font-weight: bold;">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';

                            // Gross Profit Growth
                            html += '<tr style="background: #28a745; color: white; font-weight: bold;">';
                            html += '<td>Gross Profit Growth %</td>';
                            yearsWithData.slice(0, -1).forEach((year, idx) => {
                                const nextYear = yearsWithData[idx + 1];
                                const older = allTotals[year].grossProfit;  // older
                                const newer = allTotals[nextYear].grossProfit;  // newer
                                const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                html += `<td class="number-right">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';

                            return html;
                        })()}
                        </tbody>
                    </table>
                ` : ''}
            </div>
        `;

                // INDIRECT EXPENSE COMPARISON SECTION
                container.innerHTML += `
            <div class="report-section">
                <h2>üìä Indirect Expense Detailed Comparison</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Analysis of indirect expenses as percentage of revenue with YoY growth</p>
                <table>
                    <thead>
                        <tr>
                            <th>Line Item</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}<br/>Amount</th><th class="number-right">% of Revenue</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #e9ecef; font-weight: bold;">
                            <td>Total Revenue (Base)</td>
                            ${yearsWithData.map(year => {
                    const revenue = allTotals[year].revenue;
                    return `<td class="number-right">${formatNumber(revenue)}</td><td class="number-right">100.0%</td>`;
                }).join('')}
                        </tr>
                        ${(() => {
                        // Get all unique indirect expense names
                        const expenseNames = new Set();
                        yearsWithData.forEach(year => {
                            const indirectExpenses = financialData.data[year].indirectExpenses || [];
                            indirectExpenses.forEach(exp => {
                                expenseNames.add(exp.name);
                            });
                        });

                        let html = '';
                        expenseNames.forEach(name => {
                            html += '<tr>';
                            html += `<td>${name}</td>`;
                            yearsWithData.forEach(year => {
                                const indirectExpenses = financialData.data[year].indirectExpenses || [];
                                const expense = indirectExpenses.find(e => e.name === name);
                                const value = expense ? expense.value : 0;
                                const pctOfRevenue = (value / allTotals[year].revenue * 100) || 0;
                                html += `<td class="number-right">${formatNumber(value)}</td>`;
                                html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';
                        });

                        // Total Indirect Expenses
                        html += '<tr class="total-row">';
                        html += '<td>TOTAL INDIRECT EXPENSES</td>';
                        yearsWithData.forEach(year => {
                            const total = allTotals[year].indirectExpenses;
                            const pctOfRevenue = (total / allTotals[year].revenue * 100) || 0;
                            html += `<td class="number-right">${formatNumber(total)}</td>`;
                            html += `<td class="number-right">${pctOfRevenue.toFixed(1)}%</td>`;
                        });
                        html += '</tr>';

                        return html;
                    })()}
                        <tr class="total-row">
                            <td>EBITDA</td>
                            ${yearsWithData.map(year => {
                        const ebitda = allTotals[year].ebitda;
                        const ebitdaPct = (ebitda / allTotals[year].revenue * 100) || 0;
                        return `<td class="number-right">${formatNumber(ebitda)}</td><td class="number-right">${ebitdaPct.toFixed(1)}%</td>`;
                    }).join('')}
                        </tr>
                    </tbody>
                </table>
                
                ${yearsWithData.length > 1 ? `
                    <h3 style="margin-top: 30px; color: #8b1a1a;">Year-over-Year Growth Analysis</h3>
                    <table style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Line Item</th>
                                ${yearsWithData.slice(0, -1).map((year, idx) => {
                        const nextYear = yearsWithData[idx + 1];
                        return `<th class="number-right">${year} ‚Üí ${nextYear}</th>`;
                    }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #e9ecef; font-weight: bold;">
                                <td>Total Revenue Growth %</td>
                                ${yearsWithData.slice(0, -1).map((year, idx) => {
                        const nextYear = yearsWithData[idx + 1];
                        const older = allTotals[year].revenue;       // older year (base)
                        const newer = allTotals[nextYear].revenue;   // newer year
                        const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                        const color = growth >= 0 ? '#28a745' : '#dc3545';
                        return `<td class="number-right" style="color: ${color};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                    }).join('')}
                            </tr>
                            ${(() => {
                            const expenseNames = new Set();
                            yearsWithData.forEach(year => {
                                const indirectExpenses = financialData.data[year].indirectExpenses || [];
                                indirectExpenses.forEach(exp => {
                                    expenseNames.add(exp.name);
                                });
                            });

                            let html = '';
                            expenseNames.forEach(name => {
                                html += '<tr>';
                                html += `<td>${name} Growth %</td>`;
                                yearsWithData.slice(0, -1).forEach((year, idx) => {
                                    const nextYear = yearsWithData[idx + 1];
                                    const newerIndirectExpenses = financialData.data[nextYear].indirectExpenses || [];
                                    const olderIndirectExpenses = financialData.data[year].indirectExpenses || [];
                                    const newerExp = newerIndirectExpenses.find(e => e.name === name);  // newer
                                    const olderExp = olderIndirectExpenses.find(e => e.name === name);
                                    const older = olderExp ? olderExp.value : 0;  // older
                                    const newer = newerExp ? newerExp.value : 0;  // newer
                                    const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                    const color = growth >= 0 ? '#28a745' : '#dc3545';
                                    html += `<td class="number-right" style="color: ${color};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                                });
                                html += '</tr>';
                            });

                            // Total Indirect Expenses Growth
                            html += '<tr class="total-row">';
                            html += '<td>TOTAL INDIRECT EXPENSES Growth %</td>';
                            yearsWithData.slice(0, -1).forEach((year, idx) => {
                                const nextYear = yearsWithData[idx + 1];
                                const older = allTotals[year].indirectExpenses;         // older
                                const newer = allTotals[nextYear].indirectExpenses;     // newer
                                const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                const color = growth >= 0 ? '#28a745' : '#dc3545';
                                html += `<td class="number-right" style="color: ${color}; font-weight: bold;">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';

                            // EBITDA Growth
                            html += '<tr style="background: #ffc107; color: black; font-weight: bold;">';
                            html += '<td>EBITDA Growth %</td>';
                            yearsWithData.slice(0, -1).forEach((year, idx) => {
                                const nextYear = yearsWithData[idx + 1];
                                const older = allTotals[year].ebitda;      // older
                                const newer = allTotals[nextYear].ebitda;  // newer
                                const growth = older > 0 ? ((newer - older) / older * 100) : 0;
                                html += `<td class="number-right">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                            });
                            html += '</tr>';

                            return html;
                        })()}
                        </tbody>
                    </table>
                ` : ''}
            </div>
        `;

                // Ratio Analysis
                container.innerHTML += `<div class="report-section"><h2>üìä Ratio Analysis</h2>`;

                yearsWithData.forEach(year => {
                    const totals = allTotals[year];

                    const ratios = {
                        currentRatio: totals.currentAssets / totals.currentLiabilities || 0,
                        quickRatio: (totals.currentAssets - getInventory(year)) / totals.currentLiabilities || 0,
                        debtToEquity: totals.totalLiabilities / totals.equity || 0,
                        debtRatio: totals.totalLiabilities / totals.totalAssets || 0,
                        equityRatio: totals.equity / totals.totalAssets || 0,
                        grossProfitMargin: (totals.grossProfit / totals.revenue * 100) || 0,
                        ebitdaMargin: (totals.ebitda / totals.revenue * 100) || 0,
                        ebitMargin: (totals.ebit / totals.revenue * 100) || 0,
                        netProfitMargin: (totals.netProfit / totals.revenue * 100) || 0,
                        returnOnAssets: (totals.netProfit / totals.totalAssets * 100) || 0,
                        returnOnEquity: (totals.netProfit / totals.equity * 100) || 0,
                        assetTurnover: totals.revenue / totals.totalAssets || 0,
                        workingCapital: totals.currentAssets - totals.currentLiabilities
                    };

                    container.innerHTML += `
                <h3 style="color: #8b1a1a; margin-top: 30px;">${year}</h3>
                <div class="ratio-grid">
                    <div class="ratio-card">
                        <h3>Current Ratio</h3>
                        <div class="ratio-value">${ratios.currentRatio.toFixed(2)}</div>
                        <p style="color: #6c757d; margin-top: 5px;">Liquidity measure</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Quick Ratio</h3>
                        <div class="ratio-value">${ratios.quickRatio.toFixed(2)}</div>
                        <p style="color: #6c757d; margin-top: 5px;">Acid-test ratio</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Debt-to-Equity</h3>
                        <div class="ratio-value">${ratios.debtToEquity.toFixed(2)}</div>
                        <p style="color: #6c757d; margin-top: 5px;">Leverage ratio</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Debt Ratio</h3>
                        <div class="ratio-value">${(ratios.debtRatio * 100).toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Total debt / Total assets</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Equity Ratio</h3>
                        <div class="ratio-value">${(ratios.equityRatio * 100).toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Equity / Total assets</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Gross Profit Margin</h3>
                        <div class="ratio-value">${ratios.grossProfitMargin.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Profitability ratio</p>
                    </div>
                    <div class="ratio-card">
                        <h3>EBITDA Margin</h3>
                        <div class="ratio-value">${ratios.ebitdaMargin.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Operating efficiency</p>
                    </div>
                    <div class="ratio-card">
                        <h3>EBIT Margin</h3>
                        <div class="ratio-value">${ratios.ebitMargin.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Operating margin</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Net Profit Margin</h3>
                        <div class="ratio-value">${ratios.netProfitMargin.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Bottom-line profitability</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Return on Assets (ROA)</h3>
                        <div class="ratio-value">${ratios.returnOnAssets.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Asset efficiency</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Return on Equity (ROE)</h3>
                        <div class="ratio-value">${ratios.returnOnEquity.toFixed(2)}%</div>
                        <p style="color: #6c757d; margin-top: 5px;">Shareholder returns</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Asset Turnover</h3>
                        <div class="ratio-value">${ratios.assetTurnover.toFixed(2)}x</div>
                        <p style="color: #6c757d; margin-top: 5px;">Revenue / Total assets</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Working Capital</h3>
                        <div class="ratio-value">${formatNumber(ratios.workingCapital)}</div>
                        <p style="color: #6c757d; margin-top: 5px;">Current assets - Current liabilities</p>
                    </div>
                    <div class="ratio-card" style="background: linear-gradient(135deg, #8b1a1a 0%, #630d0d 100%); color: white;">
                        <h3 style="color: white;">EPS (Earnings Per Share)</h3>
                        <div class="ratio-value" style="color: white;">${totals.eps > 0 ? '‚Çπ' + totals.eps.toFixed(2) : 'N/A'}</div>
                        <p style="color: rgba(255,255,255,0.9); margin-top: 5px;">Net Profit / Shares Outstanding</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Interest Coverage Ratio</h3>
                        <div class="ratio-value">${totals.financeCosts > 0 ? (totals.ebit / totals.financeCosts).toFixed(2) + 'x' : 'No Interest'}</div>
                        <p style="color: #6c757d; margin-top: 5px;">EBIT / Interest Expense</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Inventory Turnover</h3>
                        <div class="ratio-value">${(() => {
                            const inventory = getInventory(year);
                            return inventory > 0 ? (totals.cogs / inventory).toFixed(2) + 'x' : 'N/A';
                        })()}</div>
                        <p style="color: #6c757d; margin-top: 5px;">COGS / Inventory</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Receivables Turnover</h3>
                        <div class="ratio-value">${(() => {
                            const receivables = getReceivables(year);
                            return receivables > 0 ? (totals.revenue / receivables).toFixed(2) + 'x' : 'N/A';
                        })()}</div>
                        <p style="color: #6c757d; margin-top: 5px;">Revenue / Receivables</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Days Sales Outstanding (DSO)</h3>
                        <div class="ratio-value">${(() => {
                            const receivables = getReceivables(year);
                            return receivables > 0 && totals.revenue > 0 ? Math.round((receivables / totals.revenue) * 365) + ' days' : 'N/A';
                        })()}</div>
                        <p style="color: #6c757d; margin-top: 5px;">(Receivables / Revenue) √ó 365</p>
                    </div>
                    <div class="ratio-card">
                        <h3>Days Inventory Outstanding (DIO)</h3>
                        <div class="ratio-value">${(() => {
                            const inventory = getInventory(year);
                            return inventory > 0 && totals.cogs > 0 ? Math.round((inventory / totals.cogs) * 365) + ' days' : 'N/A';
                        })()}</div>
                        <p style="color: #6c757d; margin-top: 5px;">(Inventory / COGS) √ó 365</p>
                    </div>
                    <div class="ratio-card" style="background: #fff3cd;">
                        <h3>Cash Conversion Cycle</h3>
                        <div class="ratio-value">${(() => {
                            const inventory = getInventory(year);
                            const receivables = getReceivables(year);
                            const payables = getPayables(year);

                            if (inventory > 0 && receivables > 0 && payables > 0 && totals.cogs > 0 && totals.revenue > 0) {
                                const dio = Math.round((inventory / totals.cogs) * 365);
                                const dso = Math.round((receivables / totals.revenue) * 365);
                                const dpo = Math.round((payables / totals.cogs) * 365);
                                return (dio + dso - dpo) + ' days';
                            }
                            return 'N/A';
                        })()}</div>
                        <p style="color: #856404; margin-top: 5px;">DIO + DSO - DPO</p>
                    </div>
                </div>
            `;
                });

                container.innerHTML += `</div>`;

                // Trend Analysis
                if (yearsWithData.length > 1) {
                    const oldestYear = yearsWithData[yearsWithData.length - 1];
                    const newestYear = yearsWithData[0];
                    container.innerHTML += `
                <div class="report-section">
                    <h2>üìà Trend Analysis</h2>
                    <p style="color: #6c757d; margin-bottom: 15px;">Overall growth from ${oldestYear} to ${newestYear}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                ${yearsWithData.map(year => `<th class="number-right">${year}</th>`).join('')}
                                <th class="number-right">Overall Growth<br/><span style="font-size: 11px; font-weight: normal;">(${oldestYear} ‚Üí ${newestYear})</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="${yearsWithData.length + 2}" style="font-weight: bold; background: #e9ecef;">REVENUE & PROFITABILITY TRENDS</td></tr>
                            ${generateTrendRow('Total Revenue', yearsWithData.map(y => allTotals[y].revenue))}
                            ${generateTrendRow('Gross Profit', yearsWithData.map(y => allTotals[y].grossProfit))}
                            ${generateTrendRow('EBITDA', yearsWithData.map(y => allTotals[y].ebitda))}
                            ${generateTrendRow('EBIT', yearsWithData.map(y => allTotals[y].ebit))}
                            ${generateTrendRow('Net Profit', yearsWithData.map(y => allTotals[y].netProfit))}
                            <tr><td colspan="${yearsWithData.length + 2}" style="height: 10px;"></td></tr>
                            <tr><td colspan="${yearsWithData.length + 2}" style="font-weight: bold; background: #e9ecef;">DEPRECIATION & AMORTIZATION TRENDS</td></tr>
                            ${generateTrendRow('Depreciation & Amortization', yearsWithData.map(y => allTotals[y].depreciation))}
                            <tr>
                                <td>Depreciation as % of Revenue</td>
                                ${yearsWithData.map(year => {
                        const pct = allTotals[year].revenue > 0 ?
                            (allTotals[year].depreciation / allTotals[year].revenue * 100) : 0;
                        return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                    }).join('')}
                                <td class="number-right">-</td>
                            </tr>
                            <tr><td colspan="${yearsWithData.length + 2}" style="height: 10px;"></td></tr>
                            <tr><td colspan="${yearsWithData.length + 2}" style="font-weight: bold; background: #e9ecef;">BALANCE SHEET TRENDS</td></tr>
                            ${generateTrendRow('Total Assets', yearsWithData.map(y => allTotals[y].totalAssets))}
                            ${generateTrendRow('Total Liabilities', yearsWithData.map(y => allTotals[y].totalLiabilities))}
                            ${generateTrendRow('Total Equity', yearsWithData.map(y => allTotals[y].equity))}
                        </tbody>
                    </table>
                </div>
            `;
                }

                // Common Size Analysis
                container.innerHTML += `
            <div class="report-section">
                <h2>üìä Common Size Balance Sheet (% of Total Assets)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Particulars</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="total-row">
                            <td>Non-Current Assets</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].nonCurrentAssets / allTotals[year].totalAssets * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Current Assets</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].currentAssets / allTotals[year].totalAssets * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Total Equity</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].equity / allTotals[year].totalAssets * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Non-Current Liabilities</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].nonCurrentLiabilities / allTotals[year].totalAssets * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Current Liabilities</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].currentLiabilities / allTotals[year].totalAssets * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="report-section">
                <h2>üìä Common Size P&L (% of Revenue)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Particulars</th>
                            ${yearsWithData.map(year => `<th class="number-right">${year}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="total-row">
                            <td>Revenue</td>
                            ${yearsWithData.map(year => `<td class="number-right">100.00%</td>`).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Cost of Goods Sold</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].cogs / allTotals[year].revenue * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Gross Profit</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].grossProfit / allTotals[year].revenue * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Indirect Expenses</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].indirectExpenses / allTotals[year].revenue * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>EBITDA</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].ebitda / allTotals[year].revenue * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                        <tr class="total-row">
                            <td>Net Profit</td>
                            ${yearsWithData.map(year => {
                    const pct = (allTotals[year].netProfit / allTotals[year].revenue * 100) || 0;
                    return `<td class="number-right">${pct.toFixed(2)}%</td>`;
                }).join('')}
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

                // INNOVATIVE CHARTS & VISUALIZATIONS
                container.innerHTML += `
            <div class="report-section">
                <h2>üìä Visual Analytics & Insights</h2>
                <p style="color: #6c757d; margin-bottom: 30px; font-size: 16px;">Interactive charts providing deep insights into financial performance, efficiency, and capital structure</p>
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>üí∞ Revenue & Profitability Journey</h3>
                        <div class="chart-wrapper">
                            <canvas id="revenueTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üìâ Profitability Waterfall</h3>
                        <div class="chart-wrapper">
                            <canvas id="profitabilityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üéØ Asset Distribution</h3>
                        <div class="chart-wrapper">
                            <canvas id="assetCompositionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚öñÔ∏è Capital Structure</h3>
                        <div class="chart-wrapper">
                            <canvas id="liabilityStructureChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>üìä Profitability Margins Trend Analysis</h3>
                        <div class="chart-wrapper" style="height: 400px;">
                            <canvas id="marginsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;

                // Generate all charts
                setTimeout(() => {
                    generateAllCharts(yearsWithData, allTotals);
                }, 100);

                // DETAILED LINE-ITEM TREND ANALYSIS
                container.innerHTML += `
            <div class="report-section">
                <h2>üìà Detailed Line-Item Trend Analysis</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Year-over-year growth rates for all line items</p>
                ${generateDetailedTrendAnalysis(yearsWithData)}
            </div>
        `;

                // DETAILED LINE-ITEM COMMON SIZE ANALYSIS
                container.innerHTML += `
            <div class="report-section">
                <h2>üìä Detailed Line-Item Common Size Analysis</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Each item as a percentage of its base (Assets as % of Total Assets, Income/Expenses as % of Revenue)</p>
                ${generateDetailedCommonSize(yearsWithData, allTotals)}
            </div>
        `;

                // QUERY BUILDER SECTION
                container.innerHTML += `
            <div id="queryBuilderContainer" class="report-section" style="border: 2px solid #8b1a1a; margin-bottom: 25px; background: #f8f9fa;">
                <h2 style="color: #8b1a1a;">üéØ Advanced Financial Query Builder</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Create custom financial queries - select metrics, choose operations, and analyze trends</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">1. Primary Metric(s) (A)</label>
                        <input type="text" placeholder="Search..." onkeyup="filterCheckboxes('list_a', this.value)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <div id="list_a" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">2. Compare With (B)</label>
                        <input type="text" placeholder="Search..." onkeyup="filterCheckboxes('list_b', this.value)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <div id="list_b" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; background: #eee; padding: 15px; border-radius: 8px;">
                    <div id="list_op" style="background: white; padding: 10px; border-radius: 5px; font-size: 13px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">3. Operation</label>
                        <label><input type="checkbox" value="value" checked> Trend</label>
                        <label><input type="checkbox" value="growth"> Growth %</label>
                        <label><input type="checkbox" value="ratio"> Ratio</label>
                        <label><input type="checkbox" value="contribution"> Contribution</label>
                    </div>
                    <div id="list_time" style="background: white; padding: 10px; border-radius: 5px; font-size: 13px; max-height: 100px; overflow-y: auto;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">4. Timeframe</label>
                    </div>
                    <div id="list_view" style="background: white; padding: 10px; border-radius: 5px; font-size: 13px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">5. View As</label>
                        <label><input type="checkbox" value="chart_line" checked> Line</label>
                        <label><input type="checkbox" value="table"> Table</label>
                    </div>
                    <button class="action-btn" onclick="runQuery()" style="background: #28a745; padding: 10px 20px; height: fit-content;">üöÄ Run</button>
                </div>
                <div id="queryResultsOutput" style="margin-top: 20px;"></div>
            </div>
        `;

                // RATIO ANALYSIS SECTION
                container.innerHTML += `
            <div id="ratioAnalysisContainer" class="report-section" style="border: 2px solid #ff9f43; margin-bottom: 25px; background: #fff8f0;">
                <h2 style="color: #ff9f43;">üìä Financial Ratio Analysis</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Analyze key financial ratios across selected periods - compare profitability, liquidity, leverage, and efficiency metrics</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">Available Ratios</label>
                        <input type="text" placeholder="Search ratios..." onkeyup="filterRatios(this.value)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <div id="ratioList" style="height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">Select Years to Compare</label>
                        <div id="ratioYearsList" style="height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; background: #fff0e0; padding: 15px; border-radius: 8px;">
                    <div style="background: white; padding: 10px; border-radius: 5px; font-size: 13px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">View As</label>
                        <label><input type="checkbox" value="ratio_line" checked> Line Chart</label><br>
                        <label><input type="checkbox" value="ratio_bar"> Bar Chart</label><br>
                        <label><input type="checkbox" value="ratio_table"> Table</label>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 5px; font-size: 13px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Display</label>
                        <label><input type="checkbox" value="all_ratios" checked> All Selected</label><br>
                        <label><input type="checkbox" value="compare_years"> Compare Years Side-by-Side</label>
                    </div>
                    <button class="action-btn" onclick="runRatioAnalysis()" style="background: #ff9f43; padding: 10px 20px; height: fit-content;">üöÄ Analyze</button>
                </div>
                <div id="ratioResultsOutput" style="margin-top: 20px;"></div>
            </div>
        `;

                // EXPENSE RECLASSIFICATION ANALYZER

                // CUSTOM FINANCIAL ANALYZER SECTION
                const customInsights = document.getElementById('customInsights').value;

                switchTab('analysis');
                console.log('Analysis generated successfully');
                initQueryBuilder();
                initRatioLists();

            } catch (error) {
                console.error('Error generating analysis:', error);
                alert('Error generating analysis: ' + error.message + '\n\nPlease check browser console for details.');
            }
        }

        // Expense Reclassification Analyzer Function
        function generateReclassification() {
            const year = parseInt(document.getElementById('reclassYear').value);
            const data = window.financialData.data[year];

            if (!data) {
                alert('No data for selected year');
                return;
            }

            const totals = calculateTotals(year);

            // Build the reclassification interface
            let html = '<h3 style="color: #8b1a1a; margin: 20px 0;">Select Expenses to Reclassify:</h3>';

            // Direct Expenses Section
            html += '<div style="background: #fff; border: 2px solid #8b1a1a; border-radius: 8px; padding: 20px; margin-bottom: 20px;">';
            html += '<h4 style="color: #8b1a1a; margin-bottom: 15px;">üì¶ Current Direct Expenses (COGS)</h4>';

            if (data.directExpenses && data.directExpenses.length > 0) {
                data.directExpenses.forEach((exp, idx) => {
                    if (exp.name !== 'Opening Stock' && exp.name !== 'Closing Stock') {
                        const pctOfRevenue = totals.revenue > 0 ? (exp.value / totals.revenue * 100).toFixed(2) : 0;
                        html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 5px;">
                            <label style="flex: 1;">
                                <input type="checkbox" class="reclass-direct" data-name="${exp.name}" data-value="${exp.value}" style="margin-right: 10px;">
                                ${exp.name}
                            </label>
                            <span style="min-width: 150px; text-align: right; margin-right: 20px;">‚Çπ${formatNumber(exp.value)}</span>
                            <span style="min-width: 80px; text-align: right; color: #6c757d;">${pctOfRevenue}% of Rev</span>
                        </div>
                    `;
                    }
                });
            }
            html += '</div>';

            // Indirect Expenses Section
            html += '<div style="background: #fff; border: 2px solid #ffc107; border-radius: 8px; padding: 20px;">';
            html += '<h4 style="color: #ffc107; margin-bottom: 15px;">üìã Current Indirect Expenses</h4>';

            if (data.indirectExpenses && data.indirectExpenses.length > 0) {
                data.indirectExpenses.forEach((exp, idx) => {
                    const pctOfRevenue = totals.revenue > 0 ? (exp.value / totals.revenue * 100).toFixed(2) : 0;
                    html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff3cd; margin-bottom: 8px; border-radius: 5px;">
                        <label style="flex: 1;">
                            <input type="checkbox" class="reclass-indirect" data-name="${exp.name}" data-value="${exp.value}" style="margin-right: 10px;">
                            ${exp.name}
                        </label>
                        <span style="min-width: 150px; text-align: right; margin-right: 20px;">‚Çπ${formatNumber(exp.value)}</span>
                        <span style="min-width: 80px; text-align: right; color: #6c757d;">${pctOfRevenue}% of Rev</span>
                    </div>
                `;
                });
            }
            html += '</div>';

            html += `
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="applyReclassification(${year})" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    ‚úÖ Calculate Impact
                </button>
                <button onclick="document.getElementById('reclassResults').innerHTML = ''" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    üîÑ Clear Results
                </button>
            </div>
        `;

            document.getElementById('reclassificationTool').innerHTML = html;
        }

        function applyReclassification(year) {
            const data = window.financialData.data[year];
            const originalTotals = calculateTotals(year);

            // Get selected expenses to move
            const directToIndirect = Array.from(document.querySelectorAll('.reclass-direct:checked')).map(el => ({
                name: el.dataset.name,
                value: parseFloat(el.dataset.value)
            }));

            const indirectToDirect = Array.from(document.querySelectorAll('.reclass-indirect:checked')).map(el => ({
                name: el.dataset.name,
                value: parseFloat(el.dataset.value)
            }));

            if (directToIndirect.length === 0 && indirectToDirect.length === 0) {
                alert('Please select at least one expense to reclassify');
                return;
            }

            // Calculate impact
            const directToIndirectTotal = directToIndirect.reduce((sum, exp) => sum + exp.value, 0);
            const indirectToDirectTotal = indirectToDirect.reduce((sum, exp) => sum + exp.value, 0);

            const newCOGS = originalTotals.cogs - directToIndirectTotal + indirectToDirectTotal;
            const newGrossProfit = originalTotals.revenue - newCOGS;
            const newGrossProfitMargin = originalTotals.revenue > 0 ? (newGrossProfit / originalTotals.revenue * 100) : 0;

            const newIndirectExpenses = originalTotals.indirectExpenses + directToIndirectTotal - indirectToDirectTotal;
            const newEBITDA = newGrossProfit - newIndirectExpenses;

            // Calculate changes
            const grossProfitChange = newGrossProfit - originalTotals.grossProfit;
            const grossProfitMarginChange = newGrossProfitMargin - (originalTotals.revenue > 0 ? (originalTotals.grossProfit / originalTotals.revenue * 100) : 0);

            // Generate results
            let html = `
            <div style="background: #fff; border: 3px solid ${grossProfitChange > 0 ? '#28a745' : '#dc3545'}; border-radius: 8px; padding: 25px; margin-top: 20px;">
                <h3 style="color: ${grossProfitChange > 0 ? '#28a745' : '#dc3545'}; margin-bottom: 20px;">
                    üìä Reclassification Impact Analysis
                </h3>
        `;

            if (directToIndirect.length > 0) {
                html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<h4 style="color: #8b1a1a;">üì¶ ‚Üí üìã Moving from Direct to Indirect:</h4><ul style="margin: 10px 0;">';
                directToIndirect.forEach(exp => {
                    html += `<li>${exp.name}: ‚Çπ${formatNumber(exp.value)}</li>`;
                });
                html += `</ul><strong>Total: ‚Çπ${formatNumber(directToIndirectTotal)}</strong>`;
                html += '</div>';
            }

            if (indirectToDirect.length > 0) {
                html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<h4 style="color: #ffc107;">üìã ‚Üí üì¶ Moving from Indirect to Direct:</h4><ul style="margin: 10px 0;">';
                indirectToDirect.forEach(exp => {
                    html += `<li>${exp.name}: ‚Çπ${formatNumber(exp.value)}</li>`;
                });
                html += `</ul><strong>Total: ‚Çπ${formatNumber(indirectToDirectTotal)}</strong>`;
                html += '</div>';
            }

            html += `
            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                <thead>
                    <tr style="background: #8b1a1a; color: white;">
                        <th style="padding: 12px; text-align: left;">Metric</th>
                        <th style="padding: 12px; text-align: right;">Original</th>
                        <th style="padding: 12px; text-align: right;">After Reclassification</th>
                        <th style="padding: 12px; text-align: right;">Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #f8f9fa;">
                        <td style="padding: 10px;">Total Revenue</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.revenue)}</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.revenue)}</td>
                        <td style="padding: 10px; text-align: right;">-</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><strong>COGS (Direct Expenses)</strong></td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.cogs)}</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(newCOGS)}</td>
                        <td style="padding: 10px; text-align: right; color: ${newCOGS < originalTotals.cogs ? '#28a745' : '#dc3545'};">
                            ${newCOGS < originalTotals.cogs ? '‚Üì' : '‚Üë'} ‚Çπ${formatNumber(Math.abs(newCOGS - originalTotals.cogs))}
                        </td>
                    </tr>
                    <tr style="background: ${grossProfitChange > 0 ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 10px;"><strong>Gross Profit</strong></td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.grossProfit)}</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(newGrossProfit)}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: ${grossProfitChange > 0 ? '#28a745' : '#dc3545'};">
                            ${grossProfitChange > 0 ? '‚Üë' : '‚Üì'} ‚Çπ${formatNumber(Math.abs(grossProfitChange))}
                        </td>
                    </tr>
                    <tr style="background: ${grossProfitMarginChange > 0 ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 10px;"><strong>Gross Profit Margin</strong></td>
                        <td style="padding: 10px; text-align: right;">${(originalTotals.revenue > 0 ? (originalTotals.grossProfit / originalTotals.revenue * 100) : 0).toFixed(2)}%</td>
                        <td style="padding: 10px; text-align: right;">${newGrossProfitMargin.toFixed(2)}%</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: ${grossProfitMarginChange > 0 ? '#28a745' : '#dc3545'};">
                            ${grossProfitMarginChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(grossProfitMarginChange).toFixed(2)}%
                        </td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td style="padding: 10px;">Indirect Expenses</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.indirectExpenses)}</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(newIndirectExpenses)}</td>
                        <td style="padding: 10px; text-align: right; color: ${newIndirectExpenses > originalTotals.indirectExpenses ? '#dc3545' : '#28a745'};">
                            ${newIndirectExpenses > originalTotals.indirectExpenses ? '‚Üë' : '‚Üì'} ‚Çπ${formatNumber(Math.abs(newIndirectExpenses - originalTotals.indirectExpenses))}
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><strong>EBITDA</strong></td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(originalTotals.ebitda)}</td>
                        <td style="padding: 10px; text-align: right;">‚Çπ${formatNumber(newEBITDA)}</td>
                        <td style="padding: 10px; text-align: right;">-</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 25px; padding: 20px; background: ${Math.abs(grossProfitMarginChange) > 5 ? '#fff3cd' : '#d1ecf1'}; border-radius: 8px; border-left: 4px solid ${Math.abs(grossProfitMarginChange) > 5 ? '#ffc107' : '#17a2b8'};">
                <h4 style="margin-bottom: 10px;">${Math.abs(grossProfitMarginChange) > 5 ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} Analysis:</h4>
                <p style="line-height: 1.6; margin: 0;">
                    ${Math.abs(grossProfitMarginChange) > 5
                    ? `<strong>SIGNIFICANT IMPACT DETECTED!</strong> This reclassification changes Gross Profit Margin by ${Math.abs(grossProfitMarginChange).toFixed(2)}%. This suggests the original classification may have been used to manipulate gross profit figures. Review these expenses carefully.`
                    : `This reclassification has a moderate impact on Gross Profit Margin (${Math.abs(grossProfitMarginChange).toFixed(2)}%). While EBITDA remains unchanged, the gross profit presentation is affected.`
                }
                </p>
            </div>
        </div>
        `;

            document.getElementById('reclassResults').innerHTML = html;
        }

        // Generate all charts
        function generateAllCharts(years, totals) {
            // 1. Revenue & Profitability Waterfall - Use MONEY axis only
            createChart('revenueTrendChart', 'line', {
                labels: years,
                datasets: [
                    {
                        label: 'Total Revenue (‚Çπ)',
                        data: years.map(y => totals[y].revenue),
                        borderColor: '#8b1a1a',
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#8b1a1a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    },
                    {
                        label: 'Net Profit (‚Çπ)',
                        data: years.map(y => totals[y].netProfit),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.15)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }
                ]
            }, 'Revenue vs Profit Analysis');

            // 2. Profitability Waterfall (Stacked Bar showing breakdown) - MONEY axis
            createChart('profitabilityChart', 'bar', {
                labels: years,
                datasets: [
                    {
                        label: 'Net Profit',
                        data: years.map(y => totals[y].netProfit),
                        backgroundColor: '#8b1a1a',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    {
                        label: 'Tax',
                        data: years.map(y => totals[y].taxExpenses),
                        backgroundColor: '#dc3545',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    {
                        label: 'Interest',
                        data: years.map(y => totals[y].financeCosts),
                        backgroundColor: '#fd7e14',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    {
                        label: 'Depreciation',
                        data: years.map(y => totals[y].depreciation),
                        backgroundColor: '#6c757d',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    {
                        label: 'Operating Expenses',
                        data: years.map(y => totals[y].indirectExpenses),
                        backgroundColor: '#ffc107',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    {
                        label: 'COGS',
                        data: years.map(y => totals[y].cogs),
                        backgroundColor: '#17a2b8',
                        stack: 'stack1',
                        borderWidth: 2,
                        borderColor: '#fff'
                    }
                ]
            }, 'Profitability Waterfall: Revenue to Net Profit');

            // 3. Asset Utilization Efficiency
            const latestYear = years[0];

            // Get actual values from current assets
            const cashItem = financialData.data[latestYear].currentAssets.find(item =>
                item.name.toLowerCase().includes('cash')
            );
            const receivablesItem = financialData.data[latestYear].currentAssets.find(item =>
                item.name.toLowerCase().includes('receivable')
            );
            const inventoryItem = financialData.data[latestYear].currentAssets.find(item =>
                item.name.toLowerCase().includes('inventor')
            );

            const cashValue = cashItem ? cashItem.value : 0;
            const receivablesValue = receivablesItem ? receivablesItem.value : 0;
            const inventoryValue = inventoryItem ? inventoryItem.value : 0;
            const otherCurrentValue = totals[latestYear].currentAssets - cashValue - receivablesValue - inventoryValue;

            createChart('assetCompositionChart', 'doughnut', {
                labels: [
                    'Fixed Assets',
                    'Intangible Assets',
                    'Other Non-Current',
                    'Cash & Equivalents',
                    'Receivables',
                    'Inventory',
                    'Other Current'
                ],
                datasets: [{
                    data: [
                        totals[latestYear].fixedAssetsTangibleNet || 0,
                        totals[latestYear].intangibleAssetsNet || 0,
                        totals[latestYear].otherNonCurrentAssets || 0,
                        cashValue,
                        receivablesValue,
                        inventoryValue,
                        otherCurrentValue > 0 ? otherCurrentValue : 0
                    ],
                    backgroundColor: [
                        '#8b1a1a', '#630d0d', '#20c997',
                        '#28a745', '#ffc107', '#fd7e14', '#6c757d'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 15
                }]
            }, `Asset Distribution & Utilization - ${latestYear}`);

            // 4. Capital Structure Analysis
            const payablesValue = getPayables(latestYear);
            const otherCurrentLiabValue = totals[latestYear].currentLiabilities - payablesValue;

            createChart('liabilityStructureChart', 'polarArea', {
                labels: ['Equity', 'Long-term Debt', 'Short-term Debt', 'Payables'],
                datasets: [{
                    data: [
                        totals[latestYear].equity,
                        totals[latestYear].nonCurrentLiabilities,
                        otherCurrentLiabValue > 0 ? otherCurrentLiabValue : 0,
                        payablesValue
                    ],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(253, 126, 20, 0.8)'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            }, `Capital Structure - ${latestYear}`);

            // 5. All Margins Trend - Use PERCENTAGE axis only
            createChart('marginsChart', 'line', {
                labels: years,
                datasets: [
                    {
                        label: 'Gross Margin %',
                        data: years.map(y => (totals[y].grossProfit / totals[y].revenue * 100) || 0),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.15)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    },
                    {
                        label: 'EBITDA Margin %',
                        data: years.map(y => (totals[y].ebitda / totals[y].revenue * 100) || 0),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.15)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ffc107',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    },
                    {
                        label: 'Net Margin %',
                        data: years.map(y => (totals[y].netProfit / totals[y].revenue * 100) || 0),
                        borderColor: '#8b1a1a',
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#8b1a1a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }
                ]
            }, 'Profitability Margins Trend Analysis');
        }

        // Generate detailed trend analysis for all line items
        function generateDetailedTrendAnalysis(years) {
            const financialData = window.financialData; // Fix: Add this line
            if (years.length < 2) return '<p style="text-align: center; padding: 30px;">Need at least 2 years for trend analysis</p>';

            let html = '';

            // Categories to analyze
            const categories = [
                { key: 'fixedAssetsTangible', title: 'Fixed Assets (Tangible)' },
                { key: 'intangibleAssets', title: 'Intangible Assets' },
                { key: 'otherNonCurrentAssets', title: 'Other Non-Current Assets' },
                { key: 'currentAssets', title: 'Current Assets' },
                { key: 'nonCurrentLiabilities', title: 'Non-Current Liabilities' },
                { key: 'currentLiabilities', title: 'Current Liabilities' },
                { key: 'revenue', title: 'Revenue' },
                { key: 'otherIncome', title: 'Other Income' },
                { key: 'directExpenses', title: 'Direct Expenses' },
                { key: 'indirectExpenses', title: 'Indirect Expenses' },
                { key: 'financeCosts', title: 'Finance Costs' }
            ];

            categories.forEach(cat => {
                const items = new Set();
                years.forEach(y => {
                    const data = financialData.data[y][cat.key] || [];
                    data.forEach(item => items.add(item.name));
                });

                if (items.size > 0) {
                    html += `
                    <h3 style="color: #8b1a1a; margin-top: 30px;">${cat.title}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                ${years.map(y => `<th class="number-right">${y}</th>`).join('')}
                                ${years.slice(0, -1).map((y, i) =>
                        `<th class="number-right">${years[i]} vs ${years[i + 1]}</th>`
                    ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                    items.forEach(itemName => {
                        const values = years.map(y => {
                            const yearData = financialData.data[y][cat.key] || [];
                            const item = yearData.find(i => i.name === itemName);
                            return item ? item.value : 0;
                        });

                        html += `<tr><td>${itemName}</td>`;

                        // Add value columns
                        values.forEach(v => {
                            html += `<td class="number-right">${formatNumber(v)}</td>`;
                        });

                        // Add growth columns for each consecutive pair
                        for (let i = 0; i < values.length - 1; i++) {
                            const older = values[i];      // older year (base)
                            const newer = values[i + 1];  // newer year
                            const growth = older !== 0 ? ((newer - older) / Math.abs(older) * 100) : 0;
                            const growthClass = growth > 0 ? 'variance-positive' : growth < 0 ? 'variance-negative' : 'variance-neutral';
                            const growthArrow = growth > 0 ? '‚Üë' : growth < 0 ? '‚Üì' : '‚Üí';

                            html += `
                            <td class="number-right">
                                <span class="variance-badge ${growthClass}">
                                    <span class="trend-arrow">${growthArrow}</span> ${Math.abs(growth).toFixed(1)}%
                                </span>
                            </td>
                        `;
                        }

                        html += `</tr>`;
                    });

                    html += `</tbody></table>`;
                }
            });

            return html;
        }

        // Generate detailed common size analysis for all line items
        function generateDetailedCommonSize(years, totals) {
            const financialData = window.financialData; // Fix: Add this line
            let html = '';

            // Balance Sheet Common Size
            html += `
            <h3 style="color: #8b1a1a; margin-top: 20px;">Assets (% of Total Assets)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        ${years.map(y => `<th class="number-right">${y}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

            const assetCategories = ['fixedAssetsTangible', 'intangibleAssets', 'otherNonCurrentAssets', 'currentAssets'];

            assetCategories.forEach(catKey => {
                const items = new Set();
                years.forEach(y => {
                    const data = financialData.data[y][catKey] || [];
                    data.forEach(item => items.add(item.name));
                });

                items.forEach(itemName => {
                    html += `<tr><td>${itemName}</td>`;
                    years.forEach(y => {
                        const yearData = financialData.data[y][catKey] || [];
                        const item = yearData.find(i => i.name === itemName);
                        const value = item ? item.value : 0;
                        const pct = (value / totals[y].totalAssets * 100) || 0;
                        html += `<td class="number-right">${pct.toFixed(2)}%</td>`;
                    });
                    html += `</tr>`;
                });
            });

            html += `</tbody></table>`;

            // P&L Common Size
            html += `
            <h3 style="color: #8b1a1a; margin-top: 30px;">Income & Expenses (% of Revenue)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        ${years.map(y => `<th class="number-right">${y}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

            const plCategories = ['revenue', 'otherIncome', 'directExpenses', 'indirectExpenses', 'financeCosts'];

            plCategories.forEach(catKey => {
                const items = new Set();
                years.forEach(y => {
                    const data = financialData.data[y][catKey] || [];
                    data.forEach(item => items.add(item.name));
                });

                items.forEach(itemName => {
                    html += `<tr><td>${itemName}</td>`;
                    years.forEach(y => {
                        const yearData = financialData.data[y][catKey] || [];
                        const item = yearData.find(i => i.name === itemName);
                        const value = item ? item.value : 0;
                        const pct = (value / totals[y].revenue * 100) || 0;
                        html += `<td class="number-right">${pct.toFixed(2)}%</td>`;
                    });
                    html += `</tr>`;
                });
            });

            html += `</tbody></table>`;

            return html;
        }

        // Generate equity rows based on company type
        function generateEquityRows(yearsWithData, allTotals) {
            const financialData = window.financialData; // Fix: Add this line
            const type = financialData.companyType;
            let html = '';

            if (type === 'private_limited') {
                html += `<tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">Share Capital & Reserves</td></tr>`;
                html += `<tr class="total-row">
                <td>Share Capital</td>
                ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].shareCapital)}</td>`).join('')}
            </tr>`;
                html += generateTableRows('reserves', yearsWithData);
                html += `<tr class="total-row">
                <td>Total Reserves & Surplus</td>
                ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].reserves)}</td>`).join('')}
            </tr>`;
            } else {
                const label = type === 'proprietorship' ? "Proprietor's Capital" : "Partners' Capital";
                html += `<tr><td colspan="${yearsWithData.length + 1}" style="font-weight: bold;">${label} & Reserves</td></tr>`;
                html += generateTableRows('equity', yearsWithData);
                html += generateTableRows('reserves', yearsWithData);
            }

            html += `<tr class="total-row">
            <td>Total Equity</td>
            ${yearsWithData.map(year => `<td class="number-right">${formatNumber(allTotals[year].equity)}</td>`).join('')}
        </tr>`;

            return html;
        }

        // Helper function to get inventory value
        function getInventory(year) {
            const financialData = window.financialData;
            // Fix: Ensure currentAssets exists before calling .find()
            const currentAssets = financialData.data[year]?.currentAssets || [];
            const inventory = currentAssets.find(item =>
                item.name.toLowerCase().includes('inventor')
            );
            return inventory ? inventory.value : 0;
        }

        // Helper function to get Trade Receivables value
        function getReceivables(year) {
            const financialData = window.financialData;
            // Fix: Ensure currentAssets exists before calling .find()
            const currentAssets = financialData.data[year]?.currentAssets || [];
            const receivables = currentAssets.find(item =>
                item.name.toLowerCase().includes('receivable')
            );
            return receivables ? receivables.value : 0;
        }

        // Helper function to get Trade Payables value
        function getPayables(year) {
            const financialData = window.financialData;
            // Fix: Ensure currentLiabilities exists before calling .find()
            const currentLiabilities = financialData.data[year]?.currentLiabilities || [];
            const payables = currentLiabilities.find(item =>
                item.name.toLowerCase().includes('payable')
            );
            return payables ? payables.value : 0;
        }

        // Generate table rows for financial items
        function generateTableRows(categoryKey, yearsWithData) {
            const financialData = window.financialData;
            const allItems = new Set();
            yearsWithData.forEach(year => {
                const categoryData = financialData.data[year][categoryKey];
                if (Array.isArray(categoryData)) {
                    categoryData.forEach(item => {
                        allItems.add(item.name);
                    });
                }
            });

            let html = '';
            allItems.forEach(itemName => {
                html += `<tr><td>${itemName}</td>`;
                yearsWithData.forEach(year => {
                    const categoryData = financialData.data[year][categoryKey];
                    const item = Array.isArray(categoryData) ? categoryData.find(i => i.name === itemName) : null;
                    const value = item ? item.value : 0;
                    html += `<td class="number-right">${formatNumber(value)}</td>`;
                });
                html += '</tr>';
            });

            return html;
        }

        // Generate trend row
        function generateTrendRow(label, values) {
            // values array is now: [oldest year, ..., newest year] (after our sort fix)
            // Example: [FY 20-21, FY 21-22, FY 22-23, FY 23-24, FY 24-25]
            const oldestValue = values[0];  // First value is oldest
            const newestValue = values[values.length - 1];  // Last value is newest

            // Growth Rate = (Newest - Oldest) / Oldest * 100
            // This shows growth FROM oldest TO newest (positive = growth, negative = decline)
            const growthRate = oldestValue !== 0 ? ((newestValue - oldestValue) / Math.abs(oldestValue) * 100) : 0;

            let html = `<tr><td>${label}</td>`;
            values.forEach(value => {
                html += `<td class="number-right">${formatNumber(value)}</td>`;
            });

            const color = growthRate >= 0 ? '#28a745' : '#dc3545';
            const arrow = growthRate >= 0 ? '‚Üë' : '‚Üì';

            html += `<td class="number-right" style="color: ${color}; font-weight: bold;">
            ${arrow} ${growthRate >= 0 ? '+' : ''}${growthRate.toFixed(2)}%
        </td></tr>`;

            return html;
        }

        // Format number with commas
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(Math.round(num));
        }

        // ==================== CUSTOM ANALYZER FUNCTIONS ====================

        // Populate line items when analysis tab is opened
        function populateLineItems() {
            const container = document.getElementById('lineItemCheckboxes');
            if (!container) return;

            const categories = {
                'Fixed Assets (Tangible)': 'fixedAssetsTangible',
                'Intangible Assets': 'intangibleAssets',
                'Other Non-Current Assets': 'otherNonCurrentAssets',
                'Current Assets': 'currentAssets',
                'Non-Current Liabilities': 'nonCurrentLiabilities',
                'Current Liabilities': 'currentLiabilities',
                'Reserves & Surplus': 'reserves',
                'Equity': 'equity',
                'Revenue': 'revenue',
                'Other Income': 'otherIncome',
                'Direct Expenses': 'directExpenses',
                'Indirect Expenses': 'indirectExpenses',
                'Finance Costs': 'financeCosts',
                'Depreciation': 'depreciation',
                'Tax Expenses': 'taxExpenses'
            };

            let html = '';
            Object.keys(categories).forEach(categoryName => {
                const categoryKey = categories[categoryName];
                html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #8b1a1a;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; color: #495057;">
                    <input type="checkbox" value="${categoryKey}" class="line-item-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                    ${categoryName}
                </label>
            </div>`;
            });

            container.innerHTML = html;
        }

        // Generate custom analysis
        function generateCustomAnalysis() {
            const selectedItems = Array.from(document.querySelectorAll('.line-item-checkbox:checked')).map(cb => cb.value);
            const analysisType = document.getElementById('analysisType').value;
            const generateVisual = document.getElementById('generateVisual').checked;
            const chartType = document.getElementById('chartType').value;

            if (selectedItems.length === 0) {
                alert('Please select at least one line item to analyze');
                return;
            }

            const resultsContainer = document.getElementById('customAnalysisResults');
            resultsContainer.innerHTML = '';

            // Get years with data
            const yearsWithData = window.financialData.years.filter(year => {
                const data = window.financialData.data[year];
                return data && Object.keys(data).length > 0;
            });

            if (yearsWithData.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 30px; text-align: center; color: #6c757d;">No data available for analysis. Please enter data first.</div>';
                return;
            }

            // Generate analysis based on type
            let analysisHTML = `<div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h3 style="color: #8b1a1a; margin-bottom: 20px; font-size: 22px;">üìä Custom Analysis Results</h3>`;

            switch (analysisType) {
                case 'trend':
                    analysisHTML += generateTrendAnalysis(selectedItems, yearsWithData);
                    break;
                case 'comparison':
                    analysisHTML += generateComparisonAnalysis(selectedItems, yearsWithData);
                    break;
                case 'percentage':
                    analysisHTML += generatePercentageAnalysis(selectedItems, yearsWithData);
                    break;
                case 'ratio':
                    analysisHTML += generateRatioAnalysis(selectedItems, yearsWithData);
                    break;
                case 'horizontal':
                    analysisHTML += generateHorizontalAnalysis(selectedItems, yearsWithData);
                    break;
                case 'vertical':
                    analysisHTML += generateVerticalAnalysis(selectedItems, yearsWithData);
                    break;
            }

            analysisHTML += '</div>';

            resultsContainer.innerHTML = analysisHTML;

            // Generate visual if requested
            if (generateVisual) {
                generateCustomChart(selectedItems, yearsWithData, chartType, analysisType);
            }
        }

        // Get total for a category across all years
        function getCategoryTotal(categoryKey, year) {
            const data = window.financialData.data[year];
            if (!data || !data[categoryKey]) return 0;

            if (Array.isArray(data[categoryKey])) {
                return data[categoryKey].reduce((sum, item) => sum + (item.value || 0), 0);
            }
            return 0;
        }

        // Get category name from key
        function getCategoryName(key) {
            const names = {
                'fixedAssetsTangible': 'Fixed Assets (Tangible)',
                'intangibleAssets': 'Intangible Assets',
                'otherNonCurrentAssets': 'Other Non-Current Assets',
                'currentAssets': 'Current Assets',
                'nonCurrentLiabilities': 'Non-Current Liabilities',
                'currentLiabilities': 'Current Liabilities',
                'reserves': 'Reserves & Surplus',
                'equity': 'Equity',
                'revenue': 'Revenue',
                'otherIncome': 'Other Income',
                'directExpenses': 'Direct Expenses',
                'indirectExpenses': 'Indirect Expenses',
                'financeCosts': 'Finance Costs',
                'depreciation': 'Depreciation',
                'taxExpenses': 'Tax Expenses'
            };
            return names[key] || key;
        }

        // Trend Analysis
        function generateTrendAnalysis(items, years) {
            let html = '<h4 style="color: #495057; margin-bottom: 15px;">üìà Year-over-Year Growth Analysis</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Line Item</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year}</th>`);
            html += '<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Avg Growth</th></tr></thead><tbody>';

            items.forEach(item => {
                html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item)}</td>`;
                const values = years.map(year => getCategoryTotal(item, year));
                let growthRates = [];

                values.forEach((val, idx) => {
                    if (idx === 0) {
                        html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)}</td>`;
                    } else {
                        const prevVal = values[idx - 1];
                        const growth = prevVal > 0 ? ((val - prevVal) / prevVal * 100).toFixed(2) : 0;
                        growthRates.push(parseFloat(growth));
                        const color = growth >= 0 ? '#28a745' : '#dc3545';
                        html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)} <span style="color: ${color}; font-weight: 600;">(${growth}%)</span></td>`;
                    }
                });

                const avgGrowth = growthRates.length > 0 ? (growthRates.reduce((a, b) => a + b, 0) / growthRates.length).toFixed(2) : 0;
                const avgColor = avgGrowth >= 0 ? '#28a745' : '#dc3545';
                html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; color: ${avgColor};">${avgGrowth}%</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Comparison Analysis
        function generateComparisonAnalysis(items, years) {
            let html = '<h4 style="color: #495057; margin-bottom: 15px;">üîÑ Side-by-Side Comparison</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Line Item</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year}</th>`);
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item)}</td>`;
                years.forEach(year => {
                    const val = getCategoryTotal(item, year);
                    html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Percentage Analysis
        function generatePercentageAnalysis(items, years) {
            let html = '<h4 style="color: #495057; margin-bottom: 15px;">üìä Percentage Distribution Analysis</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Line Item</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year} (Value)</th><th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">% of Total</th>`);
            html += '</tr></thead><tbody>';

            years.forEach(year => {
                const total = items.reduce((sum, item) => sum + getCategoryTotal(item, year), 0);
                items.forEach(item => {
                    const val = getCategoryTotal(item, year);
                    const pct = total > 0 ? ((val / total) * 100).toFixed(2) : 0;
                    html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item)}</td>`;
                    html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)}</td>`;
                    html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${pct}%</td></tr>`;
                });
            });

            html += '</tbody></table>';
            return html;
        }

        // Ratio Analysis
        function generateRatioAnalysis(items, years) {
            let html = '<h4 style="color: #495057; margin-bottom: 15px;">‚öñÔ∏è Ratio Analysis</h4>';

            if (items.length < 2) {
                return '<p style="color: #dc3545;">Please select at least 2 line items for ratio analysis</p>';
            }

            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Ratio</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year}</th>`);
            html += '</tr></thead><tbody>';

            for (let i = 0; i < items.length - 1; i++) {
                for (let j = i + 1; j < items.length; j++) {
                    const item1 = items[i];
                    const item2 = items[j];
                    html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item1)} / ${getCategoryName(item2)}</td>`;

                    years.forEach(year => {
                        const val1 = getCategoryTotal(item1, year);
                        const val2 = getCategoryTotal(item2, year);
                        const ratio = val2 > 0 ? (val1 / val2).toFixed(2) : 'N/A';
                        html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${ratio}</td>`;
                    });
                    html += '</tr>';
                }
            }

            html += '</tbody></table>';
            return html;
        }

        // Horizontal Analysis
        function generateHorizontalAnalysis(items, years) {
            if (years.length < 2) {
                return '<p style="color: #dc3545;">Need at least 2 years of data for horizontal analysis</p>';
            }

            const baseYear = years[0];
            let html = `<h4 style="color: #495057; margin-bottom: 15px;">‚ÜîÔ∏è Horizontal Analysis (Base Year: ${baseYear})</h4>`;
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Line Item</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year}</th>`);
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item)}</td>`;
                const baseValue = getCategoryTotal(item, baseYear);

                years.forEach(year => {
                    const val = getCategoryTotal(item, year);
                    if (year === baseYear) {
                        html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)} (100%)</td>`;
                    } else {
                        const change = baseValue > 0 ? ((val - baseValue) / baseValue * 100).toFixed(2) : 0;
                        const color = change >= 0 ? '#28a745' : '#dc3545';
                        html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)} <span style="color: ${color}; font-weight: 600;">(${change}%)</span></td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Vertical Analysis
        function generateVerticalAnalysis(items, years) {
            let html = '<h4 style="color: #495057; margin-bottom: 15px;">‚¨áÔ∏è Vertical Analysis (% of Revenue)</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Line Item</th>';
            years.forEach(year => html += `<th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${year} (Value)</th><th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">% of Revenue</th>`);
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                html += `<tr><td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${getCategoryName(item)}</td>`;

                years.forEach(year => {
                    const val = getCategoryTotal(item, year);
                    const revenue = getCategoryTotal('revenue', year);
                    const pct = revenue > 0 ? ((val / revenue) * 100).toFixed(2) : 'N/A';
                    html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">‚Çπ${formatNumber(val)}</td>`;
                    html += `<td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${pct}%</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Generate custom chart
        function generateCustomChart(items, years, chartType, analysisType) {
            const chartContainer = document.getElementById('customAnalysisResults');
            const canvasId = 'customChart_' + Date.now();

            const chartHTML = `<div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h3 style="color: #8b1a1a; margin-bottom: 20px; font-size: 22px;">üìä Visual Analysis</h3>
            <div style="position: relative; height: 400px;">
                <canvas id="${canvasId}"></canvas>
            </div>
        </div>`;

            chartContainer.innerHTML += chartHTML;

            // Prepare chart data
            const datasets = items.map((item, idx) => {
                const data = years.map(year => getCategoryTotal(item, year));
                const colors = ['#8b1a1a', '#630d0d', '#a52a2a', '#c92a2a', '#43e97b', '#fa709a'];

                return {
                    label: getCategoryName(item),
                    data: data,
                    backgroundColor: chartType === 'pie' ? colors : colors[idx % colors.length],
                    borderColor: colors[idx % colors.length],
                    borderWidth: 2,
                    fill: chartType === 'area'
                };
            });

            // Create chart
            setTimeout(() => {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                let config = {
                    type: chartType === 'area' ? 'line' : chartType,
                    data: {
                        labels: chartType === 'pie' ? items.map(item => getCategoryName(item)) : years,
                        datasets: chartType === 'pie' ? [{
                            data: items.map(item => getCategoryTotal(item, years[years.length - 1])),
                            backgroundColor: ['#8b1a1a', '#630d0d', '#a52a2a', '#c92a2a', '#43e97b', '#fa709a']
                        }] : datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Financial Data Visualization'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: chartType !== 'pie' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return '‚Çπ' + value.toLocaleString('en-IN');
                                    }
                                }
                            }
                        } : {}
                    }
                };

                new Chart(ctx, config);
            }, 100);
        }

        // ==================== END CUSTOM ANALYZER FUNCTIONS ====================

        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const clickedTab = Array.from(document.querySelectorAll('.tab')).find(t =>
                t.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            if (clickedTab) clickedTab.classList.add('active');

            document.getElementById(tabName).classList.add('active');

            // Populate line items when analysis tab is opened
            if (tabName === 'analysis') {
                populateLineItems();
            }
        }

        // ==================== LOCAL STORAGE FUNCTIONS ====================



        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                // Use project-specific key with the function
                const projectKey = getStorageKey();  // ‚Üê CHANGE THIS LINE
                const savedData = localStorage.getItem(projectKey);

                console.log('üìÇ Loading from localStorage with key:', projectKey);  // ‚Üê ADD THIS LOG

                if (savedData) {
                    const parsed = JSON.parse(savedData);

                    // Remove this check - it's causing issues since we don't save projectId
                    // if (parsed.projectId !== window.currentCloudId) {
                    //     console.warn('Saved data is for a different project. Ignoring.');
                    //     return false;
                    // }

                    // Restore all saved properties
                    financialData.companyName = parsed.companyName || '';
                    financialData.companyType = parsed.companyType || 'private_limited';
                    financialData.currentYear = parsed.currentYear || 'FY 2025-26';
                    financialData.multiYearMode = parsed.multiYearMode || false;
                    financialData.selectedYearsForEntry = parsed.selectedYearsForEntry || ['FY 2025-26'];

                    // IMPORTANT: Restore years array first
                    if (parsed.years && Array.isArray(parsed.years)) {
                        financialData.years = parsed.years;
                    }

                    // Restore data for all years - replace entire data object
                    if (parsed.data) {
                        financialData.data = parsed.data;
                    }

                    // Update UI elements (with null checks)
                    const companyNameEl = document.getElementById('companyName');
                    const companyTypeEl = document.getElementById('companyType');
                    const multiYearToggleEl = document.getElementById('multiYearToggle');

                    if (companyNameEl) companyNameEl.value = financialData.companyName;
                    if (companyTypeEl) companyTypeEl.value = financialData.companyType;
                    if (multiYearToggleEl) multiYearToggleEl.checked = financialData.multiYearMode;

                    console.log('Data loaded from localStorage successfully with key:', projectKey);
                    console.log('Years:', financialData.years);
                    return true;
                } else {
                    console.log('No saved data found in localStorage for key:', projectKey);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
            return false;
        }


        // Clear localStorage for current project
        // Replaced by cloud version
        function clearAllProjectData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL FSA data for this project permanently!\n\nAre you absolutely sure?')) {
                if (confirm('Last chance! This CANNOT be undone.\n\nClick OK to permanently delete all data.')) {
                    // Clear project-specific localStorage key
                    const projectKey = `fsaData_${window.currentCloudId}`;
                    localStorage.removeItem(projectKey);

                    // Also clear old key just in case
                    localStorage.removeItem('financialStatementData');

                    console.log('Cleared FSA data for project:', window.currentCloudId);
                    location.href = location.href + '?nocache=' + Date.now();
                }
            }
        }

        // Export data as JSON file
        function exportDataAsJSON() {
            try {
                const dataToExport = {
                    companyName: financialData.companyName,
                    companyType: financialData.companyType,
                    currentYear: financialData.currentYear,
                    multiYearMode: financialData.multiYearMode,
                    selectedYearsForEntry: financialData.selectedYearsForEntry,
                    data: financialData.data,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `financial_statement_${financialData.companyName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert('Data exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Failed to export data.');
            }
        }

        // Import data from JSON file
        function importDataFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);

                        // Import data directly without validation
                        if (imported.companyName) {
                            financialData.companyName = imported.companyName;
                        }
                        if (imported.companyType) {
                            financialData.companyType = imported.companyType;
                        }
                        if (imported.currentYear) {
                            financialData.currentYear = imported.currentYear;
                        }
                        if (imported.multiYearMode !== undefined) {
                            financialData.multiYearMode = imported.multiYearMode;
                        }
                        if (imported.selectedYearsForEntry) {
                            financialData.selectedYearsForEntry = imported.selectedYearsForEntry;
                        }

                        // Merge imported data
                        if (imported.data) {
                            Object.keys(imported.data).forEach(year => {
                                financialData.data[year] = imported.data[year];
                            });
                        }

                        // Update UI
                        const companyNameEl = document.getElementById('companyName');
                        const companyTypeEl = document.getElementById('companyType');
                        const multiYearToggleEl = document.getElementById('multiYearToggle');

                        if (companyNameEl) companyNameEl.value = financialData.companyName;
                        if (companyTypeEl) companyTypeEl.value = financialData.companyType;
                        if (multiYearToggleEl) multiYearToggleEl.checked = financialData.multiYearMode;

                        // Refresh UI
                        initYearSelector();
                        renderAllInputs();
                        renderYearNotes();

                        // Save to cloud if in cloud mode, otherwise local
                        if (pid && user) {
                            syncData().then(() => {
                                alert('‚úÖ Import Successful - Synced to Cloud');
                            });
                        } else {
                            saveToLocalStorage();
                            alert('‚úÖ Import Successful');
                        }

                    } catch (error) {
                        console.error('Import error:', error);
                        alert('‚ùå Import Failed: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Auto-save wrapper - call this after any data change
        function autoSave() {
            saveToLocalStorage();
        }



        let currentCompanyID = '';
        let currentUserName = '';

        function generateStorageKey(companyName, userName) {
            // Remove spaces and special characters, convert to safe string
            const safeCo = companyName.replace(/[^a-zA-Z0-9]/g, '');
            const safeUser = userName.replace(/[^a-zA-Z0-9]/g, '');
            return `financialData_${safeCo}_${safeUser}`;
        }



        function updateSessionDisplay() {
            // Update header to show current session
            const header = document.querySelector('.header p');
            if (header) {
                header.innerHTML = `Company: <strong>${currentCompanyID}</strong> | User: <strong>${currentUserName}</strong> | <a href="#" onclick="changeSession(); return false;" style="color: white; text-decoration: underline;">Change Session</a>`;
            }
        }



        function changeSession() {
            if (confirm('‚ö†Ô∏è Changing session will reload the page.\n\nAny unsaved changes will be lost unless you save first.\n\nContinue?')) {
                // Clear session storage
                sessionStorage.removeItem('currentCompanyID');
                sessionStorage.removeItem('currentUserName');

                // Reload page
                location.reload();
            }
        }




        // Override clearLocalStorage to use dynamic key
        window.clearAllFSAData = async function () {
            if (!window.currentCloudId) {
                alert("No project selected!");
                return;
            }

            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL financial data for this company permanently!\n\nAre you absolutely sure?')) {
                if (confirm('LAST CHANCE: This will wipe all tables and cannot be undone. Clear everything?')) {

                    // 1. WIPE LOCAL MEMORY
                    window.financialData.data = {};
                    window.financialData.companyName = "";

                    // 2. PREPARE THE "EMPTY" CLOUD PAYLOAD
                    const currentUser = window.auth.currentUser;
                    const path = window.ispriv && currentUser ?
                        'users/' + currentUser.uid + '/private/' + window.currentCloudId :
                        'shared/' + window.currentCloudId;

                    const payload = {
                        companyName: "",
                        companyType: "private_limited",
                        fsaData: {}, // This is what actually wipes the cloud rows
                        years: ['FY 2023-24', 'FY 2024-25'],
                        multiYearMode: false,
                        selectedYearsForEntry: ['FY 2023-24'],
                        lastModified: new Date().toISOString(),
                        lastModifiedBy: currentUser?.email?.split('@')[0] || 'User'
                    };

                    try {
                        // 3. PUSH EMPTY STATE TO FIREBASE
                        await window.fb.set(window.fb.ref(window.db, path), payload);

                        // 4. CLEAR LOCALSTORAGE CACHE
                        const projectKey = `fsaData_${window.currentCloudId}`;
                        localStorage.removeItem(projectKey);

                        alert("‚úÖ Data successfully wiped from Cloud and Local storage.");

                        // 5. HARD REFRESH THE UI
                        window.openFSADashboard();

                    } catch (e) {
                        console.error("Clear Failed:", e);
                        alert("Failed to clear cloud data: " + e.message);
                    }
                }
            }
        };

        // ============================================
        // ENHANCEMENT FUNCTIONS
        // ============================================

        // Indian number formatting
        function formatIndianNumber(num) {
            if (!num || num === 0) return '0';
            const absNum = Math.abs(num);
            const isNegative = num < 0;
            const numStr = absNum.toString();

            // Split into integer and decimal parts
            const parts = numStr.split('.');
            let intPart = parts[0];
            const decPart = parts[1] ? '.' + parts[1] : '';

            // Format integer part in Indian style
            let lastThree = intPart.substring(intPart.length - 3);
            let otherNumbers = intPart.substring(0, intPart.length - 3);

            if (otherNumbers !== '') {
                lastThree = ',' + lastThree;
            }

            const formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + lastThree + decPart;
            return (isNegative ? '-' : '') + formatted;
        }

        // Auto-clear zero on focus
        function handleInputFocus(event) {
            if (event.target.value === '0' || event.target.value === '') {
                event.target.value = '';
            }
        }

        // Format on blur
        function handleInputBlur(event) {
            if (event.target.value === '') {
                event.target.value = '0';
            }
        }

        // Calculate common size percentage
        function calculateCommonSize(value, base) {
            if (!base || base === 0) return '0.00';
            return ((value / base) * 100).toFixed(2);
        }

        // Toggle attachments section
        function toggleAttachments() {
            console.log('Toggle attachments clicked');
            const section = document.getElementById('attachmentsSection');
            const button = document.getElementById('attachmentsToggleBtn');

            if (!section) {
                console.error('Attachments section not found!');
                alert('Error: Attachments section not found. Please reload the page.');
                return;
            }

            console.log('Current display:', section.style.display);

            if (section.style.display === 'none' || section.style.display === '') {
                // OPENING - Show section
                section.style.display = 'block';
                console.log('Showing attachments section');

                // Change button to GREEN (ON state)
                if (button) {
                    button.style.background = '#28a745'; // Green
                    button.style.color = 'white';
                    button.style.fontWeight = 'bold';
                    button.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.4)';
                    button.style.transform = 'scale(1.05)';
                    button.innerHTML = '‚úÖ Attachments (ON)';
                }

                renderAttachments();

                // Auto-scroll to section
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                // CLOSING - Hide section
                section.style.display = 'none';
                console.log('Hiding attachments section');

                // Change button back to PURPLE (OFF state)
                if (button) {
                    button.style.background = '#8b1a1a'; // Purple
                    button.style.color = 'white';
                    button.style.fontWeight = 'normal';
                    button.style.boxShadow = 'none';
                    button.style.transform = 'scale(1)';
                    button.innerHTML = 'üìé Attachments';
                }
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            console.log('File upload triggered');
            const files = event.target.files;
            console.log('Files selected:', files.length);

            if (files.length === 0) {
                console.log('No files selected');
                return;
            }

            // Ensure attachments array exists
            if (!financialData.attachments) {
                financialData.attachments = [];
            }

            for (let file of files) {
                console.log('Processing file:', file.name, 'Size:', file.size);
                const reader = new FileReader();
                reader.onload = function (e) {
                    const attachment = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        originalName: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    financialData.attachments.push(attachment);
                    console.log('File added to attachments:', attachment.name);
                    renderAttachments();
                    autoSave();
                };
                reader.onerror = function (error) {
                    console.error('Error reading file:', error);
                    alert('Error reading file: ' + file.name);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        // Render attachments list
        function renderAttachments() {
            console.log('Rendering attachments...');
            const container = document.getElementById('attachmentsList');

            if (!container) {
                console.error('Attachments list container not found!');
                return;
            }

            // Ensure attachments array exists
            if (!financialData.attachments) {
                financialData.attachments = [];
            }

            console.log('Attachments:', financialData.attachments);
            console.log('Attachments count:', financialData.attachments.length);

            if (financialData.attachments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px; font-size: 14px;">üìÇ No attachments yet. Click "+ Upload Files" above to attach financial statements, MOA, or other documents.</p>';
                console.log('Showing no attachments message');
                return;
            }

            container.innerHTML = financialData.attachments.map(att => `
            <div class="attachment-item">
                <div class="attachment-icon">üìÑ</div>
                <div class="attachment-info">
                    <div class="attachment-name">${att.name}</div>
                    <div class="attachment-meta">${formatFileSize(att.size)} ‚Ä¢ ${new Date(att.uploadDate).toLocaleDateString()}</div>
                </div>
                <div class="attachment-actions">
                    <button class="attachment-btn edit-name-btn" onclick="editAttachmentName('${att.id}')">‚úèÔ∏è Rename</button>
                    <button class="attachment-btn download-btn" onclick="downloadAttachment('${att.id}')">‚¨áÔ∏è Download</button>
                    <button class="attachment-btn delete-attachment-btn" onclick="deleteAttachment('${att.id}')">üóëÔ∏è Delete</button>
                </div>
            </div>
        `).join('');

            console.log('Attachments rendered successfully');
        }

        // Edit attachment name
        function editAttachmentName(id) {
            const attachment = financialData.attachments.find(a => a.id == id);
            if (!attachment) return;

            const newName = prompt('Enter new name for the file:', attachment.name);
            if (newName && newName.trim()) {
                attachment.name = newName.trim();
                renderAttachments();
                autoSave();
            }
        }

        // Download attachment
        function downloadAttachment(id) {
            const attachment = financialData.attachments.find(a => a.id == id);
            if (!attachment) return;

            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }

        // Delete attachment
        function deleteAttachment(id) {
            if (confirm('Delete this attachment?')) {
                financialData.attachments = financialData.attachments.filter(a => a.id != id);
                renderAttachments();
                autoSave();
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Render year notes
        function renderYearNotes() {
            const container = document.getElementById('yearNotesSection');
            if (!container) return;

            const yearsToShow = financialData.multiYearMode ? financialData.selectedYearsForEntry : [financialData.currentYear];

            container.innerHTML = yearsToShow.map(year => {
                // Safety check: ensure year data exists
                if (!financialData.data[year]) {
                    financialData.data[year] = initializeYearData(year);
                }

                return `
                <div class="year-notes">
                    <div class="year-notes-label">üìù Notes for ${year}</div>
                    <textarea class="notes-textarea" placeholder="Add notes or context for ${year}..." 
                              onchange="updateYearNotes('${year}', this.value)">${financialData.data[year].notes || ''}</textarea>
                </div>
            `
            }).join('');
        }

        // Update year notes
        function updateYearNotes(year, notes) {
            financialData.data[year].notes = notes;
            autoSave();
        }


        // Save custom insights
        function saveInsights() {
            financialData.customInsights = document.getElementById('customInsights').value;
            autoSave();
            // Visual feedback instead of alert
            const textarea = document.getElementById('customInsights');
            const originalBorder = textarea.style.border;
            textarea.style.border = '2px solid #28a745';
            setTimeout(() => {
                textarea.style.border = originalBorder;
            }, 1000);
        }

        // Calculate variance and trend
        function calculateVariance(currentValue, previousValue) {
            if (!previousValue || previousValue === 0) {
                return { percent: 0, direction: 'neutral', change: currentValue };
            }

            const change = currentValue - previousValue;
            const percent = (change / Math.abs(previousValue)) * 100;
            const direction = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';

            return { percent: percent.toFixed(1), direction, change };
        }

        // Render variance badge
        function renderVarianceBadge(variance) {
            if (!variance || variance.direction === 'neutral') {
                return '<span class="variance-badge variance-neutral">No change</span>';
            }

            const arrow = variance.direction === 'positive' ? '‚Üë' : '‚Üì';
            const className = `variance-badge variance-${variance.direction}`;

            return `<span class="${className}"><span class="trend-arrow">${arrow}</span> ${Math.abs(variance.percent)}%</span>`;
        }

        // Create charts
        function createChart(canvasId, chartType, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // 1. CLEANUP: Wipe old chart instance to prevent "Ghosting" when switching projects
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            // 2. SAFETY CHECK: Prevent the "Cannot read properties of undefined (reading 'every')" crash
            if (!data || !data.datasets) {
                console.error(`‚ùå Chart Error: No datasets provided for ${canvasId}`);
                return;
            }

            const needsScales = !['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType);

            const options = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: { size: 18, weight: 'bold' },
                        padding: 20,
                        color: '#8b1a1a'
                    },
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;

                                // Smart Tooltip: Show ‚Çπ for money and % for ratios
                                if (label.includes('%')) {
                                    return `${label}: ${value.toFixed(2)}%`;
                                } else {
                                    return `${label}: ‚Çπ${value.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    }
                }
            };

            // 3. DYNAMIC SCALING (Money vs Percentage)
            if (needsScales) {
                const isPercentageChart = data.datasets.every(ds => ds.label?.includes('%'));

                options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return isPercentageChart ? value + '%' : '‚Çπ' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                };
            }

            // 4. RADAR FIX: Don't force max 100 unless it's actually a percentage
            if (chartType === 'radar') {
                const isPercentage = data.datasets.every(ds => ds.label?.includes('%'));
                options.scales = {
                    r: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => isPercentage ? value + '%' : '‚Çπ' + value.toLocaleString('en-IN')
                        }
                    }
                };
                if (isPercentage) options.scales.r.max = 100;
            }

            // 5. RENDER
            new Chart(ctx, {
                type: chartType,
                data: data,
                options: options
            });
        }
        // Initialize session first, then load data
        // Initialization moved to cloud code

        // ============================================
        // ADVANCED CUSTOM ANALYZER FUNCTIONS
        // ============================================

        // Global variables for selected line items
        let selectedDeepDiveItems = [];
        let selectedLineItems = [];

        // Update Line Item Selector for Deep Dive
        function updateLineItemSelector() {
            const category = document.getElementById('deepDiveCategory').value;
            const selectorDiv = document.getElementById('lineItemSelectorDiv');
            const checkboxesDiv = document.getElementById('lineItemCheckboxes');

            if (!category) {
                selectorDiv.style.display = 'none';
                return;
            }

            const financialData = window.financialData;
            const allLineItems = new Set();

            // Get all unique line items from all years
            financialData.years.forEach(year => {
                const items = financialData.data[year]?.[category] || [];
                items.forEach(item => allLineItems.add(item.name));
            });

            if (allLineItems.size === 0) {
                selectorDiv.style.display = 'none';
                return;
            }

            selectorDiv.style.display = 'block';
            selectedDeepDiveItems = [];

            let html = '';
            Array.from(allLineItems).forEach(itemName => {
                html += `
                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${itemName}" onchange="toggleDeepDiveItem(this)" style="margin-right: 10px;">
                        <span>${itemName}</span>
                    </label>
                </div>
            `;
            });

            checkboxesDiv.innerHTML = html;
        }

        function toggleDeepDiveItem(checkbox) {
            if (checkbox.checked) {
                selectedDeepDiveItems.push(checkbox.value);
            } else {
                selectedDeepDiveItems = selectedDeepDiveItems.filter(item => item !== checkbox.value);
            }
        }

        // Part 1: Deep Dive Analysis
        function performDeepDive() {
            const category = document.getElementById('deepDiveCategory').value;
            const resultsDiv = document.getElementById('deepDiveResults');

            if (!category) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">Please select a category first</p>';
                return;
            }

            const financialData = window.financialData;
            const yearsWithData = financialData.years.filter(year => {
                const data = financialData.data[year];
                return data && data[category] && data[category].some(item => item.value > 0);
            }).sort((a, b) => {
                const yearA = parseInt(a.match(/\d{4}/)[0]);
                const yearB = parseInt(b.match(/\d{4}/)[0]);
                return yearA - yearB;
            });

            if (yearsWithData.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">No data found for this category</p>';
                return;
            }

            // Get all unique line items across all years
            const allLineItems = new Set();
            yearsWithData.forEach(year => {
                const items = financialData.data[year][category] || [];
                items.forEach(item => allLineItems.add(item.name));
            });

            // Filter to selected items if any are selected
            let itemsToAnalyze = Array.from(allLineItems);
            if (selectedDeepDiveItems.length > 0) {
                itemsToAnalyze = itemsToAnalyze.filter(item => selectedDeepDiveItems.includes(item));
            }

            if (itemsToAnalyze.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">No items selected for analysis</p>';
                return;
            }

            const categoryNames = {
                'fixedAssetsTangible': 'Fixed Assets / Tangible Assets',
                'intangibleAssets': 'Intangible Assets',
                'otherNonCurrentAssets': 'Other Non-Current Assets',
                'currentAssets': 'Current Assets',
                'shareCapital': 'Share Capital',
                'reserves': 'Reserves & Surplus',
                'nonCurrentLiabilities': 'Non-Current Liabilities',
                'currentLiabilities': 'Current Liabilities',
                'revenue': 'Revenue',
                'otherIncome': 'Other Income',
                'directExpenses': 'Direct Expenses / COGS',
                'indirectExpenses': 'Indirect Expenses / Operating Expenses',
                'financeCosts': 'Finance Costs',
                'depreciation': 'Depreciation & Amortization',
                'taxExpenses': 'Tax Expenses'
            };

            let html = `
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #8b1a1a;">
                <h3 style="color: #8b1a1a; margin-bottom: 20px;">üìä Deep Dive: ${categoryNames[category]}</h3>
                ${selectedDeepDiveItems.length > 0 ? `<p style="color: #6c757d; margin-bottom: 15px;">Analyzing ${selectedDeepDiveItems.length} selected item(s)</p>` : ''}
                
                <!-- Line Items Table -->
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #8b1a1a; color: white;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Line Item</th>
                                ${yearsWithData.map(year => `<th style="padding: 12px; text-align: right; border: 1px solid #ddd;">${year}</th>`).join('')}
                                ${yearsWithData.length > 1 ? '<th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Growth %</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
        `;

            // Add rows for each line item
            itemsToAnalyze.forEach(itemName => {
                html += '<tr style="border-bottom: 1px solid #ddd;">';
                html += `<td style="padding: 10px; font-weight: 600;">${itemName}</td>`;

                const values = [];
                yearsWithData.forEach(year => {
                    const items = financialData.data[year][category] || [];
                    const item = items.find(i => i.name === itemName);
                    const value = item ? item.value : 0;
                    values.push(value);
                    html += `<td style="padding: 10px; text-align: right;">${formatNumber(value)}</td>`;
                });

                // Calculate growth if we have multiple years
                if (yearsWithData.length > 1) {
                    const firstValue = values[0];
                    const lastValue = values[values.length - 1];
                    const growth = firstValue > 0 ? ((lastValue - firstValue) / firstValue * 100) : 0;
                    const color = growth >= 0 ? '#28a745' : '#dc3545';
                    html += `<td style="padding: 10px; text-align: right; color: ${color}; font-weight: 600;">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</td>`;
                }

                html += '</tr>';
            });

            // Calculate totals
            html += '<tr style="background: #f8f9fa; font-weight: 700;">';
            html += '<td style="padding: 12px;">TOTAL</td>';

            const totalValues = [];
            yearsWithData.forEach(year => {
                const items = financialData.data[year][category] || [];
                const total = items.reduce((sum, item) => sum + (item.value || 0), 0);
                totalValues.push(total);
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(total)}</td>`;
            });

            if (yearsWithData.length > 1) {
                const firstTotal = totalValues[0];
                const lastTotal = totalValues[totalValues.length - 1];
                const totalGrowth = firstTotal > 0 ? ((lastTotal - firstTotal) / firstTotal * 100) : 0;
                const color = totalGrowth >= 0 ? '#28a745' : '#dc3545';
                html += `<td style="padding: 12px; text-align: right; color: ${color};">${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toFixed(1)}%</td>`;
            }

            html += '</tr></tbody></table></div>';

            // Generate Chart
            html += '<div style="margin-top: 30px;"><canvas id="deepDiveChart" style="max-height: 400px;"></canvas></div>';
            html += '</div>';

            resultsDiv.innerHTML = html;

            // Create chart after DOM is updated
            setTimeout(() => {
                const ctx = document.getElementById('deepDiveChart');
                if (ctx) {
                    const datasets = [];
                    const colors = ['#8b1a1a', '#630d0d', '#a52a2a', '#c92a2a', '#e03131', '#9b1c1c', '#721c24'];

                    itemsToAnalyze.forEach((itemName, index) => {
                        const values = yearsWithData.map(year => {
                            const items = financialData.data[year][category] || [];
                            const item = items.find(i => i.name === itemName);
                            return item ? item.value : 0;
                        });

                        datasets.push({
                            label: itemName,
                            data: values,
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length] + '20',
                            borderWidth: 2,
                            tension: 0.4
                        });
                    });

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: yearsWithData,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Trend Analysis: ${categoryNames[category]}`,
                                    font: { size: 18, weight: 'bold' },
                                    color: '#8b1a1a'
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return formatNumber(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Part 2: Reclassification Functions
        function loadLineItemsForReclassification(source) {
            const category = document.getElementById('reclassFromCategory').value;
            const container = document.getElementById('reclassFromItems');

            if (!category) {
                container.innerHTML = '<p style="color: #6c757d; padding: 10px;">Select a source category first</p>';
                return;
            }

            const financialData = window.financialData;
            const allLineItems = new Set();

            // Get all unique line items from all years
            financialData.years.forEach(year => {
                const items = financialData.data[year]?.[category] || [];
                items.forEach(item => allLineItems.add(item.name));
            });

            if (allLineItems.size === 0) {
                container.innerHTML = '<p style="color: #dc3545; padding: 10px;">No items found in this category</p>';
                return;
            }

            let html = '';
            Array.from(allLineItems).forEach((itemName, index) => {
                html += `
                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${itemName}" onchange="toggleLineItem(this)" style="margin-right: 10px;">
                        <span>${itemName}</span>
                    </label>
                </div>
            `;
            });

            container.innerHTML = html;
            selectedLineItems = [];
        }

        function toggleLineItem(checkbox) {
            if (checkbox.checked) {
                selectedLineItems.push(checkbox.value);
            } else {
                selectedLineItems = selectedLineItems.filter(item => item !== checkbox.value);
            }
        }

        function performReclassification() {
            const fromCategory = document.getElementById('reclassFromCategory').value;
            const toCategory = document.getElementById('reclassToCategory').value;
            const resultsDiv = document.getElementById('reclassificationResults');

            if (!fromCategory || !toCategory) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">Please select both source and destination categories</p>';
                return;
            }

            if (fromCategory === toCategory) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">Source and destination categories cannot be the same</p>';
                return;
            }

            if (selectedLineItems.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #dc3545; padding: 20px; text-align: center;">Please select at least one line item to reclassify</p>';
                return;
            }

            const financialData = window.financialData;
            const yearsWithData = financialData.years.filter(year => {
                const data = financialData.data[year];
                return data && (data[fromCategory]?.some(item => item.value > 0) || data[toCategory]?.some(item => item.value > 0));
            }).sort((a, b) => {
                const yearA = parseInt(a.match(/\d{4}/)[0]);
                const yearB = parseInt(b.match(/\d{4}/)[0]);
                return yearA - yearB;
            });

            // Calculate original and reclassified totals
            const originalTotals = {};
            const reclassifiedTotals = {};

            yearsWithData.forEach(year => {
                const items = financialData.data[year][fromCategory] || [];

                // Original total for source category
                originalTotals[year] = {
                    from: items.reduce((sum, item) => sum + (item.value || 0), 0),
                    to: (financialData.data[year][toCategory] || []).reduce((sum, item) => sum + (item.value || 0), 0)
                };

                // Calculate reclassified amounts
                const reclassAmount = items
                    .filter(item => selectedLineItems.includes(item.name))
                    .reduce((sum, item) => sum + (item.value || 0), 0);

                reclassifiedTotals[year] = {
                    from: originalTotals[year].from - reclassAmount,
                    to: originalTotals[year].to + reclassAmount,
                    reclassAmount: reclassAmount
                };
            });

            // Calculate P&L Impact - Original vs Reclassified
            const plImpact = {};
            yearsWithData.forEach(year => {
                const allTotals = calculateTotals(year);
                const reclassAmount = reclassifiedTotals[year].reclassAmount;

                // Calculate original P&L metrics
                const originalPL = {
                    revenue: allTotals.revenue,
                    cogs: allTotals.cogs,
                    grossProfit: allTotals.grossProfit,
                    ebitda: allTotals.ebitda,
                    netProfit: allTotals.netProfit
                };

                // Calculate reclassified P&L metrics based on what was moved
                let newCOGS = originalPL.cogs;
                let newIndirectExp = allTotals.indirectExpenses;
                let newFinanceCost = allTotals.financeCosts;
                let newDepreciation = allTotals.depreciation;

                // Adjust based on movement direction
                if (fromCategory === 'indirectExpenses' && toCategory === 'directExpenses') {
                    newCOGS += reclassAmount;
                    newIndirectExp -= reclassAmount;
                } else if (fromCategory === 'directExpenses' && toCategory === 'indirectExpenses') {
                    newCOGS -= reclassAmount;
                    newIndirectExp += reclassAmount;
                } else if (fromCategory === 'financeCosts' && toCategory === 'directExpenses') {
                    newCOGS += reclassAmount;
                    newFinanceCost -= reclassAmount;
                } else if (fromCategory === 'directExpenses' && toCategory === 'financeCosts') {
                    newCOGS -= reclassAmount;
                    newFinanceCost += reclassAmount;
                } else if (fromCategory === 'depreciation' && toCategory === 'directExpenses') {
                    newCOGS += reclassAmount;
                    newDepreciation -= reclassAmount;
                } else if (fromCategory === 'directExpenses' && toCategory === 'depreciation') {
                    newCOGS -= reclassAmount;
                    newDepreciation += reclassAmount;
                } else if (fromCategory === 'indirectExpenses' && toCategory === 'financeCosts') {
                    newIndirectExp -= reclassAmount;
                    newFinanceCost += reclassAmount;
                } else if (fromCategory === 'financeCosts' && toCategory === 'indirectExpenses') {
                    newFinanceCost -= reclassAmount;
                    newIndirectExp += reclassAmount;
                }

                // Calculate new P&L metrics
                const reclassifiedPL = {
                    revenue: originalPL.revenue,
                    cogs: newCOGS,
                    grossProfit: originalPL.revenue - newCOGS,
                    ebitda: originalPL.revenue - newCOGS - newIndirectExp,
                    netProfit: originalPL.revenue - newCOGS - newIndirectExp - newFinanceCost - newDepreciation - allTotals.taxExpenses
                };

                // Calculate margins
                const originalGrossMargin = originalPL.revenue > 0 ? (originalPL.grossProfit / originalPL.revenue * 100) : 0;
                const reclassifiedGrossMargin = reclassifiedPL.revenue > 0 ? (reclassifiedPL.grossProfit / reclassifiedPL.revenue * 100) : 0;
                const originalNetMargin = originalPL.revenue > 0 ? (originalPL.netProfit / originalPL.revenue * 100) : 0;
                const reclassifiedNetMargin = reclassifiedPL.revenue > 0 ? (reclassifiedPL.netProfit / reclassifiedPL.revenue * 100) : 0;

                plImpact[year] = {
                    original: originalPL,
                    reclassified: reclassifiedPL,
                    changes: {
                        grossProfit: reclassifiedPL.grossProfit - originalPL.grossProfit,
                        ebitda: reclassifiedPL.ebitda - originalPL.ebitda,
                        netProfit: reclassifiedPL.netProfit - originalPL.netProfit
                    },
                    margins: {
                        originalGrossMargin: originalGrossMargin,
                        reclassifiedGrossMargin: reclassifiedGrossMargin,
                        originalNetMargin: originalNetMargin,
                        reclassifiedNetMargin: reclassifiedNetMargin,
                        grossMarginChange: reclassifiedGrossMargin - originalGrossMargin,
                        netMarginChange: reclassifiedNetMargin - originalNetMargin
                    }
                };
            });

            const categoryNames = {
                'directExpenses': 'Direct Expenses / COGS',
                'indirectExpenses': 'Indirect Expenses / Operating Expenses',
                'financeCosts': 'Finance Costs',
                'depreciation': 'Depreciation & Amortization',
                'nonCurrentLiabilities': 'Non-Current Liabilities',
                'currentLiabilities': 'Current Liabilities',
                'fixedAssetsTangible': 'Fixed Assets / Tangible Assets',
                'currentAssets': 'Current Assets'
            };

            let html = `
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #856404;">
                <h3 style="color: #856404; margin-bottom: 20px;">üìä Reclassification Impact Analysis</h3>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #856404;">
                    <p style="margin: 0; color: #856404; font-weight: 600;">
                        Moving: <strong>${selectedLineItems.join(', ')}</strong><br>
                        From: <strong>${categoryNames[fromCategory]}</strong><br>
                        To: <strong>${categoryNames[toCategory]}</strong>
                    </p>
                </div>
                
                <!-- Comparison Table -->
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #856404; color: white;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Category</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Scenario</th>
                                ${yearsWithData.map(year => `<th style="padding: 12px; text-align: right; border: 1px solid #ddd;">${year}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Source Category -->
                            <tr style="background: #ffe69c;">
                                <td rowspan="2" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">${categoryNames[fromCategory]}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(originalTotals[year].from)}</td>`).join('')}
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                ${yearsWithData.map(year => {
                const change = reclassifiedTotals[year].from - originalTotals[year].from;
                const color = change < 0 ? '#dc3545' : '#28a745';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${formatNumber(reclassifiedTotals[year].from)}</td>`;
            }).join('')}
                            </tr>
                            
                            <!-- Destination Category -->
                            <tr style="background: #d4edda;">
                                <td rowspan="2" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">${categoryNames[toCategory]}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(originalTotals[year].to)}</td>`).join('')}
                            </tr>
                            <tr style="background: #c3e6cb;">
                                <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                ${yearsWithData.map(year => {
                const change = reclassifiedTotals[year].to - originalTotals[year].to;
                const color = change > 0 ? '#dc3545' : '#28a745';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${formatNumber(reclassifiedTotals[year].to)}</td>`;
            }).join('')}
                            </tr>
                            
                            <!-- Reclassified Amount -->
                            <tr style="background: #f8f9fa; font-weight: 700;">
                                <td colspan="2" style="padding: 12px; border: 1px solid #ddd;">Amount Reclassified</td>
                                ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #8b1a1a;">${formatNumber(reclassifiedTotals[year].reclassAmount)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- P&L IMPACT ANALYSIS -->
                <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 5px solid #0c5460; margin-bottom: 30px;">
                    <h4 style="color: #0c5460; margin-bottom: 15px;">üí∞ Profit & Loss Statement Impact</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #17a2b8; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Metric</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Scenario</th>
                                    ${yearsWithData.map(year => `<th style="padding: 12px; text-align: right; border: 1px solid #ddd;">${year}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Revenue (unchanged) -->
                                <tr style="background: #e7f3ff;">
                                    <td style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">Revenue</td>
                                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">Both</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(plImpact[year].original.revenue)}</td>`).join('')}
                                </tr>
                                
                                <!-- Gross Profit -->
                                <tr style="background: #fff9e6;">
                                    <td rowspan="3" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">Gross Profit</td>
                                    <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(plImpact[year].original.grossProfit)}</td>`).join('')}
                                </tr>
                                <tr style="background: #fff3cd;">
                                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                    ${yearsWithData.map(year => {
                const color = plImpact[year].changes.grossProfit >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${formatNumber(plImpact[year].reclassified.grossProfit)}</td>`;
            }).join('')}
                                </tr>
                                <tr style="background: #ffe69c; font-weight: 700;">
                                    <td style="padding: 12px; border: 1px solid #ddd;">Change</td>
                                    ${yearsWithData.map(year => {
                const change = plImpact[year].changes.grossProfit;
                const color = change >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 700;">${change >= 0 ? '+' : ''}${formatNumber(change)}</td>`;
            }).join('')}
                                </tr>
                                
                                <!-- EBITDA -->
                                <tr style="background: #e8f5e9;">
                                    <td rowspan="3" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">EBITDA</td>
                                    <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(plImpact[year].original.ebitda)}</td>`).join('')}
                                </tr>
                                <tr style="background: #d4edda;">
                                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                    ${yearsWithData.map(year => {
                const color = plImpact[year].changes.ebitda >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${formatNumber(plImpact[year].reclassified.ebitda)}</td>`;
            }).join('')}
                                </tr>
                                <tr style="background: #c3e6cb; font-weight: 700;">
                                    <td style="padding: 12px; border: 1px solid #ddd;">Change</td>
                                    ${yearsWithData.map(year => {
                const change = plImpact[year].changes.ebitda;
                const color = change >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 700;">${change >= 0 ? '+' : ''}${formatNumber(change)}</td>`;
            }).join('')}
                                </tr>
                                
                                <!-- Net Profit -->
                                <tr style="background: #f3e5f5;">
                                    <td rowspan="3" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">Net Profit</td>
                                    <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatNumber(plImpact[year].original.netProfit)}</td>`).join('')}
                                </tr>
                                <tr style="background: #e1bee7;">
                                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                    ${yearsWithData.map(year => {
                const color = plImpact[year].changes.netProfit >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${formatNumber(plImpact[year].reclassified.netProfit)}</td>`;
            }).join('')}
                                </tr>
                                <tr style="background: #ce93d8; font-weight: 700;">
                                    <td style="padding: 12px; border: 1px solid #ddd;">Change</td>
                                    ${yearsWithData.map(year => {
                const change = plImpact[year].changes.netProfit;
                const color = change >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 700;">${change >= 0 ? '+' : ''}${formatNumber(change)}</td>`;
            }).join('')}
                                </tr>
                                
                                <!-- MARGIN PERCENTAGES -->
                                <tr style="background: #fff9e6;">
                                    <td rowspan="3" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">Gross Margin %</td>
                                    <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${plImpact[year].margins.originalGrossMargin.toFixed(2)}%</td>`).join('')}
                                </tr>
                                <tr style="background: #fff3cd;">
                                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                    ${yearsWithData.map(year => {
                const color = plImpact[year].margins.grossMarginChange >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${plImpact[year].margins.reclassifiedGrossMargin.toFixed(2)}%</td>`;
            }).join('')}
                                </tr>
                                <tr style="background: #ffe69c; font-weight: 700;">
                                    <td style="padding: 12px; border: 1px solid #ddd;">Change</td>
                                    ${yearsWithData.map(year => {
                const change = plImpact[year].margins.grossMarginChange;
                const color = change >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 700;">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>`;
            }).join('')}
                                </tr>
                                
                                <tr style="background: #f3e5f5;">
                                    <td rowspan="3" style="padding: 12px; font-weight: 700; border: 1px solid #ddd;">Net Margin %</td>
                                    <td style="padding: 12px; border: 1px solid #ddd;">Original</td>
                                    ${yearsWithData.map(year => `<td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${plImpact[year].margins.originalNetMargin.toFixed(2)}%</td>`).join('')}
                                </tr>
                                <tr style="background: #e1bee7;">
                                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">After Reclass</td>
                                    ${yearsWithData.map(year => {
                const color = plImpact[year].margins.netMarginChange >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 600;">${plImpact[year].margins.reclassifiedNetMargin.toFixed(2)}%</td>`;
            }).join('')}
                                </tr>
                                <tr style="background: #ce93d8; font-weight: 700;">
                                    <td style="padding: 12px; border: 1px solid #ddd;">Change</td>
                                    ${yearsWithData.map(year => {
                const change = plImpact[year].margins.netMarginChange;
                const color = change >= 0 ? '#28a745' : '#dc3545';
                return `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${color}; font-weight: 700;">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>`;
            }).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- P&L Trend Line Chart -->
                <div style="margin-top: 30px;">
                    <h4 style="color: #0c5460; margin-bottom: 15px;">üìà P&L Metrics Trend (Original vs After Reclassification)</h4>
                    <canvas id="plTrendChart" style="max-height: 400px;"></canvas>
                </div>
                
                <!-- Visual Comparison Chart -->
                <div style="margin-top: 30px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">üìä Category Movement Comparison</h4>
                    <canvas id="reclassChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        `;

            resultsDiv.innerHTML = html;

            // Create P&L Trend Line Chart with STUNNING DARK PROFESSIONAL DESIGN
            setTimeout(() => {
                const plCtx = document.getElementById('plTrendChart');
                if (plCtx) {
                    // Clean Professional Color Palette
                    const colors = {
                        text: '#333333',
                        gold: '#ff9800',
                        grid: 'rgba(0, 0, 0, 0.1)'
                    };

                    new Chart(plCtx, {
                        type: 'line',
                        data: {
                            labels: yearsWithData,
                            datasets: [
                                {
                                    label: 'üí∞ Revenue',
                                    data: yearsWithData.map(year => plImpact[year].original.revenue),
                                    borderColor: '#ffd700',
                                    backgroundColor: 'rgba(255, 215, 0, 0.15)',
                                    borderWidth: 4,
                                    tension: 0.4,
                                    pointRadius: 7,
                                    pointHoverRadius: 10,
                                    pointBackgroundColor: '#ffd700',
                                    pointBorderColor: '#1a1a1a',
                                    pointBorderWidth: 2,
                                    fill: true
                                },
                                {
                                    label: 'üìà Gross Profit - Original',
                                    data: yearsWithData.map(year => plImpact[year].original.grossProfit),
                                    borderColor: '#4a9eff',
                                    backgroundColor: 'rgba(74, 158, 255, 0.15)',
                                    borderWidth: 4,
                                    tension: 0.4,
                                    pointRadius: 7,
                                    pointHoverRadius: 10,
                                    pointBackgroundColor: '#4a9eff',
                                    pointBorderColor: '#1a1a1a',
                                    pointBorderWidth: 2,
                                    borderDash: [],
                                    fill: true
                                },
                                {
                                    label: 'üìâ Gross Profit - After Reclass',
                                    data: yearsWithData.map(year => plImpact[year].reclassified.grossProfit),
                                    borderColor: '#00d4aa',
                                    backgroundColor: 'rgba(0, 212, 170, 0.15)',
                                    borderWidth: 4,
                                    tension: 0.4,
                                    pointRadius: 7,
                                    pointHoverRadius: 10,
                                    pointBackgroundColor: '#00d4aa',
                                    pointBorderColor: '#1a1a1a',
                                    pointBorderWidth: 2,
                                    borderDash: [8, 4],
                                    fill: true
                                },
                                {
                                    label: 'üíµ Net Profit - Original',
                                    data: yearsWithData.map(year => plImpact[year].original.netProfit),
                                    borderColor: '#ff6b9d',
                                    backgroundColor: 'rgba(255, 107, 157, 0.15)',
                                    borderWidth: 4,
                                    tension: 0.4,
                                    pointRadius: 7,
                                    pointHoverRadius: 10,
                                    pointBackgroundColor: '#ff6b9d',
                                    pointBorderColor: '#1a1a1a',
                                    pointBorderWidth: 2,
                                    borderDash: [],
                                    fill: true
                                },
                                {
                                    label: 'üí∏ Net Profit - After Reclass',
                                    data: yearsWithData.map(year => plImpact[year].reclassified.netProfit),
                                    borderColor: '#ffa726',
                                    backgroundColor: 'rgba(255, 167, 38, 0.15)',
                                    borderWidth: 4,
                                    tension: 0.4,
                                    pointRadius: 7,
                                    pointHoverRadius: 10,
                                    pointBackgroundColor: '#ffa726',
                                    pointBorderColor: '#1a1a1a',
                                    pointBorderWidth: 2,
                                    borderDash: [8, 4],
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'üìä P&L Performance: Revenue, Gross & Net Profit Trends',
                                    font: {
                                        size: 20,
                                        weight: 'bold',
                                        family: "'Inter', 'Segoe UI', sans-serif"
                                    },
                                    color: colors.text,
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        color: colors.text,
                                        padding: 15,
                                        font: {
                                            size: 13,
                                            weight: '500',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 26, 0.95)',
                                    titleColor: colors.gold,
                                    bodyColor: colors.text,
                                    borderColor: '#4a9eff',
                                    borderWidth: 2,
                                    padding: 15,
                                    titleFont: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 14
                                    },
                                    callbacks: {
                                        label: function (context) {
                                            return context.dataset.label + ': ‚Çπ' + formatNumber(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: colors.grid,
                                        borderDash: [5, 5],
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'üí∞ Amount (‚Çπ)',
                                        font: {
                                            size: 14,
                                            weight: 'bold',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        color: colors.text,
                                        padding: {
                                            bottom: 15
                                        }
                                    },
                                    ticks: {
                                        color: colors.text,
                                        font: {
                                            size: 12
                                        },
                                        callback: function (value) {
                                            return '‚Çπ' + formatNumber(value);
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'üìÖ Financial Year',
                                        font: {
                                            size: 14,
                                            weight: 'bold',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        color: colors.text,
                                        padding: {
                                            top: 15
                                        }
                                    },
                                    ticks: {
                                        color: colors.text,
                                        font: {
                                            size: 13,
                                            weight: '500'
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });


                    // Apply clean light background to canvas container
                    plCtx.parentElement.style.background = '#f8f9fa';
                    plCtx.parentElement.style.padding = '30px';
                    plCtx.parentElement.style.borderRadius = '15px';
                    plCtx.parentElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    plCtx.parentElement.style.border = '1px solid #e9ecef';
                }
            }, 100);

            // Create comparison chart with CLEAN PROFESSIONAL DESIGN
            setTimeout(() => {
                const ctx = document.getElementById('reclassChart');
                if (ctx) {
                    // Clean Professional Color Palette
                    const colors = {
                        primary: '#ffffff',        // Deep Black
                        secondary: '#f8f9fa',      // Charcoal
                        accent1: '#4a9eff',        // Professional Blue
                        accent2: '#00d4aa',        // Teal Green
                        accent3: '#ff6b9d',        // Elegant Pink
                        accent4: '#ffa726',        // Sophisticated Orange
                        gold: '#ffd700',           // Luxury Gold
                        silver: '#c0c0c0',         // Premium Silver
                        text: '#333333',           // Light Gray Text
                        grid: 'rgba(0, 0, 0, 0.1)' // Subtle Grid
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: yearsWithData,
                            datasets: [
                                {
                                    label: `${categoryNames[fromCategory]} - Before`,
                                    data: yearsWithData.map(year => originalTotals[year].from || 0),
                                    backgroundColor: 'rgba(74, 158, 255, 0.85)',
                                    borderColor: colors.accent1,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(74, 158, 255, 1)',
                                    hoverBorderWidth: 3
                                },
                                {
                                    label: `${categoryNames[fromCategory]} - After`,
                                    data: yearsWithData.map(year => reclassifiedTotals[year].from || 0),
                                    backgroundColor: 'rgba(0, 212, 170, 0.85)',
                                    borderColor: colors.accent2,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(0, 212, 170, 1)',
                                    hoverBorderWidth: 3
                                },
                                {
                                    label: `${categoryNames[toCategory]} - Before`,
                                    data: yearsWithData.map(year => originalTotals[year].to || 0),
                                    backgroundColor: 'rgba(255, 107, 157, 0.85)',
                                    borderColor: colors.accent3,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(255, 107, 157, 1)',
                                    hoverBorderWidth: 3
                                },
                                {
                                    label: `${categoryNames[toCategory]} - After`,
                                    data: yearsWithData.map(year => reclassifiedTotals[year].to || 0),
                                    backgroundColor: 'rgba(255, 167, 38, 0.85)',
                                    borderColor: colors.accent4,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(255, 167, 38, 1)',
                                    hoverBorderWidth: 3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'üìä Category Movement Analysis: Before ‚Üí After Reclassification',
                                    font: {
                                        size: 20,
                                        weight: 'bold',
                                        family: "'Inter', 'Segoe UI', sans-serif"
                                    },
                                    color: colors.text,
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        color: colors.text,
                                        padding: 15,
                                        font: {
                                            size: 13,
                                            weight: '500',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'rectRounded'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 26, 0.95)',
                                    titleColor: colors.gold,
                                    bodyColor: colors.text,
                                    borderColor: colors.accent1,
                                    borderWidth: 2,
                                    padding: 15,
                                    titleFont: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 14
                                    },
                                    displayColors: true,
                                    callbacks: {
                                        label: function (context) {
                                            return context.dataset.label + ': ‚Çπ' + formatNumber(context.parsed.y);
                                        },
                                        afterLabel: function (context) {
                                            const datasetIndex = context.datasetIndex;
                                            const yearIndex = context.dataIndex;
                                            const year = yearsWithData[yearIndex];

                                            // Show the change amount
                                            if (datasetIndex === 0 || datasetIndex === 1) {
                                                // From category
                                                const original = originalTotals[year].from || 0;
                                                const after = reclassifiedTotals[year].from || 0;
                                                const change = after - original;
                                                const changePercent = original > 0 ? ((change / original) * 100).toFixed(2) : 0;
                                                return 'Change: ‚Çπ' + formatNumber(change) + ' (' + changePercent + '%)';
                                            } else {
                                                // To category
                                                const original = originalTotals[year].to || 0;
                                                const after = reclassifiedTotals[year].to || 0;
                                                const change = after - original;
                                                const changePercent = original > 0 ? ((change / original) * 100).toFixed(2) : 'N/A';
                                                return 'Change: ‚Çπ' + formatNumber(change) + ' (' + changePercent + '%)';
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    stacked: false,
                                    grid: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'üìÖ Financial Year',
                                        font: {
                                            size: 14,
                                            weight: 'bold',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        color: colors.text,
                                        padding: {
                                            top: 15
                                        }
                                    },
                                    ticks: {
                                        color: colors.text,
                                        font: {
                                            size: 13,
                                            weight: '500'
                                        }
                                    }
                                },
                                y: {
                                    stacked: false,
                                    beginAtZero: true,
                                    grid: {
                                        color: colors.grid,
                                        borderDash: [5, 5],
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'üí∞ Amount (‚Çπ)',
                                        font: {
                                            size: 14,
                                            weight: 'bold',
                                            family: "'Inter', 'Segoe UI', sans-serif"
                                        },
                                        color: colors.text,
                                        padding: {
                                            bottom: 15
                                        }
                                    },
                                    ticks: {
                                        color: colors.text,
                                        font: {
                                            size: 12
                                        },
                                        callback: function (value) {
                                            return '‚Çπ' + formatNumber(value);
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });


                    // Apply clean light background to canvas container
                    ctx.parentElement.style.background = '#f8f9fa';
                    ctx.parentElement.style.padding = '30px';
                    ctx.parentElement.style.borderRadius = '15px';
                    ctx.parentElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    ctx.parentElement.style.border = '1px solid #e9ecef';
                }
            }, 150);
        }

        // Expose functions globally
        window.updateLineItemSelector = updateLineItemSelector;
        window.toggleDeepDiveItem = toggleDeepDiveItem;
        window.performDeepDive = performDeepDive;
        window.loadLineItemsForReclassification = loadLineItemsForReclassification;
        window.toggleLineItem = toggleLineItem;
        window.performReclassification = performReclassification;

        // Expose generateAnalysis globally for the button
        window.generateAnalysis = generateAnalysis;
        window.populateLineItems = populateLineItems;
        window.generateCustomAnalysis = generateCustomAnalysis;



        /* --- THE BRAIN --- */
        const sumItems = (arr) => (Array.isArray(arr) ? arr.reduce((s, i) => s + (parseFloat(i.value) || 0), 0) : 0);

        function resolveMetricValue(id, year) {
            const d = window.financialData.data[year];
            if (!d) return 0;
            const p = id.split(':');
            if (p[0] === 'item') return (d[p[1]] || []).find(i => i.name === p[2])?.value || 0;
            if (p[0] === 'category') return sumItems(d[p[1]]);
            if (p[0] === 'derived') {
                if (p[1] === 'ebitda') return (sumItems(d.revenue) + sumItems(d.otherIncome)) - (resolveMetricValue('derived:cogs', year) + sumItems(d.indirectExpenses));
                if (p[1] === 'net_profit') return resolveMetricValue('derived:ebitda', year) - (sumItems(d.depreciation) + sumItems(d.financeCosts) + sumItems(d.taxExpenses));
                if (p[1] === 'cogs') {
                    const dr = d.directExpenses || [];
                    return (parseFloat(dr.find(i => i.name === 'Opening Stock')?.value || 0) + dr.filter(i => !['Opening Stock', 'Closing Stock'].includes(i.name)).reduce((s, i) => s + (parseFloat(i.value) || 0), 0)) - parseFloat(dr.find(i => i.name === 'Closing Stock')?.value || 0);
                }
            }
            return 0;
        }

        /* --- THE ENGINE --- */
        function runQuery() {
            const selA = Array.from(document.querySelectorAll('#list_a input:checked')).map(i => i.value);
            const selB = Array.from(document.querySelectorAll('#list_b input:checked')).map(i => i.value);
            const ops = Array.from(document.querySelectorAll('#list_op input:checked')).map(i => i.value);
            const yrs = Array.from(document.querySelectorAll('#list_time input:checked')).map(i => i.value).sort();
            const views = Array.from(document.querySelectorAll('#list_view input:checked')).map(i => i.value);

            const out = document.getElementById('queryResultsOutput');
            out.innerHTML = '';

            ops.forEach(op => {
                let datasets = [];
                if (!selB.length) {
                    // Single metric analysis
                    selA.forEach((id, idx) => {
                        const metricLabel = id.split(':').pop();
                        let data;

                        if (op === 'growth') {
                            // Calculate year-over-year growth percentage
                            data = yrs.map((y, yIdx) => {
                                if (yIdx === 0) return null;  // No growth for first year
                                const current = resolveMetricValue(id, y);
                                const previous = resolveMetricValue(id, yrs[yIdx - 1]);
                                return previous > 0 ? ((current - previous) / previous) * 100 : 0;
                            });
                        } else {
                            // Raw value
                            data = yrs.map(y => resolveMetricValue(id, y));
                        }

                        datasets.push({
                            label: metricLabel,
                            data: data,
                            borderColor: getDynamicColor(idx),
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        });
                    });
                } else {
                    // Comparison analysis (List A vs List B)
                    const data = yrs.map((y, yIdx) => {
                        const a = selA.reduce((s, id) => s + resolveMetricValue(id, y), 0);
                        const b = selB.reduce((s, id) => s + resolveMetricValue(id, y), 0);

                        if (op === 'growth') {
                            // Growth between two metrics
                            if (yIdx === 0) return null;
                            const prevA = selA.reduce((s, id) => s + resolveMetricValue(id, yrs[yIdx - 1]), 0);
                            const prevB = selB.reduce((s, id) => s + resolveMetricValue(id, yrs[yIdx - 1]), 0);
                            const curr = b ? a / b : 0;
                            const prev = prevB ? prevA / prevB : 0;
                            return prev > 0 ? ((curr - prev) / prev) * 100 : 0;
                        } else if (op === 'ratio') {
                            return b ? a / b : 0;
                        } else {
                            // contribution
                            return b ? (a / b) * 100 : 0;
                        }
                    });

                    datasets.push({
                        label: `${op.toUpperCase()} Analysis`,
                        data: data,
                        borderColor: '#667eea',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    });
                }
                views.forEach(v => renderDynamicOutput(yrs, datasets, v, op, out));
            });
        }

        function renderDynamicOutput(yrs, ds, view, op, container) {
            const wrap = document.createElement('div');
            wrap.className = 'chart-card';

            if (view.includes('chart')) {
                const can = document.createElement('canvas');
                wrap.appendChild(can);

                // Determine chart type based on view parameter
                let chartType = 'line';
                if (view === 'chart_bar') {
                    chartType = 'bar';
                } else if (view === 'chart_line') {
                    chartType = 'line';
                }

                // Format datasets for better display
                const formattedDatasets = ds.map((d, idx) => ({
                    label: d.label,
                    data: d.data,
                    borderColor: d.borderColor || getDynamicColor(idx),
                    backgroundColor: chartType === 'bar'
                        ? (d.borderColor || getDynamicColor(idx)) + '33'
                        : undefined,
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2
                }));

                new Chart(can, {
                    type: chartType,
                    data: {
                        labels: yrs,
                        datasets: formattedDatasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } else if (view === 'table') {
                let h = `<table style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #f0f0f0;">
                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Metric</th>
                        ${yrs.map(y => `<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">${y}</th>`).join('')}
                    </tr>`;
                ds.forEach(d => {
                    h += `<tr><td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">${d.label}</td>`;
                    d.data.forEach(v => {
                        let formatted = '';
                        if (v === null || v === undefined) {
                            formatted = '-';
                        } else if (typeof v === 'number') {
                            // Check if this is a growth percentage
                            if (op === 'growth') {
                                const color = v >= 0 ? '#28a745' : '#dc3545';
                                formatted = `<span style="color: ${color}; font-weight: 500;">${v >= 0 ? '+' : ''}${v.toFixed(2)}%</span>`;
                            } else if (op === 'contribution') {
                                formatted = `${v.toFixed(2)}%`;
                            } else if (op === 'ratio') {
                                formatted = v.toFixed(4);
                            } else {
                                formatted = v % 1 === 0 ? v.toLocaleString() : v.toFixed(2).toLocaleString();
                            }
                        } else {
                            formatted = v;
                        }
                        h += `<td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatted}</td>`;
                    });
                    h += `</tr>`;
                });
                h += `</table>`;
                wrap.innerHTML = h;
            }
            container.appendChild(wrap);
        }

        function getDynamicColor(i) { return ['#8b1a1a', '#630d0d', '#a52a2a', '#c92a2a', '#e03131'][i % 5]; }

        function filterCheckboxes(id, q) {
            document.getElementById(id).querySelectorAll('.qb-item-row').forEach(r => {
                r.style.display = r.getAttribute('data-label').includes(q.toLowerCase()) ? 'block' : 'none';
            });
        }

        // ===== RATIO ANALYSIS FUNCTIONS =====
        const ratioDefinitions = {
            'Current Ratio': { numerator: 'currentAssets', denominator: 'currentLiabilities', category: 'Liquidity' },
            'Quick Ratio': { numerator: 'quickAssets', denominator: 'currentLiabilities', category: 'Liquidity', custom: true },
            'Debt-to-Equity': { numerator: 'totalLiabilities', denominator: 'totalEquity', category: 'Leverage', custom: true },
            'Debt-to-Assets': { numerator: 'totalLiabilities', denominator: 'totalAssets', category: 'Leverage', custom: true },
            'Equity Ratio': { numerator: 'totalEquity', denominator: 'totalAssets', category: 'Leverage', custom: true },
            'Gross Profit Margin': { numerator: 'grossProfit', denominator: 'revenue', category: 'Profitability', custom: true },
            'Operating Profit Margin': { numerator: 'ebitda', denominator: 'revenue', category: 'Profitability', custom: true },
            'Net Profit Margin': { numerator: 'netProfit', denominator: 'revenue', category: 'Profitability', custom: true },
            'ROE (Return on Equity)': { numerator: 'netProfit', denominator: 'totalEquity', category: 'Profitability', custom: true },
            'ROA (Return on Assets)': { numerator: 'netProfit', denominator: 'totalAssets', category: 'Profitability', custom: true },
            'Asset Turnover': { numerator: 'revenue', denominator: 'totalAssets', category: 'Efficiency', custom: true },
            'Inventory Turnover': { numerator: 'cogs', denominator: 'avgInventory', category: 'Efficiency', custom: true }
        };

        function calculateRatio(ratioName, year) {
            const data = window.financialData.data[year];
            if (!data) return 0;

            const def = ratioDefinitions[ratioName];
            if (!def) return 0;

            let numerator = 0, denominator = 0;

            // Helper to sum array values
            const sumArray = (arr) => Array.isArray(arr) ? arr.reduce((s, i) => s + (parseFloat(i.value) || 0), 0) : 0;

            // Calculate based on ratio definition
            switch (def.numerator) {
                case 'currentAssets': numerator = sumArray(data.currentAssets); break;
                case 'quickAssets': numerator = sumArray(data.currentAssets) - (data.directExpenses?.find(i => i.name === 'Closing Stock')?.value || 0); break;
                case 'totalLiabilities': numerator = sumArray(data.currentLiabilities) + sumArray(data.nonCurrentLiabilities); break;
                case 'totalAssets': numerator = sumArray(data.currentAssets) + sumArray(data.fixedAssetsTangible) + sumArray(data.intangibleAssets) + sumArray(data.otherNonCurrentAssets); break;
                case 'totalEquity': numerator = sumArray(data.equity) + sumArray(data.reserves); break;
                case 'grossProfit': numerator = sumArray(data.revenue) - (parseFloat(data.directExpenses?.find(i => i.name === 'Opening Stock')?.value || 0) + sumArray(data.directExpenses.filter(i => !['Opening Stock', 'Closing Stock'].includes(i.name))) - parseFloat(data.directExpenses?.find(i => i.name === 'Closing Stock')?.value || 0)); break;
                case 'ebitda': numerator = sumArray(data.revenue) + sumArray(data.otherIncome) - sumArray(data.directExpenses) - sumArray(data.indirectExpenses); break;
                case 'netProfit': numerator = sumArray(data.revenue) + sumArray(data.otherIncome) - sumArray(data.directExpenses) - sumArray(data.indirectExpenses) - sumArray(data.depreciation) - sumArray(data.financeCosts) - sumArray(data.taxExpenses); break;
                case 'revenue': numerator = sumArray(data.revenue); break;
                case 'cogs': numerator = parseFloat(data.directExpenses?.find(i => i.name === 'Opening Stock')?.value || 0) + sumArray(data.directExpenses.filter(i => !['Opening Stock', 'Closing Stock'].includes(i.name))) - parseFloat(data.directExpenses?.find(i => i.name === 'Closing Stock')?.value || 0); break;
            }

            switch (def.denominator) {
                case 'currentLiabilities': denominator = sumArray(data.currentLiabilities); break;
                case 'totalLiabilities': denominator = sumArray(data.currentLiabilities) + sumArray(data.nonCurrentLiabilities); break;
                case 'totalEquity': denominator = sumArray(data.equity) + sumArray(data.reserves); break;
                case 'totalAssets': denominator = sumArray(data.currentAssets) + sumArray(data.fixedAssetsTangible) + sumArray(data.intangibleAssets) + sumArray(data.otherNonCurrentAssets); break;
                case 'revenue': denominator = sumArray(data.revenue); break;
                case 'avgInventory': denominator = parseFloat(data.directExpenses?.find(i => i.name === 'Closing Stock')?.value || 0); break;
            }

            return denominator !== 0 ? parseFloat((numerator / denominator).toFixed(4)) : 0;
        }

        function initRatioLists() {
            // Populate ratio list
            const ratioDiv = document.getElementById('ratioList');
            if (ratioDiv) {
                const categories = {};
                Object.keys(ratioDefinitions).forEach(ratioName => {
                    const cat = ratioDefinitions[ratioName].category;
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(ratioName);
                });

                let html = '';
                Object.entries(categories).forEach(([cat, ratios]) => {
                    html += `<div style="font-weight: bold; padding: 8px 5px; background: #fdecec; margin-top: 5px; color: #8b1a1a;">${cat}</div>`;
                    ratios.forEach(ratio => {
                        html += `<div style="padding: 5px; border-bottom: 1px solid #eee;">
                    <label><input type="checkbox" value="${ratio}" class="ratio-checkbox"> ${ratio}</label>
                </div>`;
                    });
                });
                ratioDiv.innerHTML = html;
            }

            // Populate year list
            const yearDiv = document.getElementById('ratioYearsList');
            if (yearDiv) {
                const years = window.financialData.years || [];
                yearDiv.innerHTML = years.map(year =>
                    `<div style="padding: 5px; border-bottom: 1px solid #eee;">
                <label><input type="checkbox" value="${year}" class="ratio-year-checkbox" checked> ${year}</label>
            </div>`
                ).join('');
            }
        }

        function filterRatios(query) {
            document.querySelectorAll('#ratioList .ratio-checkbox').forEach(cb => {
                const label = cb.nextElementSibling?.textContent || '';
                cb.closest('div').style.display = label.toLowerCase().includes(query.toLowerCase()) ? 'block' : 'none';
            });
        }

        function runRatioAnalysis() {
            const selectedRatios = Array.from(document.querySelectorAll('#ratioList .ratio-checkbox:checked')).map(cb => cb.value);
            const selectedYears = Array.from(document.querySelectorAll('#ratioYearsList .ratio-year-checkbox:checked')).map(cb => cb.value);
            const viewTypes = Array.from(document.querySelectorAll('#ratioAnalysisContainer input[type="checkbox"][value^="ratio_"]:checked')).map(cb => cb.value);
            const displayMode = document.querySelector('#ratioAnalysisContainer input[type="checkbox"][value="compare_years"]:checked') ? 'compare_years' : 'all_ratios';

            if (selectedRatios.length === 0) {
                alert('Please select at least one ratio');
                return;
            }
            if (selectedYears.length === 0) {
                alert('Please select at least one year');
                return;
            }

            const output = document.getElementById('ratioResultsOutput');
            output.innerHTML = '';

            if (displayMode === 'compare_years') {
                // Compare Years Side-by-Side: One ratio at a time, multiple years
                selectedRatios.forEach((ratio, ratioIdx) => {
                    const datasets = [{
                        label: ratio,
                        data: selectedYears.map(year => calculateRatio(ratio, year)),
                        borderColor: getDynamicColor(ratioIdx),
                        backgroundColor: getDynamicColor(ratioIdx) + '33',
                        fill: false,
                        tension: 0.4
                    }];

                    viewTypes.forEach(view => {
                        renderRatioOutput(selectedYears, datasets, [ratio], view, output, `${ratio} - Across Years`);
                    });
                });
            } else {
                // All Selected: Multiple ratios, multiple years
                const datasets = selectedRatios.map((ratio, idx) => ({
                    label: ratio,
                    data: selectedYears.map(year => calculateRatio(ratio, year)),
                    borderColor: getDynamicColor(idx),
                    backgroundColor: getDynamicColor(idx) + '33',
                    fill: false,
                    tension: 0.4
                }));

                viewTypes.forEach(view => {
                    renderRatioOutput(selectedYears, datasets, selectedRatios, view, output, 'All Selected Ratios');
                });
            }
        }

        function renderRatioOutput(years, datasets, ratios, viewType, container, title = '') {
            const wrap = document.createElement('div');
            wrap.className = 'chart-card';

            if (title) {
                const titleEl = document.createElement('h3');
                titleEl.textContent = title;
                titleEl.style.cssText = 'margin-top: 0; color: #8b1a1a; text-align: center;';
                wrap.appendChild(titleEl);
            }

            if (viewType === 'ratio_line') {
                const can = document.createElement('canvas');
                wrap.appendChild(can);
                new Chart(can, {
                    type: 'line',
                    data: { labels: years, datasets: datasets },
                    options: { responsive: true, plugins: { legend: { position: 'top' } } }
                });
            } else if (viewType === 'ratio_bar') {
                const can = document.createElement('canvas');
                wrap.appendChild(can);
                new Chart(can, {
                    type: 'bar',
                    data: { labels: years, datasets: datasets },
                    options: { responsive: true, plugins: { legend: { position: 'top' } } }
                });
            } else if (viewType === 'ratio_table') {
                let h = `<table style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #fdecec; color: #8b1a1a;">
                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Ratio</th>
                        ${years.map(y => `<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">${y}</th>`).join('')}
                    </tr>`;
                ratios.forEach((ratio, idx) => {
                    h += `<tr><td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">${ratio}</td>`;
                    datasets[idx].data.forEach(val => {
                        h += `<td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${val.toFixed(4)}</td>`;
                    });
                    h += `</tr>`;
                });
                h += `</table>`;
                wrap.innerHTML = h;
            }

            container.appendChild(wrap);
        }

        /* --- PHASE 1: INITIALIZATION --- */
        function initQueryBuilder() {
            const fd = window.financialData;
            if (!fd || !fd.data) {
                console.warn('financialData not ready');
                return;
            }

            // Get years with data, sorted chronologically
            const yearsWithData = Object.keys(fd.data)
                .filter(y => fd.data[y] && Object.values(fd.data[y]).some(v =>
                    Array.isArray(v) ? v.some(i => parseFloat(i.value) > 0) : parseFloat(v) > 0
                ))
                .sort((a, b) => {
                    const yearA = parseInt(a.toString().match(/\d{4}/)?.[0] || '0');
                    const yearB = parseInt(b.toString().match(/\d{4}/)?.[0] || '0');
                    return yearA - yearB;
                });

            // Populate Timeframe checkboxes (list_time)
            const timeDiv = document.getElementById('list_time');
            if (timeDiv) {
                timeDiv.innerHTML = yearsWithData.map(year =>
                    `<div class="qb-item-row" data-label="${year.toLowerCase()}">
                <label><input type="checkbox" value="${year}"> ${year}</label>
            </div>`
                ).join('');
            }

            // Build hierarchical metric structure for Box A & B
            const items = [];
            const data = fd.data[yearsWithData[0]] || {};

            // Helper to add category with line items
            const addCategory = (emoji, name, categoryKey, items) => {
                items.push({ category: emoji + ' ' + name, level: 1 });
                if (data[categoryKey] && Array.isArray(data[categoryKey])) {
                    data[categoryKey].forEach(item => {
                        items.push({ label: '‚Ü≥ ' + item.name, id: `item:${categoryKey}:${item.name}`, level: 2 });
                    });
                }
            };

            // Add all asset categories
            items.push({ category: 'üìä NON-CURRENT ASSETS', level: 1 });
            addCategory('', 'Fixed Assets (Net)', 'fixedAssetsTangible', items);
            addCategory('', 'Intangible Assets (Net)', 'intangibleAssets', items);
            addCategory('', 'Other Non-Current Assets', 'otherNonCurrentAssets', items);

            // Add current assets
            items.push({ category: 'üìä CURRENT ASSETS', level: 1 });
            addCategory('', 'Current Assets', 'currentAssets', items);

            // Add equity and reserves
            items.push({ category: 'üí∞ EQUITY & RESERVES', level: 1 });
            addCategory('', 'Equity', 'equity', items);
            addCategory('', 'Reserves & Surplus', 'reserves', items);

            // Add liabilities
            items.push({ category: 'üìå LIABILITIES', level: 1 });
            addCategory('', 'Non-Current Liabilities', 'nonCurrentLiabilities', items);
            addCategory('', 'Current Liabilities', 'currentLiabilities', items);

            // Add income and expenses
            items.push({ category: 'üíµ INCOME & EXPENSES', level: 1 });
            addCategory('', 'Revenue', 'revenue', items);
            addCategory('', 'Other Income', 'otherIncome', items);
            addCategory('', 'Direct Expenses (COGS)', 'directExpenses', items);
            addCategory('', 'Indirect Expenses', 'indirectExpenses', items);
            addCategory('', 'Finance Costs', 'financeCosts', items);
            addCategory('', 'Depreciation & Amortization', 'depreciation', items);
            addCategory('', 'Tax Expenses', 'taxExpenses', items);

            // Add derived metrics
            items.push({ category: 'üéØ DERIVED METRICS', level: 1 });
            items.push({ label: '‚Ü≥ Gross Profit', id: 'derived:gross_profit', level: 2 });
            items.push({ label: '‚Ü≥ EBITDA', id: 'derived:ebitda', level: 2 });
            items.push({ label: '‚Ü≥ Net Profit', id: 'derived:net_profit', level: 2 });

            // Populate both list_a and list_b with same items
            ['list_a', 'list_b'].forEach(listId => {
                const div = document.getElementById(listId);
                if (div) {
                    div.innerHTML = items.map(item => {
                        if (item.category) {
                            return `<div class="qb-category" data-label="${item.category.toLowerCase()}" style="font-weight: bold; padding: 8px 5px; background: #f0f0f0; margin-top: 5px;">${item.category}</div>`;
                        } else {
                            return `<div class="qb-item-row" data-label="${item.label.toLowerCase()}">
                        <label><input type="checkbox" value="${item.id}"> ${item.label}</label>
                    </div>`;
                        }
                    }).join('');
                }
            });

            // Populate Operations (list_op)
            const opDiv = document.getElementById('list_op');
            if (opDiv) {
                opDiv.innerHTML = [
                    { id: 'value', label: 'üìä Raw Value' },
                    { id: 'growth', label: 'üìà Growth %' },
                    { id: 'contribution', label: 'üéØ Contribution %' }
                ].map(op =>
                    `<div class="qb-item-row" data-label="${op.label.toLowerCase()}">
                <label><input type="checkbox" value="${op.id}"> ${op.label}</label>
            </div>`
                ).join('');
            }

            // Populate Views (list_view)
            const viewDiv = document.getElementById('list_view');
            if (viewDiv) {
                viewDiv.innerHTML = [
                    { id: 'chart_line', label: 'üìâ Line Chart' },
                    { id: 'chart_bar', label: 'üìä Bar Chart' },
                    { id: 'table', label: 'üìã Data Table' }
                ].map(view =>
                    `<div class="qb-item-row" data-label="${view.label.toLowerCase()}">
                <label><input type="checkbox" value="${view.id}"> ${view.label}</label>
            </div>`
                ).join('');
            }

            console.log('Query Builder initialized with', yearsWithData.length, 'years');
        }

        // Expose Query Builder functions globally
        window.runQuery = runQuery;
        window.filterCheckboxes = filterCheckboxes;
        window.initQueryBuilder = initQueryBuilder;
        // window.financialData already created above - DON'T OVERWRITE IT!

        function wait(cb) { if (window.fbready) cb(); else setTimeout(() => wait(cb), 100); }
        wait(() => {
            window.fb.onAuthStateChanged(window.auth, u => {
                user = u;
                if (u) {
                    uname = u.email.split('@')[0];  // ‚Üê ADD THIS LINE to set username
                    showDash();
                } else if (localStorage.getItem('verified') === '1') {
                    showLogin();
                }
            });
            if (localStorage.getItem('verified') === '1') {
                document.getElementById('screen1').classList.remove('show');
                document.getElementById('screen2').classList.add('show');
            }
        });


        function checkCode() {
            if (document.getElementById('codeinput').value.trim() === CODE) {
                localStorage.setItem('verified', '1');
                document.getElementById('screen1').classList.remove('show');
                document.getElementById('screen2').classList.add('show');
            } else {
                const e = document.getElementById('err1');
                e.textContent = 'Invalid code';
                e.classList.add('show');
            }
        }

        function toggleAuth() {
            signup = !signup;
            document.getElementById('authbtn').textContent = signup ? 'Sign Up' : 'Sign In';
            document.getElementById('authtitle').textContent = signup ? 'Create account' : 'Sign in';
            document.getElementById('namebox').style.display = signup ? 'block' : 'none';
            document.getElementById('togglelink').innerHTML = signup ? 'Have account? <a onclick="toggleAuth()">Sign In</a>' : 'Don\'t have account? <a onclick="toggleAuth()">Sign Up</a>';
        }

        async function doAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value, pass = document.getElementById('pass').value, name = document.getElementById('name').value;
            const btn = document.getElementById('authbtn'), err = document.getElementById('err2');
            btn.disabled = true;
            btn.textContent = signup ? 'Creating...' : 'Signing in...';
            err.classList.remove('show');
            try {
                if (signup) {
                    const c = await window.fb.createUserWithEmailAndPassword(window.auth, email, pass);
                    await window.fb.set(window.fb.ref(window.db, 'users/' + c.user.uid + '/profile'), { name: name || email.split('@')[0], email: email, created: new Date().toISOString() });
                } else {
                    await window.fb.signInWithEmailAndPassword(window.auth, email, pass);
                }
            } catch (x) {
                err.textContent = x.message;
                err.classList.add('show');
                btn.disabled = false;
                btn.textContent = signup ? 'Sign Up' : 'Sign In';
            }
        }

        function showLogin() {
            document.getElementById('screen1').classList.remove('show');
            document.getElementById('screen2').classList.add('show');
            document.getElementById('screen3').classList.remove('show');
        }

        async function showDash() {
            document.getElementById('screen2').classList.remove('show');
            document.getElementById('screen3').classList.add('show');
            const snap = await window.fb.get(window.fb.ref(window.db, 'users/' + user.uid + '/profile'));
            uname = (snap.val() || {}).name || user.email;
            document.getElementById('userinfo').textContent = 'Logged in as: ' + uname;
            loadProjects();
        }

        async function loadProjects() {
            const sh = await window.fb.get(window.fb.ref(window.db, 'shared'));
            const shared = sh.val() || {};
            const pr = await window.fb.get(window.fb.ref(window.db, 'users/' + user.uid + '/private'));
            const priv = pr.val() || {};

            const all = [];
            Object.keys(shared).forEach(k => all.push({ id: k, data: shared[k], private: false }));
            Object.keys(priv).forEach(k => all.push({ id: k, data: priv[k], private: true }));

            const list = document.getElementById('projectlist');
            if (all.length === 0) {
                list.innerHTML = '<p style="color:#fff;text-align:center;padding:40px;grid-column:1/-1;">No projects yet</p>';
                return;
            }

            all.sort((a, b) => new Date(b.data.lastModified) - new Date(a.data.lastModified));

            list.innerHTML = '';
            all.forEach(p => {
                const types = { private_limited: 'Private Ltd', partnership: 'Partnership', llp: 'LLP', proprietorship: 'Proprietorship' };
                const div = document.createElement('div');
                div.className = 'cloudcard';
                div.innerHTML = '<h3>' + p.data.companyName + '</h3>' +
                    '<div class="cloudmeta">' +
                    '<div><b>Type:</b> ' + (types[p.data.companyType] || p.data.companyType) + '</div>' +
                    '<div><b>Created:</b> ' + new Date(p.data.createdAt).toLocaleDateString() + ' by ' + p.data.createdBy + '</div>' +
                    '<div><b>Modified:</b> ' + new Date(p.data.lastModified).toLocaleDateString() + '</div>' +
                    '<div><b>Last edit:</b> ' + p.data.lastModifiedBy + '</div>' +
                    '</div>' +
                    '<span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-top:8px;background:' + (p.private ? '#fff3cd' : '#d1ecf1') + ';color:' + (p.private ? '#856404' : '#0c5460') + ';">' + (p.private ? 'üîí Private' : 'üåê Shared') + '</span>';

                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.gap = '10px';
                btnContainer.style.marginTop = '15px';

                const btn = document.createElement('button');
                btn.className = 'openbtn';
                btn.textContent = 'üìù Open & Enter Data';
                btn.style.flex = '1';
                btn.onclick = function () { openProject(p.id, p.private); };

                const delBtn = document.createElement('button');
                delBtn.className = 'deletebtn';
                delBtn.textContent = 'üóëÔ∏è';

                // üü¢ FIX 1: Close the onclick function properly
                delBtn.onclick = function (e) {
                    e.stopPropagation();
                    window.deleteProject(p.id, p.private, p.data.companyName);
                };

                btnContainer.appendChild(btn);
                btnContainer.appendChild(delBtn);
                div.appendChild(btnContainer);
                list.appendChild(div);
            }); // üü¢ FIX 2: Close the all.forEach loop
        } // üü¢ FIX 3: Close the async function loadProjects

        function showNew() { document.getElementById('newform').style.display = 'block'; }
        function hideNew() { document.getElementById('newform').style.display = 'none'; }

        async function createProject() {
            const name = document.getElementById('projname').value.trim(), type = document.getElementById('projtype').value, prv = document.getElementById('projpriv').checked;
            if (!name) { alert('Enter company name'); return; }
            const path = prv ? 'users/' + user.uid + '/private' : 'shared';
            const ref = window.fb.push(window.fb.ref(window.db, path));
            const year = new Date().getFullYear(), data = {};
            for (let i = year - 2; i <= year + 2; i++) {
                data[i] = { fixedAssetsTangible: [], intangibleAssets: [], otherNonCurrentAssets: [], currentAssets: [], nonCurrentLiabilities: [], currentLiabilities: [], shareCapital: { noOfEquityIssued: 0, faceValueEquity: 0, noOfPrefIssued: 0, faceValuePref: 0 }, reserves: [], equity: [], revenue: [], otherIncome: [], directExpenses: [], indirectExpenses: [], financeCosts: [], depreciation: [], taxExpenses: [], cumulativeDepreciation: 0, cumulativeAmortization: 0, notes: '' };
            }
            await window.fb.set(ref, { companyName: name, companyType: type, createdAt: new Date().toISOString(), createdBy: uname, lastModified: new Date().toISOString(), lastModifiedBy: uname, data: data });
            hideNew();
            loadProjects();
        }
        window.syncFSAStateToCloud = async function () {
            if (!window.currentCloudId) return;

            // Show visual feedback (Syncing...)
            const lastSavedEl = document.getElementById('lastSavedIndicator');
            if (lastSavedEl) lastSavedEl.innerHTML = '<span>‚è≥ Syncing to Cloud...</span>';

            const currentUser = window.auth.currentUser;
            const isPrivate = window.ispriv;
            const path = isPrivate && currentUser ?
                'users/' + currentUser.uid + '/private/' + window.currentCloudId :
                'shared/' + window.currentCloudId;

            // THE PAYLOAD: This tells the cloud EXACTLY what the state is
            const payload = {
                companyName: window.financialData.companyName || '',
                companyType: window.financialData.companyType || 'private_limited',
                fsaData: window.financialData.data,       // The actual numbers
                years: window.financialData.years,         // The Master List
                selectedYearsForEntry: window.financialData.selectedYearsForEntry, // The Checkboxes
                multiYearMode: window.financialData.multiYearMode,
                lastModified: new Date().toISOString(),
                lastModifiedBy: currentUser?.email?.split('@')[0] || 'User'
            };

            try {
                // We use set(ref, payload) instead of update() to ensure the cloud 
                // matches our local data exactly (Overwrites the old years)
                await window.fb.set(window.fb.ref(window.db, path), payload);

                if (lastSavedEl) lastSavedEl.innerHTML = '<span>‚úÖ Cloud Sync Successful</span>';
                console.log("‚òÅÔ∏è FSA Cloud State Updated Successfully.");
            } catch (e) {
                console.error("‚ùå Cloud Sync Failed:", e);
                if (lastSavedEl) lastSavedEl.innerHTML = '<span style="color:red">‚ùå Sync Failed</span>';
            }
        };
        async function loadFSAData(id, prv) {
            console.log('=== üîÑ FINAL SMART LOAD:', id, '===');

            // 0. UI WIPE: Physically clear previous table rows from the screen
            // This ensures old "FY 2022-23" rows aren't just sitting in the DOM
            const containers = ['fixedAssetsTangible', 'intangibleAssets', 'otherNonCurrentAssets', 'currentAssets', 'revenue', 'directExpenses', 'indirectExpenses'];
            containers.forEach(cid => {
                const el = document.getElementById(cid);
                if (el) el.innerHTML = '';
            });

            try {
                const currentUser = window.auth.currentUser;
                const path = prv && currentUser ? 'users/' + currentUser.uid + '/private/' + id : 'shared/' + id;
                const snap = await window.fb.get(window.fb.ref(window.db, path));
                const proj = snap.val() || {};

                window.currentCloudId = id;

                // 1. DATA RECOVERY
                let rawFsa = proj.fsaData || {};
                const incomingData = (rawFsa.data && typeof rawFsa.data === 'object') ? rawFsa.data : rawFsa;

                // 2. STRICT MASTER LIST: Don't let old 'rawFsa.years' overwrite a clean 'proj.years'
                // If 'proj.years' exists, it is the master. We only check rawFsa as a last resort.
                let cloudYears = [];
                if (proj.years && Array.isArray(proj.years)) {
                    cloudYears = proj.years;
                } else if (rawFsa.years && Array.isArray(rawFsa.years)) {
                    cloudYears = rawFsa.years;
                }

                // Final filter to ensure no garbage keys got in
                cloudYears = cloudYears.filter(y => typeof y === 'string' && y.startsWith('FY '));

                if (cloudYears.length === 0) {
                    cloudYears = ['FY 2023-24', 'FY 2024-25'];
                }

                console.log("‚òÅÔ∏è Master Year List from Cloud:", cloudYears);
                window.financialData.years = cloudYears;

                // 3. SCRUB DATA: Only keep keys that exist in our Master Year List
                const cleanData = {};
                cloudYears.forEach(year => {
                    if (incomingData[year]) {
                        cleanData[year] = incomingData[year];
                    }
                });
                window.financialData.data = cleanData;

                // 4. RESTORE METADATA
                window.financialData.companyName = proj.companyName || rawFsa.companyName || '';
                window.financialData.companyType = proj.companyType || rawFsa.companyType || 'private_limited';

                // 5. RESTORE SELECTION
                window.financialData.multiYearMode = proj.multiYearMode || false;

                // FILTER SELECTION: If a selected year was deleted from master, remove it from selection too
                let savedSelection = proj.selectedYearsForEntry || [];
                window.financialData.selectedYearsForEntry = savedSelection.filter(y => cloudYears.includes(y));

                if (window.financialData.selectedYearsForEntry.length === 0) {
                    window.financialData.selectedYearsForEntry = [cloudYears[0]];
                }

                window.financialData.currentYear = proj.currentYear || cloudYears[0];

                // 6. SYNC UI ELEMENTS
                const multiToggle = document.getElementById('multiYearMode');
                if (multiToggle) multiToggle.checked = window.financialData.multiYearMode;

                const selectorDiv = document.getElementById('yearColumnsSelector');
                if (selectorDiv) {
                    selectorDiv.style.display = window.financialData.multiYearMode ? 'block' : 'none';
                }

                // 7. RENDER
                ensureAllYearsInitialized();
                document.getElementById('mainapp').style.display = 'block';
                if (document.getElementById('companyName')) {
                    document.getElementById('companyName').value = window.financialData.companyName;
                }

                if (window.financialData.multiYearMode) {
                    if (typeof initYearColumnsSelector === 'function') initYearColumnsSelector();
                } else {
                    if (typeof initYearSelector === 'function') initYearSelector();
                }

                renderAllInputs();
                console.log("‚úÖ LOAD SUCCESSFUL: Master sync complete.");
            } catch (e) {
                console.error("‚ùå LOAD FAILED:", e);
            }
        }
        function setupSync() {
            if (!pid || !user) return;

            // Clean up existing listener
            if (syncListener) {
                syncListener();
                syncListener = null;
            }

            const path = ispriv ? 'users/' + user.uid + '/private/' + pid : 'shared/' + pid;
            const projectRef = window.fb.ref(window.db, path);

            let isFirstLoad = true;
            let lastSyncTime = Date.now();
            syncListener = window.fb.onValue(projectRef, (snapshot) => {
                if (isFirstLoad) {
                    isFirstLoad = false;
                    return;
                }

                if (isSyncing) {
                    console.log('Skipping - currently syncing');
                    return;
                }
                const now = Date.now();
                if (now - lastSyncTime < 2000) {
                    console.log('‚è≠Ô∏è Skipping - too soon after last sync');
                    return;
                }
                lastSyncTime = now;

                const data = snapshot.val();
                if (!data) return;

                console.log('Detected remote changes from:', data.lastModifiedBy);
                if (data.lastModifiedBy === uname) {
                    console.log('‚è≠Ô∏è Skipping - this is my own change');
                    return;
                }

                window.financialData.companyName = data.companyName;
                window.financialData.companyType = data.companyType;
                window.financialData.data = data.fsaData || {};

                // Reconstruct years array - use saved years or extract valid ones from data
                if (data.years && Array.isArray(data.years) && data.years.length > 0) {
                    window.financialData.years = data.years;
                } else {
                    // Extract years from data keys that match proper FY format
                    const validYears = Object.keys(data.fsaData).filter(key =>
                        /^FY \d{4}-\d{2}$/.test(key)
                    ).sort();

                    // If no valid years found, use base years
                    window.financialData.years = validYears.length > 0 ? validYears : generateFinancialYears();
                }
                window.financialData.customInsights = data.customInsights || '';
                window.financialData.attachments = data.attachments || [];
                window.financialData.multiYearMode = data.multiYearMode || false;
                window.financialData.selectedYearsForEntry = data.selectedYearsForEntry || [];
                window.financialData.currentYear = data.currentYear || new Date().getFullYear();

                // Ensure all years have properly initialized data structures
                ensureAllYearsInitialized();

                initYearSelector();
                updateYearRangeDisplay();
                renderAllInputs();
                renderYearNotes();
                if (window.financialData.customInsights) {
                    document.getElementById('customInsights').value = window.financialData.customInsights;
                }

                const modifiedBy = data.lastModifiedBy || 'another user';
                document.getElementById('synctext').textContent = 'Updated by ' + modifiedBy + ' ‚òÅÔ∏è';
                setTimeout(() => {
                    document.getElementById('synctext').textContent = 'Synced ‚òÅÔ∏è';
                }, 3000);
            });
        }

        // Function to detect detailed changes
        function detectChanges(oldData, newData) {
            const changes = [];
            const categories = [
                'fixedAssetsTangible', 'intangibleAssets', 'otherNonCurrentAssets', 'currentAssets',
                'nonCurrentLiabilities', 'currentLiabilities', 'reserves',
                'revenue', 'otherIncome', 'directExpenses', 'indirectExpenses',
                'financeCosts', 'depreciation', 'taxExpenses'
            ];

            const categoryNames = {
                'fixedAssetsTangible': 'Fixed Assets / Tangible Assets',
                'intangibleAssets': 'Intangible Assets',
                'otherNonCurrentAssets': 'Other Non-Current Assets',
                'currentAssets': 'Current Assets',
                'reserves': 'Reserves',
                'nonCurrentLiabilities': 'Non-Current Liabilities',
                'currentLiabilities': 'Current Liabilities',
                'revenue': 'Revenue',
                'otherIncome': 'Other Income',
                'directExpenses': 'Direct Expenses',
                'indirectExpenses': 'Indirect Expenses',
                'financeCosts': 'Finance Costs',
                'depreciation': 'Depreciation',
                'taxExpenses': 'Tax Expenses'
            };

            // Check each year
            for (const year in newData) {
                const oldYearData = oldData[year] || {};
                const newYearData = newData[year] || {};
                const fyYear = 'FY ' + year;

                // Check each category
                categories.forEach(category => {
                    const oldItems = oldYearData[category] || [];
                    const newItems = newYearData[category] || [];

                    // Check for new items
                    newItems.forEach(newItem => {
                        const oldItem = oldItems.find(item => item.name === newItem.name);

                        if (!oldItem) {
                            // New item added
                            changes.push({
                                action: `Added "${newItem.name}" with value ${formatNumber(newItem.value)} to ${categoryNames[category]} (Year: ${fyYear})`,
                                details: `Added "${newItem.name}" with value ${formatNumber(newItem.value)} to ${categoryNames[category]}`,
                                year: fyYear
                            });
                        } else if (oldItem.value !== newItem.value) {
                            // Value changed
                            changes.push({
                                action: `Changed ${categoryNames[category]} - ${newItem.name} from ${formatNumber(oldItem.value)} to ${formatNumber(newItem.value)} (${fyYear})`,
                                details: `Changed ${categoryNames[category]} - ${newItem.name} from ${formatNumber(oldItem.value)} to ${formatNumber(newItem.value)} (${fyYear})`,
                                year: fyYear
                            });
                        }
                    });

                    // Check for deleted items
                    oldItems.forEach(oldItem => {
                        const stillExists = newItems.find(item => item.name === oldItem.name);
                        if (!stillExists) {
                            changes.push({
                                action: `Removed "${oldItem.name}" (value: ${formatNumber(oldItem.value)}) from ${categoryNames[category]} (Year: ${fyYear})`,
                                details: `Removed "${oldItem.name}" from ${categoryNames[category]}`,
                                year: fyYear
                            });
                        }
                    });
                });

                // Check for cumulative depreciation changes
                if (oldYearData.cumulativeDepreciation !== newYearData.cumulativeDepreciation) {
                    changes.push({
                        action: `Changed Cumulative Depreciation from ${formatNumber(oldYearData.cumulativeDepreciation || 0)} to ${formatNumber(newYearData.cumulativeDepreciation || 0)} (${fyYear})`,
                        details: `Changed Cumulative Depreciation from ${formatNumber(oldYearData.cumulativeDepreciation || 0)} to ${formatNumber(newYearData.cumulativeDepreciation || 0)} (${fyYear})`,
                        year: fyYear
                    });
                }

                // Check for cumulative amortization changes
                if (oldYearData.cumulativeAmortization !== newYearData.cumulativeAmortization) {
                    changes.push({
                        action: `Changed Cumulative Amortization from ${formatNumber(oldYearData.cumulativeAmortization || 0)} to ${formatNumber(newYearData.cumulativeAmortization || 0)} (${fyYear})`,
                        details: `Changed Cumulative Amortization from ${formatNumber(oldYearData.cumulativeAmortization || 0)} to ${formatNumber(newYearData.cumulativeAmortization || 0)} (${fyYear})`,
                        year: fyYear
                    });
                }
            }

            return changes;
        }

        async function clearAllProjectData() {
            if (!confirm('‚ö†Ô∏è Are you sure? This will PERMANENTLY delete all financial data for this project.')) return;

            // 1. Wipe the State Object completely
            window.financialData.companyName = '';
            window.financialData.data = {};
            window.financialData.years = ['FY 2023-24', 'FY 2024-25']; // Reset to default years

            // 2. Initialize the default years with empty structures
            window.financialData.years.forEach(year => {
                window.financialData.data[year] = {
                    fixedAssetsTangible: [], intangibleAssets: [], otherNonCurrentAssets: [],
                    currentAssets: [], nonCurrentLiabilities: [], currentLiabilities: [],
                    shareCapital: { noOfEquityIssued: 0, faceValueEquity: 0, noOfPrefIssued: 0, faceValuePref: 0 },
                    reserves: [], equity: [], revenue: [], otherIncome: [],
                    directExpenses: [], indirectExpenses: [], financeCosts: [],
                    depreciation: [], taxExpenses: [], cumulativeDepreciation: 0,
                    cumulativeAmortization: 0, notes: ''
                };
            });

            // 3. Clear UI inputs physically
            if (document.getElementById('companyName')) document.getElementById('companyName').value = '';

            // 4. Force Sync to Cloud
            // In your file, saveToLocalStorage handles the Firebase update
            await window.saveToLocalStorage();

            // 5. Refresh UI
            alert('Project data cleared and synced.');
            location.reload();
        }
        function backToDash() {
            if (confirm('Back? (saved)')) {
                // Clean up the sync listener
                if (syncListener) {
                    syncListener();
                    syncListener = null;
                }

                // Close FSA dashboard properly
                const fsaOverlay = document.getElementById('fsa-dashboard-overlay');
                if (fsaOverlay) {
                    fsaOverlay.classList.add('hidden');
                    fsaOverlay.style.display = 'none';
                }

                document.getElementById('mainapp').style.display = 'none';
                document.getElementById('cloudtop').classList.remove('show');
                document.getElementById('cloudsync').classList.remove('show');
                document.getElementById('screen3').classList.add('show');

                // Show module hub again
                const hub = document.getElementById('module-hub');
                if (hub) {
                    hub.classList.remove('hidden');
                    hub.style.display = 'block';
                }

                loadProjects();
            }
        }


        async function showHistory() {
            if (!pid) return;
            const path = ispriv ? 'users/' + user.uid + '/private/' + pid : 'shared/' + pid;
            const snap = await window.fb.get(window.fb.ref(window.db, path + '/history'));
            const history = snap.val() || {};

            const list = document.getElementById('historyList');
            const entries = Object.entries(history).sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));

            if (entries.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#6c757d;padding:40px;">No change history yet</p>';
            } else {
                list.innerHTML = entries.map(([id, h]) => {
                    const date = new Date(h.timestamp);
                    return '<div class="histitem">' +
                        '<div class="histtime">' + date.toLocaleString() + '</div>' +
                        '<div class="histuser">üë§ ' + h.user + '</div>' +
                        '<div class="histaction">' + h.action + (h.year ? ' (Year: ' + h.year + ')' : '') + '</div>' +
                        (h.changes ? '<div class="histchanges">' + h.changes + '</div>' : '') +
                        '</div>';
                }).join('');
            }

            document.getElementById('historyModal').classList.add('show');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('show');
        }



        function logout() {
            if (confirm('Logout?')) {
                window.fb.signOut(window.auth);
            }
        }



        // Expose functions globally
        // window.checkCode = checkCode;
        window.toggleAuth = toggleAuth;
        window.doAuth = doAuth;
        window.showLogin = showLogin;
        window.showDash = showDash;
        window.loadProjects = loadProjects;
        window.showNew = showNew;
        window.hideNew = hideNew;
        window.createProject = createProject;
        window.loadFSAData = loadFSAData;
        window.showHistory = showHistory;
        window.closeHistory = closeHistory;
        window.logout = logout;
        // ============ AUTO-SAVE LISTENER ============
        document.addEventListener('input', function (e) {
            if (e.target.matches('input, textarea, select')) {
                if (window.currentCloudId) {
                    window.autoSave();
                }
            }
        });
        // ========== FSA INPUT DATA BINDING ==========




        // ============ FSA HISTORY LOGIC ============
        async function logFSAChange(action, category, itemName, year, oldValue, newValue) {
            if (!window.currentCloudId) return;

            try {
                const currentUser = window.auth.currentUser;
                const path = window.ispriv ? 'users/' + currentUser.uid + '/private/' + window.currentCloudId : 'shared/' + window.currentCloudId;

                // Custom Adapter fix: window.fb.push doesn't write data. We must use update.
                const newId = 'hist_' + Date.now() + Math.random().toString(36).substr(2, 4);
                const entry = {
                    user: (currentUser && currentUser.email) ? currentUser.email : 'Unknown',
                    timestamp: Date.now(),
                    action: action,
                    category: category,
                    item: itemName,
                    year: year,
                    oldValue: oldValue,
                    newValue: newValue
                };

                const updates = {};
                updates[path + '/fsa_history/' + newId] = entry;

                await window.fb.update(window.fb.ref(window.db, path), updates);
                console.log("üìú FSA History Logged:", action, itemName);
            } catch (e) {
                console.error("Failed to log FSA history:", e);
            }
        }

        async function showFSAHistory() {
            if (!window.currentCloudId) {
                alert("Please open a project first to view history.");
                return;
            }

            const currentUser = window.auth.currentUser;
            const path = window.ispriv ? 'users/' + currentUser.uid + '/private/' + window.currentCloudId : 'shared/' + window.currentCloudId;

            document.getElementById('fsaHistoryList').innerHTML = '<p style="text-align:center;padding:20px;">Loading history...</p>';
            document.getElementById('fsaHistoryModal').classList.add('show');

            try {
                // Custom Adapter fix: get() returns the WHOLE project, ignoring the subpath.
                const snap = await window.fb.get(window.fb.ref(window.db, path));
                const projectData = snap.val() || {};
                const historyHelper = projectData.fsa_history || {};

                const entries = Object.entries(historyHelper).sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
                const list = document.getElementById('fsaHistoryList');

                if (entries.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#6c757d;padding:40px;">No change history yet</p>';
                } else {
                    list.innerHTML = entries.map(([id, h]) => {
                        // Filter out malformed entries (if any exist from previous bugs)
                        if (!h || !h.timestamp) return '';

                        const date = new Date(h.timestamp);
                        let changeText = '';

                        if (h.action === 'Update') {
                            changeText = `<div class="histchanges">Changed <strong>${h.item}</strong> (${h.year}) from <span style="color:#dc3545">${h.oldValue}</span> to <span style="color:#198754">${h.newValue}</span></div>`;
                        } else if (h.action === 'Add') {
                            changeText = `<div class="histchanges">Added <strong>${h.item}</strong> to ${h.category}</div>`;
                        } else if (h.action === 'Delete') {
                            changeText = `<div class="histchanges">Deleted <strong>${h.item}</strong> from ${h.category}</div>`;
                        }

                        return `<div class="histitem">
                            <div class="histtime">${date.toLocaleString()}</div>
                            <div class="histuser">üë§ ${h.user}</div>
                            <div class="histaction">${h.action} - ${h.category}</div>
                            ${changeText}
                        </div>`;
                    }).join('');
                }
            } catch (e) {
                console.error("Error fetching FSA history:", e);
                document.getElementById('fsaHistoryList').innerHTML = '<p style="text-align:center;color:red;">Error loading history.</p>';
            }
        }

        function closeFSAHistory() {
            document.getElementById('fsaHistoryModal').classList.remove('show');
        }

        window.showFSAHistory = showFSAHistory;
        window.closeFSAHistory = closeFSAHistory;



    </script>
<script>
    // ==========================================
    // üÜï PHASE 3: THE AI BRAIN (LOGIC)
    // ==========================================
    
    let currentChatId = null;
    let noteTimeout = null;

    // 1. TOGGLE THE AI HUB
    window.toggleInsightsPanel = function() {
        const hub = document.getElementById('ai-hub');
        const isHidden = hub.classList.contains('hidden');
        
        if (isHidden) {
            hub.classList.remove('hidden');
            document.getElementById('ai-project-ref').innerText = document.getElementById('hub-project-name').innerText;
            if(window.auth && window.auth.currentUser) {
                document.getElementById('ai-user-email').innerText = window.auth.currentUser.email;
            }
            
            // Load Data
            loadAIHistory();
            loadAINotes();
        }
    };

    window.closeAIHub = function() {
        document.getElementById('ai-hub').classList.add('hidden');
    };

    // 2. SWITCH TABS (History vs Notes)
    window.switchAITab = function(tab) {
        const historyList = document.getElementById('ai-history-list');
        const notesPanel = document.getElementById('ai-notes-panel');
        const btnHist = document.getElementById('tab-history');
        const btnNote = document.getElementById('tab-notes');

        if(tab === 'history') {
            historyList.classList.remove('hidden');
            notesPanel.classList.add('hidden');
            btnHist.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-blue-600 text-white";
            btnNote.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded hover:bg-white/5 text-slate-400";
        } else {
            historyList.classList.add('hidden');
            notesPanel.classList.remove('hidden');
            btnHist.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded hover:bg-white/5 text-slate-400";
            btnNote.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-blue-600 text-white";
        }
    };

// 3. ALTERNATIVE AI ENGINE (Hercai - Free & Unlimited)
// ==========================================
    // üß† UNBREAKABLE AI ENGINE (Cascade Strategy)
    // ==========================================
    window.sendAIMessage = async function () {
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if (!text) return;

    appendMessage('user', text);
    input.value = '';
    input.style.height = 'auto';

    if (!currentChatId) startNewChat(false);
    const loadingId = appendMessage('ai', 'Thinking...', true);

    const apiKey = "REPLACE_WITH_NEW_KEY_FROM_AI_STUDIO";

    try {
        const url =
          `https://generativeai.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                role: "user",
                parts: [{ text }]
            }]
        };

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
            console.error("Gemini Error:", data);
            throw new Error(data.error?.message || "Gemini request failed");
        }

        const aiText =
            data.candidates?.[0]?.content?.parts?.[0]?.text ||
            "No response generated.";

        updateMessage(loadingId, aiText);
        saveInteraction(text, aiText);

    } catch (e) {
        updateMessage(
            loadingId,
            `‚ùå <b>Gemini API Error:</b><br>${e.message}`
        );
    }
};


// 4. CHAT UTILS
    function appendMessage(role, text, isLoading = false) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;
        div.className = "flex gap-4 max-w-3xl mx-auto " + (role === 'user' ? "flex-row-reverse" : "");
        
        const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
        const bgClass = role === 'user' ? 'bg-blue-600/20 border-blue-500/30' : 'bg-white/5 border-white/10';

        div.innerHTML = `
            <div class="w-8 h-8 rounded-full ${role === 'user' ? 'bg-slate-700' : 'bg-indigo-500'} flex items-center justify-center shrink-0 text-xs">${avatar}</div>
            <div class="${bgClass} border p-4 rounded-2xl ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm text-slate-300 leading-relaxed shadow-lg ${isLoading ? 'animate-pulse' : ''}">
                ${text.replace(/\n/g, '<br>')}
            </div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function updateMessage(id, newText) {
        const el = document.getElementById(id);
        if(el) {
            const bubble = el.querySelector('div:nth-child(2)');
            bubble.classList.remove('animate-pulse');
            let formatted = newText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            bubble.innerHTML = formatted;
        }
    }

    window.handleAIEnter = function(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            window.sendAIMessage();
        }
        e.target.style.height = 'auto';
        e.target.style.height = e.target.scrollHeight + 'px';
    };

    window.startNewChat = function(clearUI = true) {
        currentChatId = 'chat_' + Date.now();
        if(clearUI) {
            document.getElementById('chat-container').innerHTML = `
            <div class="flex gap-4 max-w-3xl mx-auto"><div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center shrink-0">ü§ñ</div><div class="bg-white/5 border border-white/10 p-4 rounded-2xl rounded-tl-none text-sm text-slate-300 leading-relaxed shadow-lg">New session started. Ready to help.</div></div>`;
        }
    };

    // 5. DATABASE: SAVE & LOAD
    async function saveInteraction(userText, aiText) {
        if(!window.currentCloudId) return;
        try {
            const historyRef = window.collection(window.db, "shared", window.currentCloudId, "ai_history");
            await window.addDoc(historyRef, {
                user: userText,
                ai: aiText,
                timestamp: new Date().toISOString(),
                sessionId: currentChatId
            });
            loadAIHistory();
        } catch(e) { console.error("History Save Error", e); }
    }

    async function loadAIHistory() {
        if(!window.currentCloudId) return;
        const list = document.getElementById('ai-history-list');
        try {
            const historyRef = window.collection(window.db, "shared", window.currentCloudId, "ai_history");
            const q = window.query(historyRef, window.orderBy('timestamp', 'desc'), window.limit(20));
            const snap = await window.getDocs(q);
            
            if(snap.empty) {
                list.innerHTML = '<div class="text-slate-600 text-xs p-4 text-center italic">No history yet</div>';
                return;
            }

            list.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = "p-3 rounded hover:bg-white/5 cursor-pointer border-b border-white/5";
                item.onclick = () => { /* Restore logic */ };
                item.innerHTML = `
                    <div class="text-xs text-white truncate font-medium">"${data.user.substring(0, 30)}..."</div>
                    <div class="text-[9px] text-slate-500 mt-1">${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;
                list.appendChild(item);
            });
        } catch(e) { console.log("History Load Error", e); }
    }

    // 6. NOTES SYSTEM (Auto-Save)
    async function loadAINotes() {
        if(!window.currentCloudId) return;
        const noteField = document.getElementById('ai-global-notes');
        try {
            const noteRef = window.doc(window.db, "shared", window.currentCloudId, "insights", "global_notes");
            const snap = await window.getDoc(noteRef);
            if(snap.exists()) {
                noteField.value = snap.data().content || "";
            } else {
                noteField.value = "";
            }
        } catch(e) {}
    }

    document.getElementById('ai-global-notes').addEventListener('input', (e) => {
        const status = document.getElementById('note-save-status');
        status.innerText = "Typing...";
        
        clearTimeout(noteTimeout);
        noteTimeout = setTimeout(async () => {
            if(!window.currentCloudId) return;
            status.innerText = "Saving...";
            try {
                const noteRef = window.doc(window.db, "shared", window.currentCloudId, "insights", "global_notes");
                await window.setDoc(noteRef, { content: e.target.value, lastModified: new Date().toISOString() });
                status.innerText = "Saved ‚úÖ";
                setTimeout(() => status.innerText = "", 2000);
            } catch(e) { status.innerText = "Error ‚ùå"; }
        }, 1000);
    });
</script>
<script type="module">
    // =========================================================
    // üöÄ FINAL MASTER CONTROL (MODULE VERSION - RUNS LAST)
    // =========================================================
    console.log("‚úÖ MASTER CONTROL MODULE ACTIVE");

    // 1. IMPORT FIREBASE (Required for Module Scripts)
    import { doc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. THE MASTER OPENER (Hijacks both 'loadProject' and 'openProject')
    const masterOpener = async function(id) {
        console.log("üü¢ MASTER OPENER ACTIVATED:", id);
        window.currentCloudId = id;

        // A. UI SWITCH: Hide List, Show Dashboard
        const overlay = document.getElementById('project-overlay');
        const hub = document.getElementById('module-hub');
        
        if (overlay) {
            overlay.classList.add('hidden');
            overlay.style.display = 'none'; 
        }
        if (hub) {
            hub.classList.remove('hidden');
            hub.style.display = 'block'; 
        }

        // B. SET TITLE
        try {
            // Check 'shared' first, then 'projects'
            let snap = await getDoc(doc(window.db, "shared", id));
            if (!snap.exists()) snap = await getDoc(doc(window.db, "projects", id));
            
            if (snap.exists()) {
                const name = snap.data().companyName || snap.data().name || "Untitled";
                const titleEl = document.getElementById('hub-project-name');
                if (titleEl) titleEl.innerText = name;
            }
        } catch (e) { console.warn("Title error:", e); }

        // C. START WATCHER
        startModuleWatcher(id);
    };

    // 3. OVERWRITE THE OLD FUNCTIONS
    window.openProject = masterOpener;
    window.loadProject = masterOpener; 

    // 4. THE BACK BUTTON REPAIR
    window.exitToProjectList = function() {
        console.log("üî¥ EXITING TO LIST");
        
        // Stop Listeners
        if(window.activeModuleListeners) {
            window.activeModuleListeners.forEach(u => u());
            window.activeModuleListeners = [];
        }

        // Hide Dashboard
        const hub = document.getElementById('module-hub');
        if(hub) {
            hub.classList.add('hidden');
            hub.style.display = 'none';
        }

        // Show List
        const list = document.getElementById('project-overlay');
        if(list) {
            list.classList.remove('hidden');
            list.style.display = 'flex';
        }
        
        window.currentCloudId = null;
    };
// 5. THE REAL-TIME WATCHER (Finds V1, V2... with Unique IDs)
window.activeModuleListeners = [];

function startModuleWatcher(projectId) {
    // Clear old listeners
    window.activeModuleListeners.forEach(u => u());
    window.activeModuleListeners = [];

    const imGrid = document.getElementById('im-grid');
    const fsaGrid = document.getElementById('fsa-grid');
    
    if (imGrid) imGrid.innerHTML = '<div class="text-white animate-pulse">Scanning...</div>';
    if (fsaGrid) fsaGrid.innerHTML = '<div class="text-white animate-pulse">Scanning...</div>';

    const draw = (snap, container, type) => {
        container.innerHTML = '';
        if (snap.empty) {
            container.innerHTML = `<div class="text-slate-500 italic p-4 border border-white/5 rounded-xl">No ${type}s created yet.</div>`;
            return;
        }
        
        // Sort by the specific version timestamp or last updated date
        const docs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                              .sort((a,b) => {
                                  const dateA = new Date(a.versionTimestamp || a.lastUpdated || a.createdAt || 0);
                                  const dateB = new Date(b.versionTimestamp || b.lastUpdated || b.createdAt || 0);
                                  return dateB - dateA;
                              });

        docs.forEach(d => {
            // Priority on versionTimestamp for display
            const dateStr = d.versionTimestamp || d.lastUpdated || d.createdAt;
            const date = dateStr ? new Date(dateStr).toLocaleDateString() : 'N/A';
            const time = dateStr ? new Date(dateStr).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            
            const card = document.createElement('div');
            card.className = "bg-slate-800/40 hover:bg-slate-800/80 border border-white/5 hover:border-white/20 p-5 rounded-2xl cursor-pointer transition-all group relative overflow-hidden";
            
            // CLICK ACTION (Ensures window.currentModuleId is the UNIQUE Version ID)
            card.onclick = () => {
                // 1. Store the UNIQUE ID for this specific version
                window.currentModuleId = d.id;
                window.currentModuleName = d.name;

                console.log(`üéØ Accessing Unique Version ID: ${d.id}`);

                // 2. Route to the correct Dashboard
                if (type === 'FSA') {
                    console.log("üìÇ Opening FSA Dashboard...");
                    if (typeof window.launchFSA === 'function') {
                        window.launchFSA(); 
                    } else {
                        console.error("Critical: launchFSA() not found in global scope.");
                    }
                } else if (type === 'IM') {
                    console.log("üìÇ Opening IM Dashboard...");
                    if (typeof window.launchIM === 'function') {
                        window.launchIM();
                    } else {
                        console.error("Critical: launchIM() not found in global scope.");
                    }
                }
            };
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${type === 'IM' ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'} flex items-center justify-center font-bold text-xs">
                            ${type}
                        </div>
                        <h4 class="text-white font-bold truncate max-w-[120px]">${d.name || 'Untitled Version'}</h4>
                    </div>
                    <span class="text-[8px] font-mono text-slate-500 bg-black/40 px-1.5 py-0.5 rounded border border-white/5">
                        ID: ${d.id.substring(0,6)}
                    </span>
                </div>
                
                <div class="flex flex-col gap-1">
                    <p class="text-[10px] text-slate-400 flex justify-between">
                        <span>Date:</span>
                        <span class="text-slate-300">${date}</span>
                    </p>
                    <p class="text-[10px] text-slate-400 flex justify-between">
                        <span>Sync:</span>
                        <span class="text-slate-500 font-mono">${time}</span>
                    </p>
                </div>

                <div class="absolute bottom-0 left-0 w-full h-1 ${type === 'IM' ? 'bg-red-500/10' : 'bg-emerald-500/10'} group-hover:h-1.5 transition-all"></div>
            `;
            container.appendChild(card);
        });
    };

    try {
        const qIM = window.collection(window.db, "shared", projectId, "ims");
        const qFSA = window.collection(window.db, "shared", projectId, "fsas");
        
        window.activeModuleListeners.push(window.onSnapshot(qIM, s => draw(s, imGrid, 'IM')));
        window.activeModuleListeners.push(window.onSnapshot(qFSA, s => draw(s, fsaGrid, 'FSA')));
    } catch(e) { console.error("DB Error:", e); }
}

// 6. ATTACH TO WINDOW
window.fetchProjectModules = startModuleWatcher;
    
// üü¢ UPDATED FSA LAUNCHER
window.launchFSA = function() {
    console.log("üöÄ Switching to FSA Dashboard View");
    
    // 1. Set the Type Context (Crucial for the Adapter)
    window.currentModuleType = 'FSA'; 

    // 2. Hide Hub
    const hub = document.getElementById('module-hub');
    if (hub) hub.classList.add('hidden');

    // 3. Show FSA
    const fsaOverlay = document.getElementById('fsa-dashboard-overlay');
    if (fsaOverlay) {
        fsaOverlay.classList.remove('hidden');
        fsaOverlay.style.display = 'block';
    }

    // 4. Trigger Loader
    if (typeof window.openFSADashboard === 'function') {
        window.openFSADashboard();
    }
};

// üü¢ UPDATED IM LAUNCHER
window.launchIM = function() {
    console.log("üöÄ Switching to IM Editor View");
    
    // 1. Set Type Context
    window.currentModuleType = 'IM';

    const hub = document.getElementById('module-hub');
    if (hub) hub.classList.add('hidden');

    const sidebar = document.getElementById('main-sidebar');
    const mainContent = document.getElementById('main-content');
    if (sidebar) sidebar.classList.remove('hidden');
    if (mainContent) mainContent.classList.remove('hidden');

    if (window.currentCloudId && window.currentModuleId) {
        console.log("üì° Bridging IM to Version:", window.currentModuleId);
        if (typeof window.loadIMDashboard === 'function') {
            window.loadIMDashboard(window.currentModuleId);
        }
    } else {
        console.error("No Active Cloud Session found.");
    }
};

console.log("‚úÖ SYSTEM SECURED: All functions overwritten successfully.");

    window.saveIMToCloud = async function() {
    if (!window.currentCloudId || !window.currentModuleId || window.isProjectLoading) return;

    // 1. Collect all current data from the UI
    const dataToSave = {};
    document.querySelectorAll('input, textarea, select').forEach(el => {
        if (el.id && el.type !== 'file') {
            dataToSave[el.id] = el.value;
        }
    });

    try {
        const docRef = window.doc(window.db, "shared", window.currentCloudId, "ims", window.currentModuleId);
        await window.updateDoc(docRef, {
            data: dataToSave,
            lastUpdated: new Date().toISOString()
        });
        console.log("‚òÅÔ∏è Cloud Auto-Save Complete");
    } catch (e) {
        console.error("‚ùå Cloud Save Failed:", e);
    }
};

// This waits 2 seconds after you stop typing to push to the cloud
let saveTimeout;
document.addEventListener('input', (e) => {
    // Only auto-save if we are inside the IM dashboard
    const content = document.getElementById('main-content');
    if (content && !content.classList.contains('hidden')) {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            window.saveIMToCloud();
        }, 2000); 
    }
});

window.commitNewVersion = async function() {
    if (!window.currentCloudId || window.isProjectLoading) return;

    const dataToSave = {};
    document.querySelectorAll('input, textarea, select').forEach(el => {
        if (el.id && el.type !== 'file' && el.type !== 'button') {
            dataToSave[el.id] = el.value;
        }
    });

    try {
        // Use addDoc instead of updateDoc to create a SEPARATE ID
        const imCollection = window.collection(window.db, "shared", window.currentCloudId, "ims");
        
        // Ask for a version name (e.g., "Draft 1", "Final Audit")
        const vName = prompt("Enter Version Name:", `Version ${new Date().toLocaleTimeString()}`);
        if (!vName) return;

        const newDoc = await window.addDoc(imCollection, {
            name: vName,
            data: dataToSave,
            versionTimestamp: new Date().toISOString(),
            status: 'archived', // Marks this as a fixed version
            rootProjectId: window.currentModuleId // Links it to the original project
        });

        console.log("üìÑ New Independent Version Created:", newDoc.id);
        alert("Version Committed Successfully with unique ID: " + newDoc.id);
    } catch (e) {
        console.error("‚ùå Version Commit Failed:", e);
    }
};

</script>
</body>

</html>
